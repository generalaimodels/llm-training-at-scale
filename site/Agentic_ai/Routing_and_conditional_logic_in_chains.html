<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="1.6 Routing and Conditional Logic in Chains">
  <title>1.6 Routing and Conditional Logic in Chains | AI Engineering Knowledge Hub</title>
  <script>
  (() => {
    try {
      const key = "docs-theme-mode";
      const raw = window.localStorage.getItem(key);
      const mode = raw === "graphite" || raw === "ivory" ? raw : "ivory";
      document.documentElement.dataset.theme = mode;
      document.documentElement.style.colorScheme = mode === "graphite" ? "dark" : "light";
    } catch {
      document.documentElement.dataset.theme = "ivory";
      document.documentElement.style.colorScheme = "light";
    }
  })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="../assets/vendor/katex/katex.min.css?v=2026-02-19T19%3A13%3A56.962Z">
  <link rel="stylesheet" href="../assets/styles.css?v=2026-02-19T19%3A13%3A56.962Z">
</head>
<body>
  <div class="ambient-layer ambient-layer-a" aria-hidden="true"></div>
  <div class="ambient-layer ambient-layer-b" aria-hidden="true"></div>
  <header class="topbar">
    <button id="menu-toggle" class="icon-btn" type="button" aria-label="Toggle navigation">Menu</button>
    <a class="brand" href="../index.html">
      <span class="brand-kicker">Docs</span>
      <strong>AI Engineering Knowledge Hub</strong>
    </a>
    <div class="topbar-actions">
      <input id="nav-filter" class="doc-filter" type="search" placeholder="Filter documents" aria-label="Filter documents">
      <p id="filter-status" class="filter-status" aria-live="polite"></p>
      <button id="theme-toggle" class="icon-btn" type="button" aria-label="Switch theme">Graphite</button>
    </div>
  </header>
  <div class="site-shell">
    <aside class="nav-pane" id="left-nav">
      <p class="pane-label">Source Folder</p>
      <p class="pane-title">llm_training_at_scale</p>
      <nav class="doc-nav" aria-label="Document list">
<a class="doc-link" data-doc-link data-doc-title="1.10 advanced prompt chaining techniques" data-doc-path="agentic_ai/advanced_prompt_chaining_techniques" data-doc-folder="agentic_ai" href="../Agentic_ai/Advanced_prompt_chaining_techniques.html"><span>1.10 Advanced Prompt Chaining Techniques</span><small>Agentic_ai/Advanced_prompt_chaining_techniques</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/architecture_and_design_patterns_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Architecture_and_design_patterns_of_prompt_chains.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Architecture_and_design_patterns_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.7 error handling, robustness, and fault tolerance" data-doc-path="agentic_ai/error_handling_robustness_and_fault_tolerance" data-doc-folder="agentic_ai" href="../Agentic_ai/Error_handling_robustness_and_fault_tolerance.html"><span>1.7 Error Handling, Robustness, and Fault Tolerance</span><small>Agentic_ai/Error_handling_robustness_and_fault_tolerance</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.13 evaluation of prompt chains" data-doc-path="agentic_ai/evaluation_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Evaluation_of_prompt_chains.html"><span>1.13 Evaluation of Prompt Chains</span><small>Agentic_ai/Evaluation_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive treatment" data-doc-path="agentic_ai/foundations_of_prompt_chaining" data-doc-folder="agentic_ai" href="../Agentic_ai/Foundations_of_prompt_chaining.html"><span>Chapter 1: Prompt Chaining — Comprehensive Treatment</span><small>Agentic_ai/Foundations_of_prompt_chaining</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.9 optimization of prompt chains" data-doc-path="agentic_ai/optimization_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Optimization_of_prompt_chains.html"><span>1.9 Optimization of Prompt Chains</span><small>Agentic_ai/Optimization_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="prompt chaining: frameworks, observability, evaluation, security, applications, and paradigm comparisons" data-doc-path="agentic_ai/prompt chaining_frameworks_and_implementation" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt Chaining_frameworks_and_Implementation.html"><span>Prompt Chaining: Frameworks, Observability, Evaluation, Security, Applications, and Paradigm Comparisons</span><small>Agentic_ai/Prompt Chaining_frameworks_and_Implementation</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive index" data-doc-path="agentic_ai/prompt_chaining_index" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_Chaining_index.html"><span>Chapter 1: Prompt Chaining — Comprehensive Index</span><small>Agentic_ai/Prompt_Chaining_index</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.16 prompt chaining vs. related paradigms" data-doc-path="agentic_ai/prompt_chaining_vs_related_paradigm" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_chaining_vs_related_paradigm.html"><span>1.16 Prompt Chaining vs. Related Paradigms</span><small>Agentic_ai/Prompt_chaining_vs_related_paradigm</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/prompt_design_for_chain_steps" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_design_for_chain_steps.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Prompt_design_for_chain_steps</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.15 real-world applications and case studies" data-doc-path="agentic_ai/real-world_applications_and_case_studies" data-doc-folder="agentic_ai" href="../Agentic_ai/Real-World_applications_and_case_studies.html"><span>1.15 Real-World Applications and Case Studies</span><small>Agentic_ai/Real-World_applications_and_case_studies</small></a>
<a class="doc-link is-active" data-doc-link data-doc-title="1.6 routing and conditional logic in chains" data-doc-path="agentic_ai/routing_and_conditional_logic_in_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Routing_and_conditional_logic_in_chains.html"><span>1.6 Routing and Conditional Logic in Chains</span><small>Agentic_ai/Routing_and_conditional_logic_in_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.14 security, safety, and guardrails in prompt chains" data-doc-path="agentic_ai/security_safety_and_guardrails_in_prompt_chaind" data-doc-folder="agentic_ai" href="../Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind.html"><span>1.14 Security, Safety, and Guardrails in Prompt Chains</span><small>Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.4 state management and context propagation" data-doc-path="agentic_ai/state_management_and_context_propagation" data-doc-folder="agentic_ai" href="../Agentic_ai/State_management_and_context_propagation.html"><span>1.4 State Management and Context Propagation</span><small>Agentic_ai/State_management_and_context_propagation</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.5 task decomposition strategies" data-doc-path="agentic_ai/task_decomposition_strategies" data-doc-folder="agentic_ai" href="../Agentic_ai/Task_decomposition_strategies.html"><span>1.5 Task Decomposition Strategies</span><small>Agentic_ai/Task_decomposition_strategies</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/documentation_mcp_mcp_for_agent_security" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/introduction_tools_action" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Introduction_Tools_Action.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Introduction_Tools_Action</small></a>
<a class="doc-link" data-doc-link data-doc-title="2.6 security in mcp" data-doc-path="agentic_ai/tools/security_mcp_conclusion" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Security_MCP_conclusion.html"><span>2.6 Security in MCP</span><small>Agentic_ai/Tools/Security_MCP_conclusion</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota index" data-doc-path="agentic_ai/tools/tools_comprehensive_index" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Tools_comprehensive_Index.html"><span>Chapter 2: Tools — Comprehensive SOTA Index</span><small>Agentic_ai/Tools/Tools_comprehensive_Index</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.8 verification, validation, and quality control" data-doc-path="agentic_ai/verification_validation_and_quality_control" data-doc-folder="agentic_ai" href="../Agentic_ai/Verification_validation_and_quality_control.html"><span>1.8 Verification, Validation, and Quality Control</span><small>Agentic_ai/Verification_validation_and_quality_control</small></a>
<a class="doc-link" data-doc-link data-doc-title="context parallelism and ring attention" data-doc-path="context_parallelism_update" data-doc-folder="root" href="../context_parallelism_update.html"><span>Context Parallelism and Ring Attention</span><small>context_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="context_parallelism" data-doc-folder="root" href="../context_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>context_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism: a comprehensive technical treatment" data-doc-path="data_parallelism_basic" data-doc-folder="root" href="../data_parallelism_basic.html"><span>Data Parallelism: A Comprehensive Technical Treatment</span><small>data_parallelism_basic</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism (dp): a comprehensive technical treatment" data-doc-path="data_parallelism" data-doc-folder="root" href="../data_parallelism.html"><span>Data Parallelism (DP): A Comprehensive Technical Treatment</span><small>data_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="finding the best training configuration for distributed large model training" data-doc-path="distributed_large_model_training" data-doc-folder="root" href="../distributed_large_model_training.html"><span>Finding the Best Training Configuration for Distributed Large Model Training</span><small>distributed_large_model_training</small></a>
<a class="doc-link" data-doc-link data-doc-title="diving into the gpus — fusing, threading, and mixing" data-doc-path="diving_gpus_fusing_threading_and_mixing" data-doc-folder="root" href="../diving_gpus_fusing_threading_and_mixing.html"><span>Diving into the GPUs — Fusing, Threading, and Mixing</span><small>diving_gpus_fusing_threading_and_mixing</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism_update" data-doc-folder="root" href="../expert_parallelism_update.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism" data-doc-folder="root" href="../expert_parallelism.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="scaling distributed training: foundations and first principles" data-doc-path="high_level_overview_updated" data-doc-folder="root" href="../high_level_overview_updated.html"><span>Scaling Distributed Training: Foundations and First Principles</span><small>high_level_overview_updated</small></a>
<a class="doc-link" data-doc-link data-doc-title="high-level overview of distributed training: foundations, memory analysis, and first-step techniques" data-doc-path="high_level_overview" data-doc-folder="root" href="../high_level_overview.html"><span>High-Level Overview of Distributed Training: Foundations, Memory Analysis, and First-Step Techniques</span><small>high_level_overview</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: comprehensive technical exposition" data-doc-path="pipelineparallelism_update" data-doc-folder="root" href="../pipelineparallelism_update.html"><span>Pipeline Parallelism: Comprehensive Technical Exposition</span><small>pipelineparallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: a comprehensive technical exposition" data-doc-path="pipelineparallelism" data-doc-folder="root" href="../pipelineparallelism.html"><span>Pipeline Parallelism: A Comprehensive Technical Exposition</span><small>pipelineparallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism_update" data-doc-folder="root" href="../tensor_parallelism_update.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism" data-doc-folder="root" href="../tensor_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism</small></a>
      </nav>
    </aside>
    <main class="content-pane">
      <article class="doc-content">
<h1 id="16-routing-and-conditional-logic-in-chains" tabindex="-1">1.6 Routing and Conditional Logic in Chains</h1>
<blockquote>
<p><strong>Scope.</strong> In any non-trivial agentic system, the execution path is not a fixed linear sequence — it is a <strong>conditional computation graph</strong> where the next step depends on the content, quality, or classification of the current step’s output. Routing is the mechanism that implements this conditional branching: given an intermediate result, which downstream path should execute? Gate mechanisms are the dual concept: given an intermediate result, should execution proceed at all, or should it loop, retry, escalate, or halt? Together, routing and gating transform a static chain into a dynamic, adaptive system capable of handling the full distribution of real-world inputs. This section provides a first-principles treatment of every routing and gating pattern, with formal decision-theoretic foundations, production-grade implementations, and rigorous analysis of failure modes.</p>
</blockquote>
<hr>
<h2 id="161-static-routing" tabindex="-1">1.6.1 Static Routing</h2>
<h3 id="1611-foundational-definition" tabindex="-1">1.6.1.1 Foundational Definition</h3>
<p>Static routing uses <strong>predetermined, code-defined rules</strong> to select the next chain step. The routing function is a pure deterministic mapping from observable features of the state to a branch identifier:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>static</mtext></msub><mo>:</mo><mi mathvariant="script">F</mi><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>⟶</mo><mo stretchy="false">{</mo><msub><mi>b</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>b</mi><mi>k</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">
R_{\text{static}}: \mathcal{F}(S_t) \longrightarrow \{b_1, b_2, \dots, b_k\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.09931em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟶</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">F</mi><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{F}(S_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.09931em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></eq>extracts discrete features from the current state<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">S_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>(keywords, numeric thresholds, type tags, regex matches), and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>b</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>b</mi><mi>k</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{b_1, \dots, b_k\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></eq> is the finite set of possible downstream branches.</p>
<p><strong>Key properties:</strong></p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Determinism</strong></td>
<td>Given identical input, always selects identical branch</td>
</tr>
<tr>
<td><strong>Latency</strong></td>
<td>Near-zero (no LLM call, no embedding computation)</td>
</tr>
<tr>
<td><strong>Interpretability</strong></td>
<td>Fully transparent — every routing decision is inspectable</td>
</tr>
<tr>
<td><strong>Flexibility</strong></td>
<td>Low — cannot handle novel inputs outside predefined rules</td>
</tr>
<tr>
<td><strong>Maintenance cost</strong></td>
<td>Grows linearly with rule count; rules may conflict</td>
</tr>
</tbody>
</table>
<h3 id="1612-predefined-conditional-branches" tabindex="-1">1.6.1.2 Predefined Conditional Branches</h3>
<p>The simplest routing pattern: explicit <code>if/elif/else</code> logic that examines structured fields of the state.</p>
<p><strong>Formal model.</strong> Define a set of predicates <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>P</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>P</mi><mi>k</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{P_1, P_2, \dots, P_k\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></eq>where each<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub><mo>:</mo><mi mathvariant="script">S</mi><mo>→</mo><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">P_j: \mathcal{S} \rightarrow \{0, 1\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.075em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">}</span></span></span></span></eq>, and a <strong>priority ordering</strong> among predicates. The routing decision is:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>b</mi><mi>j</mi></msub><mspace width="1em"/><mtext>where </mtext><mi>j</mi><mo>=</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">{</mo><mi>i</mi><mo>:</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">
R(S_t) = b_j \quad \text{where } j = \min\{i : P_i(S_t) = 1\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">where </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mopen">{</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">}</span></span></span></span></span></eqn></section><p>If no predicate fires, a <strong>default branch</strong> <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mtext>default</mtext></msub></mrow><annotation encoding="application/x-tex">b_{\text{default}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">default</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> handles the input (critical for robustness — never leave an input unrouted).</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Callable</span>, <span class="hljs-type">Any</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Route</span>:
    name: <span class="hljs-built_in">str</span>
    predicate: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">dict</span>], <span class="hljs-built_in">bool</span>]
    handler: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">dict</span>], <span class="hljs-type">Any</span>]
    priority: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># lower = higher priority</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Deterministic, rule-based router with priority ordering.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, default_handler: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">dict</span>], <span class="hljs-type">Any</span>]</span>):
        <span class="hljs-variable language_">self</span>.routes: <span class="hljs-built_in">list</span>[Route] = []
        <span class="hljs-variable language_">self</span>.default_handler = default_handler
        <span class="hljs-variable language_">self</span>._routing_log: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>] = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_route</span>(<span class="hljs-params">self, route: Route</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-variable language_">self</span>.routes.append(route)
        <span class="hljs-variable language_">self</span>.routes.sort(key=<span class="hljs-keyword">lambda</span> r: r.priority)  <span class="hljs-comment"># maintain priority order</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, state: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Select the first matching route by priority.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">for</span> route <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.routes:
            <span class="hljs-keyword">if</span> route.predicate(state):
                <span class="hljs-variable language_">self</span>._routing_log.append({
                    <span class="hljs-string">&quot;state_summary&quot;</span>: <span class="hljs-built_in">str</span>(state.get(<span class="hljs-string">&quot;query&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))[:<span class="hljs-number">100</span>],
                    <span class="hljs-string">&quot;matched_route&quot;</span>: route.name,
                    <span class="hljs-string">&quot;priority&quot;</span>: route.priority
                })
                <span class="hljs-keyword">return</span> route.name, route.handler
        
        <span class="hljs-variable language_">self</span>._routing_log.append({
            <span class="hljs-string">&quot;state_summary&quot;</span>: <span class="hljs-built_in">str</span>(state.get(<span class="hljs-string">&quot;query&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))[:<span class="hljs-number">100</span>],
            <span class="hljs-string">&quot;matched_route&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,
            <span class="hljs-string">&quot;priority&quot;</span>: -<span class="hljs-number">1</span>
        })
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-variable language_">self</span>.default_handler


<span class="hljs-comment"># --- Instantiation Example ---</span>

router = StaticRouter(default_handler=general_handler)

router.add_route(Route(
    name=<span class="hljs-string">&quot;code_generation&quot;</span>,
    predicate=<span class="hljs-keyword">lambda</span> s: s.get(<span class="hljs-string">&quot;task_type&quot;</span>) == <span class="hljs-string">&quot;code&quot;</span>,
    handler=code_generation_chain,
    priority=<span class="hljs-number">0</span>
))

router.add_route(Route(
    name=<span class="hljs-string">&quot;data_analysis&quot;</span>,
    predicate=<span class="hljs-keyword">lambda</span> s: s.get(<span class="hljs-string">&quot;task_type&quot;</span>) == <span class="hljs-string">&quot;analysis&quot;</span>,
    handler=data_analysis_chain,
    priority=<span class="hljs-number">1</span>
))

router.add_route(Route(
    name=<span class="hljs-string">&quot;simple_qa&quot;</span>,
    predicate=<span class="hljs-keyword">lambda</span> s: s.get(<span class="hljs-string">&quot;estimated_complexity&quot;</span>, <span class="hljs-number">1.0</span>) &lt; <span class="hljs-number">0.3</span>,
    handler=simple_qa_handler,
    priority=<span class="hljs-number">2</span>
))
</code></pre>
</div><h3 id="1613-rule-based-routing-regex-keyword-threshold" tabindex="-1">1.6.1.3 Rule-Based Routing (Regex, Keyword, Threshold)</h3>
<p>When the routing decision depends on the <strong>content</strong> of unstructured text (the user query or a previous step’s output), static routing employs pattern-matching heuristics.</p>
<h4 id="a-keyword-based-routing" tabindex="-1">A. Keyword-Based Routing</h4>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>keyword</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>b</mi><mi>j</mi></msub><mspace width="1em"/><mtext>where </mtext><mi>j</mi><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>j</mi></munder><mtext>  </mtext><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">K</mi><mi>j</mi></msub><mo>∩</mo><mtext>tokens</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">
R_{\text{keyword}}(x) = b_j \quad \text{where } j = \arg\max_j \; |\mathcal{K}_j \cap \text{tokens}(x)|
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">keyword</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">where </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.6138em;vertical-align:-0.8638em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3723em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8638em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.01445em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0144em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">tokens</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord">∣</span></span></span></span></span></eqn></section><p>Here <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">K</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{K}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.01445em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0144em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq>is the keyword set associated with branch<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">b_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq>, and <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>tokens</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{tokens}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">tokens</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq> is the tokenized input.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">KeywordRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Route based on keyword overlap with predefined vocabularies.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.keyword_sets: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">set</span>[<span class="hljs-built_in">str</span>]] = {}
        <span class="hljs-variable language_">self</span>.handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_route</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, keywords: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], handler: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-variable language_">self</span>.keyword_sets[name] = {kw.lower() <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> keywords}
        <span class="hljs-variable language_">self</span>.handlers[name] = handler
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Return (route_name, match_score) for the best matching route.&quot;&quot;&quot;</span>
        tokens = <span class="hljs-built_in">set</span>(text.lower().split())
        scores = {}
        
        <span class="hljs-keyword">for</span> name, keywords <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.keyword_sets.items():
            overlap = tokens &amp; keywords
            <span class="hljs-comment"># Normalized score: fraction of route keywords found</span>
            scores[name] = <span class="hljs-built_in">len</span>(overlap) / <span class="hljs-built_in">max</span>(<span class="hljs-built_in">len</span>(keywords), <span class="hljs-number">1</span>)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> scores <span class="hljs-keyword">or</span> <span class="hljs-built_in">max</span>(scores.values()) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-number">0.0</span>
        
        best_route = <span class="hljs-built_in">max</span>(scores, key=scores.get)
        <span class="hljs-keyword">return</span> best_route, scores[best_route]


<span class="hljs-comment"># Example</span>
kw_router = KeywordRouter()
kw_router.add_route(<span class="hljs-string">&quot;code&quot;</span>, [<span class="hljs-string">&quot;write&quot;</span>, <span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;function&quot;</span>, <span class="hljs-string">&quot;implement&quot;</span>, <span class="hljs-string">&quot;debug&quot;</span>, <span class="hljs-string">&quot;python&quot;</span>, <span class="hljs-string">&quot;script&quot;</span>], code_handler)
kw_router.add_route(<span class="hljs-string">&quot;math&quot;</span>, [<span class="hljs-string">&quot;calculate&quot;</span>, <span class="hljs-string">&quot;solve&quot;</span>, <span class="hljs-string">&quot;equation&quot;</span>, <span class="hljs-string">&quot;integral&quot;</span>, <span class="hljs-string">&quot;derivative&quot;</span>, <span class="hljs-string">&quot;proof&quot;</span>], math_handler)
kw_router.add_route(<span class="hljs-string">&quot;search&quot;</span>, [<span class="hljs-string">&quot;find&quot;</span>, <span class="hljs-string">&quot;search&quot;</span>, <span class="hljs-string">&quot;look up&quot;</span>, <span class="hljs-string">&quot;what is&quot;</span>, <span class="hljs-string">&quot;who is&quot;</span>, <span class="hljs-string">&quot;when did&quot;</span>], search_handler)
</code></pre>
</div><p><strong>Limitations:</strong> Keyword matching is brittle — “I want to <em>debug</em> my <em>relationship</em>” would incorrectly route to <code>code</code>. This motivates semantic routing (§1.6.2).</p>
<h4 id="b-regex-based-routing" tabindex="-1">B. Regex-Based Routing</h4>
<p>More expressive than keyword matching, regex routing captures structural patterns:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>regex</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>b</mi><mi>j</mi></msub><mspace width="1em"/><mtext>where </mtext><mi>j</mi><mo>=</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">{</mo><mi>i</mi><mo>:</mo><msub><mtext>regex</mtext><mi>i</mi></msub><mtext> matches </mtext><mi>x</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">
R_{\text{regex}}(x) = b_j \quad \text{where } j = \min\{i : \text{regex}_i \text{ matches } x\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">regex</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">where </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mopen">{</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">regex</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord"> matches </span></span><span class="mord mathnormal">x</span><span class="mclose">}</span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> re

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RegexRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Route based on regular expression pattern matching.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.patterns: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, re.Pattern, <span class="hljs-type">Callable</span>]] = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_route</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, pattern: <span class="hljs-built_in">str</span>, handler: <span class="hljs-type">Callable</span>, 
                  flags: <span class="hljs-built_in">int</span> = re.IGNORECASE</span>):
        <span class="hljs-variable language_">self</span>.patterns.append((name, re.<span class="hljs-built_in">compile</span>(pattern, flags), handler))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>]:
        <span class="hljs-keyword">for</span> name, pattern, handler <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.patterns:
            <span class="hljs-keyword">match</span> = pattern.search(text)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                <span class="hljs-keyword">return</span> name, {
                    <span class="hljs-string">&quot;handler&quot;</span>: handler,
                    <span class="hljs-string">&quot;matched_text&quot;</span>: <span class="hljs-keyword">match</span>.group(),
                    <span class="hljs-string">&quot;groups&quot;</span>: <span class="hljs-keyword">match</span>.groups(),
                    <span class="hljs-string">&quot;named_groups&quot;</span>: <span class="hljs-keyword">match</span>.groupdict()
                }
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;default&quot;</span>, {<span class="hljs-string">&quot;handler&quot;</span>: <span class="hljs-literal">None</span>}


regex_router = RegexRouter()
regex_router.add_route(
    <span class="hljs-string">&quot;sql_query&quot;</span>, 
    <span class="hljs-string">r&quot;\b(SELECT|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER)\b&quot;</span>,
    sql_handler
)
regex_router.add_route(
    <span class="hljs-string">&quot;url_analysis&quot;</span>,
    <span class="hljs-string">r&quot;https?://[^\s]+&quot;</span>,
    url_analysis_handler
)
regex_router.add_route(
    <span class="hljs-string">&quot;email_task&quot;</span>,
    <span class="hljs-string">r&quot;\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b&quot;</span>,
    email_handler
)
</code></pre>
</div><h4 id="c-threshold-based-routing" tabindex="-1">C. Threshold-Based Routing</h4>
<p>When the state contains numeric signals (confidence scores, token counts, complexity estimates), routing decisions are based on threshold comparisons:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>threshold</mtext></msub><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>simple</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if score</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mn>1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>standard</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mi>τ</mi><mn>1</mn></msub><mo>≤</mo><mtext>score</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mn>2</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>complex</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if score</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>≥</mo><msub><mi>τ</mi><mn>2</mn></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
R_{\text{threshold}}(S_t) = \begin{cases}
b_{\text{simple}} &amp; \text{if } \text{score}(S_t) &lt; \tau_1 \\
b_{\text{standard}} &amp; \text{if } \tau_1 \leq \text{score}(S_t) &lt; \tau_2 \\
b_{\text{complex}} &amp; \text{if } \text{score}(S_t) \geq \tau_2
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">threshold</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">simple</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">standard</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">complex</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord text"><span class="mord">score</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">score</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord text"><span class="mord">score</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThresholdRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Multi-threshold routing based on numeric state features.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, feature_extractor: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">dict</span>], <span class="hljs-built_in">float</span>]</span>):
        <span class="hljs-variable language_">self</span>.feature_extractor = feature_extractor
        <span class="hljs-variable language_">self</span>.thresholds: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">float</span>, <span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>]] = []
        <span class="hljs-comment"># Stored as (upper_bound, name, handler), sorted ascending</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_band</span>(<span class="hljs-params">self, upper_bound: <span class="hljs-built_in">float</span>, name: <span class="hljs-built_in">str</span>, handler: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-variable language_">self</span>.thresholds.append((upper_bound, name, handler))
        <span class="hljs-variable language_">self</span>.thresholds.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, state: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]:
        score = <span class="hljs-variable language_">self</span>.feature_extractor(state)
        <span class="hljs-keyword">for</span> upper_bound, name, handler <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.thresholds:
            <span class="hljs-keyword">if</span> score &lt; upper_bound:
                <span class="hljs-keyword">return</span> name, score
        <span class="hljs-comment"># Above all thresholds: use the last band</span>
        _, name, handler = <span class="hljs-variable language_">self</span>.thresholds[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> name, score


<span class="hljs-comment"># Example: Route by estimated query complexity</span>
complexity_router = ThresholdRouter(
    feature_extractor=<span class="hljs-keyword">lambda</span> s: s.get(<span class="hljs-string">&quot;estimated_complexity&quot;</span>, <span class="hljs-number">0.5</span>)
)
complexity_router.add_band(<span class="hljs-number">0.3</span>, <span class="hljs-string">&quot;simple_path&quot;</span>, simple_handler)    <span class="hljs-comment"># &lt; 0.3</span>
complexity_router.add_band(<span class="hljs-number">0.7</span>, <span class="hljs-string">&quot;standard_path&quot;</span>, standard_handler) <span class="hljs-comment"># 0.3 - 0.7</span>
complexity_router.add_band(<span class="hljs-number">1.1</span>, <span class="hljs-string">&quot;complex_path&quot;</span>, complex_handler)   <span class="hljs-comment"># &gt;= 0.7</span>
</code></pre>
</div><h3 id="1614-deterministic-path-selection-formal-properties" tabindex="-1">1.6.1.4 Deterministic Path Selection — Formal Properties</h3>
<p>A static router <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mtext>static</mtext></msub></mrow><annotation encoding="application/x-tex">R_{\text{static}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> satisfies three formal guarantees that dynamic routers cannot:</p>
<p><strong>Property 1 — Idempotency:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>static</mtext></msub><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>R</mi><mtext>static</mtext></msub><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mspace width="1em"/><mi mathvariant="normal">∀</mi><msub><mi>S</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">
R_{\text{static}}(S_t) = R_{\text{static}}(S_t) \quad \forall S_t
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mord">∀</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>The same state always produces the same routing decision (no stochastic sampling, no model temperature effects).</p>
<p><strong>Property 2 — Composability:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>R</mi><mtext>static</mtext><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msubsup><mo>∘</mo><msubsup><mi>R</mi><mtext>static</mtext><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msubsup><mtext> is also a static router</mtext></mrow><annotation encoding="application/x-tex">
R_{\text{static}}^{(1)} \circ R_{\text{static}}^{(2)} \text{ is also a static router}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3275em;vertical-align:-0.2827em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4173em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2827em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.3275em;vertical-align:-0.2827em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4173em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2827em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord"> is also a static router</span></span></span></span></span></span></eqn></section><p>Chaining two static routers produces a static router — the combined behavior remains deterministic and inspectable.</p>
<p><strong>Property 3 — Decidability:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∀</mi><msub><mi>S</mi><mi>t</mi></msub><mo>:</mo><mtext>  </mtext><mi mathvariant="normal">∃</mi><mtext> </mtext><msub><mi>b</mi><mi>j</mi></msub><mo>∈</mo><mo stretchy="false">{</mo><msub><mi>b</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>b</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>b</mi><mtext>default</mtext></msub><mo stretchy="false">}</mo><mtext> s.t. </mtext><msub><mi>R</mi><mtext>static</mtext></msub><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>b</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">
\forall S_t:\; \exists\, b_j \in \{b_1, \dots, b_k, b_{\text{default}}\} \text{ s.t. } R_{\text{static}}(S_t) = b_j
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord">∀</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord">∃</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">default</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord text"><span class="mord"> s.t. </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>Every input is routed somewhere (given a default branch), with guaranteed <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></eq> time complexity.</p>
<p><strong>When static routing fails.</strong> Define the <strong>coverage</strong> of a static router:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Coverage</mtext><mo stretchy="false">(</mo><msub><mi>R</mi><mtext>static</mtext></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mrow><mi>Pr</mi><mo>⁡</mo></mrow><mrow><mi>x</mi><mo>∼</mo><msub><mi mathvariant="script">D</mi><mtext>input</mtext></msub></mrow></munder><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mtext> </mtext><msub><mi>R</mi><mtext>static</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo mathvariant="normal">≠</mo><msub><mi>b</mi><mtext>default</mtext></msub><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">
\text{Coverage}(R_{\text{static}}) = \Pr_{x \sim \mathcal{D}_{\text{input}}}\!\bigl[\, R_{\text{static}}(x) \neq b_{\text{default}} \,\bigr]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Coverage</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7917em;vertical-align:-0.9417em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6833em;"><span style="top:-2.3557em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.334em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">input</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">Pr</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9417em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">[</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">static</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">default</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">]</span></span></span></span></span></span></eqn></section><p>If coverage falls below an acceptable threshold (many inputs hitting the default branch), the router’s rule set is insufficient and should be augmented — or replaced with a dynamic router.</p>
<hr>
<h2 id="162-dynamic-semantic-routing" tabindex="-1">1.6.2 Dynamic / Semantic Routing</h2>
<h3 id="1621-foundational-motivation" tabindex="-1">1.6.2.1 Foundational Motivation</h3>
<p>Static routing fails when:</p>
<ol>
<li>The input space is too large or varied for enumerable rules.</li>
<li>The routing decision requires <strong>semantic understanding</strong> (meaning, intent, topic).</li>
<li>The classification boundary is <strong>non-linear</strong> in feature space.</li>
<li>New categories emerge over time without code changes.</li>
</ol>
<p>Dynamic routing uses <strong>learned representations</strong> — either from an LLM or from embedding models — to classify inputs and select branches.</p>
<p><strong>General formulation:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>dynamic</mtext></msub><mo>:</mo><mi>x</mi><mo>⟶</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><msub><mi>b</mi><mi>j</mi></msub><mo>∈</mo><mi mathvariant="script">B</mi></mrow></munder><mtext>  </mtext><mtext>score</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
R_{\text{dynamic}}: x \longrightarrow \arg\max_{b_j \in \mathcal{B}} \; \text{score}(x, b_j)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">dynamic</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.522em;vertical-align:-0.011em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟶</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.6994em;vertical-align:-0.9494em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathcal mtight" style="margin-right:0.03041em;">B</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9494em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">score</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>score</mtext></mrow><annotation encoding="application/x-tex">\text{score}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord text"><span class="mord">score</span></span></span></span></span></eq> is computed by a model (LLM, embedding similarity, classifier).</p>
<h3 id="1622-llm-as-a-router-classification-prompt" tabindex="-1">1.6.2.2 LLM-as-a-Router: Classification Prompt</h3>
<p>The most flexible dynamic routing approach: ask the LLM to classify the input into one of <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq> predefined categories.</p>
<p><strong>Formal model.</strong> The LLM acts as a <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq>-class classifier:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>LLM</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><msub><mi>b</mi><mi>j</mi></msub><mo>∈</mo><mi mathvariant="script">B</mi></mrow></munder><mtext>  </mtext><msub><mi>p</mi><mi>θ</mi></msub><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><msub><mi>b</mi><mi>j</mi></msub><mo>∣</mo><mi>x</mi><mo separator="true">,</mo><mtext>  </mtext><msub><mtext>prompt</mtext><mtext>routing</mtext></msub><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
R_{\text{LLM}}(x) = \arg\max_{b_j \in \mathcal{B}} \; p_\theta\!\bigl(\, b_j \mid x,\; \text{prompt}_{\text{routing}} \,\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">LLM</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7994em;vertical-align:-0.9494em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathcal mtight" style="margin-right:0.03041em;">B</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9494em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2302em;vertical-align:-0.3802em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">prompt</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2234em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">routing</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><p><strong>Implementation — Structured Output Router:</strong></p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Literal</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteDecision</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">&quot;&quot;&quot;Structured output from the LLM router.&quot;&quot;&quot;</span>
    reasoning: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">&quot;Brief explanation of classification logic&quot;</span>)
    selected_route: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">&quot;The chosen route name&quot;</span>)
    confidence: <span class="hljs-built_in">float</span> = Field(ge=<span class="hljs-number">0.0</span>, le=<span class="hljs-number">1.0</span>, description=<span class="hljs-string">&quot;Confidence in this classification&quot;</span>)
    alternative_route: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(
        default=<span class="hljs-literal">None</span>, 
        description=<span class="hljs-string">&quot;Second-best route if confidence is low&quot;</span>
    )


<span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Use an LLM to semantically classify inputs and select chain branches.&quot;&quot;&quot;</span>
    
    ROUTING_PROMPT_TEMPLATE = <span class="hljs-string">&quot;&quot;&quot;You are a precise query classifier. Given the user&#x27;s 
input, classify it into exactly ONE of the following categories:

{route_descriptions}

Rules:
1. Choose the MOST specific matching category
2. If uncertain between two categories, choose the one that better serves the user
3. Provide your confidence (0.0 to 1.0) — be calibrated, not overconfident
4. If confidence &lt; 0.6, also specify an alternative route

User input: {input}

Respond as JSON matching this schema:
{{&quot;reasoning&quot;: &quot;...&quot;, &quot;selected_route&quot;: &quot;...&quot;, &quot;confidence&quot;: 0.X, &quot;alternative_route&quot;: &quot;...&quot; or null}}&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, routes: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>]</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        Args:
            llm: LLM client for classification
            routes: dict mapping route_name -&gt; {
                &quot;description&quot;: str,   # what this route handles
                &quot;examples&quot;: list[str], # few-shot examples
                &quot;handler&quot;: callable
            }
        &quot;&quot;&quot;</span>
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.routes = routes
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_build_route_descriptions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        lines = []
        <span class="hljs-keyword">for</span> name, config <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.routes.items():
            desc = <span class="hljs-string">f&quot;- **<span class="hljs-subst">{name}</span>**: <span class="hljs-subst">{config[<span class="hljs-string">&#x27;description&#x27;</span>]}</span>&quot;</span>
            <span class="hljs-keyword">if</span> config.get(<span class="hljs-string">&quot;examples&quot;</span>):
                examples = <span class="hljs-string">&quot;; &quot;</span>.join(<span class="hljs-string">f&#x27;&quot;<span class="hljs-subst">{ex}</span>&quot;&#x27;</span> <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> config[<span class="hljs-string">&quot;examples&quot;</span>][:<span class="hljs-number">3</span>])
                desc += <span class="hljs-string">f&quot;\n  Examples: <span class="hljs-subst">{examples}</span>&quot;</span>
            lines.append(desc)
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\n&quot;</span>.join(lines)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, user_input: <span class="hljs-built_in">str</span></span>) -&gt; RouteDecision:
        prompt = <span class="hljs-variable language_">self</span>.ROUTING_PROMPT_TEMPLATE.<span class="hljs-built_in">format</span>(
            route_descriptions=<span class="hljs-variable language_">self</span>._build_route_descriptions(),
            <span class="hljs-built_in">input</span>=user_input
        )
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=prompt,
            temperature=<span class="hljs-number">0.0</span>,       <span class="hljs-comment"># deterministic classification</span>
            max_tokens=<span class="hljs-number">200</span>
        )
        decision = RouteDecision.model_validate_json(response)
        
        <span class="hljs-comment"># Validate that selected_route exists</span>
        <span class="hljs-keyword">if</span> decision.selected_route <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.routes:
            <span class="hljs-comment"># Fallback: find closest route name (fuzzy matching)</span>
            decision.selected_route = <span class="hljs-variable language_">self</span>._fuzzy_match(decision.selected_route)
        
        <span class="hljs-keyword">return</span> decision
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_fuzzy_match</span>(<span class="hljs-params">self, candidate: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">&quot;&quot;&quot;Find the closest valid route name.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">from</span> difflib <span class="hljs-keyword">import</span> get_close_matches
        matches = get_close_matches(candidate, <span class="hljs-variable language_">self</span>.routes.keys(), n=<span class="hljs-number">1</span>, cutoff=<span class="hljs-number">0.4</span>)
        <span class="hljs-keyword">return</span> matches[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> matches <span class="hljs-keyword">else</span> <span class="hljs-built_in">list</span>(<span class="hljs-variable language_">self</span>.routes.keys())[<span class="hljs-number">0</span>]


<span class="hljs-comment"># --- Instantiation ---</span>

llm_router = LLMRouter(
    llm=llm_client,
    routes={
        <span class="hljs-string">&quot;code_assistance&quot;</span>: {
            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Writing, debugging, explaining, or reviewing code in any programming language&quot;</span>,
            <span class="hljs-string">&quot;examples&quot;</span>: [<span class="hljs-string">&quot;Write a Python function to sort a list&quot;</span>, <span class="hljs-string">&quot;Why does this SQL query fail?&quot;</span>],
            <span class="hljs-string">&quot;handler&quot;</span>: code_chain
        },
        <span class="hljs-string">&quot;research_analysis&quot;</span>: {
            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;In-depth research requiring multiple sources, data analysis, or literature review&quot;</span>,
            <span class="hljs-string">&quot;examples&quot;</span>: [<span class="hljs-string">&quot;Compare transformer architectures published in 2024&quot;</span>, <span class="hljs-string">&quot;Analyze market trends in EV sector&quot;</span>],
            <span class="hljs-string">&quot;handler&quot;</span>: research_chain
        },
        <span class="hljs-string">&quot;creative_writing&quot;</span>: {
            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Generating creative content: stories, poems, marketing copy, brainstorming&quot;</span>,
            <span class="hljs-string">&quot;examples&quot;</span>: [<span class="hljs-string">&quot;Write a haiku about machine learning&quot;</span>, <span class="hljs-string">&quot;Generate taglines for a coffee brand&quot;</span>],
            <span class="hljs-string">&quot;handler&quot;</span>: creative_chain
        },
        <span class="hljs-string">&quot;simple_qa&quot;</span>: {
            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Direct factual questions answerable in a few sentences without research&quot;</span>,
            <span class="hljs-string">&quot;examples&quot;</span>: [<span class="hljs-string">&quot;What is the capital of France?&quot;</span>, <span class="hljs-string">&quot;When was Python first released?&quot;</span>],
            <span class="hljs-string">&quot;handler&quot;</span>: simple_qa_handler
        }
    }
)
</code></pre>
</div><p><strong>Latency-accuracy trade-off:</strong> LLM routing adds a full LLM call (~200–1000ms) before the actual chain begins. This is acceptable only when routing savings (avoiding expensive wrong-path execution) exceed the routing cost:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Net benefit</mtext><mo>=</mo><munder><munder><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mtext>cost</mtext><mo stretchy="false">(</mo><mtext>wrong path</mtext><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>⋅</mo><mi>Pr</mi><mo>⁡</mo><mo stretchy="false">[</mo><mtext>misroute without LLM</mtext><mo stretchy="false">]</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>avoided cost</mtext></munder><mo>−</mo><munder><munder><mrow><mtext>cost</mtext><mo stretchy="false">(</mo><mtext>LLM routing call</mtext><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>routing overhead</mtext></munder></mrow><annotation encoding="application/x-tex">
\text{Net benefit} = \underbrace{\mathbb{E}[\text{cost}(\text{wrong path})] \cdot \Pr[\text{misroute without LLM}]}_{\text{avoided cost}} - \underbrace{\text{cost}(\text{LLM routing call})}_{\text{routing overhead}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Net benefit</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3341em;vertical-align:-1.5841em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.75em;"><span style="top:-1.4159em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">avoided cost</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.75em;"><span class="svg-align" style="top:-2.102em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="mopen">[</span><span class="mord text"><span class="mord">cost</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">wrong path</span></span><span class="mclose">)]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">Pr</span><span class="mopen">[</span><span class="mord text"><span class="mord">misroute without LLM</span></span><span class="mclose">]</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.898em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5841em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4702em;vertical-align:-1.7202em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.75em;"><span style="top:-1.4159em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">routing overhead</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.75em;"><span class="svg-align" style="top:-2.102em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">cost</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">LLM routing call</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.898em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.7202em;"><span></span></span></span></span></span></span></span></span></span></eqn></section><h3 id="1623-embedding-based-routing" tabindex="-1">1.6.2.3 Embedding-Based Routing</h3>
<p>Instead of a full LLM call, compute dense embeddings of the input and compare against pre-computed <strong>route prototype embeddings</strong> using cosine similarity. This reduces routing latency from ~500ms (LLM call) to ~5ms (embedding lookup + similarity computation).</p>
<p><strong>Formal model.</strong> Let <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">e</mi><mo>:</mo><msup><mi mathvariant="script">V</mi><mo>∗</mo></msup><mo>→</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{e}: \mathcal{V}^* \rightarrow \mathbb{R}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6887em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></eq>be a sentence embedding function. For each route<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">b_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq>, precompute a prototype embedding <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">p</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{p}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7305em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq> from its description and examples:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">p</mi><mi>j</mi></msub><mo>=</mo><mfrac><mn>1</mn><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">E</mi><mi>j</mi></msub><mi mathvariant="normal">∣</mi></mrow></mfrac><munder><mo>∑</mo><mrow><mi>e</mi><mo>∈</mo><msub><mi mathvariant="script">E</mi><mi>j</mi></msub></mrow></munder><mi mathvariant="bold">e</mi><mo stretchy="false">(</mo><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\mathbf{p}_j = \frac{1}{|\mathcal{E}_j|} \sum_{e \in \mathcal{E}_j} \mathbf{e}(e)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7305em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.8131em;vertical-align:-1.4917em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.08944em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0894em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.08944em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0894em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4917em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf">e</span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">E</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{E}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08944em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0894em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq>is the set of example texts for route<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">b_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq>. At inference time:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>embed</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><msub><mi>b</mi><mi>j</mi></msub></munder><mtext>  </mtext><mtext>sim</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><mi mathvariant="bold">e</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext>  </mtext><msub><mi mathvariant="bold">p</mi><mi>j</mi></msub><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><msub><mi>b</mi><mi>j</mi></msub></munder><mtext>  </mtext><mfrac><mrow><mi mathvariant="bold">e</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi mathvariant="bold">p</mi><mi>j</mi></msub></mrow><mrow><mi mathvariant="normal">∥</mi><mi mathvariant="bold">e</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∥</mi><mo>⋅</mo><mi mathvariant="normal">∥</mi><msub><mi mathvariant="bold">p</mi><mi>j</mi></msub><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
R_{\text{embed}}(x) = \arg\max_{b_j} \; \text{sim}\!\bigl(\, \mathbf{e}(x),\; \mathbf{p}_j \,\bigr) = \arg\max_{b_j} \; \frac{\mathbf{e}(x) \cdot \mathbf{p}_j}{\|\mathbf{e}(x)\| \cdot \|\mathbf{p}_j\|}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">embed</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7994em;vertical-align:-0.9494em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9494em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">sim</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf">e</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3991em;vertical-align:-0.9721em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9494em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∥</span><span class="mord mathbf">e</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord">∥</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">∥</span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">∥</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathbf">e</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddingRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Fast semantic routing via embedding cosine similarity.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_fn: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>], np.ndarray]</span>):
        <span class="hljs-variable language_">self</span>.embed_fn = embed_fn
        <span class="hljs-variable language_">self</span>.routes: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>] = {}
        <span class="hljs-variable language_">self</span>.prototypes: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, np.ndarray] = {}
        <span class="hljs-variable language_">self</span>._all_example_embeddings: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">list</span>[np.ndarray]] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_route</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, description: <span class="hljs-built_in">str</span>, 
                  examples: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], handler: <span class="hljs-type">Callable</span>,
                  prototype_method: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;centroid&quot;</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;Register a route with examples; compute prototype embedding.&quot;&quot;&quot;</span>
        example_embeds = [<span class="hljs-variable language_">self</span>.embed_fn(ex) <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> examples]
        desc_embed = <span class="hljs-variable language_">self</span>.embed_fn(description)
        
        <span class="hljs-keyword">if</span> prototype_method == <span class="hljs-string">&quot;centroid&quot;</span>:
            <span class="hljs-comment"># Average of description + all examples</span>
            all_embeds = [desc_embed] + example_embeds
            prototype = np.mean(all_embeds, axis=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">elif</span> prototype_method == <span class="hljs-string">&quot;description_only&quot;</span>:
            prototype = desc_embed
        <span class="hljs-keyword">elif</span> prototype_method == <span class="hljs-string">&quot;medoid&quot;</span>:
            <span class="hljs-comment"># The example closest to the centroid (more robust to outliers)</span>
            centroid = np.mean(example_embeds, axis=<span class="hljs-number">0</span>)
            idx = np.argmax([
                np.dot(e, centroid) / (np.linalg.norm(e) * np.linalg.norm(centroid))
                <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> example_embeds
            ])
            prototype = example_embeds[idx]
        
        <span class="hljs-comment"># L2-normalize for efficient cosine similarity via dot product</span>
        prototype = prototype / (np.linalg.norm(prototype) + <span class="hljs-number">1e-8</span>)
        
        <span class="hljs-variable language_">self</span>.routes[name] = {<span class="hljs-string">&quot;description&quot;</span>: description, <span class="hljs-string">&quot;handler&quot;</span>: handler}
        <span class="hljs-variable language_">self</span>.prototypes[name] = prototype
        <span class="hljs-variable language_">self</span>._all_example_embeddings[name] = example_embeds
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>, <span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Route input to the most similar route prototype.
        
        Returns:
            (route_name, similarity_score, full_scores_dict)
        &quot;&quot;&quot;</span>
        query_embed = <span class="hljs-variable language_">self</span>.embed_fn(text)
        query_embed = query_embed / (np.linalg.norm(query_embed) + <span class="hljs-number">1e-8</span>)
        
        scores = {}
        <span class="hljs-keyword">for</span> name, prototype <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.prototypes.items():
            scores[name] = <span class="hljs-built_in">float</span>(np.dot(query_embed, prototype))
        
        best_route = <span class="hljs-built_in">max</span>(scores, key=scores.get)
        best_score = scores[best_route]
        
        <span class="hljs-keyword">if</span> best_score &lt; threshold:
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;default&quot;</span>, best_score, scores
        
        <span class="hljs-keyword">return</span> best_route, best_score, scores
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route_knn</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">&quot;&quot;&quot;K-nearest-neighbor routing: vote among k closest examples.&quot;&quot;&quot;</span>
        query_embed = <span class="hljs-variable language_">self</span>.embed_fn(text)
        query_norm = query_embed / (np.linalg.norm(query_embed) + <span class="hljs-number">1e-8</span>)
        
        all_similarities = []
        <span class="hljs-keyword">for</span> name, examples <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._all_example_embeddings.items():
            <span class="hljs-keyword">for</span> ex_embed <span class="hljs-keyword">in</span> examples:
                ex_norm = ex_embed / (np.linalg.norm(ex_embed) + <span class="hljs-number">1e-8</span>)
                sim = <span class="hljs-built_in">float</span>(np.dot(query_norm, ex_norm))
                all_similarities.append((sim, name))
        
        <span class="hljs-comment"># Sort by similarity, take top-k</span>
        all_similarities.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>], reverse=<span class="hljs-literal">True</span>)
        top_k = all_similarities[:k]
        
        <span class="hljs-comment"># Majority vote (weighted by similarity)</span>
        votes: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>] = {}
        <span class="hljs-keyword">for</span> sim, name <span class="hljs-keyword">in</span> top_k:
            votes[name] = votes.get(name, <span class="hljs-number">0.0</span>) + sim
        
        best_route = <span class="hljs-built_in">max</span>(votes, key=votes.get)
        confidence = votes[best_route] / <span class="hljs-built_in">sum</span>(votes.values())
        <span class="hljs-keyword">return</span> best_route, confidence
</code></pre>
</div><p><strong>Prototype refinement.</strong> The initial prototype computed from a handful of examples may be suboptimal. Improve it by:</p>
<ol>
<li><strong>Online update:</strong> As inputs are routed and confirmed correct, update the prototype with exponential moving average:</li>
</ol>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="bold">p</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mi>α</mi><mo>⋅</mo><mi mathvariant="bold">e</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><mo>⋅</mo><msubsup><mi mathvariant="bold">p</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">
\mathbf{p}_j^{(t+1)} = \alpha \cdot \mathbf{e}(x_t) + (1 - \alpha) \cdot \mathbf{p}_j^{(t)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbf">e</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><ol start="2">
<li><strong>Contrastive learning:</strong> Fine-tune the embedding model so that inputs belonging to route <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></eq>are closer to<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">p</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{p}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7305em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq> and farther from other prototypes:</li>
</ol>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>contrastive</mtext></msub><mo>=</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext>sim</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">e</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi mathvariant="bold">p</mi><mo>+</mo></msub><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>τ</mi><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mi>exp</mi><mo>⁡</mo><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext>sim</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">e</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi mathvariant="bold">p</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>τ</mi><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\mathcal{L}_{\text{contrastive}} = -\log \frac{\exp\!\bigl(\text{sim}(\mathbf{e}(x), \mathbf{p}_+) / \tau\bigr)}{\sum_{j=1}^{k} \exp\!\bigl(\text{sim}(\mathbf{e}(x), \mathbf{p}_j) / \tau\bigr)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">contrastive</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9048em;vertical-align:-1.3148em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.121em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord mathbf">e</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord mathbf">e</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2583em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3148em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">p</mi><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">\mathbf{p}_+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6528em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathbf">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2583em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></eq>is the correct route prototype and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></eq> is a temperature parameter.</p>
<h3 id="1624-confidence-based-routing" tabindex="-1">1.6.2.4 Confidence-Based Routing</h3>
<p>Confidence-based routing uses the <strong>model’s own uncertainty</strong> about its output to decide the execution path. If the model is confident, take the fast path; if uncertain, escalate to a more capable (or more cautious) path.</p>
<p><strong>Formal model:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>confidence</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>fast</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>y</mi></msub><mtext>  </mtext><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>&gt;</mo><msub><mi>τ</mi><mtext>high</mtext></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>standard</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mi>τ</mi><mtext>low</mtext></msub><mo>≤</mo><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>y</mi></msub><mtext>  </mtext><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>≤</mo><msub><mi>τ</mi><mtext>high</mtext></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>escalate</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>y</mi></msub><mtext>  </mtext><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mtext>low</mtext></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
R_{\text{confidence}}(x) = \begin{cases}
b_{\text{fast}} &amp; \text{if } \max_y \; p_\theta(y \mid x) &gt; \tau_{\text{high}} \\
b_{\text{standard}} &amp; \text{if } \tau_{\text{low}} \leq \max_y \; p_\theta(y \mid x) \leq \tau_{\text{high}} \\
b_{\text{escalate}} &amp; \text{if } \max_y \; p_\theta(y \mid x) &lt; \tau_{\text{low}}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">confidence</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fast</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">standard</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">escalate</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">high</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">low</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">high</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">low</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p><strong>Confidence estimation methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Mechanism</th>
<th>Reliability</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Token log-probabilities</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>conf</mtext><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mi>exp</mi><mo>⁡</mo><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></msubsup><mi>log</mi><mo>⁡</mo><mi>p</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo>∣</mo><msub><mi>y</mi><mrow><mo>&lt;</mo><mi>t</mi></mrow></msub><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">\text{conf}(y) = \exp\!\bigl(\frac{1}{T}\sum_{t=1}^{T} \log p(y_t \mid y_{&lt;t}, x)\bigr)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">conf</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.3312em;vertical-align:-0.35em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></eq></td>
<td>Moderate — well-calibrated in some models</td>
</tr>
<tr>
<td><strong>Self-verbalized confidence</strong></td>
<td>Ask the LLM: “Rate your confidence 0–1”</td>
<td>Low — models tend toward overconfidence</td>
</tr>
<tr>
<td><strong>Consistency sampling</strong></td>
<td>Generate <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq> responses; measure agreement</td>
<td>High — directly estimates epistemic uncertainty</td>
</tr>
<tr>
<td><strong>Entropy of output distribution</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><msub><mo>∑</mo><mi>y</mi></msub><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mi>log</mi><mo>⁡</mo><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(Y \mid x) = -\sum_y p(y \mid x) \log p(y \mid x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1858em;vertical-align:-0.4358em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0017em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq></td>
<td>Theoretically sound; hard to compute over full sequence space</td>
</tr>
</tbody>
</table>
<p><strong>Consistency-based confidence (most robust):</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Confidence</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mi>N</mi><mn>2</mn></mfrac><mo fence="true">)</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow></munder><mtext>sim</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\text{Confidence}(x) = \frac{1}{\binom{N}{2}} \sum_{i &lt; j} \text{sim}(y_i, y_j)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Confidence</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7352em;vertical-align:-1.4138em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.1877em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9223em;"><span style="top:-2.355em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.144em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1623em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>N</mi></msub><mo>∼</mo><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mo>⋅</mo><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">y_1, \dots, y_N \sim p_\theta(\cdot \mid x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">⋅</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq>are<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq>independent samples and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>sim</mtext></mrow><annotation encoding="application/x-tex">\text{sim}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em;"></span><span class="mord text"><span class="mord">sim</span></span></span></span></span></eq> is semantic similarity (e.g., ROUGE-L or embedding cosine).</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfidenceRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Route based on model&#x27;s confidence in its own output.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, 
                 high_threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.85</span>,
                 low_threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.5</span>,
                 n_samples: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.tau_high = high_threshold
        <span class="hljs-variable language_">self</span>.tau_low = low_threshold
        <span class="hljs-variable language_">self</span>.n_samples = n_samples
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">estimate_confidence_logprob</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">&quot;&quot;&quot;Confidence via mean token log-probability.&quot;&quot;&quot;</span>
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=prompt,
            temperature=<span class="hljs-number">0.0</span>,
            logprobs=<span class="hljs-literal">True</span>,
            max_tokens=<span class="hljs-number">500</span>
        )
        token_logprobs = response.logprobs  <span class="hljs-comment"># list of log-probabilities</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> token_logprobs:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span>  <span class="hljs-comment"># no logprobs available</span>
        
        <span class="hljs-comment"># Geometric mean of token probabilities</span>
        mean_logprob = <span class="hljs-built_in">sum</span>(token_logprobs) / <span class="hljs-built_in">len</span>(token_logprobs)
        confidence = <span class="hljs-built_in">float</span>(np.exp(mean_logprob))
        <span class="hljs-keyword">return</span> confidence
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">estimate_confidence_consistency</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">&quot;&quot;&quot;Confidence via consistency across multiple samples.&quot;&quot;&quot;</span>
        responses = <span class="hljs-keyword">await</span> asyncio.gather(*[
            <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.7</span>, max_tokens=<span class="hljs-number">500</span>)
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.n_samples)
        ])
        
        texts = [r.text <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(r, <span class="hljs-string">&#x27;text&#x27;</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">str</span>(r) <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> responses]
        
        <span class="hljs-comment"># Pairwise similarity (using simple token overlap as proxy)</span>
        <span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> combinations
        similarities = []
        <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> combinations(texts, <span class="hljs-number">2</span>):
            tokens_a = <span class="hljs-built_in">set</span>(a.lower().split())
            tokens_b = <span class="hljs-built_in">set</span>(b.lower().split())
            <span class="hljs-keyword">if</span> tokens_a | tokens_b:
                jaccard = <span class="hljs-built_in">len</span>(tokens_a &amp; tokens_b) / <span class="hljs-built_in">len</span>(tokens_a | tokens_b)
                similarities.append(jaccard)
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(np.mean(similarities)) <span class="hljs-keyword">if</span> similarities <span class="hljs-keyword">else</span> <span class="hljs-number">0.5</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span>, 
                    method: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;logprob&quot;</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-keyword">if</span> method == <span class="hljs-string">&quot;logprob&quot;</span>:
            confidence = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.estimate_confidence_logprob(prompt)
        <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&quot;consistency&quot;</span>:
            confidence = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.estimate_confidence_consistency(prompt)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Unknown method: <span class="hljs-subst">{method}</span>&quot;</span>)
        
        <span class="hljs-keyword">if</span> confidence &gt; <span class="hljs-variable language_">self</span>.tau_high:
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fast_path&quot;</span>, confidence
        <span class="hljs-keyword">elif</span> confidence &gt;= <span class="hljs-variable language_">self</span>.tau_low:
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;standard_path&quot;</span>, confidence
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;escalation_path&quot;</span>, confidence
</code></pre>
</div><h3 id="1625-multi-class-routing-with-softmax-over-chain-paths" tabindex="-1">1.6.2.5 Multi-Class Routing with Softmax over Chain Paths</h3>
<p>When routing among <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq> paths, the most principled approach is to model the routing decision as a categorical distribution over paths, computed via <strong>softmax over route scores</strong>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>b</mi><mi>j</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext>score</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>τ</mi><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mi>exp</mi><mo>⁡</mo><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext>score</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>τ</mi><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
P(b_j \mid x) = \frac{\exp\!\bigl(\text{score}(x, b_j) / \tau\bigr)}{\sum_{i=1}^{k} \exp\!\bigl(\text{score}(x, b_i) / \tau\bigr)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.819em;vertical-align:-1.229em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.121em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord text"><span class="mord">score</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord text"><span class="mord">score</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.229em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></eq> is a temperature parameter controlling the sharpness of the distribution:</p>
<ul>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi><mo>→</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\tau \to 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></eq>: deterministic (argmax) selection</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\tau = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></eq>: standard softmax</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\tau \to \infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">∞</span></span></span></span></eq>: uniform random selection</li>
</ul>
<p><strong>Advantages of probabilistic routing:</strong></p>
<ol>
<li><strong>Calibrated uncertainty:</strong> <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>b</mi><mi>j</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(b_j \mid x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq> directly measures how well the input fits each route.</li>
<li><strong>Rejection detection:</strong> If <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>j</mi></msub><mi>P</mi><mo stretchy="false">(</mo><msub><mi>b</mi><mi>j</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mtext>reject</mtext></msub></mrow><annotation encoding="application/x-tex">\max_j P(b_j \mid x) &lt; \tau_{\text{reject}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">reject</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq>, the input doesn’t fit any route well.</li>
<li><strong>Multi-path execution:</strong> When <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>b</mi><mn>1</mn></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>≈</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>b</mi><mn>2</mn></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(b_1 \mid x) \approx P(b_2 \mid x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq>, both paths can be executed and results merged.</li>
</ol>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SoftmaxRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Probabilistic multi-class router with softmax scoring.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_fn: <span class="hljs-type">Callable</span>, temperature: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.1</span></span>):
        <span class="hljs-variable language_">self</span>.embed_fn = embed_fn
        <span class="hljs-variable language_">self</span>.temperature = temperature
        <span class="hljs-variable language_">self</span>.routes: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>] = {}
        <span class="hljs-variable language_">self</span>.prototypes: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, np.ndarray] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_route</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, prototype_texts: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], handler: <span class="hljs-type">Callable</span></span>):
        embeds = [<span class="hljs-variable language_">self</span>.embed_fn(t) <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> prototype_texts]
        prototype = np.mean(embeds, axis=<span class="hljs-number">0</span>)
        prototype /= (np.linalg.norm(prototype) + <span class="hljs-number">1e-8</span>)
        <span class="hljs-variable language_">self</span>.routes[name] = {<span class="hljs-string">&quot;handler&quot;</span>: handler}
        <span class="hljs-variable language_">self</span>.prototypes[name] = prototype
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_distribution</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Compute softmax probability distribution over routes.&quot;&quot;&quot;</span>
        query = <span class="hljs-variable language_">self</span>.embed_fn(text)
        query /= (np.linalg.norm(query) + <span class="hljs-number">1e-8</span>)
        
        scores = {name: <span class="hljs-built_in">float</span>(np.dot(query, proto)) 
                  <span class="hljs-keyword">for</span> name, proto <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.prototypes.items()}
        
        <span class="hljs-comment"># Softmax</span>
        names = <span class="hljs-built_in">list</span>(scores.keys())
        raw_scores = np.array([scores[n] <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> names])
        exp_scores = np.exp((raw_scores - raw_scores.<span class="hljs-built_in">max</span>()) / <span class="hljs-variable language_">self</span>.temperature)
        probs = exp_scores / exp_scores.<span class="hljs-built_in">sum</span>()
        
        <span class="hljs-keyword">return</span> {name: <span class="hljs-built_in">float</span>(prob) <span class="hljs-keyword">for</span> name, prob <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(names, probs)}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route_deterministic</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Select the highest-probability route.&quot;&quot;&quot;</span>
        dist = <span class="hljs-variable language_">self</span>.compute_distribution(text)
        best = <span class="hljs-built_in">max</span>(dist, key=dist.get)
        <span class="hljs-keyword">return</span> best, dist[best]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route_with_rejection</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, 
                              reject_threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.4</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>, <span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Route with rejection: return None if no route is confident enough.&quot;&quot;&quot;</span>
        dist = <span class="hljs-variable language_">self</span>.compute_distribution(text)
        best = <span class="hljs-built_in">max</span>(dist, key=dist.get)
        
        <span class="hljs-keyword">if</span> dist[best] &lt; reject_threshold:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, dist  <span class="hljs-comment"># no route matches well</span>
        <span class="hljs-keyword">return</span> best, dist
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route_multi_path</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, 
                          threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.2</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]]:
        <span class="hljs-string">&quot;&quot;&quot;Return all routes above threshold, for parallel execution.&quot;&quot;&quot;</span>
        dist = <span class="hljs-variable language_">self</span>.compute_distribution(text)
        <span class="hljs-keyword">return</span> [(name, prob) <span class="hljs-keyword">for</span> name, prob <span class="hljs-keyword">in</span> dist.items() <span class="hljs-keyword">if</span> prob &gt;= threshold]
</code></pre>
</div><h3 id="1626-ensemble-routing-multiple-classifiers-voting" tabindex="-1">1.6.2.6 Ensemble Routing (Multiple Classifiers Voting)</h3>
<p>When no single routing method is sufficiently reliable, <strong>ensemble routing</strong> combines multiple routing signals through a voting or aggregation mechanism.</p>
<p><strong>Formal model.</strong> Given <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></eq>routers<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>R</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>R</mi><mi>M</mi></msub></mrow><annotation encoding="application/x-tex">R_1, R_2, \dots, R_M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>, each producing a probability distribution over routes:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mtext>ensemble</mtext></msub><mo stretchy="false">(</mo><msub><mi>b</mi><mi>j</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>w</mi><mi>m</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>m</mi></msub><mo stretchy="false">(</mo><msub><mi>b</mi><mi>j</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
P_{\text{ensemble}}(b_j \mid x) = \sum_{m=1}^{M} w_m \cdot P_m(b_j \mid x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ensemble</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">w_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>are router weights satisfying<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>m</mi></msub><msub><mi>w</mi><mi>m</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_m w_m = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0017em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></eq>, calibrated based on each router’s historical accuracy.</p>
<p><strong>Voting strategies:</strong></p>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Formula</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Majority vote</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mtext>ens</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>mode</mtext><mo stretchy="false">{</mo><msub><mi>R</mi><mi>m</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><msubsup><mo stretchy="false">}</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></msubsup></mrow><annotation encoding="application/x-tex">R_{\text{ens}}(x) = \text{mode}\{R_m(x)\}_{m=1}^{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ens</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">mode</span></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span></span></span></span></eq></td>
<td>All routers are equally reliable</td>
</tr>
<tr>
<td><strong>Weighted vote</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mtext>ens</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>j</mi></msub><msub><mo>∑</mo><mi>m</mi></msub><msub><mi>w</mi><mi>m</mi></msub><mo>⋅</mo><mn mathvariant="double-struck">1</mn><mo stretchy="false">[</mo><msub><mi>R</mi><mi>m</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>b</mi><mi>j</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">R_{\text{ens}}(x) = \arg\max_j \sum_m w_m \cdot \mathbb{1}[R_m(x) = b_j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ens</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0017em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></eq></td>
<td>Routers have known accuracy differences</td>
</tr>
<tr>
<td><strong>Probability averaging</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mtext>ens</mtext></msub><mo stretchy="false">(</mo><msub><mi>b</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>M</mi></mfrac><msub><mo>∑</mo><mi>m</mi></msub><msub><mi>P</mi><mi>m</mi></msub><mo stretchy="false">(</mo><msub><mi>b</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_{\text{ens}}(b_j) = \frac{1}{M}\sum_m P_m(b_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ens</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0017em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></eq></td>
<td>Routers produce calibrated probabilities</td>
</tr>
<tr>
<td><strong>Cascading</strong></td>
<td>Use <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">R_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>; if confidence <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>τ</mi></mrow><annotation encoding="application/x-tex">&lt; \tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></eq>, try <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">R_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>; etc.</td>
<td>Routers have different cost/accuracy profiles</td>
</tr>
</tbody>
</table>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EnsembleRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Ensemble of multiple routing strategies with weighted voting.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.routers: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>, <span class="hljs-built_in">float</span>]] = []
        <span class="hljs-comment"># (name, route_fn, weight)</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_router</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, 
                   route_fn: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]], 
                   weight: <span class="hljs-built_in">float</span> = <span class="hljs-number">1.0</span></span>):
        <span class="hljs-variable language_">self</span>.routers.append((name, route_fn, weight))
        <span class="hljs-comment"># Renormalize weights</span>
        total = <span class="hljs-built_in">sum</span>(w <span class="hljs-keyword">for</span> _, _, w <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.routers)
        <span class="hljs-variable language_">self</span>.routers = [(n, fn, w/total) <span class="hljs-keyword">for</span> n, fn, w <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.routers]
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, 
                    strategy: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;weighted_vote&quot;</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>]:
        <span class="hljs-comment"># Collect all router decisions</span>
        decisions = {}
        <span class="hljs-keyword">for</span> name, route_fn, weight <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.routers:
            route_name, confidence = <span class="hljs-keyword">await</span> route_fn(text) <span class="hljs-keyword">if</span> asyncio.iscoroutinefunction(route_fn) \
                                     <span class="hljs-keyword">else</span> (route_fn(text))
            decisions[name] = {
                <span class="hljs-string">&quot;route&quot;</span>: route_name,
                <span class="hljs-string">&quot;confidence&quot;</span>: confidence,
                <span class="hljs-string">&quot;weight&quot;</span>: weight
            }
        
        <span class="hljs-keyword">if</span> strategy == <span class="hljs-string">&quot;weighted_vote&quot;</span>:
            <span class="hljs-comment"># Aggregate weighted votes</span>
            vote_scores: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>] = {}
            <span class="hljs-keyword">for</span> dec <span class="hljs-keyword">in</span> decisions.values():
                route = dec[<span class="hljs-string">&quot;route&quot;</span>]
                vote_scores[route] = vote_scores.get(route, <span class="hljs-number">0</span>) + dec[<span class="hljs-string">&quot;weight&quot;</span>]
            
            best_route = <span class="hljs-built_in">max</span>(vote_scores, key=vote_scores.get)
            <span class="hljs-keyword">return</span> best_route, {
                <span class="hljs-string">&quot;individual_decisions&quot;</span>: decisions,
                <span class="hljs-string">&quot;aggregated_scores&quot;</span>: vote_scores,
                <span class="hljs-string">&quot;strategy&quot;</span>: strategy
            }
        
        <span class="hljs-keyword">elif</span> strategy == <span class="hljs-string">&quot;cascade&quot;</span>:
            <span class="hljs-comment"># Use first router with confidence above threshold</span>
            <span class="hljs-keyword">for</span> name, route_fn, weight <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.routers:
                dec = decisions[name]
                <span class="hljs-keyword">if</span> dec[<span class="hljs-string">&quot;confidence&quot;</span>] &gt;= <span class="hljs-number">0.7</span>:
                    <span class="hljs-keyword">return</span> dec[<span class="hljs-string">&quot;route&quot;</span>], {
                        <span class="hljs-string">&quot;decided_by&quot;</span>: name,
                        <span class="hljs-string">&quot;confidence&quot;</span>: dec[<span class="hljs-string">&quot;confidence&quot;</span>],
                        <span class="hljs-string">&quot;all_decisions&quot;</span>: decisions
                    }
            <span class="hljs-comment"># Fallback: use highest-weight router</span>
            primary = <span class="hljs-built_in">max</span>(decisions.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>][<span class="hljs-string">&quot;weight&quot;</span>])
            <span class="hljs-keyword">return</span> primary[<span class="hljs-number">1</span>][<span class="hljs-string">&quot;route&quot;</span>], {<span class="hljs-string">&quot;decided_by&quot;</span>: <span class="hljs-string">&quot;fallback&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>: decisions}
</code></pre>
</div><hr>
<h2 id="163-routing-architectures" tabindex="-1">1.6.3 Routing Architectures</h2>
<h3 id="1631-architecture-taxonomy" tabindex="-1">1.6.3.1 Architecture Taxonomy</h3>
<p>Each routing architecture addresses a specific axis of variation in the input distribution:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">                    ┌──────────────────────────────┐
                    │     Input Classification      │
                    │         Dimensions             │
                    └──────────┬───────────────────┘
          ┌───────────┬───────┼────────┬────────────┐
          ▼           ▼       ▼        ▼            ▼
     ┌─────────┐ ┌────────┐ ┌──────┐ ┌──────────┐ ┌──────────┐
     │ Intent  │ │ Topic  │ │Compl.│ │  Model   │ │ Fallback │
     │ Router  │ │ Router │ │Router│ │ Selector │ │  Router  │
     └─────────┘ └────────┘ └──────┘ └──────────┘ └──────────┘
     &quot;What does  &quot;What is   &quot;How     &quot;Which      &quot;What if
      the user    it about?&quot; hard?&quot;   model?&quot;     nothing
      want to                                     works?&quot;
      achieve?&quot;
</code></pre>
</div><h3 id="1632-intent-classification-routers" tabindex="-1">1.6.3.2 Intent Classification Routers</h3>
<p>An intent router determines the user’s <strong>communicative goal</strong> — what action they want the system to perform.</p>
<p><strong>Formal model.</strong> The intent space <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">I</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>i</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>i</mi><mi>k</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{I} = \{i_1, \dots, i_k\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></eq> partitions all possible user inputs by desired action:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>intent</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi>i</mi><mo>∈</mo><mi mathvariant="script">I</mi></mrow></munder><mtext>  </mtext><mi>p</mi><mo stretchy="false">(</mo><mi>i</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
R_{\text{intent}}(x) = \arg\max_{i \in \mathcal{I}} \; p(i \mid x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">intent</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.5217em;vertical-align:-0.7717em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3557em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight" style="margin-right:0.07382em;">I</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7717em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></eqn></section><p><strong>Standard intent taxonomy for agentic systems:</strong></p>
<table>
<thead>
<tr>
<th>Intent Category</th>
<th>Sub-Intents</th>
<th>Chain Mapping</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Informational</strong></td>
<td>Factual Q&amp;A, explanation, comparison</td>
<td>RAG chain / direct answer</td>
</tr>
<tr>
<td><strong>Instructional</strong></td>
<td>Write code, generate text, create plan</td>
<td>Generation chain</td>
</tr>
<tr>
<td><strong>Analytical</strong></td>
<td>Analyze data, evaluate options, summarize</td>
<td>Analysis chain</td>
</tr>
<tr>
<td><strong>Transactional</strong></td>
<td>Book appointment, send email, execute trade</td>
<td>Tool-action chain</td>
</tr>
<tr>
<td><strong>Navigational</strong></td>
<td>Find a document, locate a setting</td>
<td>Search/retrieval chain</td>
</tr>
<tr>
<td><strong>Conversational</strong></td>
<td>Chitchat, clarification, follow-up</td>
<td>Simple response / clarification loop</td>
</tr>
</tbody>
</table>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IntentRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Hierarchical intent classification router.&quot;&quot;&quot;</span>
    
    INTENT_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Classify the user&#x27;s intent into one of these categories.
    
Primary intents:
- INFORMATIONAL: User wants to learn or understand something
- INSTRUCTIONAL: User wants something created or generated
- ANALYTICAL: User wants data analyzed or options evaluated
- TRANSACTIONAL: User wants an action performed (email, API call, etc.)
- NAVIGATIONAL: User wants to find a specific resource
- CONVERSATIONAL: User is engaging in dialogue, not requesting a task
- CLARIFICATION_NEEDED: User&#x27;s intent is ambiguous; need to ask follow-up

User input: {input}

Respond as JSON:
{{&quot;primary_intent&quot;: &quot;...&quot;, &quot;sub_intent&quot;: &quot;...&quot;, &quot;confidence&quot;: 0.X, 
  &quot;requires_tools&quot;: true/false, &quot;clarification_question&quot;: &quot;...&quot; or null}}&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, intent_to_chain: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>]</span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.intent_to_chain = intent_to_chain
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">classify_and_route</span>(<span class="hljs-params">self, user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=<span class="hljs-variable language_">self</span>.INTENT_PROMPT.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">input</span>=user_input),
            temperature=<span class="hljs-number">0.0</span>,
            max_tokens=<span class="hljs-number">150</span>
        )
        classification = json.loads(response)
        
        primary = classification[<span class="hljs-string">&quot;primary_intent&quot;</span>]
        
        <span class="hljs-keyword">if</span> primary == <span class="hljs-string">&quot;CLARIFICATION_NEEDED&quot;</span>:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;clarify&quot;</span>,
                <span class="hljs-string">&quot;question&quot;</span>: classification.get(<span class="hljs-string">&quot;clarification_question&quot;</span>,
                    <span class="hljs-string">&quot;Could you please provide more details about what you need?&quot;</span>)
            }
        
        handler = <span class="hljs-variable language_">self</span>.intent_to_chain.get(primary)
        <span class="hljs-keyword">if</span> handler <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            handler = <span class="hljs-variable language_">self</span>.intent_to_chain.get(<span class="hljs-string">&quot;DEFAULT&quot;</span>)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;execute&quot;</span>,
            <span class="hljs-string">&quot;intent&quot;</span>: classification,
            <span class="hljs-string">&quot;handler&quot;</span>: handler
        }
</code></pre>
</div><h3 id="1633-topic-based-routers" tabindex="-1">1.6.3.3 Topic-Based Routers</h3>
<p>Topic routers direct inputs to <strong>domain-specific chains</strong> optimized for particular subject areas. Unlike intent routers (which classify <em>what the user wants to do</em>), topic routers classify <em>what the input is about</em>.</p>
<p><strong>Formal model:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>topic</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi>t</mi><mo>∈</mo><msub><mi mathvariant="script">T</mi><mtext>topics</mtext></msub></mrow></munder><mtext>  </mtext><mi>p</mi><mo stretchy="false">(</mo><mi>t</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
R_{\text{topic}}(x) = \arg\max_{t \in \mathcal{T}_{\text{topics}}} \; p(t \mid x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">topic</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.6917em;vertical-align:-0.9417em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3557em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.25417em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.334em;"><span style="top:-2.357em;margin-left:-0.2542em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">topics</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9417em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></eqn></section><p><strong>Implementation via embedding clusters:</strong></p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Route to domain-specific chains based on topic classification.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_fn: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-variable language_">self</span>.embed_fn = embed_fn
        <span class="hljs-variable language_">self</span>.topic_centroids: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, np.ndarray] = {}
        <span class="hljs-variable language_">self</span>.topic_handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>] = {}
        <span class="hljs-variable language_">self</span>.topic_examples: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">list</span>[np.ndarray]] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_topic</span>(<span class="hljs-params">self, topic: <span class="hljs-built_in">str</span>, 
                       seed_documents: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], 
                       handler: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;Register a topic with seed documents to compute centroid.&quot;&quot;&quot;</span>
        embeddings = [<span class="hljs-variable language_">self</span>.embed_fn(doc) <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> seed_documents]
        centroid = np.mean(embeddings, axis=<span class="hljs-number">0</span>)
        centroid /= (np.linalg.norm(centroid) + <span class="hljs-number">1e-8</span>)
        
        <span class="hljs-variable language_">self</span>.topic_centroids[topic] = centroid
        <span class="hljs-variable language_">self</span>.topic_handlers[topic] = handler
        <span class="hljs-variable language_">self</span>.topic_examples[topic] = embeddings
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>, <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]]:
        query = <span class="hljs-variable language_">self</span>.embed_fn(text)
        query /= (np.linalg.norm(query) + <span class="hljs-number">1e-8</span>)
        
        similarities = {
            topic: <span class="hljs-built_in">float</span>(np.dot(query, centroid))
            <span class="hljs-keyword">for</span> topic, centroid <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.topic_centroids.items()
        }
        
        best_topic = <span class="hljs-built_in">max</span>(similarities, key=similarities.get)
        <span class="hljs-keyword">return</span> best_topic, similarities[best_topic], similarities


<span class="hljs-comment"># Example: Multi-domain support agent</span>
topic_router = TopicRouter(embed_fn=sentence_embed)
topic_router.register_topic(
    <span class="hljs-string">&quot;finance&quot;</span>,
    seed_documents=[
        <span class="hljs-string">&quot;quarterly earnings report analysis&quot;</span>,
        <span class="hljs-string">&quot;stock portfolio rebalancing strategy&quot;</span>,
        <span class="hljs-string">&quot;compound interest calculation&quot;</span>,
        <span class="hljs-string">&quot;credit score improvement&quot;</span>
    ],
    handler=finance_chain
)
topic_router.register_topic(
    <span class="hljs-string">&quot;healthcare&quot;</span>,
    seed_documents=[
        <span class="hljs-string">&quot;symptoms of seasonal allergies&quot;</span>,
        <span class="hljs-string">&quot;medication interaction checker&quot;</span>,
        <span class="hljs-string">&quot;blood test results interpretation&quot;</span>,
        <span class="hljs-string">&quot;vaccination schedule&quot;</span>
    ],
    handler=healthcare_chain
)
</code></pre>
</div><h3 id="1634-complexity-based-routers" tabindex="-1">1.6.3.4 Complexity-Based Routers</h3>
<p>Complexity routers estimate the <strong>difficulty</strong> of the input and select an execution path calibrated to that difficulty — simple inputs take a fast/cheap path; complex inputs take a thorough/expensive path.</p>
<p><strong>Formal model.</strong> Define a complexity function <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>κ</mi><mo>:</mo><mi mathvariant="script">X</mi><mo>→</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\kappa: \mathcal{X} \rightarrow [0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">κ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.14643em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></eq> and a set of paths ordered by capability:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>complexity</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>direct</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>κ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mn>1</mn></msub><mspace width="1em"/><mtext>(single LLM call)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>chain</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mi>τ</mi><mn>1</mn></msub><mo>≤</mo><mi>κ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mn>2</mn></msub><mspace width="1em"/><mtext>(multi-step chain)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mtext>agent</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>κ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>≥</mo><msub><mi>τ</mi><mn>2</mn></msub><mspace width="1em"/><mtext>(full agent loop with tools)</mtext></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
R_{\text{complexity}}(x) = \begin{cases}
b_{\text{direct}} &amp; \text{if } \kappa(x) &lt; \tau_1 \quad \text{(single LLM call)} \\
b_{\text{chain}} &amp; \text{if } \tau_1 \leq \kappa(x) &lt; \tau_2 \quad \text{(multi-step chain)} \\
b_{\text{agent}} &amp; \text{if } \kappa(x) \geq \tau_2 \quad \text{(full agent loop with tools)}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">complexity</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">direct</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chain</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">agent</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">κ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(single LLM call)</span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">κ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(multi-step chain)</span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">κ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(full agent loop with tools)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p><strong>Complexity estimation heuristics:</strong></p>
<table>
<thead>
<tr>
<th>Signal</th>
<th>Measurement</th>
<th>Complexity Contribution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Query length</strong></td>
<td>Token count</td>
<td>Longer queries correlate with complexity</td>
</tr>
<tr>
<td><strong>Entity count</strong></td>
<td>NER or keyword extraction</td>
<td>More entities → more relationships to reason about</td>
</tr>
<tr>
<td><strong>Constraint count</strong></td>
<td>Clause parsing</td>
<td>“but not…”, “only if…”, “unless…” add complexity</td>
</tr>
<tr>
<td><strong>Required tools</strong></td>
<td>Keyword/intent detection</td>
<td>Tool use implies non-trivial execution</td>
</tr>
<tr>
<td><strong>Temporal reasoning</strong></td>
<td>Tense/date detection</td>
<td>“Compare last year vs. this year” requires multi-step</td>
</tr>
<tr>
<td><strong>Compositional depth</strong></td>
<td>Parse tree depth</td>
<td>Nested questions (“What is the GDP of the country where…”)</td>
</tr>
</tbody>
</table>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexityRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Estimate input complexity and route to appropriate execution tier.&quot;&quot;&quot;</span>
    
    COMPLEXITY_TIERS = [
        {<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;direct&quot;</span>,   <span class="hljs-string">&quot;max_complexity&quot;</span>: <span class="hljs-number">0.3</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Single LLM call&quot;</span>},
        {<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;chain&quot;</span>,    <span class="hljs-string">&quot;max_complexity&quot;</span>: <span class="hljs-number">0.7</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Multi-step chain&quot;</span>},
        {<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;agent&quot;</span>,    <span class="hljs-string">&quot;max_complexity&quot;</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Full agent with tools&quot;</span>},
    ]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.tier_handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_tier</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, handler: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-variable language_">self</span>.tier_handlers[name] = handler
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">estimate_complexity_heuristic</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">&quot;&quot;&quot;Fast heuristic complexity estimation (no LLM call).&quot;&quot;&quot;</span>
        tokens = text.split()
        
        <span class="hljs-comment"># Feature extraction</span>
        length_score = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(tokens) / <span class="hljs-number">100</span>, <span class="hljs-number">1.0</span>)  <span class="hljs-comment"># normalize by 100 tokens</span>
        
        question_words = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tokens <span class="hljs-keyword">if</span> t.lower() <span class="hljs-keyword">in</span> 
            {<span class="hljs-string">&quot;what&quot;</span>, <span class="hljs-string">&quot;why&quot;</span>, <span class="hljs-string">&quot;how&quot;</span>, <span class="hljs-string">&quot;compare&quot;</span>, <span class="hljs-string">&quot;analyze&quot;</span>, <span class="hljs-string">&quot;evaluate&quot;</span>, <span class="hljs-string">&quot;explain&quot;</span>})
        question_score = <span class="hljs-built_in">min</span>(question_words / <span class="hljs-number">5</span>, <span class="hljs-number">1.0</span>)
        
        constraint_words = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tokens <span class="hljs-keyword">if</span> t.lower() <span class="hljs-keyword">in</span>
            {<span class="hljs-string">&quot;but&quot;</span>, <span class="hljs-string">&quot;unless&quot;</span>, <span class="hljs-string">&quot;except&quot;</span>, <span class="hljs-string">&quot;only&quot;</span>, <span class="hljs-string">&quot;must&quot;</span>, <span class="hljs-string">&quot;should&quot;</span>, <span class="hljs-string">&quot;between&quot;</span>,
             <span class="hljs-string">&quot;versus&quot;</span>, <span class="hljs-string">&quot;vs&quot;</span>, <span class="hljs-string">&quot;compared&quot;</span>})
        constraint_score = <span class="hljs-built_in">min</span>(constraint_words / <span class="hljs-number">3</span>, <span class="hljs-number">1.0</span>)
        
        tool_indicators = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tokens <span class="hljs-keyword">if</span> t.lower() <span class="hljs-keyword">in</span>
            {<span class="hljs-string">&quot;calculate&quot;</span>, <span class="hljs-string">&quot;search&quot;</span>, <span class="hljs-string">&quot;find&quot;</span>, <span class="hljs-string">&quot;look up&quot;</span>, <span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>,
             <span class="hljs-string">&quot;execute&quot;</span>, <span class="hljs-string">&quot;fetch&quot;</span>, <span class="hljs-string">&quot;download&quot;</span>, <span class="hljs-string">&quot;scrape&quot;</span>})
        tool_score = <span class="hljs-built_in">min</span>(tool_indicators / <span class="hljs-number">2</span>, <span class="hljs-number">1.0</span>)
        
        <span class="hljs-comment"># Weighted combination</span>
        complexity = (
            <span class="hljs-number">0.2</span> * length_score +
            <span class="hljs-number">0.25</span> * question_score +
            <span class="hljs-number">0.25</span> * constraint_score +
            <span class="hljs-number">0.3</span> * tool_score
        )
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(complexity, <span class="hljs-number">1.0</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">estimate_complexity_llm</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">&quot;&quot;&quot;LLM-based complexity estimation (more accurate, higher latency).&quot;&quot;&quot;</span>
        prompt = (
            <span class="hljs-string">&quot;Estimate the complexity of answering this query on a 0.0-1.0 scale.\n&quot;</span>
            <span class="hljs-string">&quot;0.0 = trivial factual question\n&quot;</span>
            <span class="hljs-string">&quot;0.5 = requires some reasoning or multiple pieces of info\n&quot;</span>
            <span class="hljs-string">&quot;1.0 = requires research, tools, multi-step analysis\n\n&quot;</span>
            <span class="hljs-string">f&quot;Query: <span class="hljs-subst">{text}</span>\n\n&quot;</span>
            <span class="hljs-string">&quot;Respond with ONLY a number between 0.0 and 1.0.&quot;</span>
        )
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, max_tokens=<span class="hljs-number">10</span>, temperature=<span class="hljs-number">0.0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(response.strip())
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, use_llm: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-keyword">if</span> use_llm <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.llm:
            complexity = asyncio.run(<span class="hljs-variable language_">self</span>.estimate_complexity_llm(text))
        <span class="hljs-keyword">else</span>:
            complexity = <span class="hljs-variable language_">self</span>.estimate_complexity_heuristic(text)
        
        <span class="hljs-keyword">for</span> tier <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.COMPLEXITY_TIERS:
            <span class="hljs-keyword">if</span> complexity &lt;= tier[<span class="hljs-string">&quot;max_complexity&quot;</span>]:
                <span class="hljs-keyword">return</span> tier[<span class="hljs-string">&quot;name&quot;</span>], complexity
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;agent&quot;</span>, complexity  <span class="hljs-comment"># fallback to most capable tier</span>
</code></pre>
</div><h3 id="1635-model-selection-routers" tabindex="-1">1.6.3.5 Model-Selection Routers</h3>
<p>Model-selection routers choose <strong>which LLM</strong> to use for a given step — routing easy tasks to small, fast, cheap models and hard tasks to large, capable, expensive models.</p>
<p><strong>Decision-theoretic formulation.</strong> For input <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></eq>, model <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>∈</mo><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">m \in \mathcal{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">M</span></span></span></span></eq>, the optimal model selection minimizes expected cost subject to a quality constraint:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>m</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><mrow><mi>m</mi><mo>∈</mo><mi mathvariant="script">M</mi></mrow></munder><mtext>  </mtext><mtext>cost</mtext><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mspace width="1em"/><mtext>s.t.</mtext><mspace width="1em"/><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mtext>quality</mtext><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>≥</mo><msub><mi>q</mi><mi>min</mi><mo>⁡</mo></msub></mrow><annotation encoding="application/x-tex">
m^*(x) = \arg\min_{m \in \mathcal{M}} \; \text{cost}(m) \quad \text{s.t.} \quad \mathbb{E}[\text{quality}(m, x)] \geq q_{\min}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.5217em;vertical-align:-0.7717em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.3557em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight">M</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7717em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">cost</span></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">s.t.</span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord mathbb">E</span><span class="mopen">[</span><span class="mord text"><span class="mord">quality</span></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">i</span><span class="mtight">n</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>Equivalently, maximize quality-adjusted utility:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>m</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi>m</mi><mo>∈</mo><mi mathvariant="script">M</mi></mrow></munder><mtext>  </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mtext> </mtext><mtext>quality</mtext><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>−</mo><mi>λ</mi><mo>⋅</mo><mtext>cost</mtext><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">
m^*(x) = \arg\max_{m \in \mathcal{M}} \; \bigl[\, \text{quality}(m, x) - \lambda \cdot \text{cost}(m) \,\bigr]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.6217em;vertical-align:-0.7717em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3557em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight">M</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7717em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen"><span class="delimsizing size1">[</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">quality</span></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">λ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">cost</span></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">]</span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">λ</span></span></span></span></eq> is the cost-quality trade-off parameter.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelConfig</span>:
    name: <span class="hljs-built_in">str</span>
    cost_per_input_token: <span class="hljs-built_in">float</span>    <span class="hljs-comment"># in USD per 1M tokens</span>
    cost_per_output_token: <span class="hljs-built_in">float</span>
    latency_ms: <span class="hljs-built_in">float</span>              <span class="hljs-comment"># average time-to-first-token</span>
    capability_score: <span class="hljs-built_in">float</span>        <span class="hljs-comment"># 0-1, estimated general capability</span>
    context_window: <span class="hljs-built_in">int</span>
    supports_tools: <span class="hljs-built_in">bool</span>
    supports_structured_output: <span class="hljs-built_in">bool</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Select the optimal model for each task based on requirements.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, models: <span class="hljs-built_in">list</span>[ModelConfig]</span>):
        <span class="hljs-variable language_">self</span>.models = models
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">select</span>(<span class="hljs-params">self, requirements: <span class="hljs-built_in">dict</span></span>) -&gt; ModelConfig:
        <span class="hljs-string">&quot;&quot;&quot;
        Requirements dict:
        - min_capability: float (0-1)
        - max_cost_per_call: float (USD)
        - max_latency_ms: float
        - needs_tools: bool
        - needs_structured_output: bool
        - estimated_input_tokens: int
        - estimated_output_tokens: int
        - priority: &quot;cost&quot; | &quot;quality&quot; | &quot;latency&quot;
        &quot;&quot;&quot;</span>
        candidates = <span class="hljs-variable language_">self</span>.models.copy()
        
        <span class="hljs-comment"># Hard filters</span>
        min_cap = requirements.get(<span class="hljs-string">&quot;min_capability&quot;</span>, <span class="hljs-number">0.0</span>)
        candidates = [m <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> candidates <span class="hljs-keyword">if</span> m.capability_score &gt;= min_cap]
        
        <span class="hljs-keyword">if</span> requirements.get(<span class="hljs-string">&quot;needs_tools&quot;</span>):
            candidates = [m <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> candidates <span class="hljs-keyword">if</span> m.supports_tools]
        
        <span class="hljs-keyword">if</span> requirements.get(<span class="hljs-string">&quot;needs_structured_output&quot;</span>):
            candidates = [m <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> candidates <span class="hljs-keyword">if</span> m.supports_structured_output]
        
        max_latency = requirements.get(<span class="hljs-string">&quot;max_latency_ms&quot;</span>, <span class="hljs-built_in">float</span>(<span class="hljs-string">&quot;inf&quot;</span>))
        candidates = [m <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> candidates <span class="hljs-keyword">if</span> m.latency_ms &lt;= max_latency]
        
        <span class="hljs-comment"># Cost filter</span>
        in_tok = requirements.get(<span class="hljs-string">&quot;estimated_input_tokens&quot;</span>, <span class="hljs-number">1000</span>)
        out_tok = requirements.get(<span class="hljs-string">&quot;estimated_output_tokens&quot;</span>, <span class="hljs-number">500</span>)
        max_cost = requirements.get(<span class="hljs-string">&quot;max_cost_per_call&quot;</span>, <span class="hljs-built_in">float</span>(<span class="hljs-string">&quot;inf&quot;</span>))
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_cost</span>(<span class="hljs-params">m: ModelConfig</span>) -&gt; <span class="hljs-built_in">float</span>:
            <span class="hljs-keyword">return</span> (m.cost_per_input_token * in_tok + 
                    m.cost_per_output_token * out_tok) / <span class="hljs-number">1e6</span>
        
        candidates = [m <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> candidates <span class="hljs-keyword">if</span> call_cost(m) &lt;= max_cost]
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> candidates:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;No model satisfies all requirements&quot;</span>)
        
        <span class="hljs-comment"># Soft ranking</span>
        priority = requirements.get(<span class="hljs-string">&quot;priority&quot;</span>, <span class="hljs-string">&quot;cost&quot;</span>)
        <span class="hljs-keyword">if</span> priority == <span class="hljs-string">&quot;cost&quot;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(candidates, key=call_cost)
        <span class="hljs-keyword">elif</span> priority == <span class="hljs-string">&quot;quality&quot;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(candidates, key=<span class="hljs-keyword">lambda</span> m: m.capability_score)
        <span class="hljs-keyword">elif</span> priority == <span class="hljs-string">&quot;latency&quot;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(candidates, key=<span class="hljs-keyword">lambda</span> m: m.latency_ms)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> candidates[<span class="hljs-number">0</span>]


<span class="hljs-comment"># --- Model Inventory ---</span>
models = [
    ModelConfig(<span class="hljs-string">&quot;gpt-4o&quot;</span>, <span class="hljs-number">2.50</span>, <span class="hljs-number">10.00</span>, <span class="hljs-number">800</span>, <span class="hljs-number">0.95</span>, <span class="hljs-number">128000</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>),
    ModelConfig(<span class="hljs-string">&quot;gpt-4o-mini&quot;</span>, <span class="hljs-number">0.15</span>, <span class="hljs-number">0.60</span>, <span class="hljs-number">300</span>, <span class="hljs-number">0.82</span>, <span class="hljs-number">128000</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>),
    ModelConfig(<span class="hljs-string">&quot;claude-3.5-sonnet&quot;</span>, <span class="hljs-number">3.00</span>, <span class="hljs-number">15.00</span>, <span class="hljs-number">900</span>, <span class="hljs-number">0.96</span>, <span class="hljs-number">200000</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>),
    ModelConfig(<span class="hljs-string">&quot;claude-3.5-haiku&quot;</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">400</span>, <span class="hljs-number">0.80</span>, <span class="hljs-number">200000</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>),
    ModelConfig(<span class="hljs-string">&quot;gemini-2.0-flash&quot;</span>, <span class="hljs-number">0.10</span>, <span class="hljs-number">0.40</span>, <span class="hljs-number">250</span>, <span class="hljs-number">0.78</span>, <span class="hljs-number">1000000</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>),
]

model_router = ModelRouter(models)

<span class="hljs-comment"># Route a simple task to the cheapest model</span>
simple_model = model_router.select({
    <span class="hljs-string">&quot;min_capability&quot;</span>: <span class="hljs-number">0.7</span>,
    <span class="hljs-string">&quot;needs_tools&quot;</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">&quot;priority&quot;</span>: <span class="hljs-string">&quot;cost&quot;</span>,
    <span class="hljs-string">&quot;estimated_input_tokens&quot;</span>: <span class="hljs-number">500</span>,
    <span class="hljs-string">&quot;estimated_output_tokens&quot;</span>: <span class="hljs-number">200</span>
})
<span class="hljs-comment"># Returns: gemini-2.0-flash</span>

<span class="hljs-comment"># Route a complex task to the best model</span>
complex_model = model_router.select({
    <span class="hljs-string">&quot;min_capability&quot;</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-string">&quot;needs_tools&quot;</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">&quot;needs_structured_output&quot;</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">&quot;priority&quot;</span>: <span class="hljs-string">&quot;quality&quot;</span>
})
<span class="hljs-comment"># Returns: claude-3.5-sonnet</span>
</code></pre>
</div><h3 id="1636-fallback-routing-and-escalation-paths" tabindex="-1">1.6.3.6 Fallback Routing and Escalation Paths</h3>
<p>Fallback routing ensures that <strong>every input receives a response</strong>, even when the primary routing path fails. Escalation paths progressively invoke more capable (and expensive) resources.</p>
<p><strong>Formal model — Escalation Ladder:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Escalation</mtext><mo>:</mo><msub><mi>b</mi><mn>1</mn></msub><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>fail</mtext></mpadded></mover><msub><mi>b</mi><mn>2</mn></msub><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>fail</mtext></mpadded></mover><msub><mi>b</mi><mn>3</mn></msub><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>fail</mtext></mpadded></mover><mo>⋯</mo><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>fail</mtext></mpadded></mover><msub><mi>b</mi><mtext>human</mtext></msub></mrow><annotation encoding="application/x-tex">
\text{Escalation}: b_1 \xrightarrow{\text{fail}} b_2 \xrightarrow{\text{fail}} b_3 \xrightarrow{\text{fail}} \cdots \xrightarrow{\text{fail}} b_{\text{human}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Escalation</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2581em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1081em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fail</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2581em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1081em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fail</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2581em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1081em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fail</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1191em;vertical-align:-0.011em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1081em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fail</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">human</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>At each rung, the system checks whether the output satisfies quality criteria. If not, it escalates:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>output</mtext><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>≥</mo><msub><mi>q</mi><mi>min</mi><mo>⁡</mo></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>2</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>q</mi><mi>min</mi><mo>⁡</mo></msub><mtext> and </mtext><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>≥</mo><msub><mi>q</mi><mi>min</mi><mo>⁡</mo></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>human response</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if all automated paths fail</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{output} = \begin{cases}
y_1 &amp; \text{if } Q(y_1) \geq q_{\min} \\
y_2 &amp; \text{if } Q(y_1) &lt; q_{\min} \text{ and } Q(y_2) \geq q_{\min} \\
\vdots \\
\text{human response} &amp; \text{if all automated paths fail}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">output</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:6.252em;vertical-align:-2.876em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-1.366em;"><span class="pstrut" style="height:3.216em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.358em;"><span class="pstrut" style="height:3.216em;"></span><span style="height:1.216em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="1.216em" style="width:0.8889em" viewBox="0 0 888.89 1216" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V1216 H384z M384 0 H504 V1216 H384z"/></svg></span></span><span style="top:-3.216em;"><span class="pstrut" style="height:3.216em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.358em;"><span class="pstrut" style="height:3.216em;"></span><span style="height:1.216em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="1.216em" style="width:0.8889em" viewBox="0 0 888.89 1216" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V1216 H384z M384 0 H504 V1216 H384z"/></svg></span></span><span style="top:-5.566em;"><span class="pstrut" style="height:3.216em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.376em;"><span style="top:-6.0555em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6155em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.6835em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.2435em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">human response</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.876em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.376em;"><span style="top:-5.376em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">i</span><span class="mtight">n</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.936em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">i</span><span class="mtight">n</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord"> and </span></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">i</span><span class="mtight">n</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-0.564em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if all automated paths fail</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.876em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EscalationRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Progressive escalation through increasingly capable paths.&quot;&quot;&quot;</span>
    
<span class="hljs-meta">    @dataclass</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">EscalationLevel</span>:
        name: <span class="hljs-built_in">str</span>
        handler: <span class="hljs-type">Callable</span>
        quality_checker: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">float</span>]  <span class="hljs-comment"># output → quality score</span>
        cost: <span class="hljs-built_in">float</span>  <span class="hljs-comment"># estimated cost in USD</span>
        max_latency_ms: <span class="hljs-built_in">float</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, quality_threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.7</span></span>):
        <span class="hljs-variable language_">self</span>.levels: <span class="hljs-built_in">list</span>[<span class="hljs-string">&quot;EscalationRouter.EscalationLevel&quot;</span>] = []
        <span class="hljs-variable language_">self</span>.quality_threshold = quality_threshold
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_level</span>(<span class="hljs-params">self, level: <span class="hljs-string">&quot;EscalationRouter.EscalationLevel&quot;</span></span>):
        <span class="hljs-variable language_">self</span>.levels.append(level)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, input_data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;Try each escalation level until quality threshold is met.&quot;&quot;&quot;</span>
        attempts = []
        
        <span class="hljs-keyword">for</span> level <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.levels:
            <span class="hljs-keyword">try</span>:
                output = <span class="hljs-keyword">await</span> asyncio.wait_for(
                    level.handler(input_data),
                    timeout=level.max_latency_ms / <span class="hljs-number">1000</span>
                )
                quality = level.quality_checker(output)
                
                attempts.append({
                    <span class="hljs-string">&quot;level&quot;</span>: level.name,
                    <span class="hljs-string">&quot;output&quot;</span>: output,
                    <span class="hljs-string">&quot;quality&quot;</span>: quality,
                    <span class="hljs-string">&quot;cost&quot;</span>: level.cost
                })
                
                <span class="hljs-keyword">if</span> quality &gt;= <span class="hljs-variable language_">self</span>.quality_threshold:
                    <span class="hljs-keyword">return</span> {
                        <span class="hljs-string">&quot;final_output&quot;</span>: output,
                        <span class="hljs-string">&quot;served_by&quot;</span>: level.name,
                        <span class="hljs-string">&quot;quality&quot;</span>: quality,
                        <span class="hljs-string">&quot;total_cost&quot;</span>: <span class="hljs-built_in">sum</span>(a[<span class="hljs-string">&quot;cost&quot;</span>] <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> attempts),
                        <span class="hljs-string">&quot;escalation_depth&quot;</span>: <span class="hljs-built_in">len</span>(attempts),
                        <span class="hljs-string">&quot;attempts&quot;</span>: attempts
                    }
            <span class="hljs-keyword">except</span> (asyncio.TimeoutError, Exception) <span class="hljs-keyword">as</span> e:
                attempts.append({
                    <span class="hljs-string">&quot;level&quot;</span>: level.name,
                    <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-built_in">str</span>(e),
                    <span class="hljs-string">&quot;cost&quot;</span>: level.cost
                })
                <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># All levels failed: return best attempt or escalate to human</span>
        valid_attempts = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> attempts <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;output&quot;</span> <span class="hljs-keyword">in</span> a]
        <span class="hljs-keyword">if</span> valid_attempts:
            best = <span class="hljs-built_in">max</span>(valid_attempts, key=<span class="hljs-keyword">lambda</span> a: a[<span class="hljs-string">&quot;quality&quot;</span>])
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">&quot;final_output&quot;</span>: best[<span class="hljs-string">&quot;output&quot;</span>],
                <span class="hljs-string">&quot;served_by&quot;</span>: best[<span class="hljs-string">&quot;level&quot;</span>],
                <span class="hljs-string">&quot;quality&quot;</span>: best[<span class="hljs-string">&quot;quality&quot;</span>],
                <span class="hljs-string">&quot;warning&quot;</span>: <span class="hljs-string">&quot;Below quality threshold — best effort&quot;</span>,
                <span class="hljs-string">&quot;total_cost&quot;</span>: <span class="hljs-built_in">sum</span>(a.get(<span class="hljs-string">&quot;cost&quot;</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> attempts),
                <span class="hljs-string">&quot;attempts&quot;</span>: attempts
            }
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;final_output&quot;</span>: <span class="hljs-literal">None</span>,
            <span class="hljs-string">&quot;escalate_to&quot;</span>: <span class="hljs-string">&quot;human&quot;</span>,
            <span class="hljs-string">&quot;all_attempts_failed&quot;</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">&quot;attempts&quot;</span>: attempts
        }


<span class="hljs-comment"># --- Escalation ladder ---</span>
escalation = EscalationRouter(quality_threshold=<span class="hljs-number">0.75</span>)

escalation.add_level(EscalationRouter.EscalationLevel(
    name=<span class="hljs-string">&quot;cache_lookup&quot;</span>,
    handler=cache_handler,
    quality_checker=<span class="hljs-keyword">lambda</span> o: <span class="hljs-number">1.0</span> <span class="hljs-keyword">if</span> o <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>,
    cost=<span class="hljs-number">0.0</span>,
    max_latency_ms=<span class="hljs-number">50</span>
))

escalation.add_level(EscalationRouter.EscalationLevel(
    name=<span class="hljs-string">&quot;small_model_direct&quot;</span>,
    handler=small_model_handler,
    quality_checker=quality_scorer,
    cost=<span class="hljs-number">0.001</span>,
    max_latency_ms=<span class="hljs-number">2000</span>
))

escalation.add_level(EscalationRouter.EscalationLevel(
    name=<span class="hljs-string">&quot;large_model_chain&quot;</span>,
    handler=large_model_chain_handler,
    quality_checker=quality_scorer,
    cost=<span class="hljs-number">0.05</span>,
    max_latency_ms=<span class="hljs-number">15000</span>
))

escalation.add_level(EscalationRouter.EscalationLevel(
    name=<span class="hljs-string">&quot;agent_with_tools&quot;</span>,
    handler=agent_handler,
    quality_checker=quality_scorer,
    cost=<span class="hljs-number">0.50</span>,
    max_latency_ms=<span class="hljs-number">60000</span>
))
</code></pre>
</div><h3 id="1637-composite-routing-architecture" tabindex="-1">1.6.3.7 Composite Routing Architecture</h3>
<p>Production systems combine multiple routing dimensions into a <strong>multi-stage routing pipeline</strong>:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">User Input
    │
    ▼
┌───────────────────────────────┐
│ Stage 1: Safety/Guardrail     │  ← Static (keyword + regex)
│ Block harmful inputs          │
└──────────┬────────────────────┘
           │ pass
           ▼
┌───────────────────────────────┐
│ Stage 2: Intent Classification│  ← LLM or classifier
│ What does the user want?      │
└──────────┬────────────────────┘
           │ intent
           ▼
┌───────────────────────────────┐
│ Stage 3: Topic Routing        │  ← Embedding similarity
│ What domain is this about?    │
└──────────┬────────────────────┘
           │ topic + intent
           ▼
┌───────────────────────────────┐
│ Stage 4: Complexity Estimation│  ← Heuristic + optional LLM
│ How hard is this task?        │
└──────────┬────────────────────┘
           │ complexity level
           ▼
┌───────────────────────────────┐
│ Stage 5: Model Selection      │  ← Cost-quality optimization
│ Which model for this step?    │
└──────────┬────────────────────┘
           │ model + chain
           ▼
┌───────────────────────────────┐
│ Stage 6: Execution            │  ← With escalation fallback
│ Run chain; escalate if needed │
└───────────────────────────────┘
</code></pre>
</div><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiStageRouter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Production-grade multi-stage routing pipeline.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,
                 safety_router: StaticRouter,
                 intent_router: IntentRouter,
                 topic_router: TopicRouter,
                 complexity_router: ComplexityRouter,
                 model_router: ModelRouter,
                 escalation_router: EscalationRouter</span>):
        <span class="hljs-variable language_">self</span>.safety = safety_router
        <span class="hljs-variable language_">self</span>.intent = intent_router
        <span class="hljs-variable language_">self</span>.topic = topic_router
        <span class="hljs-variable language_">self</span>.complexity = complexity_router
        <span class="hljs-variable language_">self</span>.model = model_router
        <span class="hljs-variable language_">self</span>.escalation = escalation_router
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">self, user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        routing_trace = {<span class="hljs-string">&quot;input&quot;</span>: user_input, <span class="hljs-string">&quot;stages&quot;</span>: []}
        
        <span class="hljs-comment"># Stage 1: Safety check (static, ~0ms)</span>
        safety_result, _ = <span class="hljs-variable language_">self</span>.safety.route({<span class="hljs-string">&quot;query&quot;</span>: user_input})
        routing_trace[<span class="hljs-string">&quot;stages&quot;</span>].append({<span class="hljs-string">&quot;safety&quot;</span>: safety_result})
        <span class="hljs-keyword">if</span> safety_result == <span class="hljs-string">&quot;blocked&quot;</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;block&quot;</span>, <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Safety filter&quot;</span>, <span class="hljs-string">&quot;trace&quot;</span>: routing_trace}
        
        <span class="hljs-comment"># Stage 2: Intent classification (~200-500ms if LLM)</span>
        intent_result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.intent.classify_and_route(user_input)
        routing_trace[<span class="hljs-string">&quot;stages&quot;</span>].append({<span class="hljs-string">&quot;intent&quot;</span>: intent_result})
        <span class="hljs-keyword">if</span> intent_result[<span class="hljs-string">&quot;action&quot;</span>] == <span class="hljs-string">&quot;clarify&quot;</span>:
            <span class="hljs-keyword">return</span> {**intent_result, <span class="hljs-string">&quot;trace&quot;</span>: routing_trace}
        
        <span class="hljs-comment"># Stage 3: Topic routing (~5ms with embeddings)</span>
        topic, topic_score, all_topics = <span class="hljs-variable language_">self</span>.topic.route(user_input)
        routing_trace[<span class="hljs-string">&quot;stages&quot;</span>].append({
            <span class="hljs-string">&quot;topic&quot;</span>: topic, <span class="hljs-string">&quot;score&quot;</span>: topic_score, <span class="hljs-string">&quot;all_scores&quot;</span>: all_topics
        })
        
        <span class="hljs-comment"># Stage 4: Complexity estimation (~0ms heuristic)</span>
        tier, complexity = <span class="hljs-variable language_">self</span>.complexity.route(user_input)
        routing_trace[<span class="hljs-string">&quot;stages&quot;</span>].append({<span class="hljs-string">&quot;tier&quot;</span>: tier, <span class="hljs-string">&quot;complexity&quot;</span>: complexity})
        
        <span class="hljs-comment"># Stage 5: Model selection (~0ms)</span>
        model = <span class="hljs-variable language_">self</span>.model.select({
            <span class="hljs-string">&quot;min_capability&quot;</span>: <span class="hljs-number">0.7</span> <span class="hljs-keyword">if</span> tier == <span class="hljs-string">&quot;direct&quot;</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.85</span> <span class="hljs-keyword">if</span> tier == <span class="hljs-string">&quot;chain&quot;</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.93</span>,
            <span class="hljs-string">&quot;needs_tools&quot;</span>: tier == <span class="hljs-string">&quot;agent&quot;</span>,
            <span class="hljs-string">&quot;priority&quot;</span>: <span class="hljs-string">&quot;cost&quot;</span> <span class="hljs-keyword">if</span> tier == <span class="hljs-string">&quot;direct&quot;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;quality&quot;</span>
        })
        routing_trace[<span class="hljs-string">&quot;stages&quot;</span>].append({<span class="hljs-string">&quot;model&quot;</span>: model.name})
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;execute&quot;</span>,
            <span class="hljs-string">&quot;intent&quot;</span>: intent_result[<span class="hljs-string">&quot;intent&quot;</span>],
            <span class="hljs-string">&quot;topic&quot;</span>: topic,
            <span class="hljs-string">&quot;complexity_tier&quot;</span>: tier,
            <span class="hljs-string">&quot;model&quot;</span>: model,
            <span class="hljs-string">&quot;trace&quot;</span>: routing_trace
        }
</code></pre>
</div><hr>
<h2 id="164-gate-mechanisms" tabindex="-1">1.6.4 Gate Mechanisms</h2>
<h3 id="1641-foundational-definition" tabindex="-1">1.6.4.1 Foundational Definition</h3>
<p>A <strong>gate</strong> is a binary or graded decision function inserted between chain steps that determines whether execution should <strong>proceed</strong>, <strong>retry</strong>, <strong>branch</strong>, or <strong>halt</strong>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>g</mi><mo>:</mo><mi mathvariant="script">Y</mi><mo>×</mo><mi mathvariant="script">S</mi><mo>⟶</mo><mo stretchy="false">{</mo><mtext mathvariant="monospace">PASS</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">FAIL</mtext><mo stretchy="false">}</mo><mo>×</mo><msub><mi mathvariant="script">A</mi><mtext>action</mtext></msub></mrow><annotation encoding="application/x-tex">
g: \mathcal{Y} \times \mathcal{S} \longrightarrow \{\texttt{PASS}, \texttt{FAIL}\} \times \mathcal{A}_{\text{action}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6943em;vertical-align:-0.011em;"></span><span class="mord mathcal" style="margin-right:0.075em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟶</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord text"><span class="mord texttt">PASS</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">FAIL</span></span><span class="mclose">}</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathcal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">action</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">Y</mi></mrow><annotation encoding="application/x-tex">\mathcal{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span></span></span></span></eq>is the space of step outputs,<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">S</mi></mrow><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.075em;">S</span></span></span></span></eq>is the state space, and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">A</mi><mtext>action</mtext></msub><mo>=</mo><mo stretchy="false">{</mo><mtext mathvariant="monospace">proceed</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">retry</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">retry_modified</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">escalate</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">abort</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">human_review</mtext><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{A}_{\text{action}} = \{\texttt{proceed}, \texttt{retry}, \texttt{retry\_modified}, \texttt{escalate}, \texttt{abort}, \texttt{human\_review}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathcal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">action</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord text"><span class="mord texttt">proceed</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">retry</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">retry_modified</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">escalate</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">abort</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">human_review</span></span><span class="mclose">}</span></span></span></span></eq> is the set of possible gate actions.</p>
<p><strong>Formally, a gate acts as a binary classifier with an action policy:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mtext mathvariant="monospace">PASS</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">proceed</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>≥</mo><mi>τ</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mtext mathvariant="monospace">FAIL</mtext><mo separator="true">,</mo><msub><mi>π</mi><mtext>fail</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>τ</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
g(y_t) = \begin{cases}
(\texttt{PASS}, \texttt{proceed}) &amp; \text{if } Q(y_t) \geq \tau \\
(\texttt{FAIL}, \pi_{\text{fail}}(y_t, S_t)) &amp; \text{if } Q(y_t) &lt; \tau
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">(</span><span class="mord text"><span class="mord texttt">PASS</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">proceed</span></span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">(</span><span class="mord text"><span class="mord texttt">FAIL</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fail</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>:</mo><mi mathvariant="script">Y</mi><mo>→</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Q: \mathcal{Y} \rightarrow [0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></eq>is a quality function and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>fail</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{fail}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fail</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> is the failure-handling policy.</p>
<p><strong>Chain topology with gates:</strong></p>
<div class="code-shell"><pre class="hljs"><code class="hljs">[Step 1] → [Gate 1] → [Step 2] → [Gate 2] → [Step 3] → [Gate 3] → [Output]
              │                      │                      │
              ▼                      ▼                      ▼
          ┌───────┐              ┌───────┐              ┌───────┐
          │ Retry │              │ Retry │              │ Human │
          │ Loop  │              │ Loop  │              │Review │
          └───────┘              └───────┘              └───────┘
</code></pre>
</div><h3 id="1642-quality-gates-between-chain-steps" tabindex="-1">1.6.4.2 Quality Gates Between Chain Steps</h3>
<p>Quality gates evaluate whether a step’s output meets a minimum quality standard before allowing execution to continue.</p>
<p><strong>Multi-dimensional quality function:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>d</mi><mo>=</mo><mn>1</mn></mrow><mi>D</mi></munderover><msub><mi>w</mi><mi>d</mi></msub><mo>⋅</mo><msub><mi>q</mi><mi>d</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mspace width="1em"/><mtext>where </mtext><munderover><mo>∑</mo><mrow><mi>d</mi><mo>=</mo><mn>1</mn></mrow><mi>D</mi></munderover><msub><mi>w</mi><mi>d</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">
Q(y_t) = \sum_{d=1}^{D} w_d \cdot q_d(y_t) \quad \text{where } \sum_{d=1}^{D} w_d = 1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">where </span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span></eqn></section><table>
<thead>
<tr>
<th>Quality Dimension <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">q_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq></th>
<th>Measurement Method</th>
<th>Typical Weight</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Relevance</strong></td>
<td>Semantic similarity to task specification</td>
<td>0.30</td>
</tr>
<tr>
<td><strong>Completeness</strong></td>
<td>Required fields present / all sub-questions answered</td>
<td>0.25</td>
</tr>
<tr>
<td><strong>Coherence</strong></td>
<td>Logical consistency, no contradictions</td>
<td>0.20</td>
</tr>
<tr>
<td><strong>Format compliance</strong></td>
<td>Matches expected schema / structure</td>
<td>0.15</td>
</tr>
<tr>
<td><strong>Length appropriateness</strong></td>
<td>Within expected token range</td>
<td>0.10</td>
</tr>
</tbody>
</table>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">QualityGate</span>:
    <span class="hljs-string">&quot;&quot;&quot;Multi-dimensional quality gate between chain steps.&quot;&quot;&quot;</span>
    
<span class="hljs-meta">    @dataclass</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">QualityCheck</span>:
        name: <span class="hljs-built_in">str</span>
        checker: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>], <span class="hljs-built_in">float</span>]  <span class="hljs-comment"># (output, state) → score [0,1]</span>
        weight: <span class="hljs-built_in">float</span>
        min_score: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>  <span class="hljs-comment"># hard minimum for this dimension</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.7</span>, max_retries: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span></span>):
        <span class="hljs-variable language_">self</span>.threshold = threshold
        <span class="hljs-variable language_">self</span>.max_retries = max_retries
        <span class="hljs-variable language_">self</span>.checks: <span class="hljs-built_in">list</span>[QualityGate.QualityCheck] = []
        <span class="hljs-variable language_">self</span>._gate_log: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>] = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_check</span>(<span class="hljs-params">self, check: <span class="hljs-string">&quot;QualityGate.QualityCheck&quot;</span></span>):
        <span class="hljs-variable language_">self</span>.checks.append(check)
        <span class="hljs-comment"># Renormalize weights</span>
        total = <span class="hljs-built_in">sum</span>(c.weight <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.checks)
        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.checks:
            c.weight /= total
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span>, state: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;Evaluate output quality across all dimensions.&quot;&quot;&quot;</span>
        scores = {}
        failed_hard = []
        
        <span class="hljs-keyword">for</span> check <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.checks:
            score = check.checker(output, state)
            scores[check.name] = {
                <span class="hljs-string">&quot;score&quot;</span>: score,
                <span class="hljs-string">&quot;weight&quot;</span>: check.weight,
                <span class="hljs-string">&quot;weighted_score&quot;</span>: score * check.weight,
                <span class="hljs-string">&quot;passed_minimum&quot;</span>: score &gt;= check.min_score
            }
            <span class="hljs-keyword">if</span> score &lt; check.min_score:
                failed_hard.append(check.name)
        
        aggregate = <span class="hljs-built_in">sum</span>(s[<span class="hljs-string">&quot;weighted_score&quot;</span>] <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> scores.values())
        
        passed = aggregate &gt;= <span class="hljs-variable language_">self</span>.threshold <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(failed_hard) == <span class="hljs-number">0</span>
        
        result = {
            <span class="hljs-string">&quot;passed&quot;</span>: passed,
            <span class="hljs-string">&quot;aggregate_score&quot;</span>: aggregate,
            <span class="hljs-string">&quot;dimension_scores&quot;</span>: scores,
            <span class="hljs-string">&quot;failed_hard_checks&quot;</span>: failed_hard,
            <span class="hljs-string">&quot;threshold&quot;</span>: <span class="hljs-variable language_">self</span>.threshold
        }
        <span class="hljs-variable language_">self</span>._gate_log.append(result)
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">gate</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span>, state: <span class="hljs-built_in">dict</span>,
                   retry_fn: <span class="hljs-type">Callable</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Apply the gate with retry logic.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.max_retries + <span class="hljs-number">1</span>):
            eval_result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.evaluate(output, state)
            
            <span class="hljs-keyword">if</span> eval_result[<span class="hljs-string">&quot;passed&quot;</span>]:
                <span class="hljs-keyword">return</span> output, {**eval_result, <span class="hljs-string">&quot;attempts&quot;</span>: attempt + <span class="hljs-number">1</span>}
            
            <span class="hljs-keyword">if</span> attempt &lt; <span class="hljs-variable language_">self</span>.max_retries <span class="hljs-keyword">and</span> retry_fn:
                <span class="hljs-comment"># Construct feedback for retry</span>
                feedback = <span class="hljs-variable language_">self</span>._build_feedback(eval_result)
                output = <span class="hljs-keyword">await</span> retry_fn(output, feedback, state)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> output, {
                    **eval_result, 
                    <span class="hljs-string">&quot;attempts&quot;</span>: attempt + <span class="hljs-number">1</span>,
                    <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;escalate&quot;</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> eval_result[<span class="hljs-string">&quot;passed&quot;</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;proceed&quot;</span>
                }
        
        <span class="hljs-keyword">return</span> output, eval_result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_build_feedback</span>(<span class="hljs-params">self, eval_result: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">&quot;&quot;&quot;Generate specific feedback for retry based on failed checks.&quot;&quot;&quot;</span>
        feedback_parts = [<span class="hljs-string">&quot;The previous output did not meet quality standards:&quot;</span>]
        
        <span class="hljs-keyword">for</span> name, scores <span class="hljs-keyword">in</span> eval_result[<span class="hljs-string">&quot;dimension_scores&quot;</span>].items():
            <span class="hljs-keyword">if</span> scores[<span class="hljs-string">&quot;score&quot;</span>] &lt; <span class="hljs-number">0.6</span>:
                feedback_parts.append(
                    <span class="hljs-string">f&quot;- <span class="hljs-subst">{name}</span>: scored <span class="hljs-subst">{scores[<span class="hljs-string">&#x27;score&#x27;</span>]:<span class="hljs-number">.2</span>f}</span> &quot;</span>
                    <span class="hljs-string">f&quot;(minimum: <span class="hljs-subst">{self.threshold:<span class="hljs-number">.2</span>f}</span>). Please improve this aspect.&quot;</span>
                )
        
        <span class="hljs-keyword">if</span> eval_result[<span class="hljs-string">&quot;failed_hard_checks&quot;</span>]:
            feedback_parts.append(
                <span class="hljs-string">f&quot;Critical failures in: <span class="hljs-subst">{<span class="hljs-string">&#x27;, &#x27;</span>.join(eval_result[<span class="hljs-string">&#x27;failed_hard_checks&#x27;</span>])}</span>&quot;</span>
            )
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\n&quot;</span>.join(feedback_parts)
</code></pre>
</div><h3 id="1643-validation-gates-schema-factuality-safety" tabindex="-1">1.6.4.3 Validation Gates (Schema, Factuality, Safety)</h3>
<p>Validation gates enforce <strong>hard constraints</strong> — outputs that violate these constraints are categorically unacceptable, regardless of other quality dimensions.</p>
<h4 id="a-schema-validation-gate" tabindex="-1">A. Schema Validation Gate</h4>
<p>Ensures the output conforms to a predefined structure:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>g</mi><mtext>schema</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext mathvariant="monospace">PASS</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mi>y</mi><mi>t</mi></msub><mo>∈</mo><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext mathvariant="monospace">FAIL</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
g_{\text{schema}}(y_t) = \begin{cases}
\texttt{PASS} &amp; \text{if } y_t \in \mathcal{L}(\sigma) \\
\texttt{FAIL} &amp; \text{otherwise}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">schema</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">PASS</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">FAIL</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathcal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{L}(\sigma)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose">)</span></span></span></span></eq>is the language (set of valid instances) defined by schema<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></eq>.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> ValidationError

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SchemaValidationGate</span>:
    <span class="hljs-string">&quot;&quot;&quot;Ensure output conforms to a Pydantic schema.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, schema: <span class="hljs-built_in">type</span>[BaseModel], max_retries: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
        <span class="hljs-variable language_">self</span>.schema = schema
        <span class="hljs-variable language_">self</span>.max_retries = max_retries
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">self, raw_output: <span class="hljs-built_in">str</span>, 
                       retry_fn: <span class="hljs-type">Callable</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[BaseModel | <span class="hljs-literal">None</span>, <span class="hljs-built_in">dict</span>]:
        errors = []
        
        <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.max_retries + <span class="hljs-number">1</span>):
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># Attempt to parse</span>
                parsed = <span class="hljs-variable language_">self</span>.schema.model_validate_json(raw_output)
                <span class="hljs-keyword">return</span> parsed, {
                    <span class="hljs-string">&quot;valid&quot;</span>: <span class="hljs-literal">True</span>,
                    <span class="hljs-string">&quot;attempts&quot;</span>: attempt + <span class="hljs-number">1</span>,
                    <span class="hljs-string">&quot;errors&quot;</span>: errors
                }
            <span class="hljs-keyword">except</span> ValidationError <span class="hljs-keyword">as</span> e:
                error_detail = e.errors()
                errors.append({
                    <span class="hljs-string">&quot;attempt&quot;</span>: attempt + <span class="hljs-number">1</span>,
                    <span class="hljs-string">&quot;errors&quot;</span>: error_detail
                })
                
                <span class="hljs-keyword">if</span> attempt &lt; <span class="hljs-variable language_">self</span>.max_retries <span class="hljs-keyword">and</span> retry_fn:
                    feedback = (
                        <span class="hljs-string">f&quot;Your output failed schema validation:\n&quot;</span>
                        <span class="hljs-string">f&quot;<span class="hljs-subst">{json.dumps(error_detail, indent=<span class="hljs-number">2</span>)}</span>\n\n&quot;</span>
                        <span class="hljs-string">f&quot;Expected schema:\n&quot;</span>
                        <span class="hljs-string">f&quot;<span class="hljs-subst">{self.schema.model_json_schema()}</span>\n\n&quot;</span>
                        <span class="hljs-string">f&quot;Please fix the output to match the schema exactly.&quot;</span>
                    )
                    raw_output = <span class="hljs-keyword">await</span> retry_fn(raw_output, feedback)
            <span class="hljs-keyword">except</span> json.JSONDecodeError <span class="hljs-keyword">as</span> e:
                errors.append({<span class="hljs-string">&quot;attempt&quot;</span>: attempt + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;Invalid JSON: <span class="hljs-subst">{e}</span>&quot;</span>})
                <span class="hljs-keyword">if</span> attempt &lt; <span class="hljs-variable language_">self</span>.max_retries <span class="hljs-keyword">and</span> retry_fn:
                    raw_output = <span class="hljs-keyword">await</span> retry_fn(
                        raw_output, 
                        <span class="hljs-string">f&quot;Output is not valid JSON: <span class="hljs-subst">{e}</span>. Please output valid JSON.&quot;</span>
                    )
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, {<span class="hljs-string">&quot;valid&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;attempts&quot;</span>: <span class="hljs-variable language_">self</span>.max_retries + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;errors&quot;</span>: errors}
</code></pre>
</div><h4 id="b-factuality-validation-gate" tabindex="-1">B. Factuality Validation Gate</h4>
<p>Checks whether claims in the output are supported by provided evidence:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>g</mi><mtext>factual</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo separator="true">,</mo><mi mathvariant="script">E</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext mathvariant="monospace">PASS</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi mathvariant="normal">∀</mi><mtext> </mtext><mi>c</mi><mo>∈</mo><mtext>claims</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>:</mo><mtext>  </mtext><mi mathvariant="normal">∃</mi><mtext> </mtext><mi>e</mi><mo>∈</mo><mi mathvariant="script">E</mi><mtext> s.t. supports</mtext><mo stretchy="false">(</mo><mi>e</mi><mo separator="true">,</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext mathvariant="monospace">FAIL</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
g_{\text{factual}}(y_t, \mathcal{E}) = \begin{cases}
\texttt{PASS} &amp; \text{if } \forall\, c \in \text{claims}(y_t):\; \exists\, e \in \mathcal{E} \text{ s.t. } \text{supports}(e, c) \\
\texttt{FAIL} &amp; \text{otherwise}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">factual</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathcal" style="margin-right:0.08944em;">E</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">PASS</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">FAIL</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">∀</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">claims</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∃</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathcal" style="margin-right:0.08944em;">E</span><span class="mord text"><span class="mord"> s.t. </span></span><span class="mord text"><span class="mord">supports</span></span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FactualityGate</span>:
    <span class="hljs-string">&quot;&quot;&quot;Verify that output claims are supported by provided evidence.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, strictness: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.8</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.strictness = strictness
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span>, evidence: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Step 1: Extract claims from output</span>
        claims = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._extract_claims(output)
        
        <span class="hljs-comment"># Step 2: Verify each claim against evidence</span>
        verification_results = []
        <span class="hljs-keyword">for</span> claim <span class="hljs-keyword">in</span> claims:
            result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._verify_claim(claim, evidence)
            verification_results.append(result)
        
        <span class="hljs-comment"># Step 3: Aggregate</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> verification_results:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;passed&quot;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;No verifiable claims found&quot;</span>}
        
        supported_ratio = <span class="hljs-built_in">sum</span>(
            <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> verification_results <span class="hljs-keyword">if</span> r[<span class="hljs-string">&quot;supported&quot;</span>]
        ) / <span class="hljs-built_in">len</span>(verification_results)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;passed&quot;</span>: supported_ratio &gt;= <span class="hljs-variable language_">self</span>.strictness,
            <span class="hljs-string">&quot;supported_ratio&quot;</span>: supported_ratio,
            <span class="hljs-string">&quot;total_claims&quot;</span>: <span class="hljs-built_in">len</span>(claims),
            <span class="hljs-string">&quot;unsupported_claims&quot;</span>: [
                r[<span class="hljs-string">&quot;claim&quot;</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> verification_results <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> r[<span class="hljs-string">&quot;supported&quot;</span>]
            ],
            <span class="hljs-string">&quot;details&quot;</span>: verification_results
        }
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_extract_claims</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
        prompt = (
            <span class="hljs-string">&quot;Extract all factual claims from the following text. &quot;</span>
            <span class="hljs-string">&quot;List each claim as a separate, self-contained statement.\n\n&quot;</span>
            <span class="hljs-string">f&quot;Text: <span class="hljs-subst">{text}</span>\n\n&quot;</span>
            <span class="hljs-string">&quot;Claims (one per line):&quot;</span>
        )
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>)
        <span class="hljs-keyword">return</span> [c.strip(<span class="hljs-string">&quot;- &quot;</span>).strip() <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> response.strip().split(<span class="hljs-string">&quot;\n&quot;</span>) <span class="hljs-keyword">if</span> c.strip()]
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_verify_claim</span>(<span class="hljs-params">self, claim: <span class="hljs-built_in">str</span>, evidence: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">dict</span>:
        evidence_text = <span class="hljs-string">&quot;\n---\n&quot;</span>.join(evidence)
        prompt = (
            <span class="hljs-string">f&quot;Claim: <span class="hljs-subst">{claim}</span>\n\n&quot;</span>
            <span class="hljs-string">f&quot;Evidence:\n<span class="hljs-subst">{evidence_text}</span>\n\n&quot;</span>
            <span class="hljs-string">f&quot;Is this claim supported by the evidence? &quot;</span>
            <span class="hljs-string">f&quot;Respond as JSON: {{\&quot;supported\&quot;: true/false, \&quot;reasoning\&quot;: \&quot;...\&quot;, &quot;</span>
            <span class="hljs-string">f&quot;\&quot;supporting_evidence\&quot;: \&quot;...\&quot; or null}}&quot;</span>
        )
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>)
        result = json.loads(response)
        result[<span class="hljs-string">&quot;claim&quot;</span>] = claim
        <span class="hljs-keyword">return</span> result
</code></pre>
</div><h4 id="c-safety-validation-gate" tabindex="-1">C. Safety Validation Gate</h4>
<p>Blocks outputs containing harmful, biased, or policy-violating content:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>g</mi><mtext>safety</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext mathvariant="monospace">PASS</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi mathvariant="normal">∀</mi><mtext> </mtext><mi>d</mi><mo>∈</mo><msub><mi mathvariant="script">D</mi><mtext>safety</mtext></msub><mo>:</mo><mtext>  </mtext><msub><mi>h</mi><mi>d</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mi>d</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext mathvariant="monospace">FAIL</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi mathvariant="normal">∃</mi><mtext> </mtext><mi>d</mi><mo>∈</mo><msub><mi mathvariant="script">D</mi><mtext>safety</mtext></msub><mo>:</mo><mtext>  </mtext><msub><mi>h</mi><mi>d</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>≥</mo><msub><mi>τ</mi><mi>d</mi></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
g_{\text{safety}}(y_t) = \begin{cases}
\texttt{PASS} &amp; \text{if } \forall\, d \in \mathcal{D}_{\text{safety}}:\; h_d(y_t) &lt; \tau_d \\
\texttt{FAIL} &amp; \text{if } \exists\, d \in \mathcal{D}_{\text{safety}}:\; h_d(y_t) \geq \tau_d
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">safety</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">PASS</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">FAIL</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">∀</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">safety</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">∃</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">safety</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">D</mi><mtext>safety</mtext></msub></mrow><annotation encoding="application/x-tex">\mathcal{D}_{\text{safety}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">safety</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></eq>is the set of safety dimensions (toxicity, bias, PII, etc.) and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">h_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>is a hazard scorer for dimension<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span></eq>.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafetyGate</span>:
    <span class="hljs-string">&quot;&quot;&quot;Multi-dimensional safety validation gate.&quot;&quot;&quot;</span>
    
    SAFETY_DIMENSIONS = [
        <span class="hljs-string">&quot;toxicity&quot;</span>,
        <span class="hljs-string">&quot;personal_identifiable_information&quot;</span>,
        <span class="hljs-string">&quot;medical_advice&quot;</span>,
        <span class="hljs-string">&quot;financial_advice&quot;</span>,
        <span class="hljs-string">&quot;legal_advice&quot;</span>,
        <span class="hljs-string">&quot;bias_discrimination&quot;</span>,
        <span class="hljs-string">&quot;misinformation&quot;</span>
    ]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, 
                 thresholds: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">float</span>] = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.thresholds = thresholds <span class="hljs-keyword">or</span> {d: <span class="hljs-number">0.5</span> <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.SAFETY_DIMENSIONS}
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        prompt = (
            <span class="hljs-string">&quot;Evaluate the following text for safety concerns. &quot;</span>
            <span class="hljs-string">&quot;For each dimension, provide a risk score from 0.0 (safe) to 1.0 (unsafe).\n\n&quot;</span>
            <span class="hljs-string">f&quot;Text: <span class="hljs-subst">{output}</span>\n\n&quot;</span>
            <span class="hljs-string">&quot;Dimensions to evaluate:\n&quot;</span>
            + <span class="hljs-string">&quot;\n&quot;</span>.join(<span class="hljs-string">f&quot;- <span class="hljs-subst">{d}</span>&quot;</span> <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.SAFETY_DIMENSIONS) +
            <span class="hljs-string">&quot;\n\nRespond as JSON: {\&quot;dimension_name\&quot;: score, ...}&quot;</span>
        )
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>)
        scores = json.loads(response)
        
        violations = []
        <span class="hljs-keyword">for</span> dim, threshold <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.thresholds.items():
            score = scores.get(dim, <span class="hljs-number">0.0</span>)
            <span class="hljs-keyword">if</span> score &gt;= threshold:
                violations.append({
                    <span class="hljs-string">&quot;dimension&quot;</span>: dim,
                    <span class="hljs-string">&quot;score&quot;</span>: score,
                    <span class="hljs-string">&quot;threshold&quot;</span>: threshold
                })
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;passed&quot;</span>: <span class="hljs-built_in">len</span>(violations) == <span class="hljs-number">0</span>,
            <span class="hljs-string">&quot;scores&quot;</span>: scores,
            <span class="hljs-string">&quot;violations&quot;</span>: violations,
            <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;proceed&quot;</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> violations <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;block&quot;</span>
        }
</code></pre>
</div><h3 id="1644-human-in-the-loop-gates" tabindex="-1">1.6.4.4 Human-in-the-Loop Gates</h3>
<p>Human gates insert a <strong>human decision point</strong> into the chain, pausing automated execution until a human approves, rejects, or modifies the intermediate result.</p>
<p><strong>Formal model:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>g</mi><mtext>human</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mtext>await</mtext><mtext>  </mtext><msub><mi>h</mi><mtext>human</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>∈</mo><mo stretchy="false">{</mo><mtext mathvariant="monospace">approve</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">reject</mtext><mo separator="true">,</mo><mtext mathvariant="monospace">modify</mtext><mo stretchy="false">(</mo><msubsup><mi>y</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo stretchy="false">)</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">
g_{\text{human}}(y_t) = \text{await}\; h_{\text{human}}(y_t) \in \{\texttt{approve}, \texttt{reject}, \texttt{modify}(y_t&#x27;)\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">human</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">await</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">human</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord text"><span class="mord texttt">approve</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">reject</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord texttt">modify</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)}</span></span></span></span></span></eqn></section><p><strong>When to insert human gates:</strong></p>
<table>
<thead>
<tr>
<th>Criterion</th>
<th>Trigger Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>High-stakes output</strong></td>
<td>Financial transactions, legal documents, medical advice</td>
</tr>
<tr>
<td><strong>Low model confidence</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>confidence</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>τ</mi><mtext>human</mtext></msub></mrow><annotation encoding="application/x-tex">\text{confidence}(y_t) &lt; \tau_{\text{human}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">confidence</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">human</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq></td>
</tr>
<tr>
<td><strong>Novel situation</strong></td>
<td>Input is far from training distribution (OOD detection)</td>
</tr>
<tr>
<td><strong>Policy requirement</strong></td>
<td>Regulatory or compliance mandate</td>
</tr>
<tr>
<td><strong>Quality gate failure</strong></td>
<td>Automated retries exhausted without meeting threshold</td>
</tr>
</tbody>
</table>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HumanDecision</span>(<span class="hljs-title class_ inherited__">Enum</span>):
    APPROVE = <span class="hljs-string">&quot;approve&quot;</span>
    REJECT = <span class="hljs-string">&quot;reject&quot;</span>
    MODIFY = <span class="hljs-string">&quot;modify&quot;</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HumanReview</span>:
    decision: HumanDecision
    modified_output: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
    reviewer_notes: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;&quot;</span>
    reviewer_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;&quot;</span>
    timestamp: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;&quot;</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HumanInTheLoopGate</span>:
    <span class="hljs-string">&quot;&quot;&quot;Pause chain execution for human review and approval.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, review_queue: <span class="hljs-string">&quot;AsyncQueue&quot;</span>,
                 timeout_seconds: <span class="hljs-built_in">float</span> = <span class="hljs-number">3600</span>,
                 auto_approve_after_timeout: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>):
        <span class="hljs-variable language_">self</span>.review_queue = review_queue
        <span class="hljs-variable language_">self</span>.timeout = timeout_seconds
        <span class="hljs-variable language_">self</span>.auto_approve = auto_approve_after_timeout
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">request_review</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">dict</span>,
                              urgency: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;normal&quot;</span></span>) -&gt; HumanReview:
        <span class="hljs-string">&quot;&quot;&quot;Submit output for human review and wait for decision.&quot;&quot;&quot;</span>
        review_request = {
            <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-built_in">str</span>(uuid4()),
            <span class="hljs-string">&quot;output&quot;</span>: output,
            <span class="hljs-string">&quot;context&quot;</span>: context,
            <span class="hljs-string">&quot;urgency&quot;</span>: urgency,
            <span class="hljs-string">&quot;submitted_at&quot;</span>: datetime.utcnow().isoformat(),
            <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;pending&quot;</span>
        }
        
        <span class="hljs-comment"># Submit to review queue (webhook, Slack, email, dashboard)</span>
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.review_queue.put(review_request)
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Wait for human response</span>
            review = <span class="hljs-keyword">await</span> asyncio.wait_for(
                <span class="hljs-variable language_">self</span>._wait_for_decision(review_request[<span class="hljs-string">&quot;id&quot;</span>]),
                timeout=<span class="hljs-variable language_">self</span>.timeout
            )
            <span class="hljs-keyword">return</span> review
        <span class="hljs-keyword">except</span> asyncio.TimeoutError:
            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.auto_approve:
                <span class="hljs-keyword">return</span> HumanReview(
                    decision=HumanDecision.APPROVE,
                    reviewer_notes=<span class="hljs-string">&quot;Auto-approved after timeout&quot;</span>
                )
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> HumanReview(
                    decision=HumanDecision.REJECT,
                    reviewer_notes=<span class="hljs-string">f&quot;Rejected: no review within <span class="hljs-subst">{self.timeout}</span>s&quot;</span>
                )
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">gate</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span>, state: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Apply human-in-the-loop gate.&quot;&quot;&quot;</span>
        review = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.request_review(
            output=output,
            context={
                <span class="hljs-string">&quot;step&quot;</span>: state.get(<span class="hljs-string">&quot;step_index&quot;</span>),
                <span class="hljs-string">&quot;task&quot;</span>: state.get(<span class="hljs-string">&quot;query&quot;</span>),
                <span class="hljs-string">&quot;confidence&quot;</span>: state.get(<span class="hljs-string">&quot;confidence&quot;</span>, <span class="hljs-string">&quot;unknown&quot;</span>)
            }
        )
        
        <span class="hljs-keyword">if</span> review.decision == HumanDecision.APPROVE:
            <span class="hljs-keyword">return</span> output, {<span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;proceed&quot;</span>, <span class="hljs-string">&quot;reviewer&quot;</span>: review.reviewer_id}
        <span class="hljs-keyword">elif</span> review.decision == HumanDecision.MODIFY:
            <span class="hljs-keyword">return</span> review.modified_output, {
                <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;proceed_modified&quot;</span>,
                <span class="hljs-string">&quot;reviewer&quot;</span>: review.reviewer_id,
                <span class="hljs-string">&quot;notes&quot;</span>: review.reviewer_notes
            }
        <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># REJECT</span>
            <span class="hljs-keyword">return</span> output, {
                <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;abort&quot;</span>,
                <span class="hljs-string">&quot;reviewer&quot;</span>: review.reviewer_id,
                <span class="hljs-string">&quot;reason&quot;</span>: review.reviewer_notes
            }
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_wait_for_decision</span>(<span class="hljs-params">self, request_id: <span class="hljs-built_in">str</span></span>) -&gt; HumanReview:
        <span class="hljs-string">&quot;&quot;&quot;Poll or listen for a human decision on the given request.&quot;&quot;&quot;</span>
        <span class="hljs-comment"># Implementation depends on infrastructure:</span>
        <span class="hljs-comment"># - Webhook callback</span>
        <span class="hljs-comment"># - Database polling</span>
        <span class="hljs-comment"># - WebSocket subscription</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">&quot;Implement per deployment infrastructure&quot;</span>)
</code></pre>
</div><h3 id="1645-approval-workflows-within-chains" tabindex="-1">1.6.4.5 Approval Workflows Within Chains</h3>
<p>For complex enterprise applications, gates are organized into <strong>multi-stage approval workflows</strong> where different reviewers or validators must approve at different stages.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApprovalStage</span>:
    name: <span class="hljs-built_in">str</span>
    gate: <span class="hljs-type">Callable</span>  <span class="hljs-comment"># any gate type: quality, schema, safety, human</span>
    required: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># if False, failure is logged but doesn&#x27;t block</span>
    on_fail: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;retry&quot;</span>  <span class="hljs-comment"># retry | escalate | abort | skip</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApprovalWorkflow</span>:
    <span class="hljs-string">&quot;&quot;&quot;Multi-stage approval workflow embedded within a chain.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, stages: <span class="hljs-built_in">list</span>[ApprovalStage]</span>):
        <span class="hljs-variable language_">self</span>.stages = stages
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span>, state: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Execute all approval stages sequentially.&quot;&quot;&quot;</span>
        workflow_log = []
        current_output = output
        
        <span class="hljs-keyword">for</span> stage <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.stages:
            result_output, gate_result = <span class="hljs-keyword">await</span> stage.gate(current_output, state)
            
            stage_log = {
                <span class="hljs-string">&quot;stage&quot;</span>: stage.name,
                <span class="hljs-string">&quot;passed&quot;</span>: gate_result.get(<span class="hljs-string">&quot;passed&quot;</span>, gate_result.get(<span class="hljs-string">&quot;action&quot;</span>) == <span class="hljs-string">&quot;proceed&quot;</span>),
                <span class="hljs-string">&quot;details&quot;</span>: gate_result
            }
            workflow_log.append(stage_log)
            
            <span class="hljs-keyword">if</span> stage_log[<span class="hljs-string">&quot;passed&quot;</span>]:
                current_output = result_output
                <span class="hljs-keyword">continue</span>
            
            <span class="hljs-comment"># Handle failure</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> stage.required:
                <span class="hljs-comment"># Non-blocking gate: log and continue</span>
                stage_log[<span class="hljs-string">&quot;skipped&quot;</span>] = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">continue</span>
            
            <span class="hljs-keyword">if</span> stage.on_fail == <span class="hljs-string">&quot;abort&quot;</span>:
                <span class="hljs-keyword">return</span> current_output, {
                    <span class="hljs-string">&quot;workflow_passed&quot;</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">&quot;failed_at&quot;</span>: stage.name,
                    <span class="hljs-string">&quot;log&quot;</span>: workflow_log
                }
            <span class="hljs-keyword">elif</span> stage.on_fail == <span class="hljs-string">&quot;escalate&quot;</span>:
                <span class="hljs-keyword">return</span> current_output, {
                    <span class="hljs-string">&quot;workflow_passed&quot;</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">&quot;escalate&quot;</span>: <span class="hljs-literal">True</span>,
                    <span class="hljs-string">&quot;failed_at&quot;</span>: stage.name,
                    <span class="hljs-string">&quot;log&quot;</span>: workflow_log
                }
            <span class="hljs-comment"># &quot;retry&quot; is handled within the gate itself</span>
        
        <span class="hljs-keyword">return</span> current_output, {
            <span class="hljs-string">&quot;workflow_passed&quot;</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">&quot;log&quot;</span>: workflow_log
        }


<span class="hljs-comment"># --- Example: Document Generation Approval Workflow ---</span>

workflow = ApprovalWorkflow(stages=[
    ApprovalStage(
        name=<span class="hljs-string">&quot;schema_check&quot;</span>,
        gate=schema_gate.gate,
        required=<span class="hljs-literal">True</span>,
        on_fail=<span class="hljs-string">&quot;retry&quot;</span>
    ),
    ApprovalStage(
        name=<span class="hljs-string">&quot;factuality_check&quot;</span>,
        gate=factuality_gate.validate_as_gate,
        required=<span class="hljs-literal">True</span>,
        on_fail=<span class="hljs-string">&quot;retry&quot;</span>
    ),
    ApprovalStage(
        name=<span class="hljs-string">&quot;safety_check&quot;</span>,
        gate=safety_gate.validate_as_gate,
        required=<span class="hljs-literal">True</span>,
        on_fail=<span class="hljs-string">&quot;abort&quot;</span>  <span class="hljs-comment"># safety violations are non-negotiable</span>
    ),
    ApprovalStage(
        name=<span class="hljs-string">&quot;quality_review&quot;</span>,
        gate=quality_gate.gate,
        required=<span class="hljs-literal">True</span>,
        on_fail=<span class="hljs-string">&quot;retry&quot;</span>
    ),
    ApprovalStage(
        name=<span class="hljs-string">&quot;human_approval&quot;</span>,
        gate=human_gate.gate,
        required=<span class="hljs-literal">True</span>,
        on_fail=<span class="hljs-string">&quot;escalate&quot;</span>
    )
])
</code></pre>
</div><h3 id="1646-gate-as-a-binary-classifier-formal-analysis" tabindex="-1">1.6.4.6 Gate as a Binary Classifier — Formal Analysis</h3>
<p>Treating the gate <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span></eq> as a binary classifier enables rigorous analysis using standard classification metrics.</p>
<p><strong>Definition.</strong> Let <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>:</mo><mi mathvariant="script">Y</mi><mo>→</mo><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">g: \mathcal{Y} \rightarrow \{0, 1\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">}</span></span></span></span></eq>where<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">g(y) = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></eq>means PASS and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">g(y) = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></eq>means FAIL. Let<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">y^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8831em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></eq> be the ground-truth quality label (1 = genuinely good output, 0 = genuinely bad output).</p>
<p><strong>Confusion matrix:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnalign="center center center" columnlines="solid none" columnspacing="1em" rowlines="solid none"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn><mtext>  </mtext><mo stretchy="false">(</mo><mtext>PASS</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn><mtext>  </mtext><mo stretchy="false">(</mo><mtext>FAIL</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><mn>1</mn><mtext>  </mtext><mo stretchy="false">(</mo><mtext>good</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True Positive (TP)</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>False Negative (FN)</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><mn>0</mn><mtext>  </mtext><mo stretchy="false">(</mo><mtext>bad</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>False Positive (FP)</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True Negative (TN)</mtext></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{array}{c|cc}
 &amp; g(y) = 1 \; (\text{PASS}) &amp; g(y) = 0 \; (\text{FAIL}) \\
\hline
y^* = 1 \; (\text{good}) &amp; \text{True Positive (TP)} &amp; \text{False Negative (FN)} \\
y^* = 0 \; (\text{bad}) &amp; \text{False Positive (FP)} &amp; \text{True Negative (TN)}
\end{array}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:4.05em;"></span><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">good</span></span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">bad</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="vertical-separator" style="height:3.6em;border-right-width:0.04em;border-right-style:solid;margin:0 -0.02em;vertical-align:-1.55em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">PASS</span></span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">True Positive (TP)</span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">False Positive (FP)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">FAIL</span></span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">False Negative (FN)</span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">True Negative (TN)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span style="top:-4.9em;"><span class="pstrut" style="height:4.05em;"></span><span class="hline" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></eqn></section><p><strong>Critical metrics for gates:</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
<th>Interpretation for Gates</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Precision</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>P</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{TP}{TP + FP}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2757em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">TP</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">FP</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">TP</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Of outputs that pass the gate, what fraction are truly good?</td>
</tr>
<tr>
<td><strong>Recall</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{TP}{TP + FN}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2757em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">TP</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">FN</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">TP</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Of truly good outputs, what fraction does the gate let through?</td>
</tr>
<tr>
<td><strong>False Pass Rate</strong> (FPR)</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>F</mi><mi>P</mi></mrow><mrow><mi>F</mi><mi>P</mi><mo>+</mo><mi>T</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{FP}{FP + TN}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2757em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">FP</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">TN</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">FP</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Fraction of bad outputs that incorrectly pass (most dangerous)</td>
</tr>
<tr>
<td><strong>False Block Rate</strong> (FNR)</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>F</mi><mi>N</mi></mrow><mrow><mi>F</mi><mi>N</mi><mo>+</mo><mi>T</mi><mi>P</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{FN}{FN + TP}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2757em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">FN</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">TP</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">FN</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Fraction of good outputs incorrectly blocked (wastes compute)</td>
</tr>
</tbody>
</table>
<p><strong>The fundamental gate trade-off:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>τ</mi><mo>↑</mo><mtext>  </mtext><mo>⇒</mo><mtext>  </mtext><mtext>FPR</mtext><mo>↓</mo><mo separator="true">,</mo><mtext>  </mtext><mtext>FNR</mtext><mo>↑</mo><mspace width="1em"/><mo stretchy="false">(</mo><mtext>stricter gate: fewer bad pass, more good blocked</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\tau \uparrow \;\Rightarrow\; \text{FPR} \downarrow,\; \text{FNR} \uparrow \quad (\text{stricter gate: fewer bad pass, more good blocked})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">↑</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">FPR</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">↓</span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">FNR</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">↑</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">stricter gate: fewer bad pass, more good blocked</span></span><span class="mclose">)</span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>τ</mi><mo>↓</mo><mtext>  </mtext><mo>⇒</mo><mtext>  </mtext><mtext>FPR</mtext><mo>↑</mo><mo separator="true">,</mo><mtext>  </mtext><mtext>FNR</mtext><mo>↓</mo><mspace width="1em"/><mo stretchy="false">(</mo><mtext>lenient gate: more bad pass, fewer good blocked</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\tau \downarrow \;\Rightarrow\; \text{FPR} \uparrow,\; \text{FNR} \downarrow \quad (\text{lenient gate: more bad pass, fewer good blocked})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">↓</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">FPR</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">↑</span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">FNR</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">↓</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">lenient gate: more bad pass, fewer good blocked</span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p><strong>Optimal threshold selection.</strong> The optimal <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>τ</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">\tau^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></eq> minimizes expected cost:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>τ</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><mi>τ</mi></munder><mtext>  </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mtext> </mtext><msub><mi>c</mi><mtext>FP</mtext></msub><mo>⋅</mo><mtext>FPR</mtext><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>c</mi><mtext>FN</mtext></msub><mo>⋅</mo><mtext>FNR</mtext><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">
\tau^* = \arg\min_\tau \; \bigl[\, c_{\text{FP}} \cdot \text{FPR}(\tau) + c_{\text{FN}} \cdot \text{FNR}(\tau) \,\bigr]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7387em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.55em;vertical-align:-0.7em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen"><span class="delimsizing size1">[</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FP</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FPR</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FN</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">FNR</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">]</span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mtext>FP</mtext></msub></mrow><annotation encoding="application/x-tex">c_{\text{FP}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FP</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>is the cost of passing a bad output (user-facing error, reputational damage) and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mtext>FN</mtext></msub></mrow><annotation encoding="application/x-tex">c_{\text{FN}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FN</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> is the cost of blocking a good output (retry cost, latency).</p>
<p>In high-stakes applications (medical, legal, financial): <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mtext>FP</mtext></msub><mo>≫</mo><msub><mi>c</mi><mtext>FN</mtext></msub></mrow><annotation encoding="application/x-tex">c_{\text{FP}} \gg c_{\text{FN}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FP</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≫</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FN</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>, so set <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></eq> high.
In low-stakes applications (creative writing, brainstorming): <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mtext>FP</mtext></msub><mo>≈</mo><msub><mi>c</mi><mtext>FN</mtext></msub></mrow><annotation encoding="application/x-tex">c_{\text{FP}} \approx c_{\text{FN}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6331em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FP</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">FN</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>, so set <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></eq> moderate.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GateAnalyzer</span>:
    <span class="hljs-string">&quot;&quot;&quot;Analyze gate performance using classification metrics.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.predictions: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">bool</span>] = []  <span class="hljs-comment"># gate decisions</span>
        <span class="hljs-variable language_">self</span>.ground_truth: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">bool</span>] = []  <span class="hljs-comment"># actual quality (from human review)</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">record</span>(<span class="hljs-params">self, gate_passed: <span class="hljs-built_in">bool</span>, actually_good: <span class="hljs-built_in">bool</span></span>):
        <span class="hljs-variable language_">self</span>.predictions.append(gate_passed)
        <span class="hljs-variable language_">self</span>.ground_truth.append(actually_good)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_metrics</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">dict</span>:
        tp = <span class="hljs-built_in">sum</span>(p <span class="hljs-keyword">and</span> g <span class="hljs-keyword">for</span> p, g <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.predictions, <span class="hljs-variable language_">self</span>.ground_truth))
        fp = <span class="hljs-built_in">sum</span>(p <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> g <span class="hljs-keyword">for</span> p, g <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.predictions, <span class="hljs-variable language_">self</span>.ground_truth))
        fn = <span class="hljs-built_in">sum</span>(<span class="hljs-keyword">not</span> p <span class="hljs-keyword">and</span> g <span class="hljs-keyword">for</span> p, g <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.predictions, <span class="hljs-variable language_">self</span>.ground_truth))
        tn = <span class="hljs-built_in">sum</span>(<span class="hljs-keyword">not</span> p <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> g <span class="hljs-keyword">for</span> p, g <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.predictions, <span class="hljs-variable language_">self</span>.ground_truth))
        
        precision = tp / <span class="hljs-built_in">max</span>(tp + fp, <span class="hljs-number">1</span>)
        recall = tp / <span class="hljs-built_in">max</span>(tp + fn, <span class="hljs-number">1</span>)
        fpr = fp / <span class="hljs-built_in">max</span>(fp + tn, <span class="hljs-number">1</span>)
        fnr = fn / <span class="hljs-built_in">max</span>(fn + tp, <span class="hljs-number">1</span>)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;precision&quot;</span>: precision,
            <span class="hljs-string">&quot;recall&quot;</span>: recall,
            <span class="hljs-string">&quot;false_pass_rate&quot;</span>: fpr,
            <span class="hljs-string">&quot;false_block_rate&quot;</span>: fnr,
            <span class="hljs-string">&quot;f1&quot;</span>: <span class="hljs-number">2</span> * precision * recall / <span class="hljs-built_in">max</span>(precision + recall, <span class="hljs-number">1e-8</span>),
            <span class="hljs-string">&quot;total_samples&quot;</span>: <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.predictions),
            <span class="hljs-string">&quot;confusion_matrix&quot;</span>: {<span class="hljs-string">&quot;TP&quot;</span>: tp, <span class="hljs-string">&quot;FP&quot;</span>: fp, <span class="hljs-string">&quot;FN&quot;</span>: fn, <span class="hljs-string">&quot;TN&quot;</span>: tn}
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">suggest_threshold</span>(<span class="hljs-params">self, cost_false_pass: <span class="hljs-built_in">float</span>, 
                           cost_false_block: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">&quot;&quot;&quot;Suggest optimal threshold based on asymmetric costs.&quot;&quot;&quot;</span>
        <span class="hljs-comment"># Theoretical: threshold where marginal cost of FP = marginal cost of FN</span>
        <span class="hljs-comment"># Approximation: bias toward strictness when FP cost is high</span>
        ratio = cost_false_pass / (cost_false_pass + cost_false_block)
        <span class="hljs-keyword">return</span> ratio  <span class="hljs-comment"># higher ratio → higher (stricter) threshold</span>
</code></pre>
</div><hr>
<h2 id="summary-routing-and-gating-decision-framework" tabindex="-1">Summary: Routing and Gating Decision Framework</h2>
<table>
<thead>
<tr>
<th>Decision</th>
<th>Criteria</th>
<th>Recommended Approach</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Routing type</strong></td>
<td>Input categories are well-defined and stable?</td>
<td><strong>Static</strong> (regex, keyword, threshold)</td>
</tr>
<tr>
<td></td>
<td>Categories are fuzzy or evolving?</td>
<td><strong>Dynamic</strong> (embedding or LLM-based)</td>
</tr>
<tr>
<td></td>
<td>Multiple routing signals available?</td>
<td><strong>Ensemble</strong> (weighted voting)</td>
</tr>
<tr>
<td><strong>Routing dimension</strong></td>
<td>What does the user want?</td>
<td><strong>Intent</strong> router</td>
</tr>
<tr>
<td></td>
<td>What is the topic?</td>
<td><strong>Topic</strong> router (embedding-based)</td>
</tr>
<tr>
<td></td>
<td>How hard is the task?</td>
<td><strong>Complexity</strong> router</td>
</tr>
<tr>
<td></td>
<td>Which model should handle it?</td>
<td><strong>Model selector</strong> router</td>
</tr>
<tr>
<td></td>
<td>What if everything fails?</td>
<td><strong>Escalation</strong> router with fallback</td>
</tr>
<tr>
<td><strong>Gate type</strong></td>
<td>Output must match a specific structure?</td>
<td><strong>Schema</strong> validation gate</td>
</tr>
<tr>
<td></td>
<td>Output must be factually grounded?</td>
<td><strong>Factuality</strong> gate</td>
</tr>
<tr>
<td></td>
<td>Output must be safe/compliant?</td>
<td><strong>Safety</strong> gate (hard block on violation)</td>
</tr>
<tr>
<td></td>
<td>High-stakes or uncertain output?</td>
<td><strong>Human-in-the-loop</strong> gate</td>
</tr>
<tr>
<td></td>
<td>Multiple gate dimensions?</td>
<td><strong>Approval workflow</strong> (sequential multi-gate)</td>
</tr>
<tr>
<td><strong>Threshold calibration</strong></td>
<td>High cost of bad output reaching user?</td>
<td>High <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></eq> (strict) — prioritize precision</td>
</tr>
<tr>
<td></td>
<td>High cost of unnecessary retries?</td>
<td>Low <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></eq> (lenient) — prioritize recall</td>
</tr>
<tr>
<td></td>
<td>Both costs balanced?</td>
<td>Optimize <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>τ</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">\tau^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></eq> via cost-weighted objective</td>
</tr>
</tbody>
</table>

      </article>
      <section class="doc-pager" aria-label="Document pagination">
        <a class="pager-link" href="../Agentic_ai/Real-World_applications_and_case_studies.html"><small>Previous</small><strong>1.15 Real-World Applications and Case Studies</strong></a>
        <a class="pager-link" href="../Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind.html"><small>Next</small><strong>1.14 Security, Safety, and Guardrails in Prompt Chains</strong></a>
      </section>
      <footer class="doc-footer">
        <p>Generated from <code>llm_training_at_scale</code> at <time datetime="2026-02-19T19:13:56.962Z">2026-02-19T19:13:56.962Z</time>.</p>
      </footer>
    </main>
    <aside class="toc-pane">
      <p class="pane-label">On This Page</p>
      <nav class="toc-nav" aria-label="Table of contents">
<a class="toc-link toc-level-2" data-toc-link href="#161-static-routing">1.6.1 Static Routing</a>
<a class="toc-link toc-level-3" data-toc-link href="#1611-foundational-definition">1.6.1.1 Foundational Definition</a>
<a class="toc-link toc-level-3" data-toc-link href="#1612-predefined-conditional-branches">1.6.1.2 Predefined Conditional Branches</a>
<a class="toc-link toc-level-3" data-toc-link href="#1613-rule-based-routing-regex-keyword-threshold">1.6.1.3 Rule-Based Routing (Regex, Keyword, Threshold)</a>
<a class="toc-link toc-level-4" data-toc-link href="#a-keyword-based-routing">A. Keyword-Based Routing</a>
<a class="toc-link toc-level-4" data-toc-link href="#b-regex-based-routing">B. Regex-Based Routing</a>
<a class="toc-link toc-level-4" data-toc-link href="#c-threshold-based-routing">C. Threshold-Based Routing</a>
<a class="toc-link toc-level-3" data-toc-link href="#1614-deterministic-path-selection-formal-properties">1.6.1.4 Deterministic Path Selection — Formal Properties</a>
<a class="toc-link toc-level-2" data-toc-link href="#162-dynamic-semantic-routing">1.6.2 Dynamic / Semantic Routing</a>
<a class="toc-link toc-level-3" data-toc-link href="#1621-foundational-motivation">1.6.2.1 Foundational Motivation</a>
<a class="toc-link toc-level-3" data-toc-link href="#1622-llm-as-a-router-classification-prompt">1.6.2.2 LLM-as-a-Router: Classification Prompt</a>
<a class="toc-link toc-level-3" data-toc-link href="#1623-embedding-based-routing">1.6.2.3 Embedding-Based Routing</a>
<a class="toc-link toc-level-3" data-toc-link href="#1624-confidence-based-routing">1.6.2.4 Confidence-Based Routing</a>
<a class="toc-link toc-level-3" data-toc-link href="#1625-multi-class-routing-with-softmax-over-chain-paths">1.6.2.5 Multi-Class Routing with Softmax over Chain Paths</a>
<a class="toc-link toc-level-3" data-toc-link href="#1626-ensemble-routing-multiple-classifiers-voting">1.6.2.6 Ensemble Routing (Multiple Classifiers Voting)</a>
<a class="toc-link toc-level-2" data-toc-link href="#163-routing-architectures">1.6.3 Routing Architectures</a>
<a class="toc-link toc-level-3" data-toc-link href="#1631-architecture-taxonomy">1.6.3.1 Architecture Taxonomy</a>
<a class="toc-link toc-level-3" data-toc-link href="#1632-intent-classification-routers">1.6.3.2 Intent Classification Routers</a>
<a class="toc-link toc-level-3" data-toc-link href="#1633-topic-based-routers">1.6.3.3 Topic-Based Routers</a>
<a class="toc-link toc-level-3" data-toc-link href="#1634-complexity-based-routers">1.6.3.4 Complexity-Based Routers</a>
<a class="toc-link toc-level-3" data-toc-link href="#1635-model-selection-routers">1.6.3.5 Model-Selection Routers</a>
<a class="toc-link toc-level-3" data-toc-link href="#1636-fallback-routing-and-escalation-paths">1.6.3.6 Fallback Routing and Escalation Paths</a>
<a class="toc-link toc-level-3" data-toc-link href="#1637-composite-routing-architecture">1.6.3.7 Composite Routing Architecture</a>
<a class="toc-link toc-level-2" data-toc-link href="#164-gate-mechanisms">1.6.4 Gate Mechanisms</a>
<a class="toc-link toc-level-3" data-toc-link href="#1641-foundational-definition">1.6.4.1 Foundational Definition</a>
<a class="toc-link toc-level-3" data-toc-link href="#1642-quality-gates-between-chain-steps">1.6.4.2 Quality Gates Between Chain Steps</a>
<a class="toc-link toc-level-3" data-toc-link href="#1643-validation-gates-schema-factuality-safety">1.6.4.3 Validation Gates (Schema, Factuality, Safety)</a>
<a class="toc-link toc-level-4" data-toc-link href="#a-schema-validation-gate">A. Schema Validation Gate</a>
<a class="toc-link toc-level-4" data-toc-link href="#b-factuality-validation-gate">B. Factuality Validation Gate</a>
<a class="toc-link toc-level-4" data-toc-link href="#c-safety-validation-gate">C. Safety Validation Gate</a>
<a class="toc-link toc-level-3" data-toc-link href="#1644-human-in-the-loop-gates">1.6.4.4 Human-in-the-Loop Gates</a>
<a class="toc-link toc-level-3" data-toc-link href="#1645-approval-workflows-within-chains">1.6.4.5 Approval Workflows Within Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#1646-gate-as-a-binary-classifier-formal-analysis">1.6.4.6 Gate as a Binary Classifier — Formal Analysis</a>
<a class="toc-link toc-level-2" data-toc-link href="#summary-routing-and-gating-decision-framework">Summary: Routing and Gating Decision Framework</a>
      </nav>
    </aside>
  </div>
  <script type="module" src="../assets/app.js?v=2026-02-19T19%3A13%3A56.962Z"></script>
</body>
</html>