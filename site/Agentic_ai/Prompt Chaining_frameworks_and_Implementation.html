<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Prompt Chaining: Frameworks, Observability, Evaluation, Security, Applications, and Paradigm Comparisons">
  <title>Prompt Chaining: Frameworks, Observability, Evaluation, Security, Applications, and Paradigm Comparisons | AI Engineering Knowledge Hub</title>
  <script>
  (() => {
    try {
      const key = "docs-theme-mode";
      const raw = window.localStorage.getItem(key);
      const mode = raw === "graphite" || raw === "ivory" ? raw : "ivory";
      document.documentElement.dataset.theme = mode;
      document.documentElement.style.colorScheme = mode === "graphite" ? "dark" : "light";
    } catch {
      document.documentElement.dataset.theme = "ivory";
      document.documentElement.style.colorScheme = "light";
    }
  })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="../assets/vendor/katex/katex.min.css?v=2026-02-19T19%3A13%3A56.962Z">
  <link rel="stylesheet" href="../assets/styles.css?v=2026-02-19T19%3A13%3A56.962Z">
</head>
<body>
  <div class="ambient-layer ambient-layer-a" aria-hidden="true"></div>
  <div class="ambient-layer ambient-layer-b" aria-hidden="true"></div>
  <header class="topbar">
    <button id="menu-toggle" class="icon-btn" type="button" aria-label="Toggle navigation">Menu</button>
    <a class="brand" href="../index.html">
      <span class="brand-kicker">Docs</span>
      <strong>AI Engineering Knowledge Hub</strong>
    </a>
    <div class="topbar-actions">
      <input id="nav-filter" class="doc-filter" type="search" placeholder="Filter documents" aria-label="Filter documents">
      <p id="filter-status" class="filter-status" aria-live="polite"></p>
      <button id="theme-toggle" class="icon-btn" type="button" aria-label="Switch theme">Graphite</button>
    </div>
  </header>
  <div class="site-shell">
    <aside class="nav-pane" id="left-nav">
      <p class="pane-label">Source Folder</p>
      <p class="pane-title">llm_training_at_scale</p>
      <nav class="doc-nav" aria-label="Document list">
<a class="doc-link" data-doc-link data-doc-title="1.10 advanced prompt chaining techniques" data-doc-path="agentic_ai/advanced_prompt_chaining_techniques" data-doc-folder="agentic_ai" href="../Agentic_ai/Advanced_prompt_chaining_techniques.html"><span>1.10 Advanced Prompt Chaining Techniques</span><small>Agentic_ai/Advanced_prompt_chaining_techniques</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/architecture_and_design_patterns_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Architecture_and_design_patterns_of_prompt_chains.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Architecture_and_design_patterns_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.7 error handling, robustness, and fault tolerance" data-doc-path="agentic_ai/error_handling_robustness_and_fault_tolerance" data-doc-folder="agentic_ai" href="../Agentic_ai/Error_handling_robustness_and_fault_tolerance.html"><span>1.7 Error Handling, Robustness, and Fault Tolerance</span><small>Agentic_ai/Error_handling_robustness_and_fault_tolerance</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.13 evaluation of prompt chains" data-doc-path="agentic_ai/evaluation_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Evaluation_of_prompt_chains.html"><span>1.13 Evaluation of Prompt Chains</span><small>Agentic_ai/Evaluation_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive treatment" data-doc-path="agentic_ai/foundations_of_prompt_chaining" data-doc-folder="agentic_ai" href="../Agentic_ai/Foundations_of_prompt_chaining.html"><span>Chapter 1: Prompt Chaining — Comprehensive Treatment</span><small>Agentic_ai/Foundations_of_prompt_chaining</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.9 optimization of prompt chains" data-doc-path="agentic_ai/optimization_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Optimization_of_prompt_chains.html"><span>1.9 Optimization of Prompt Chains</span><small>Agentic_ai/Optimization_of_prompt_chains</small></a>
<a class="doc-link is-active" data-doc-link data-doc-title="prompt chaining: frameworks, observability, evaluation, security, applications, and paradigm comparisons" data-doc-path="agentic_ai/prompt chaining_frameworks_and_implementation" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt Chaining_frameworks_and_Implementation.html"><span>Prompt Chaining: Frameworks, Observability, Evaluation, Security, Applications, and Paradigm Comparisons</span><small>Agentic_ai/Prompt Chaining_frameworks_and_Implementation</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive index" data-doc-path="agentic_ai/prompt_chaining_index" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_Chaining_index.html"><span>Chapter 1: Prompt Chaining — Comprehensive Index</span><small>Agentic_ai/Prompt_Chaining_index</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.16 prompt chaining vs. related paradigms" data-doc-path="agentic_ai/prompt_chaining_vs_related_paradigm" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_chaining_vs_related_paradigm.html"><span>1.16 Prompt Chaining vs. Related Paradigms</span><small>Agentic_ai/Prompt_chaining_vs_related_paradigm</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/prompt_design_for_chain_steps" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_design_for_chain_steps.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Prompt_design_for_chain_steps</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.15 real-world applications and case studies" data-doc-path="agentic_ai/real-world_applications_and_case_studies" data-doc-folder="agentic_ai" href="../Agentic_ai/Real-World_applications_and_case_studies.html"><span>1.15 Real-World Applications and Case Studies</span><small>Agentic_ai/Real-World_applications_and_case_studies</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.6 routing and conditional logic in chains" data-doc-path="agentic_ai/routing_and_conditional_logic_in_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Routing_and_conditional_logic_in_chains.html"><span>1.6 Routing and Conditional Logic in Chains</span><small>Agentic_ai/Routing_and_conditional_logic_in_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.14 security, safety, and guardrails in prompt chains" data-doc-path="agentic_ai/security_safety_and_guardrails_in_prompt_chaind" data-doc-folder="agentic_ai" href="../Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind.html"><span>1.14 Security, Safety, and Guardrails in Prompt Chains</span><small>Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.4 state management and context propagation" data-doc-path="agentic_ai/state_management_and_context_propagation" data-doc-folder="agentic_ai" href="../Agentic_ai/State_management_and_context_propagation.html"><span>1.4 State Management and Context Propagation</span><small>Agentic_ai/State_management_and_context_propagation</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.5 task decomposition strategies" data-doc-path="agentic_ai/task_decomposition_strategies" data-doc-folder="agentic_ai" href="../Agentic_ai/Task_decomposition_strategies.html"><span>1.5 Task Decomposition Strategies</span><small>Agentic_ai/Task_decomposition_strategies</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/documentation_mcp_mcp_for_agent_security" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/introduction_tools_action" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Introduction_Tools_Action.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Introduction_Tools_Action</small></a>
<a class="doc-link" data-doc-link data-doc-title="2.6 security in mcp" data-doc-path="agentic_ai/tools/security_mcp_conclusion" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Security_MCP_conclusion.html"><span>2.6 Security in MCP</span><small>Agentic_ai/Tools/Security_MCP_conclusion</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota index" data-doc-path="agentic_ai/tools/tools_comprehensive_index" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Tools_comprehensive_Index.html"><span>Chapter 2: Tools — Comprehensive SOTA Index</span><small>Agentic_ai/Tools/Tools_comprehensive_Index</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.8 verification, validation, and quality control" data-doc-path="agentic_ai/verification_validation_and_quality_control" data-doc-folder="agentic_ai" href="../Agentic_ai/Verification_validation_and_quality_control.html"><span>1.8 Verification, Validation, and Quality Control</span><small>Agentic_ai/Verification_validation_and_quality_control</small></a>
<a class="doc-link" data-doc-link data-doc-title="context parallelism and ring attention" data-doc-path="context_parallelism_update" data-doc-folder="root" href="../context_parallelism_update.html"><span>Context Parallelism and Ring Attention</span><small>context_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="context_parallelism" data-doc-folder="root" href="../context_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>context_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism: a comprehensive technical treatment" data-doc-path="data_parallelism_basic" data-doc-folder="root" href="../data_parallelism_basic.html"><span>Data Parallelism: A Comprehensive Technical Treatment</span><small>data_parallelism_basic</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism (dp): a comprehensive technical treatment" data-doc-path="data_parallelism" data-doc-folder="root" href="../data_parallelism.html"><span>Data Parallelism (DP): A Comprehensive Technical Treatment</span><small>data_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="finding the best training configuration for distributed large model training" data-doc-path="distributed_large_model_training" data-doc-folder="root" href="../distributed_large_model_training.html"><span>Finding the Best Training Configuration for Distributed Large Model Training</span><small>distributed_large_model_training</small></a>
<a class="doc-link" data-doc-link data-doc-title="diving into the gpus — fusing, threading, and mixing" data-doc-path="diving_gpus_fusing_threading_and_mixing" data-doc-folder="root" href="../diving_gpus_fusing_threading_and_mixing.html"><span>Diving into the GPUs — Fusing, Threading, and Mixing</span><small>diving_gpus_fusing_threading_and_mixing</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism_update" data-doc-folder="root" href="../expert_parallelism_update.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism" data-doc-folder="root" href="../expert_parallelism.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="scaling distributed training: foundations and first principles" data-doc-path="high_level_overview_updated" data-doc-folder="root" href="../high_level_overview_updated.html"><span>Scaling Distributed Training: Foundations and First Principles</span><small>high_level_overview_updated</small></a>
<a class="doc-link" data-doc-link data-doc-title="high-level overview of distributed training: foundations, memory analysis, and first-step techniques" data-doc-path="high_level_overview" data-doc-folder="root" href="../high_level_overview.html"><span>High-Level Overview of Distributed Training: Foundations, Memory Analysis, and First-Step Techniques</span><small>high_level_overview</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: comprehensive technical exposition" data-doc-path="pipelineparallelism_update" data-doc-folder="root" href="../pipelineparallelism_update.html"><span>Pipeline Parallelism: Comprehensive Technical Exposition</span><small>pipelineparallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: a comprehensive technical exposition" data-doc-path="pipelineparallelism" data-doc-folder="root" href="../pipelineparallelism.html"><span>Pipeline Parallelism: A Comprehensive Technical Exposition</span><small>pipelineparallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism_update" data-doc-folder="root" href="../tensor_parallelism_update.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism" data-doc-folder="root" href="../tensor_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism</small></a>
      </nav>
    </aside>
    <main class="content-pane">
      <article class="doc-content">
<h1 id="prompt-chaining-frameworks-observability-evaluation-security-applications-and-paradigm-comparisons" tabindex="-1">Prompt Chaining: Frameworks, Observability, Evaluation, Security, Applications, and Paradigm Comparisons</h1>
<hr>
<h2 id="111-prompt-chaining-frameworks-and-implementation" tabindex="-1">1.11 Prompt Chaining Frameworks and Implementation</h2>
<h3 id="1111-framework-landscape" tabindex="-1">1.11.1 Framework Landscape</h3>
<p>Prompt chaining frameworks abstract the orchestration of multi-step LLM workflows into composable, reusable, and observable software primitives. The design philosophy of each framework reflects distinct assumptions about the nature of chain composition, optimization, and deployment.</p>
<h4 id="taxonomy-of-design-philosophies" tabindex="-1">Taxonomy of Design Philosophies</h4>
<table>
<thead>
<tr>
<th>Framework</th>
<th>Core Abstraction</th>
<th>Composition Model</th>
<th>Optimization Strategy</th>
<th>Primary Strength</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LangChain (LCEL)</strong></td>
<td>Runnable</td>
<td>Pipe operator / DAG</td>
<td>Manual</td>
<td>Ecosystem breadth, rapid prototyping</td>
</tr>
<tr>
<td><strong>LlamaIndex</strong></td>
<td>QueryPipeline</td>
<td>DAG with typed links</td>
<td>Index-aware</td>
<td>Retrieval-centric workflows</td>
</tr>
<tr>
<td><strong>Semantic Kernel</strong></td>
<td>Kernel + Plugins</td>
<td>Planner-driven</td>
<td>AI-assisted planning</td>
<td>Enterprise .NET/Python integration</td>
</tr>
<tr>
<td><strong>Haystack</strong></td>
<td>Pipeline + Component</td>
<td>DAG (explicit wiring)</td>
<td>Component-level</td>
<td>Production NLP pipelines</td>
</tr>
<tr>
<td><strong>DSPy</strong></td>
<td>Module + Signature</td>
<td>Programmatic composition</td>
<td>Compiler-based (teleprompters)</td>
<td>Automated prompt optimization</td>
</tr>
<tr>
<td><strong>Anthropic Patterns</strong></td>
<td>Constitutional chains</td>
<td>Sequential with checks</td>
<td>Safety-oriented</td>
<td>Alignment-aware chaining</td>
</tr>
<tr>
<td><strong>OpenAI Function Calling</strong></td>
<td>Function schema</td>
<td>Tool-augmented sequential</td>
<td>Schema-validated</td>
<td>Structured output extraction</td>
</tr>
</tbody>
</table>
<h4 id="architectural-invariants-across-frameworks" tabindex="-1">Architectural Invariants Across Frameworks</h4>
<p>Every framework, regardless of API surface, must solve five fundamental problems:</p>
<ol>
<li><strong>Step Abstraction</strong>: Encapsulate each chain step behind a uniform interface that accepts typed input and produces typed output.</li>
<li><strong>Composition Algebra</strong>: Define operators (sequential, parallel, conditional, iterative) that combine steps into compound structures while preserving type safety.</li>
<li><strong>State Management</strong>: Propagate intermediate results, metadata, and execution context across steps without leaking implementation details.</li>
<li><strong>Error Semantics</strong>: Specify how failures at individual steps propagate, whether the chain retries, falls back, or terminates.</li>
<li><strong>Observability Hooks</strong>: Instrument every step boundary with tracing, logging, and metrics emission points.</li>
</ol>
<p>Formally, a framework defines a <strong>chain algebra</strong> <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">C</mi><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="script">S</mi><mo separator="true">,</mo><mo>∘</mo><mo separator="true">,</mo><mi mathvariant="normal">∥</mi><mo separator="true">,</mo><mo>▹</mo><mo separator="true">,</mo><mo>↺</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{C} = (\mathcal{S}, \circ, \|, \triangleright, \circlearrowleft)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.05834em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathcal" style="margin-right:0.075em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∘</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∥</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">▹</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">↺</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">)</span></span></span></span></eq> where:</p>
<ul>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">S</mi></mrow><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.075em;">S</span></span></span></span></eq> is the set of all valid chain steps</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∘</mo></mrow><annotation encoding="application/x-tex">\circ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord">∘</span></span></span></span></eq>is sequential composition:<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>s</mi><mn>1</mn></msub><mo>∘</mo><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s_1 \circ s_2)(x) = s_2(s_1(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></eq></li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span></span></span></span></eq>is parallel composition:<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>s</mi><mn>1</mn></msub><mi mathvariant="normal">∥</mi><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s_1 \| s_2)(x) = (s_1(x), s_2(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∥</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></eq></li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>▹</mo></mrow><annotation encoding="application/x-tex">\triangleright</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4653em;"></span><span class="mord">▹</span></span></span></span></eq>is conditional branching:<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>s</mi><mn>1</mn></msub><msub><mo>▹</mo><mi>p</mi></msub><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">(s_1 \triangleright_{p} s_2)(x) = \begin{cases} s_1(x) &amp; \text{if } p(x) \\ s_2(x) &amp; \text{otherwise} \end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin"><span class="mbin">▹</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↺</mo></mrow><annotation encoding="application/x-tex">\circlearrowleft</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.664em;vertical-align:-0.082em;"></span><span class="mrel amsrm">↺</span></span></span></span></eq>is iterative composition:<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>s</mi><mo lspace="0em" rspace="0em">↺</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>s</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s^{\circlearrowleft}(x) = s^{(n)}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0204em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7704em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel amsrm mtight">↺</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq>where<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">{</mo><mi>k</mi><mo>:</mo><mtext>term</mtext><mo stretchy="false">(</mo><msup><mi>s</mi><mrow><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">n = \min\{k : \text{term}(s^{(k)}(x))\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">term</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))}</span></span></span></span></eq></li>
</ul>
<hr>
<h3 id="1112-langchain-expression-language-lcel" tabindex="-1">1.11.2 LangChain Expression Language (LCEL)</h3>
<p>LCEL is LangChain’s declarative composition layer that transforms chain construction from imperative class instantiation into algebraic expression building. It implements the <strong>Runnable protocol</strong>—a universal interface that every chain component implements.</p>
<h4 id="the-runnable-interface" tabindex="-1">The Runnable Interface</h4>
<p>Every LCEL component implements a minimal interface with three execution modes:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypeVar, <span class="hljs-type">List</span>, AsyncIterator, <span class="hljs-type">Optional</span>

Input = TypeVar(<span class="hljs-string">&quot;Input&quot;</span>)
Output = TypeVar(<span class="hljs-string">&quot;Output&quot;</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Runnable</span>(ABC, <span class="hljs-type">Generic</span>[Input, Output]):
    <span class="hljs-string">&quot;&quot;&quot;Universal chain step interface.&quot;&quot;&quot;</span>
    
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>: Input, config: <span class="hljs-type">Optional</span>[RunnableConfig] = <span class="hljs-literal">None</span></span>) -&gt; Output:
        <span class="hljs-string">&quot;&quot;&quot;Single synchronous execution.&quot;&quot;&quot;</span>
        ...
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch</span>(<span class="hljs-params">self, inputs: <span class="hljs-type">List</span>[Input], config: <span class="hljs-type">Optional</span>[RunnableConfig] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">List</span>[Output]:
        <span class="hljs-string">&quot;&quot;&quot;Batch execution with optional concurrency control.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> [<span class="hljs-variable language_">self</span>.invoke(x, config) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> inputs]
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ainvoke</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>: Input, config: <span class="hljs-type">Optional</span>[RunnableConfig] = <span class="hljs-literal">None</span></span>) -&gt; Output:
        <span class="hljs-string">&quot;&quot;&quot;Async single execution.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> asyncio.to_thread(<span class="hljs-variable language_">self</span>.invoke, <span class="hljs-built_in">input</span>, config)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>: Input, config: <span class="hljs-type">Optional</span>[RunnableConfig] = <span class="hljs-literal">None</span></span>) -&gt; Iterator[Output]:
        <span class="hljs-string">&quot;&quot;&quot;Streaming execution yielding partial results.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">yield</span> <span class="hljs-variable language_">self</span>.invoke(<span class="hljs-built_in">input</span>, config)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">astream</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>: Input, config: <span class="hljs-type">Optional</span>[RunnableConfig] = <span class="hljs-literal">None</span></span>) -&gt; AsyncIterator[Output]:
        <span class="hljs-string">&quot;&quot;&quot;Async streaming execution.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.ainvoke(<span class="hljs-built_in">input</span>, config)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__or__</span>(<span class="hljs-params">self, other: <span class="hljs-string">&quot;Runnable&quot;</span></span>) -&gt; <span class="hljs-string">&quot;RunnableSequence&quot;</span>:
        <span class="hljs-string">&quot;&quot;&quot;Pipe operator for sequential composition.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> RunnableSequence(first=<span class="hljs-variable language_">self</span>, last=other)
</code></pre>
</div><p>The key insight: <strong>every LLM call, prompt template, output parser, retriever, and tool wrapper is a Runnable</strong>. This enables uniform composition.</p>
<h4 id="sequential-composition-via-pipe-operator" tabindex="-1">Sequential Composition via Pipe Operator</h4>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># Each component is a Runnable</span>
prompt = ChatPromptTemplate.from_template(<span class="hljs-string">&quot;Summarize: {text}&quot;</span>)
model = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4o&quot;</span>, temperature=<span class="hljs-number">0</span>)
parser = StrOutputParser()

<span class="hljs-comment"># Pipe operator creates RunnableSequence</span>
chain = prompt | model | parser

<span class="hljs-comment"># Execution</span>
result = chain.invoke({<span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;Long document content...&quot;</span>})
</code></pre>
</div><p><strong>Internal execution semantics</strong>: The pipe operator <code>|</code> constructs a <code>RunnableSequence</code> that applies steps left-to-right. For steps <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>s</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">s_1, s_2, \ldots, s_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RunnableSequence</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo>∘</mo><msub><mi>s</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>∘</mo><mo>⋯</mo><mo>∘</mo><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mo>⋯</mo><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>⋯</mo><mtext> </mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\text{RunnableSequence}(x) = (s_n \circ s_{n-1} \circ \cdots \circ s_1)(x) = s_n(s_{n-1}(\cdots s_1(x) \cdots))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RunnableSequence</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6528em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose">))</span></span></span></span></span></eqn></section><p>Each step’s output type must be compatible with the next step’s input type. LCEL performs <strong>runtime type coercion</strong> rather than compile-time type checking—a pragmatic but fragile design choice.</p>
<h4 id="runnableparallel" tabindex="-1">RunnableParallel</h4>
<p><code>RunnableParallel</code> executes multiple runnables concurrently on the same input, collecting results into a dictionary:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableParallel, RunnablePassthrough

<span class="hljs-comment"># Parallel execution: same input → multiple branches</span>
parallel = RunnableParallel(
    summary=prompt_summary | model | parser,
    entities=prompt_entities | model | entity_parser,
    sentiment=prompt_sentiment | model | sentiment_parser,
)

<span class="hljs-comment"># Semantics: parallel(x) = {</span>
<span class="hljs-comment">#   &quot;summary&quot;: (prompt_summary | model | parser)(x),</span>
<span class="hljs-comment">#   &quot;entities&quot;: (prompt_entities | model | entity_parser)(x),</span>
<span class="hljs-comment">#   &quot;sentiment&quot;: (prompt_sentiment | model | sentiment_parser)(x)</span>
<span class="hljs-comment"># }</span>
results = parallel.invoke({<span class="hljs-string">&quot;text&quot;</span>: document})
</code></pre>
</div><p>Formally:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RunnableParallel</mtext><mo stretchy="false">(</mo><mo stretchy="false">{</mo><msub><mi>k</mi><mi>i</mi></msub><mo>:</mo><msub><mi>s</mi><mi>i</mi></msub><msubsup><mo stretchy="false">}</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">{</mo><msub><mi>k</mi><mi>i</mi></msub><mo>:</mo><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><msubsup><mo stretchy="false">}</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup></mrow><annotation encoding="application/x-tex">
\text{RunnableParallel}(\{k_i: s_i\}_{i=1}^m)(x) = \{k_i: s_i(x)\}_{i=1}^m
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RunnableParallel</span></span><span class="mopen">({</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>Execution is <strong>concurrent by default</strong> using asyncio or thread pools, with configurable <code>max_concurrency</code> in the <code>RunnableConfig</code>.</p>
<h4 id="runnablebranch-conditional-routing" tabindex="-1">RunnableBranch (Conditional Routing)</h4>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableBranch

branch = RunnableBranch(
    (<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;technical&quot;</span>, technical_chain),
    (<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;creative&quot;</span>, creative_chain),
    (<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;analytical&quot;</span>, analytical_chain),
    default_chain  <span class="hljs-comment"># fallback</span>
)
</code></pre>
</div><p>Formal semantics:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RunnableBranch</mtext><mo stretchy="false">(</mo><mo stretchy="false">{</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msubsup><mo stretchy="false">}</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mo separator="true">,</mo><msub><mi>s</mi><mtext>default</mtext></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi mathvariant="normal">¬</mi><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>∧</mo><msub><mi>p</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>s</mi><mtext>default</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi mathvariant="normal">∀</mi><mi>i</mi><mo>:</mo><mi mathvariant="normal">¬</mi><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{RunnableBranch}(\{(p_i, s_i)\}_{i=1}^n, s_{\text{default}})(x) = \begin{cases}
s_1(x) &amp; \text{if } p_1(x) \\
s_2(x) &amp; \text{if } \neg p_1(x) \wedge p_2(x) \\
\vdots &amp; \\
s_{\text{default}}(x) &amp; \text{if } \forall i: \neg p_i(x)
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RunnableBranch</span></span><span class="mopen">({(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">default</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:6.252em;vertical-align:-2.876em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-1.366em;"><span class="pstrut" style="height:3.216em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.358em;"><span class="pstrut" style="height:3.216em;"></span><span style="height:1.216em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="1.216em" style="width:0.8889em" viewBox="0 0 888.89 1216" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V1216 H384z M384 0 H504 V1216 H384z"/></svg></span></span><span style="top:-3.216em;"><span class="pstrut" style="height:3.216em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.358em;"><span class="pstrut" style="height:3.216em;"></span><span style="height:1.216em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="1.216em" style="width:0.8889em" viewBox="0 0 888.89 1216" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V1216 H384z M384 0 H504 V1216 H384z"/></svg></span></span><span style="top:-5.566em;"><span class="pstrut" style="height:3.216em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.376em;"><span style="top:-6.0555em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-4.6155em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.6835em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.2435em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">default</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.876em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.376em;"><span style="top:-5.868em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-4.428em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.496em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-1.056em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">∀</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.876em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>Predicates <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> are evaluated sequentially; the first matching predicate determines the branch.</p>
<h4 id="runnablepassthrough-and-data-flow-control" tabindex="-1">RunnablePassthrough and Data Flow Control</h4>
<p><code>RunnablePassthrough</code> forwards input unchanged, enabling data flow patterns where intermediate steps enrich but do not replace the original input:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough

<span class="hljs-comment"># Classic RAG pattern: retrieve context + preserve question</span>
chain = (
    RunnableParallel(
        context=retriever | format_docs,
        question=RunnablePassthrough()
    )
    | prompt
    | model
    | parser
)
</code></pre>
</div><p>This implements the <strong>fork-join pattern</strong>: input is duplicated across parallel branches, then merged for downstream consumption.</p>
<h4 id="output-parsers-integration" tabindex="-1">Output Parsers Integration</h4>
<p>Output parsers transform raw LLM text into structured objects, serving as <strong>type coercion boundaries</strong> within chains:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> JsonOutputParser
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AnalysisResult</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">&quot;Brief summary&quot;</span>)
    key_points: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">&quot;Key points extracted&quot;</span>)
    confidence: <span class="hljs-built_in">float</span> = Field(description=<span class="hljs-string">&quot;Confidence score 0-1&quot;</span>)

parser = JsonOutputParser(pydantic_object=AnalysisResult)

chain = prompt | model | parser  <span class="hljs-comment"># Output is AnalysisResult instance</span>
</code></pre>
</div><p>The parser enforces a <strong>post-condition contract</strong>: if the LLM output cannot be parsed into the target schema, the chain raises a structured error rather than propagating malformed data.</p>
<h4 id="streaming-and-async-architecture" tabindex="-1">Streaming and Async Architecture</h4>
<p>LCEL’s streaming model propagates <strong>partial tokens</strong> through the chain. For a sequence <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>1</mn></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mn>2</mn></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">s_1 | s_2 | s_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>:</p>
<ul>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">s_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> (prompt template): emits complete output (no streaming needed)</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">s_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> (LLM): streams tokens as they are generated</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">s_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> (parser): may buffer or stream depending on parser type</li>
</ul>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-comment"># Streaming execution</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chain.astream({<span class="hljs-string">&quot;text&quot;</span>: document}):
    <span class="hljs-built_in">print</span>(chunk, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># Streaming with events (full observability)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> chain.astream_events({<span class="hljs-string">&quot;text&quot;</span>: document}, version=<span class="hljs-string">&quot;v2&quot;</span>):
    <span class="hljs-keyword">if</span> event[<span class="hljs-string">&quot;event&quot;</span>] == <span class="hljs-string">&quot;on_chat_model_stream&quot;</span>:
        <span class="hljs-built_in">print</span>(event[<span class="hljs-string">&quot;data&quot;</span>][<span class="hljs-string">&quot;chunk&quot;</span>].content, end=<span class="hljs-string">&quot;&quot;</span>)
</code></pre>
</div><p>The event-based streaming API exposes <strong>every internal step transition</strong>, enabling fine-grained observability without modifying chain logic.</p>
<h4 id="lcel-limitations-and-design-tradeoffs" tabindex="-1">LCEL Limitations and Design Tradeoffs</h4>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Strength</th>
<th>Limitation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Composition</td>
<td>Elegant pipe syntax</td>
<td>Complex branching becomes unreadable</td>
</tr>
<tr>
<td>Type Safety</td>
<td>Runtime coercion</td>
<td>No compile-time type checking</td>
</tr>
<tr>
<td>Debugging</td>
<td>Event streaming</td>
<td>Stack traces through Runnables are opaque</td>
</tr>
<tr>
<td>Optimization</td>
<td>None built-in</td>
<td>No automatic prompt optimization</td>
</tr>
<tr>
<td>Statefulness</td>
<td>Stateless by design</td>
<td>Requires external state management for iterative chains</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="1113-dspy-based-chain-construction" tabindex="-1">1.11.3 DSPy-Based Chain Construction</h3>
<p>DSPy (Declarative Self-improving Language Programs in Python) represents a <strong>paradigm shift</strong> from prompt engineering to prompt programming. Rather than manually crafting prompt text, DSPy defines <strong>input-output contracts</strong> (Signatures) and uses <strong>compilers</strong> (Teleprompters/Optimizers) to automatically generate and optimize prompts.</p>
<h4 id="signatures-as-chain-step-contracts" tabindex="-1">Signatures as Chain Step Contracts</h4>
<p>A Signature declares <strong>what</strong> a step does without specifying <strong>how</strong> (the prompt text):</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> dspy

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SummarizeDocument</span>(dspy.Signature):
    <span class="hljs-string">&quot;&quot;&quot;Summarize the given document into key points.&quot;&quot;&quot;</span>
    document: <span class="hljs-built_in">str</span> = dspy.InputField(desc=<span class="hljs-string">&quot;The full document text&quot;</span>)
    summary: <span class="hljs-built_in">str</span> = dspy.OutputField(desc=<span class="hljs-string">&quot;Concise summary of key points&quot;</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExtractEntities</span>(dspy.Signature):
    <span class="hljs-string">&quot;&quot;&quot;Extract named entities from text.&quot;&quot;&quot;</span>
    text: <span class="hljs-built_in">str</span> = dspy.InputField(desc=<span class="hljs-string">&quot;Input text&quot;</span>)
    entities: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] = dspy.OutputField(desc=<span class="hljs-string">&quot;List of named entities&quot;</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GenerateReport</span>(dspy.Signature):
    <span class="hljs-string">&quot;&quot;&quot;Generate a structured report from summary and entities.&quot;&quot;&quot;</span>
    summary: <span class="hljs-built_in">str</span> = dspy.InputField()
    entities: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] = dspy.InputField()
    report: <span class="hljs-built_in">str</span> = dspy.OutputField(desc=<span class="hljs-string">&quot;Structured analytical report&quot;</span>)
</code></pre>
</div><p>Formally, a Signature <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></eq> defines a mapping contract:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>σ</mi><mo>:</mo><munder><munder><mrow><mo stretchy="false">(</mo><msubsup><mi>f</mi><mn>1</mn><mtext>in</mtext></msubsup><mo separator="true">,</mo><msubsup><mi>f</mi><mn>2</mn><mtext>in</mtext></msubsup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msubsup><mi>f</mi><mi>m</mi><mtext>in</mtext></msubsup><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>input fields</mtext></munder><mo>→</mo><munder><munder><mrow><mo stretchy="false">(</mo><msubsup><mi>f</mi><mn>1</mn><mtext>out</mtext></msubsup><mo separator="true">,</mo><msubsup><mi>f</mi><mn>2</mn><mtext>out</mtext></msubsup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msubsup><mi>f</mi><mi>n</mi><mtext>out</mtext></msubsup><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>output fields</mtext></munder></mrow><annotation encoding="application/x-tex">
\sigma: \underbrace{(f_1^{\text{in}}, f_2^{\text{in}}, \ldots, f_m^{\text{in}})}_{\text{input fields}} \rightarrow \underbrace{(f_1^{\text{out}}, f_2^{\text{out}}, \ldots, f_n^{\text{out}})}_{\text{output fields}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.6007em;vertical-align:-1.7202em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8805em;"><span style="top:-1.4159em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">input fields</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8805em;"><span class="svg-align" style="top:-2.102em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8805em;"><span style="top:-2.453em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">in</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8805em;"><span style="top:-2.453em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">in</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8805em;"><span style="top:-2.453em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">in</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.898em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.7202em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5638em;vertical-align:-1.7202em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8436em;"><span style="top:-1.4159em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">output fields</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8436em;"><span class="svg-align" style="top:-2.102em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8436em;"><span style="top:-2.453em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">out</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8436em;"><span style="top:-2.453em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">out</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8436em;"><span style="top:-2.453em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">out</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.898em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.7202em;"><span></span></span></span></span></span></span></span></span></span></eqn></section><p>Each field <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> carries a name, type annotation, and natural language description. The Signature is <strong>the unit of semantic contract</strong> in DSPy—analogous to function type signatures in typed programming languages.</p>
<h4 id="modules-as-composable-chain-steps" tabindex="-1">Modules as Composable Chain Steps</h4>
<p>DSPy provides <strong>Modules</strong> that implement Signatures using different prompting strategies:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentAnalysisPipeline</span>(dspy.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># Each module wraps a Signature with a prompting strategy</span>
        <span class="hljs-variable language_">self</span>.summarize = dspy.ChainOfThought(SummarizeDocument)
        <span class="hljs-variable language_">self</span>.extract = dspy.Predict(ExtractEntities)
        <span class="hljs-variable language_">self</span>.generate = dspy.ChainOfThought(GenerateReport)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, document: <span class="hljs-built_in">str</span></span>) -&gt; dspy.Prediction:
        <span class="hljs-comment"># Explicit data flow — programmatic composition</span>
        summary_result = <span class="hljs-variable language_">self</span>.summarize(document=document)
        entities_result = <span class="hljs-variable language_">self</span>.extract(text=document)
        report_result = <span class="hljs-variable language_">self</span>.generate(
            summary=summary_result.summary,
            entities=entities_result.entities
        )
        <span class="hljs-keyword">return</span> dspy.Prediction(
            summary=summary_result.summary,
            entities=entities_result.entities,
            report=report_result.report
        )
</code></pre>
</div><p><strong>Module types</strong> correspond to different prompting strategies:</p>
<table>
<thead>
<tr>
<th>Module</th>
<th>Strategy</th>
<th>Internal Mechanism</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dspy.Predict</code></td>
<td>Direct prediction</td>
<td>Single LLM call with formatted prompt</td>
</tr>
<tr>
<td><code>dspy.ChainOfThought</code></td>
<td>CoT reasoning</td>
<td>Adds <code>rationale</code> output field before final answer</td>
</tr>
<tr>
<td><code>dspy.ProgramOfThought</code></td>
<td>Code generation</td>
<td>Generates and executes code to derive answer</td>
</tr>
<tr>
<td><code>dspy.ReAct</code></td>
<td>Reasoning + Acting</td>
<td>Interleaves thought and tool-use steps</td>
</tr>
<tr>
<td><code>dspy.MultiChainComparison</code></td>
<td>Ensemble reasoning</td>
<td>Generates multiple chains, selects best</td>
</tr>
</tbody>
</table>
<h4 id="telepromptersoptimizers-for-chain-optimization" tabindex="-1">Teleprompters/Optimizers for Chain Optimization</h4>
<p>The critical innovation of DSPy: <strong>compilers that automatically optimize prompts and few-shot examples</strong> given a metric and training data.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> dspy.teleprompt <span class="hljs-keyword">import</span> BootstrapFewShot, MIPROv2, BootstrapFewShotWithRandomSearch

<span class="hljs-comment"># Define evaluation metric</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">report_quality_metric</span>(<span class="hljs-params">example, prediction, trace=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;Composite metric for chain output quality.&quot;&quot;&quot;</span>
    correctness = dspy.evaluate.answer_exact_match(example, prediction)
    completeness = check_completeness(prediction.report, example.expected_entities)
    <span class="hljs-keyword">return</span> <span class="hljs-number">0.6</span> * correctness + <span class="hljs-number">0.4</span> * completeness

<span class="hljs-comment"># Compile the pipeline with optimization</span>
teleprompter = BootstrapFewShot(
    metric=report_quality_metric,
    max_bootstrapped_demos=<span class="hljs-number">4</span>,
    max_labeled_demos=<span class="hljs-number">8</span>
)

optimized_pipeline = teleprompter.<span class="hljs-built_in">compile</span>(
    DocumentAnalysisPipeline(),
    trainset=training_examples
)
</code></pre>
</div><p><strong>Optimization process</strong> (BootstrapFewShot):</p>
<ol>
<li>Execute the unoptimized pipeline on training examples</li>
<li>Collect successful traces (where metric exceeds threshold)</li>
<li>Select the most informative traces as few-shot demonstrations</li>
<li>Inject these demonstrations into each module’s prompt</li>
<li>Iterate, evaluating on a validation set</li>
</ol>
<p>Formally, the optimizer solves:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>θ</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi>θ</mi><mo>∈</mo><mi mathvariant="normal">Θ</mi></mrow></munder><mfrac><mn>1</mn><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">D</mi><mtext>train</mtext></msub><mi mathvariant="normal">∣</mi></mrow></mfrac><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>∈</mo><msub><mi mathvariant="script">D</mi><mtext>train</mtext></msub></mrow></munder><mi mathvariant="script">M</mi><mo stretchy="false">(</mo><mi>y</mi><mo separator="true">,</mo><msub><mtext>Pipeline</mtext><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\theta^* = \arg\max_{\theta \in \Theta} \frac{1}{|\mathcal{D}_{\text{train}}|} \sum_{(x, y) \in \mathcal{D}_{\text{train}}} \mathcal{M}(y, \text{Pipeline}_\theta(x))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7387em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.8374em;vertical-align:-1.516em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="mrel mtight">∈</span><span class="mord mtight">Θ</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7795em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">train</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.809em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.334em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">train</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathcal">M</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">Pipeline</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.242em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></eq>represents the <strong>prompt parameters</strong> (instructions, few-shot examples, field orderings) and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">M</span></span></span></span></eq> is the user-defined metric.</p>
<p><strong>Advanced optimizers</strong>:</p>
<ul>
<li><strong>MIPROv2</strong>: Uses Bayesian optimization over prompt instruction candidates, jointly optimizing instructions and demonstrations</li>
<li><strong>BootstrapFewShotWithRandomSearch</strong>: Random search over demonstration subsets with bootstrapped augmentation</li>
<li><strong>COPRO</strong>: Coordinate-wise prompt optimization, optimizing one module at a time while holding others fixed</li>
</ul>
<h4 id="assertions-and-constraints-in-chains" tabindex="-1">Assertions and Constraints in Chains</h4>
<p>DSPy supports <strong>runtime constraints</strong> that enforce output properties:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstrainedAnalysis</span>(dspy.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.analyze = dspy.ChainOfThought(AnalyzeSignature)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, text</span>):
        result = <span class="hljs-variable language_">self</span>.analyze(text=text)
        
        <span class="hljs-comment"># Hard constraint: must contain at least 3 entities</span>
        dspy.Assert(
            <span class="hljs-built_in">len</span>(result.entities) &gt;= <span class="hljs-number">3</span>,
            <span class="hljs-string">&quot;Analysis must identify at least 3 entities&quot;</span>
        )
        
        <span class="hljs-comment"># Soft constraint: suggest but don&#x27;t require</span>
        dspy.Suggest(
            result.confidence &gt; <span class="hljs-number">0.7</span>,
            <span class="hljs-string">&quot;Consider increasing analysis depth for higher confidence&quot;</span>
        )
        
        <span class="hljs-keyword">return</span> result
</code></pre>
</div><p><strong>Assertion semantics</strong>:</p>
<ul>
<li><code>dspy.Assert</code>: If violated, triggers <strong>automatic retry</strong> with the error message appended to the prompt as corrective feedback. Raises exception after <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq> retries.</li>
<li><code>dspy.Suggest</code>: If violated, appends guidance but does <strong>not</strong> trigger retry or exception.</li>
</ul>
<p>This implements a <strong>constraint-guided generation loop</strong>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>output</mtext><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>LLM</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mtext>feedback</mtext><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi mathvariant="normal">¬</mi><mi>C</mi><mo stretchy="false">(</mo><msub><mtext>output</mtext><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>∧</mo><mi>i</mi><mo>≤</mo><mi>k</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mtext>output</mtext><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>C</mi><mo stretchy="false">(</mo><msub><mtext>output</mtext><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>FAIL</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>i</mi><mo>&gt;</mo><mi>k</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{output}_i = \begin{cases}
\text{LLM}(x, \text{feedback}_{i-1}) &amp; \text{if } \neg C(\text{output}_{i-1}) \wedge i \leq k \\
\text{output}_{i-1} &amp; \text{if } C(\text{output}_{i-1}) \\
\text{FAIL} &amp; \text{if } i &gt; k
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8592em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">output</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">LLM</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">feedback</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">output</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3025em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">FAIL</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">¬</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">output</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3025em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">output</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3025em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><h4 id="programmatic-vs-declarative-chain-definition" tabindex="-1">Programmatic vs. Declarative Chain Definition</h4>
<table>
<thead>
<tr>
<th>Dimension</th>
<th>DSPy (Programmatic)</th>
<th>LCEL (Declarative)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Prompt authoring</strong></td>
<td>Auto-generated from Signatures</td>
<td>Manually crafted templates</td>
</tr>
<tr>
<td><strong>Optimization</strong></td>
<td>Compiler-driven (teleprompters)</td>
<td>Manual iteration</td>
</tr>
<tr>
<td><strong>Data flow</strong></td>
<td>Python control flow (if/for/while)</td>
<td>Runnable combinators</td>
</tr>
<tr>
<td><strong>Debugging</strong></td>
<td>Standard Python debugger</td>
<td>Custom tracing infrastructure</td>
</tr>
<tr>
<td><strong>Few-shot examples</strong></td>
<td>Automatically selected</td>
<td>Manually curated</td>
</tr>
<tr>
<td><strong>Adaptability</strong></td>
<td>Recompile for new data/models</td>
<td>Rewrite prompts manually</td>
</tr>
<tr>
<td><strong>Abstraction level</strong></td>
<td>What (contracts)</td>
<td>How (prompt templates)</td>
</tr>
</tbody>
</table>
<p><strong>Key insight</strong>: DSPy treats prompts as <strong>learned parameters</strong> rather than hand-engineered artifacts. This is analogous to the transition from feature engineering to representation learning in classical ML.</p>
<hr>
<h3 id="1114-implementation-patterns" tabindex="-1">1.11.4 Implementation Patterns</h3>
<h4 id="pattern-1-chain-as-a-class-hierarchy" tabindex="-1">Pattern 1: Chain as a Class Hierarchy</h4>
<p>Object-oriented pattern where each chain step is a class inheriting from a base:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Generic</span>, TypeVar
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

T_in = TypeVar(<span class="hljs-string">&quot;T_in&quot;</span>)
T_out = TypeVar(<span class="hljs-string">&quot;T_out&quot;</span>)

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StepResult</span>(<span class="hljs-type">Generic</span>[T_out]):
    output: T_out
    metadata: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    tokens_used: <span class="hljs-built_in">int</span>
    latency_ms: <span class="hljs-built_in">float</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainStep</span>(ABC, <span class="hljs-type">Generic</span>[T_in, T_out]):
    <span class="hljs-string">&quot;&quot;&quot;Base class for all chain steps.&quot;&quot;&quot;</span>
    
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, input_data: T_in, context: <span class="hljs-string">&quot;ChainContext&quot;</span></span>) -&gt; StepResult[T_out]:
        ...
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_input</span>(<span class="hljs-params">self, input_data: T_in</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_output</span>(<span class="hljs-params">self, result: StepResult[T_out]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainContext</span>:
    <span class="hljs-string">&quot;&quot;&quot;Shared execution context propagated through chain.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.trace_id: <span class="hljs-built_in">str</span> = generate_trace_id()
        <span class="hljs-variable language_">self</span>.step_results: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, StepResult] = {}
        <span class="hljs-variable language_">self</span>.metadata: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = {}
        <span class="hljs-variable language_">self</span>.start_time: <span class="hljs-built_in">float</span> = time.time()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SequentialChain</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, steps: <span class="hljs-type">List</span>[ChainStep]</span>):
        <span class="hljs-variable language_">self</span>.steps = steps
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, initial_input: <span class="hljs-type">Any</span></span>) -&gt; StepResult:
        context = ChainContext()
        current_input = initial_input
        
        <span class="hljs-keyword">for</span> i, step <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-variable language_">self</span>.steps):
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> step.validate_input(current_input):
                <span class="hljs-keyword">raise</span> ChainValidationError(<span class="hljs-string">f&quot;Step <span class="hljs-subst">{i}</span> input validation failed&quot;</span>)
            
            result = step.execute(current_input, context)
            
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> step.validate_output(result):
                <span class="hljs-keyword">raise</span> ChainValidationError(<span class="hljs-string">f&quot;Step <span class="hljs-subst">{i}</span> output validation failed&quot;</span>)
            
            context.step_results[<span class="hljs-string">f&quot;step_<span class="hljs-subst">{i}</span>&quot;</span>] = result
            current_input = result.output
        
        <span class="hljs-keyword">return</span> result
</code></pre>
</div><p><strong>Advantages</strong>: Strong typing, clear inheritance hierarchy, easy to test individual steps.
<strong>Disadvantages</strong>: Rigid structure, difficult to express parallel/conditional patterns without additional abstractions.</p>
<h4 id="pattern-2-chain-as-a-pipeline-functional-composition" tabindex="-1">Pattern 2: Chain as a Pipeline (Functional Composition)</h4>
<p>Functional pattern using higher-order functions:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Callable</span>, TypeVar, <span class="hljs-type">Tuple</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce

A = TypeVar(<span class="hljs-string">&quot;A&quot;</span>)
B = TypeVar(<span class="hljs-string">&quot;B&quot;</span>)
C = TypeVar(<span class="hljs-string">&quot;C&quot;</span>)

<span class="hljs-comment"># A chain step is simply a function</span>
ChainFn = <span class="hljs-type">Callable</span>[[<span class="hljs-type">Any</span>], <span class="hljs-type">Any</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">*functions: ChainFn</span>) -&gt; ChainFn:
    <span class="hljs-string">&quot;&quot;&quot;Compose functions left-to-right (pipeline order).&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> reduce(<span class="hljs-keyword">lambda</span> f, g: <span class="hljs-keyword">lambda</span> x: g(f(x)), functions)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">parallel</span>(<span class="hljs-params">**branches: ChainFn</span>) -&gt; ChainFn:
    <span class="hljs-string">&quot;&quot;&quot;Execute branches in parallel, collect results.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">x</span>):
        <span class="hljs-keyword">import</span> concurrent.futures
        <span class="hljs-keyword">with</span> concurrent.futures.ThreadPoolExecutor() <span class="hljs-keyword">as</span> executor:
            futures = {k: executor.submit(fn, x) <span class="hljs-keyword">for</span> k, fn <span class="hljs-keyword">in</span> branches.items()}
            <span class="hljs-keyword">return</span> {k: f.result() <span class="hljs-keyword">for</span> k, f <span class="hljs-keyword">in</span> futures.items()}
    <span class="hljs-keyword">return</span> run

<span class="hljs-keyword">def</span> <span class="hljs-title function_">conditional</span>(<span class="hljs-params">predicate: <span class="hljs-type">Callable</span>, if_true: ChainFn, if_false: ChainFn</span>) -&gt; ChainFn:
    <span class="hljs-string">&quot;&quot;&quot;Conditional routing.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">lambda</span> x: if_true(x) <span class="hljs-keyword">if</span> predicate(x) <span class="hljs-keyword">else</span> if_false(x)

<span class="hljs-comment"># Usage</span>
pipeline = compose(
    preprocess,
    parallel(summary=summarize, entities=extract_entities),
    merge_results,
    generate_report,
    postprocess
)

result = pipeline(document)
</code></pre>
</div><p><strong>Advantages</strong>: Highly composable, minimal boilerplate, easy to reason about data flow.
<strong>Disadvantages</strong>: Limited error handling, no built-in observability, type safety relies on discipline.</p>
<h4 id="pattern-3-chain-as-a-graph-dag-execution-engine" tabindex="-1">Pattern 3: Chain as a Graph (DAG Execution Engine)</h4>
<p>The most flexible pattern, treating chains as directed acyclic graphs:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict, deque
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Set</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">Callable</span>
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass, field
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">str</span>
    fn: <span class="hljs-type">Callable</span>
    dependencies: <span class="hljs-type">Set</span>[<span class="hljs-built_in">str</span>] = field(default_factory=<span class="hljs-built_in">set</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DAGExecutor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.nodes: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, Node] = {}
        <span class="hljs-variable language_">self</span>.adjacency: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Set</span>[<span class="hljs-built_in">str</span>]] = defaultdict(<span class="hljs-built_in">set</span>)  <span class="hljs-comment"># parent → children</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_node</span>(<span class="hljs-params">self, node: Node</span>):
        <span class="hljs-variable language_">self</span>.nodes[node.<span class="hljs-built_in">id</span>] = node
        <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> node.dependencies:
            <span class="hljs-variable language_">self</span>.adjacency[dep].add(node.<span class="hljs-built_in">id</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_topological_sort</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        in_degree = {nid: <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.nodes[nid].dependencies) <span class="hljs-keyword">for</span> nid <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.nodes}
        queue = deque([nid <span class="hljs-keyword">for</span> nid, deg <span class="hljs-keyword">in</span> in_degree.items() <span class="hljs-keyword">if</span> deg == <span class="hljs-number">0</span>])
        order = []
        <span class="hljs-keyword">while</span> queue:
            nid = queue.popleft()
            order.append(nid)
            <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.adjacency[nid]:
                in_degree[child] -= <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> in_degree[child] == <span class="hljs-number">0</span>:
                    queue.append(child)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(order) != <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.nodes):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Cycle detected in chain DAG&quot;</span>)
        <span class="hljs-keyword">return</span> order
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, inputs: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        results: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = <span class="hljs-built_in">dict</span>(inputs)
        execution_order = <span class="hljs-variable language_">self</span>._topological_sort()
        
        <span class="hljs-comment"># Group by levels for parallel execution</span>
        levels = <span class="hljs-variable language_">self</span>._compute_levels()
        
        <span class="hljs-keyword">for</span> level_nodes <span class="hljs-keyword">in</span> levels:
            <span class="hljs-comment"># Execute all nodes at the same level concurrently</span>
            tasks = []
            <span class="hljs-keyword">for</span> nid <span class="hljs-keyword">in</span> level_nodes:
                node = <span class="hljs-variable language_">self</span>.nodes[nid]
                node_inputs = {dep: results[dep] <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> node.dependencies}
                tasks.append(<span class="hljs-variable language_">self</span>._execute_node(node, node_inputs))
            
            level_results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)
            <span class="hljs-keyword">for</span> nid, result <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(level_nodes, level_results):
                results[nid] = result
        
        <span class="hljs-keyword">return</span> results
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_execute_node</span>(<span class="hljs-params">self, node: Node, inputs: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-keyword">if</span> asyncio.iscoroutinefunction(node.fn):
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> node.fn(**inputs)
        <span class="hljs-keyword">return</span> node.fn(**inputs)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_compute_levels</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">&quot;&quot;&quot;Group nodes by execution level (nodes at same level can run in parallel).&quot;&quot;&quot;</span>
        levels = []
        remaining = <span class="hljs-built_in">set</span>(<span class="hljs-variable language_">self</span>.nodes.keys())
        completed = <span class="hljs-built_in">set</span>()
        <span class="hljs-keyword">while</span> remaining:
            level = [
                nid <span class="hljs-keyword">for</span> nid <span class="hljs-keyword">in</span> remaining
                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.nodes[nid].dependencies.issubset(completed)
            ]
            levels.append(level)
            completed.update(level)
            remaining -= <span class="hljs-built_in">set</span>(level)
        <span class="hljs-keyword">return</span> levels
</code></pre>
</div><p><strong>Execution complexity</strong>: For a DAG with <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></eq>nodes and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></eq>edges, topological sort runs in<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>V</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(V + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq>. The maximum parallelism is determined by the <strong>width</strong> of the DAG (maximum number of nodes at any single level):</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Parallelism</mtext><mo>=</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi mathvariant="normal">ℓ</mi><mo>∈</mo><mtext>levels</mtext></mrow></munder><mi mathvariant="normal">∣</mi><mi mathvariant="normal">ℓ</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">
\text{Parallelism} = \max_{\ell \in \text{levels}} |\ell|
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Parallelism</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.5295em;vertical-align:-0.7795em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">levels</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7795em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∣</span><span class="mord">ℓ</span><span class="mord">∣</span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Critical path latency</mtext><mo>=</mo><munder><mo>∑</mo><mrow><mi mathvariant="normal">ℓ</mi><mo>∈</mo><mtext>levels</mtext></mrow></munder><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi>n</mi><mo>∈</mo><mi mathvariant="normal">ℓ</mi></mrow></munder><mtext>latency</mtext><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\text{Critical path latency} = \sum_{\ell \in \text{levels}} \max_{n \in \ell} \text{latency}(n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Critical path latency</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3795em;vertical-align:-1.3295em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">levels</span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3295em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">∈</span><span class="mord mtight">ℓ</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7795em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">latency</span></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></eqn></section><h4 id="pattern-4-chain-as-a-state-machine" tabindex="-1">Pattern 4: Chain as a State Machine</h4>
<p>For chains requiring complex control flow with explicit state transitions:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, auto
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">Callable</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainState</span>(<span class="hljs-title class_ inherited__">Enum</span>):
    INIT = auto()
    CLASSIFYING = auto()
    RETRIEVING = auto()
    GENERATING = auto()
    VALIDATING = auto()
    REFINING = auto()
    COMPLETE = auto()
    FAILED = auto()

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StateContext</span>:
    state: ChainState
    data: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    history: <span class="hljs-type">List</span>[<span class="hljs-type">Tuple</span>[ChainState, <span class="hljs-built_in">float</span>]]  <span class="hljs-comment"># (state, timestamp)</span>
    retry_count: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    max_retries: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainStateMachine</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.transitions: <span class="hljs-type">Dict</span>[ChainState, <span class="hljs-type">Callable</span>[[StateContext], <span class="hljs-type">Tuple</span>[ChainState, StateContext]]] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">self, state: ChainState, handler: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-variable language_">self</span>.transitions[state] = handler
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, initial_data: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; StateContext:
        ctx = StateContext(
            state=ChainState.INIT,
            data=initial_data,
            history=[(ChainState.INIT, time.time())]
        )
        
        <span class="hljs-keyword">while</span> ctx.state <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (ChainState.COMPLETE, ChainState.FAILED):
            handler = <span class="hljs-variable language_">self</span>.transitions.get(ctx.state)
            <span class="hljs-keyword">if</span> handler <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;No handler for state <span class="hljs-subst">{ctx.state}</span>&quot;</span>)
            
            <span class="hljs-keyword">try</span>:
                next_state, ctx = handler(ctx)
                ctx.state = next_state
                ctx.history.append((next_state, time.time()))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                ctx.retry_count += <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> ctx.retry_count &gt; ctx.max_retries:
                    ctx.state = ChainState.FAILED
                    ctx.data[<span class="hljs-string">&quot;error&quot;</span>] = <span class="hljs-built_in">str</span>(e)
        
        <span class="hljs-keyword">return</span> ctx
</code></pre>
</div><p><strong>Advantages</strong>: Explicit state management, natural retry/recovery logic, clear audit trail.
<strong>Disadvantages</strong>: Verbose for simple chains, state explosion for complex workflows.</p>
<h4 id="serialization-and-version-control" tabindex="-1">Serialization and Version Control</h4>
<p>Chains must be <strong>serializable</strong> for storage, versioning, and distributed execution:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainDefinition</span>:
    <span class="hljs-string">&quot;&quot;&quot;Serializable chain definition.&quot;&quot;&quot;</span>
    version: <span class="hljs-built_in">str</span>
    steps: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]
    topology: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># &quot;sequential&quot;, &quot;parallel&quot;, &quot;dag&quot;, &quot;state_machine&quot;</span>
    metadata: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_json</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">return</span> json.dumps(asdict(<span class="hljs-variable language_">self</span>), indent=<span class="hljs-number">2</span>)
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_json</span>(<span class="hljs-params">cls, json_str: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-string">&quot;ChainDefinition&quot;</span>:
        <span class="hljs-keyword">return</span> cls(**json.loads(json_str))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">content_hash</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">&quot;&quot;&quot;Deterministic hash for version comparison.&quot;&quot;&quot;</span>
        canonical = json.dumps(asdict(<span class="hljs-variable language_">self</span>), sort_keys=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> hashlib.sha256(canonical.encode()).hexdigest()[:<span class="hljs-number">12</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">diff</span>(<span class="hljs-params">self, other: <span class="hljs-string">&quot;ChainDefinition&quot;</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Compute differences between chain versions.&quot;&quot;&quot;</span>
        diffs = {}
        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.steps != other.steps:
            diffs[<span class="hljs-string">&quot;steps&quot;</span>] = {<span class="hljs-string">&quot;before&quot;</span>: <span class="hljs-variable language_">self</span>.steps, <span class="hljs-string">&quot;after&quot;</span>: other.steps}
        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.topology != other.topology:
            diffs[<span class="hljs-string">&quot;topology&quot;</span>] = {<span class="hljs-string">&quot;before&quot;</span>: <span class="hljs-variable language_">self</span>.topology, <span class="hljs-string">&quot;after&quot;</span>: other.topology}
        <span class="hljs-keyword">return</span> diffs
</code></pre>
</div><p><strong>Version control strategy</strong>: Store <code>ChainDefinition</code> in Git alongside code. Use content hashing to detect chain modifications. Tag deployments with chain version hashes for reproducibility.</p>
<hr>
<h3 id="1115-infrastructure-and-deployment" tabindex="-1">1.11.5 Infrastructure and Deployment</h3>
<h4 id="chain-execution-engines" tabindex="-1">Chain Execution Engines</h4>
<p>A production chain execution engine must manage:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">┌─────────────────────────────────────────────────────┐
│                Chain Execution Engine                 │
├─────────────┬───────────┬───────────┬───────────────┤
│  Scheduler  │  Worker   │   State   │  Observability│
│             │   Pool    │   Store   │    Emitter    │
├─────────────┼───────────┼───────────┼───────────────┤
│ - DAG       │ - LLM     │ - Redis   │ - Traces      │
│   analysis  │   calls   │ - DynamoDB│ - Metrics     │
│ - Level     │ - Tool    │ - Postgres│ - Logs        │
│   grouping  │   exec    │           │ - Alerts      │
│ - Priority  │ - Retry   │           │               │
│   queue     │   logic   │           │               │
└─────────────┴───────────┴───────────┴───────────────┘
</code></pre>
</div><h4 id="distributed-chain-execution" tabindex="-1">Distributed Chain Execution</h4>
<p>For chains with high throughput requirements or long-running steps:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-comment"># Celery-based distributed chain execution</span>
<span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> Celery, chain <span class="hljs-keyword">as</span> celery_chain, group, chord

app = Celery(<span class="hljs-string">&#x27;chain_engine&#x27;</span>, broker=<span class="hljs-string">&#x27;redis://localhost:6379&#x27;</span>)

<span class="hljs-meta">@app.task(<span class="hljs-params">bind=<span class="hljs-literal">True</span>, max_retries=<span class="hljs-number">3</span>, retry_backoff=<span class="hljs-literal">True</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">llm_step</span>(<span class="hljs-params">self, input_data: <span class="hljs-built_in">dict</span>, step_config: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">&quot;&quot;&quot;Individual chain step as a Celery task.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">try</span>:
        result = execute_llm_call(input_data, step_config)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;output&quot;</span>: result, <span class="hljs-string">&quot;step_id&quot;</span>: step_config[<span class="hljs-string">&quot;id&quot;</span>], <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>}
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
        <span class="hljs-variable language_">self</span>.retry(exc=exc, countdown=<span class="hljs-number">2</span> ** <span class="hljs-variable language_">self</span>.request.retries)

<span class="hljs-comment"># Sequential chain</span>
workflow = celery_chain(
    llm_step.s({<span class="hljs-string">&quot;text&quot;</span>: doc}, {<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;classify&quot;</span>, <span class="hljs-string">&quot;prompt&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>}),
    llm_step.s({<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;extract&quot;</span>, <span class="hljs-string">&quot;prompt&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>}),
    llm_step.s({<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;generate&quot;</span>, <span class="hljs-string">&quot;prompt&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>})
)

<span class="hljs-comment"># Parallel fan-out / fan-in (chord)</span>
workflow = chord(
    group(
        llm_step.s({<span class="hljs-string">&quot;text&quot;</span>: doc}, {<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;summarize&quot;</span>}),
        llm_step.s({<span class="hljs-string">&quot;text&quot;</span>: doc}, {<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;entities&quot;</span>}),
        llm_step.s({<span class="hljs-string">&quot;text&quot;</span>: doc}, {<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;sentiment&quot;</span>}),
    ),
    merge_results.s()  <span class="hljs-comment"># callback after all complete</span>
)

result = workflow.apply_async()
</code></pre>
</div><h4 id="serverless-chain-deployment" tabindex="-1">Serverless Chain Deployment</h4>
<div class="code-shell"><pre class="hljs"><code class="hljs language-yaml"><span class="hljs-comment"># AWS Step Functions state machine definition</span>
<span class="hljs-attr">Comment:</span> <span class="hljs-string">&quot;Document Analysis Chain&quot;</span>
<span class="hljs-attr">StartAt:</span> <span class="hljs-string">ClassifyDocument</span>
<span class="hljs-attr">States:</span>
  <span class="hljs-attr">ClassifyDocument:</span>
    <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
    <span class="hljs-attr">Resource:</span> <span class="hljs-string">&quot;arn:aws:lambda:...:classify&quot;</span>
    <span class="hljs-attr">Next:</span> <span class="hljs-string">RouteByType</span>
    <span class="hljs-attr">Retry:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span> [<span class="hljs-string">&quot;States.TaskFailed&quot;</span>]
        <span class="hljs-attr">MaxAttempts:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">BackoffRate:</span> <span class="hljs-number">2</span>

  <span class="hljs-attr">RouteByType:</span>
    <span class="hljs-attr">Type:</span> <span class="hljs-string">Choice</span>
    <span class="hljs-attr">Choices:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">Variable:</span> <span class="hljs-string">&quot;$.classification&quot;</span>
        <span class="hljs-attr">StringEquals:</span> <span class="hljs-string">&quot;technical&quot;</span>
        <span class="hljs-attr">Next:</span> <span class="hljs-string">TechnicalAnalysis</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">Variable:</span> <span class="hljs-string">&quot;$.classification&quot;</span>
        <span class="hljs-attr">StringEquals:</span> <span class="hljs-string">&quot;legal&quot;</span>
        <span class="hljs-attr">Next:</span> <span class="hljs-string">LegalAnalysis</span>
    <span class="hljs-attr">Default:</span> <span class="hljs-string">GeneralAnalysis</span>

  <span class="hljs-attr">TechnicalAnalysis:</span>
    <span class="hljs-attr">Type:</span> <span class="hljs-string">Parallel</span>
    <span class="hljs-attr">Branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">StartAt:</span> <span class="hljs-string">ExtractCode</span>
        <span class="hljs-attr">States:</span>
          <span class="hljs-attr">ExtractCode:</span>
            <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
            <span class="hljs-attr">Resource:</span> <span class="hljs-string">&quot;arn:aws:lambda:...:extract_code&quot;</span>
            <span class="hljs-attr">End:</span> <span class="hljs-literal">true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">StartAt:</span> <span class="hljs-string">ExtractDiagrams</span>
        <span class="hljs-attr">States:</span>
          <span class="hljs-attr">ExtractDiagrams:</span>
            <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
            <span class="hljs-attr">Resource:</span> <span class="hljs-string">&quot;arn:aws:lambda:...:extract_diagrams&quot;</span>
            <span class="hljs-attr">End:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">Next:</span> <span class="hljs-string">MergeAndGenerate</span>

  <span class="hljs-attr">MergeAndGenerate:</span>
    <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
    <span class="hljs-attr">Resource:</span> <span class="hljs-string">&quot;arn:aws:lambda:...:generate_report&quot;</span>
    <span class="hljs-attr">End:</span> <span class="hljs-literal">true</span>
</code></pre>
</div><h4 id="queue-based-async-chain-execution" tabindex="-1">Queue-Based Async Chain Execution</h4>
<p>For high-throughput scenarios with variable latency:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Input   │───▶│  Step 1  │───▶│  Step 2  │───▶│  Step 3  │
│  Queue   │    │  Workers │    │  Workers │    │  Workers │
│ (SQS/    │    │          │    │          │    │          │
│  Kafka)  │    │ ┌──────┐ │    │ ┌──────┐ │    │ ┌──────┐ │
│          │    │ │Queue │─┼───▶│ │Queue │─┼───▶│ │Queue │ │
│          │    │ │  Out │ │    │ │  Out │ │    │ │  Out │ │
│          │    │ └──────┘ │    │ └──────┘ │    │ └──────┘ │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                      │
                                                      ▼
                                               ┌──────────┐
                                               │  Result  │
                                               │  Store   │
                                               └──────────┘
</code></pre>
</div><p><strong>Backpressure management</strong>: Each inter-step queue has configurable capacity. When a queue fills, upstream workers block, preventing cascading overload. The system throughput is bounded by the <strong>slowest step</strong> (bottleneck):</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>Throughput</mtext><mtext>chain</mtext></msub><mo>=</mo><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><mrow><mi>i</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">}</mo></mrow></munder><mfrac><msub><mi>W</mi><mi>i</mi></msub><msub><mtext>latency</mtext><mi>i</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">
\text{Throughput}_{\text{chain}} = \min_{i \in \{1,\ldots,n\}} \frac{W_i}{\text{latency}_i}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9386em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">Throughput</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.242em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chain</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3263em;vertical-align:-0.966em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.309em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">∈</span><span class="mopen mtight">{</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">}</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.966em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">latency</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9301em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">W_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>is the number of workers for step<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></eq>.</p>
<hr>
<h2 id="112-observability-debugging-and-tracing" tabindex="-1">1.12 Observability, Debugging, and Tracing</h2>
<h3 id="1121-tracing-and-logging" tabindex="-1">1.12.1 Tracing and Logging</h3>
<p>Observability in prompt chains requires instrumenting <strong>every step boundary</strong> to capture inputs, outputs, timing, token usage, and error states. Unlike monolithic applications, chains have <strong>distributed causality</strong>—a failure at step <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq>may be caused by subtle output drift at step<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>&lt;</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">j &lt; k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq>.</p>
<h4 id="per-step-inputoutput-logging" tabindex="-1">Per-Step Input/Output Logging</h4>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Callable</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass, field, asdict
<span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid4

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StepTrace</span>:
    trace_id: <span class="hljs-built_in">str</span>
    step_id: <span class="hljs-built_in">str</span>
    step_name: <span class="hljs-built_in">str</span>
    input_data: <span class="hljs-type">Any</span>
    output_data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span>
    error: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>
    start_time: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>
    end_time: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>
    latency_ms: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>
    token_usage: <span class="hljs-built_in">dict</span> = field(default_factory=<span class="hljs-built_in">dict</span>)
    metadata: <span class="hljs-built_in">dict</span> = field(default_factory=<span class="hljs-built_in">dict</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainTracer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, trace_id: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.trace_id = trace_id <span class="hljs-keyword">or</span> <span class="hljs-built_in">str</span>(uuid4())
        <span class="hljs-variable language_">self</span>.steps: <span class="hljs-built_in">list</span>[StepTrace] = []
        <span class="hljs-variable language_">self</span>.logger = logging.getLogger(<span class="hljs-string">&quot;chain_tracer&quot;</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">trace_step</span>(<span class="hljs-params">self, step_name: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;Decorator for tracing chain steps.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">fn: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:
<span class="hljs-meta">            @wraps(<span class="hljs-params">fn</span>)</span>
            <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
                step_trace = StepTrace(
                    trace_id=<span class="hljs-variable language_">self</span>.trace_id,
                    step_id=<span class="hljs-built_in">str</span>(uuid4()),
                    step_name=step_name,
                    input_data=<span class="hljs-variable language_">self</span>._serialize_safe(kwargs <span class="hljs-keyword">or</span> args),
                    start_time=time.time()
                )
                
                <span class="hljs-keyword">try</span>:
                    result = fn(*args, **kwargs)
                    step_trace.output_data = <span class="hljs-variable language_">self</span>._serialize_safe(result)
                    <span class="hljs-keyword">return</span> result
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    step_trace.error = <span class="hljs-string">f&quot;<span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>
                    <span class="hljs-keyword">raise</span>
                <span class="hljs-keyword">finally</span>:
                    step_trace.end_time = time.time()
                    step_trace.latency_ms = (step_trace.end_time - step_trace.start_time) * <span class="hljs-number">1000</span>
                    <span class="hljs-variable language_">self</span>.steps.append(step_trace)
                    <span class="hljs-variable language_">self</span>._emit(step_trace)
            
            <span class="hljs-keyword">return</span> wrapper
        <span class="hljs-keyword">return</span> decorator
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_serialize_safe</span>(<span class="hljs-params">self, data: <span class="hljs-type">Any</span>, max_length: <span class="hljs-built_in">int</span> = <span class="hljs-number">10000</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">&quot;&quot;&quot;Serialize data for logging, truncating large values.&quot;&quot;&quot;</span>
        serialized = json.dumps(data, default=<span class="hljs-built_in">str</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(serialized) &gt; max_length:
            <span class="hljs-keyword">return</span> serialized[:max_length] + <span class="hljs-string">&quot;...[TRUNCATED]&quot;</span>
        <span class="hljs-keyword">return</span> json.loads(serialized)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_emit</span>(<span class="hljs-params">self, trace: StepTrace</span>):
        <span class="hljs-variable language_">self</span>.logger.info(json.dumps(asdict(trace), default=<span class="hljs-built_in">str</span>))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_summary</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;trace_id&quot;</span>: <span class="hljs-variable language_">self</span>.trace_id,
            <span class="hljs-string">&quot;total_steps&quot;</span>: <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.steps),
            <span class="hljs-string">&quot;total_latency_ms&quot;</span>: <span class="hljs-built_in">sum</span>(s.latency_ms <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.steps),
            <span class="hljs-string">&quot;failed_steps&quot;</span>: [s.step_name <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.steps <span class="hljs-keyword">if</span> s.error],
            <span class="hljs-string">&quot;total_tokens&quot;</span>: <span class="hljs-built_in">sum</span>(
                s.token_usage.get(<span class="hljs-string">&quot;total_tokens&quot;</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.steps
            )
        }
</code></pre>
</div><h4 id="token-usage-tracking-per-step" tabindex="-1">Token Usage Tracking Per Step</h4>
<p>Token tracking must capture both <strong>prompt tokens</strong> (input cost) and <strong>completion tokens</strong> (output cost) per step to enable cost attribution:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenUsage</span>:
    prompt_tokens: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    completion_tokens: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    total_tokens: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    estimated_cost_usd: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>
    model: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;&quot;</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenTracker</span>:
    <span class="hljs-comment"># Pricing per 1M tokens (as of representative rates)</span>
    PRICING = {
        <span class="hljs-string">&quot;gpt-4o&quot;</span>: {<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-number">2.50</span>, <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-number">10.00</span>},
        <span class="hljs-string">&quot;gpt-4o-mini&quot;</span>: {<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-number">0.15</span>, <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-number">0.60</span>},
        <span class="hljs-string">&quot;claude-3.5-sonnet&quot;</span>: {<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-number">3.00</span>, <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-number">15.00</span>},
        <span class="hljs-string">&quot;claude-3.5-haiku&quot;</span>: {<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-number">0.80</span>, <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-number">4.00</span>},
    }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_cost</span>(<span class="hljs-params">self, usage: TokenUsage</span>) -&gt; <span class="hljs-built_in">float</span>:
        pricing = <span class="hljs-variable language_">self</span>.PRICING.get(usage.model, {<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-number">0</span>, <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-number">0</span>})
        cost = (
            (usage.prompt_tokens / <span class="hljs-number">1_000_000</span>) * pricing[<span class="hljs-string">&quot;input&quot;</span>] +
            (usage.completion_tokens / <span class="hljs-number">1_000_000</span>) * pricing[<span class="hljs-string">&quot;output&quot;</span>]
        )
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">round</span>(cost, <span class="hljs-number">6</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">aggregate_chain_cost</span>(<span class="hljs-params">self, step_usages: <span class="hljs-type">List</span>[TokenUsage]</span>) -&gt; <span class="hljs-built_in">dict</span>:
        total_prompt = <span class="hljs-built_in">sum</span>(u.prompt_tokens <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> step_usages)
        total_completion = <span class="hljs-built_in">sum</span>(u.completion_tokens <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> step_usages)
        total_cost = <span class="hljs-built_in">sum</span>(<span class="hljs-variable language_">self</span>.compute_cost(u) <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> step_usages)
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;total_prompt_tokens&quot;</span>: total_prompt,
            <span class="hljs-string">&quot;total_completion_tokens&quot;</span>: total_completion,
            <span class="hljs-string">&quot;total_tokens&quot;</span>: total_prompt + total_completion,
            <span class="hljs-string">&quot;total_cost_usd&quot;</span>: total_cost,
            <span class="hljs-string">&quot;cost_by_step&quot;</span>: {
                <span class="hljs-string">f&quot;step_<span class="hljs-subst">{i}</span>&quot;</span>: <span class="hljs-variable language_">self</span>.compute_cost(u)
                <span class="hljs-keyword">for</span> i, u <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(step_usages)
            }
        }
</code></pre>
</div><h4 id="trace-id-propagation" tabindex="-1">Trace ID Propagation</h4>
<p>Trace ID propagation follows the <strong>W3C Trace Context</strong> standard, ensuring every step in a chain (including external service calls) can be correlated:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> contextvars <span class="hljs-keyword">import</span> ContextVar

<span class="hljs-comment"># Context variable for trace propagation</span>
_current_trace: ContextVar[<span class="hljs-built_in">str</span>] = ContextVar(<span class="hljs-string">&quot;current_trace&quot;</span>, default=<span class="hljs-string">&quot;&quot;</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TraceContext</span>:
    <span class="hljs-string">&quot;&quot;&quot;W3C-compatible trace context for chain execution.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, trace_id: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>, parent_span_id: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.trace_id = trace_id <span class="hljs-keyword">or</span> uuid4().<span class="hljs-built_in">hex</span>
        <span class="hljs-variable language_">self</span>.parent_span_id = parent_span_id
        <span class="hljs-variable language_">self</span>.span_id = uuid4().<span class="hljs-built_in">hex</span>[:<span class="hljs-number">16</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_child_span</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-string">&quot;TraceContext&quot;</span>:
        <span class="hljs-keyword">return</span> TraceContext(
            trace_id=<span class="hljs-variable language_">self</span>.trace_id,
            parent_span_id=<span class="hljs-variable language_">self</span>.span_id
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_headers</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;Generate W3C traceparent header.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;traceparent&quot;</span>: <span class="hljs-string">f&quot;00-<span class="hljs-subst">{self.trace_id}</span>-<span class="hljs-subst">{self.span_id}</span>-01&quot;</span>
        }
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_headers</span>(<span class="hljs-params">cls, headers: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-string">&quot;TraceContext&quot;</span>:
        traceparent = headers.get(<span class="hljs-string">&quot;traceparent&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)
        parts = traceparent.split(<span class="hljs-string">&quot;-&quot;</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) == <span class="hljs-number">4</span>:
            <span class="hljs-keyword">return</span> cls(trace_id=parts[<span class="hljs-number">1</span>], parent_span_id=parts[<span class="hljs-number">2</span>])
        <span class="hljs-keyword">return</span> cls()
</code></pre>
</div><h4 id="structured-logging-format" tabindex="-1">Structured Logging Format</h4>
<div class="code-shell"><pre class="hljs"><code class="hljs language-json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2025-01-15T10:23:45.123Z&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;INFO&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;trace_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;abc123def456&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;span_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;span_001&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;parent_span_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;step_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;classify_intent&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;step_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;event&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;step_complete&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;input_hash&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sha256:a1b2c3...&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;output_preview&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;classification: technical_question&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;latency_ms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">342.5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;tokens&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;prompt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">156</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;completion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">23</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">179</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;model&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;gpt-4o-mini&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;temperature&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;cost_usd&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.000037</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;retry_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</div><hr>
<h3 id="1122-observability-tools" tabindex="-1">1.12.2 Observability Tools</h3>
<h4 id="langsmith-tracing" tabindex="-1">LangSmith Tracing</h4>
<p>LangSmith provides native LCEL tracing with automatic instrumentation:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> os
os.environ[<span class="hljs-string">&quot;LANGCHAIN_TRACING_V2&quot;</span>] = <span class="hljs-string">&quot;true&quot;</span>
os.environ[<span class="hljs-string">&quot;LANGCHAIN_API_KEY&quot;</span>] = <span class="hljs-string">&quot;ls__...&quot;</span>
os.environ[<span class="hljs-string">&quot;LANGCHAIN_PROJECT&quot;</span>] = <span class="hljs-string">&quot;document-analysis-chain&quot;</span>

<span class="hljs-comment"># All LCEL chain executions are automatically traced</span>
<span class="hljs-comment"># No code changes required — instrumentation is automatic</span>

<span class="hljs-comment"># Manual run annotation</span>
<span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client
client = Client()

<span class="hljs-comment"># Create dataset for evaluation</span>
dataset = client.create_dataset(<span class="hljs-string">&quot;chain_test_cases&quot;</span>)
<span class="hljs-keyword">for</span> example <span class="hljs-keyword">in</span> test_cases:
    client.create_example(
        inputs=example[<span class="hljs-string">&quot;input&quot;</span>],
        outputs=example[<span class="hljs-string">&quot;expected_output&quot;</span>],
        dataset_id=dataset.<span class="hljs-built_in">id</span>
    )

<span class="hljs-comment"># Run evaluation</span>
<span class="hljs-keyword">from</span> langchain.smith <span class="hljs-keyword">import</span> RunEvalConfig
eval_config = RunEvalConfig(
    evaluators=[<span class="hljs-string">&quot;qa&quot;</span>, <span class="hljs-string">&quot;criteria&quot;</span>],
    custom_evaluators=[custom_metric],
)
results = client.run_on_dataset(
    dataset_name=<span class="hljs-string">&quot;chain_test_cases&quot;</span>,
    llm_or_chain_factory=<span class="hljs-keyword">lambda</span>: chain,
    evaluation=eval_config
)
</code></pre>
</div><p><strong>Trace hierarchy captured</strong>:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">Chain Run (trace_id: abc123)
├── ChatPromptTemplate (span: 001, 2ms)
├── ChatOpenAI (span: 002, 450ms)
│   └── Token streaming events
├── StrOutputParser (span: 003, 1ms)
├── RetrieverStep (span: 004, 120ms)
│   └── VectorStore query
├── ChatPromptTemplate (span: 005, 1ms)
├── ChatOpenAI (span: 006, 890ms)
│   └── Token streaming events
└── JsonOutputParser (span: 007, 3ms)
</code></pre>
</div><h4 id="opentelemetry-integration" tabindex="-1">OpenTelemetry Integration</h4>
<p>For framework-agnostic observability:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> opentelemetry <span class="hljs-keyword">import</span> trace
<span class="hljs-keyword">from</span> opentelemetry.sdk.trace <span class="hljs-keyword">import</span> TracerProvider
<span class="hljs-keyword">from</span> opentelemetry.sdk.trace.export <span class="hljs-keyword">import</span> BatchSpanProcessor
<span class="hljs-keyword">from</span> opentelemetry.exporter.otlp.proto.grpc.trace_exporter <span class="hljs-keyword">import</span> OTLPSpanExporter
<span class="hljs-keyword">from</span> opentelemetry.sdk.resources <span class="hljs-keyword">import</span> Resource

<span class="hljs-comment"># Initialize OpenTelemetry</span>
resource = Resource.create({<span class="hljs-string">&quot;service.name&quot;</span>: <span class="hljs-string">&quot;prompt-chain-service&quot;</span>})
provider = TracerProvider(resource=resource)
provider.add_span_processor(
    BatchSpanProcessor(OTLPSpanExporter(endpoint=<span class="hljs-string">&quot;http://collector:4317&quot;</span>))
)
trace.set_tracer_provider(provider)
tracer = trace.get_tracer(<span class="hljs-string">&quot;chain_engine&quot;</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">traced_chain_step</span>(<span class="hljs-params">step_name: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">fn</span>):
<span class="hljs-meta">        @wraps(<span class="hljs-params">fn</span>)</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
            <span class="hljs-keyword">with</span> tracer.start_as_current_span(step_name) <span class="hljs-keyword">as</span> span:
                span.set_attribute(<span class="hljs-string">&quot;chain.step.name&quot;</span>, step_name)
                span.set_attribute(<span class="hljs-string">&quot;chain.step.input_size&quot;</span>, <span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>(args)))
                
                <span class="hljs-keyword">try</span>:
                    result = fn(*args, **kwargs)
                    span.set_attribute(<span class="hljs-string">&quot;chain.step.status&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>)
                    span.set_attribute(<span class="hljs-string">&quot;chain.step.output_size&quot;</span>, <span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>(result)))
                    
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(result, <span class="hljs-string">&#x27;usage&#x27;</span>):
                        span.set_attribute(<span class="hljs-string">&quot;llm.tokens.prompt&quot;</span>, result.usage.prompt_tokens)
                        span.set_attribute(<span class="hljs-string">&quot;llm.tokens.completion&quot;</span>, result.usage.completion_tokens)
                    
                    <span class="hljs-keyword">return</span> result
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    span.set_attribute(<span class="hljs-string">&quot;chain.step.status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)
                    span.record_exception(e)
                    <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator
</code></pre>
</div><hr>
<h3 id="1123-debugging-techniques" tabindex="-1">1.12.3 Debugging Techniques</h3>
<h4 id="step-by-step-replay" tabindex="-1">Step-by-Step Replay</h4>
<p>Replay enables reproducing exact chain execution from logged traces:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainReplayer</span>:
    <span class="hljs-string">&quot;&quot;&quot;Replay chain execution from stored traces for debugging.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, trace_store</span>):
        <span class="hljs-variable language_">self</span>.trace_store = trace_store
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">replay</span>(<span class="hljs-params">self, trace_id: <span class="hljs-built_in">str</span>, stop_at_step: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span>,
               override_step: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span>, override_input: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;
        Replay a chain execution with optional modifications.
        
        Args:
            trace_id: ID of the original trace
            stop_at_step: Stop replay at this step index
            override_step: Step index to inject modified input
            override_input: Modified input for the override step
        &quot;&quot;&quot;</span>
        traces = <span class="hljs-variable language_">self</span>.trace_store.get_steps(trace_id)
        results = {}
        
        <span class="hljs-keyword">for</span> i, step_trace <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(traces):
            <span class="hljs-keyword">if</span> stop_at_step <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> i &gt;= stop_at_step:
                <span class="hljs-keyword">break</span>
            
            <span class="hljs-keyword">if</span> i == override_step <span class="hljs-keyword">and</span> override_input <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-comment"># Re-execute step with modified input</span>
                step_fn = <span class="hljs-variable language_">self</span>._resolve_step_fn(step_trace.step_name)
                results[<span class="hljs-string">f&quot;step_<span class="hljs-subst">{i}</span>&quot;</span>] = step_fn(override_input)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Step <span class="hljs-subst">{i}</span> (<span class="hljs-subst">{step_trace.step_name}</span>): RE-EXECUTED with override&quot;</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Use cached result from original execution</span>
                results[<span class="hljs-string">f&quot;step_<span class="hljs-subst">{i}</span>&quot;</span>] = step_trace.output_data
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Step <span class="hljs-subst">{i}</span> (<span class="hljs-subst">{step_trace.step_name}</span>): REPLAYED from cache&quot;</span>)
        
        <span class="hljs-keyword">return</span> results
</code></pre>
</div><h4 id="input-perturbation-analysis" tabindex="-1">Input Perturbation Analysis</h4>
<p>Systematically modify inputs to identify sensitivity:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PerturbationAnalyzer</span>:
    <span class="hljs-string">&quot;&quot;&quot;Analyze chain sensitivity to input perturbations.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, chain, similarity_fn</span>):
        <span class="hljs-variable language_">self</span>.chain = chain
        <span class="hljs-variable language_">self</span>.similarity_fn = similarity_fn
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze</span>(<span class="hljs-params">self, base_input: <span class="hljs-built_in">dict</span>, perturbations: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]</span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;
        Run chain on base input and perturbations, measure output drift.
        &quot;&quot;&quot;</span>
        base_output = <span class="hljs-variable language_">self</span>.chain.invoke(base_input)
        
        results = []
        <span class="hljs-keyword">for</span> perturbed_input <span class="hljs-keyword">in</span> perturbations:
            perturbed_output = <span class="hljs-variable language_">self</span>.chain.invoke(perturbed_input)
            
            input_distance = <span class="hljs-variable language_">self</span>._compute_input_distance(base_input, perturbed_input)
            output_similarity = <span class="hljs-variable language_">self</span>.similarity_fn(base_output, perturbed_output)
            
            results.append({
                <span class="hljs-string">&quot;perturbation&quot;</span>: <span class="hljs-variable language_">self</span>._describe_perturbation(base_input, perturbed_input),
                <span class="hljs-string">&quot;input_distance&quot;</span>: input_distance,
                <span class="hljs-string">&quot;output_similarity&quot;</span>: output_similarity,
                <span class="hljs-string">&quot;amplification_factor&quot;</span>: (<span class="hljs-number">1</span> - output_similarity) / <span class="hljs-built_in">max</span>(input_distance, <span class="hljs-number">1e-8</span>)
            })
        
        <span class="hljs-comment"># Sort by amplification factor to find most sensitive perturbations</span>
        results.sort(key=<span class="hljs-keyword">lambda</span> r: r[<span class="hljs-string">&quot;amplification_factor&quot;</span>], reverse=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;base_output&quot;</span>: base_output,
            <span class="hljs-string">&quot;sensitivity_analysis&quot;</span>: results,
            <span class="hljs-string">&quot;most_sensitive&quot;</span>: results[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> results <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
        }
</code></pre>
</div><p><strong>Amplification factor</strong>: measures how much output changes relative to input change:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>AF</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><msub><mi>d</mi><mtext>output</mtext></msub><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><msub><mi>d</mi><mtext>input</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\text{AF}(x, x&#x27;) = \frac{d_{\text{output}}(f(x), f(x&#x27;))}{d_{\text{input}}(x, x&#x27;)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">AF</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.401em;vertical-align:-0.9721em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4289em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">input</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6779em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">output</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>A high amplification factor indicates <strong>brittle chain steps</strong> where small input variations cause large output deviations—analogous to gradient explosion in neural networks.</p>
<h4 id="root-cause-analysis-for-chain-failures" tabindex="-1">Root Cause Analysis for Chain Failures</h4>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainRCA</span>:
    <span class="hljs-string">&quot;&quot;&quot;Root Cause Analysis for chain failures.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_failure</span>(<span class="hljs-params">self, trace_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        steps = <span class="hljs-variable language_">self</span>.trace_store.get_steps(trace_id)
        
        <span class="hljs-comment"># Find the first failing step</span>
        failure_step = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">for</span> i, step <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(steps):
            <span class="hljs-keyword">if</span> step.error <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                failure_step = i
                <span class="hljs-keyword">break</span>
        
        <span class="hljs-keyword">if</span> failure_step <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;no_failure_detected&quot;</span>}
        
        <span class="hljs-comment"># Analyze upstream context</span>
        analysis = {
            <span class="hljs-string">&quot;failing_step&quot;</span>: steps[failure_step].step_name,
            <span class="hljs-string">&quot;failure_index&quot;</span>: failure_step,
            <span class="hljs-string">&quot;error&quot;</span>: steps[failure_step].error,
            <span class="hljs-string">&quot;upstream_analysis&quot;</span>: [],
            <span class="hljs-string">&quot;probable_causes&quot;</span>: []
        }
        
        <span class="hljs-comment"># Check upstream outputs for anomalies</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(failure_step):
            step = steps[i]
            anomalies = <span class="hljs-variable language_">self</span>._detect_anomalies(step)
            <span class="hljs-keyword">if</span> anomalies:
                analysis[<span class="hljs-string">&quot;upstream_analysis&quot;</span>].append({
                    <span class="hljs-string">&quot;step&quot;</span>: step.step_name,
                    <span class="hljs-string">&quot;anomalies&quot;</span>: anomalies
                })
        
        <span class="hljs-comment"># Classify probable cause</span>
        error_text = steps[failure_step].error
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;parse&quot;</span> <span class="hljs-keyword">in</span> error_text.lower() <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;json&quot;</span> <span class="hljs-keyword">in</span> error_text.lower():
            analysis[<span class="hljs-string">&quot;probable_causes&quot;</span>].append(
                <span class="hljs-string">&quot;Output format mismatch — upstream step produced &quot;</span>
                <span class="hljs-string">&quot;unstructured output where structured was expected&quot;</span>
            )
            <span class="hljs-comment"># Check if upstream output was truncated</span>
            prev_output = <span class="hljs-built_in">str</span>(steps[failure_step - <span class="hljs-number">1</span>].output_data) <span class="hljs-keyword">if</span> failure_step &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span>
            <span class="hljs-keyword">if</span> prev_output.endswith(<span class="hljs-string">&quot;...&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(prev_output) &gt; <span class="hljs-number">4000</span>:
                analysis[<span class="hljs-string">&quot;probable_causes&quot;</span>].append(
                    <span class="hljs-string">&quot;Possible token limit truncation in upstream step&quot;</span>
                )
        
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;rate&quot;</span> <span class="hljs-keyword">in</span> error_text.lower() <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;429&quot;</span> <span class="hljs-keyword">in</span> error_text:
            analysis[<span class="hljs-string">&quot;probable_causes&quot;</span>].append(
                <span class="hljs-string">&quot;API rate limit exceeded — consider adding backoff/retry&quot;</span>
            )
        
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;context&quot;</span> <span class="hljs-keyword">in</span> error_text.lower() <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;length&quot;</span> <span class="hljs-keyword">in</span> error_text.lower():
            <span class="hljs-comment"># Calculate cumulative token usage</span>
            cumulative_tokens = <span class="hljs-built_in">sum</span>(
                s.token_usage.get(<span class="hljs-string">&quot;total_tokens&quot;</span>, <span class="hljs-number">0</span>)
                <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> steps[:failure_step + <span class="hljs-number">1</span>]
            )
            analysis[<span class="hljs-string">&quot;probable_causes&quot;</span>].append(
                <span class="hljs-string">f&quot;Context window overflow — cumulative tokens: <span class="hljs-subst">{cumulative_tokens}</span>&quot;</span>
            )
        
        <span class="hljs-keyword">return</span> analysis
</code></pre>
</div><hr>
<h3 id="1124-metrics-and-kpis" tabindex="-1">1.12.4 Metrics and KPIs</h3>
<h4 id="comprehensive-metrics-framework" tabindex="-1">Comprehensive Metrics Framework</h4>
<p>Define a metrics hierarchy that spans from individual steps to entire chain performance:</p>
<p><strong>Level 1: Step-Level Metrics</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Step latency</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> (ms)</td>
<td>Identify bottleneck steps</td>
</tr>
<tr>
<td>Step token usage</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>T</mi><mi>i</mi><mtext>prompt</mtext></msubsup><mo>+</mo><msubsup><mi>T</mi><mi>i</mi><mtext>completion</mtext></msubsup></mrow><annotation encoding="application/x-tex">T_i^{\text{prompt}} + T_i^{\text{completion}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1883em;vertical-align:-0.2769em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9115em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">prompt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2439em;vertical-align:-0.2769em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.967em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">completion</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span></span></span></span></eq></td>
<td>Cost attribution</td>
</tr>
<tr>
<td>Step success rate</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mtext>successful</mtext><mi>i</mi></msub><msub><mtext>total</mtext><mi>i</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\frac{\text{successful}_{i}}{\text{total}_{i}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3413em;vertical-align:-0.4451em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8962em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">total</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">successful</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Reliability per step</td>
</tr>
<tr>
<td>Step retry rate</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mtext>retries</mtext><mi>i</mi></msub><msub><mtext>total</mtext><mi>i</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\frac{\text{retries}_{i}}{\text{total}_{i}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3227em;vertical-align:-0.4451em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8776em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">total</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">retries</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Transient failure frequency</td>
</tr>
</tbody>
</table>
<p><strong>Level 2: Chain-Level Metrics</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>End-to-end latency</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>e2e</mtext></msub><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_{\text{e2e}} = \sum_{i=1}^{n} L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">e2e</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> (sequential)</td>
<td>User experience</td>
</tr>
<tr>
<td>End-to-end success rate</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mi>P</mi><mo stretchy="false">(</mo><msub><mtext>success</mtext><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\prod_{i=1}^{n} P(\text{success}_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">success</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></eq> (independent steps)</td>
<td>Reliability</td>
</tr>
<tr>
<td>Total cost</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mtext>total</mtext></msub><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_{\text{total}} = \sum_{i=1}^{n} C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">total</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq></td>
<td>Budget management</td>
</tr>
<tr>
<td>Token efficiency</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>η</mi><mo>=</mo><mfrac><msub><mi>Q</mi><mtext>output</mtext></msub><mrow><mo>∑</mo><msub><mi>T</mi><mi>i</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\eta = \frac{Q_{\text{output}}}{\sum T_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.5057em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9857em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5073em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">output</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Value per token</td>
</tr>
</tbody>
</table>
<p><strong>Level 3: System-Level Metrics</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Throughput</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mtext>chains completed</mtext><mtext>time window</mtext></mfrac></mrow><annotation encoding="application/x-tex">\frac{\text{chains completed}}{\text{time window}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">time window</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chains completed</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Capacity</td>
</tr>
<tr>
<td>Queue depth</td>
<td>Per-step queue sizes</td>
<td>Backpressure detection</td>
</tr>
<tr>
<td>Error rate over time</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mo stretchy="false">(</mo><mtext>errors</mtext><mo stretchy="false">)</mo></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{d(\text{errors})}{dt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mopen mtight">(</span><span class="mord text mtight"><span class="mord mtight">errors</span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></td>
<td>Trend detection</td>
</tr>
</tbody>
</table>
<h4 id="latency-distribution-analysis" tabindex="-1">Latency Distribution Analysis</h4>
<p>Chain latency follows a <strong>sum of distributions</strong> (for sequential chains):</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>L</mi><mtext>chain</mtext></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">
L_{\text{chain}} = \sum_{i=1}^{n} L_i
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chain</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>If each <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>is approximately log-normal (common for API calls), then<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>chain</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{chain}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chain</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> is approximately log-normal by the CLT for log-normal distributions:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>ln</mi><mo>⁡</mo><msub><mi>L</mi><mtext>chain</mtext></msub><mo>≈</mo><mi mathvariant="script">N</mi><mrow><mo fence="true">(</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>μ</mi><mi>i</mi></msub><mo separator="true">,</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msubsup><mi>σ</mi><mi>i</mi><mn>2</mn></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\ln L_{\text{chain}} \approx \mathcal{N}\left(\sum_{i=1}^{n} \mu_i, \sum_{i=1}^{n} \sigma_i^2\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chain</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0277em;vertical-align:-1.2777em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span></eqn></section><p>Report <strong>percentile metrics</strong> rather than means:</p>
<ul>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>50</mn></msub></mrow><annotation encoding="application/x-tex">p_{50}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">50</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>: Median latency (typical user experience)</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>95</mn></msub></mrow><annotation encoding="application/x-tex">p_{95}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">95</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>: Tail latency (degraded experience threshold)</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>99</mn></msub></mrow><annotation encoding="application/x-tex">p_{99}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">99</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>: Extreme tail (SLA boundary)</li>
</ul>
<p>The relationship:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mn>99</mn></msub><mo>=</mo><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>μ</mi><mrow><mi>ln</mi><mo>⁡</mo><mi>L</mi></mrow></msub><mo>+</mo><mn>2.326</mn><mo>⋅</mo><msub><mi>σ</mi><mrow><mi>ln</mi><mo>⁡</mo><mi>L</mi></mrow></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p_{99} = \exp\left(\mu_{\ln L} + 2.326 \cdot \sigma_{\ln L}\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">99</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">l</span><span class="mtight">n</span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">2.326</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">l</span><span class="mtight">n</span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></eqn></section><h4 id="token-efficiency-metric" tabindex="-1">Token Efficiency Metric</h4>
<p>Define token efficiency as the ratio of output quality to tokens consumed:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>η</mi><mtext>token</mtext></msub><mo>=</mo><mfrac><msub><mi>Q</mi><mtext>output</mtext></msub><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msubsup><mi>T</mi><mi>i</mi><mtext>prompt</mtext></msubsup><mo>+</mo><msubsup><mi>T</mi><mi>i</mi><mtext>completion</mtext></msubsup><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\eta_{\text{token}} = \frac{Q_{\text{output}}}{\sum_{i=1}^{n} (T_i^{\text{prompt}} + T_i^{\text{completion}})}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">token</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5171em;vertical-align:-1.1567em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.143em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9115em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">prompt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.967em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">completion</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">output</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1567em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mtext>output</mtext></msub><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Q_{\text{output}} \in [0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">output</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></eq> is a normalized quality score. This metric enables <strong>chain architecture comparison</strong>: two chains achieving the same quality but with different token budgets can be objectively ranked.</p>
<h4 id="cost-per-successful-execution" tabindex="-1">Cost Per Successful Execution</h4>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>CPSE</mtext><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mtext>all runs</mtext></munder><msub><mi>C</mi><mtext>run</mtext></msub></mrow><mrow><munder><mo>∑</mo><mtext>all runs</mtext></munder><mn mathvariant="double-struck">1</mn><mo stretchy="false">[</mo><mtext>success</mtext><mo stretchy="false">]</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\text{CPSE} = \frac{\sum_{\text{all runs}} C_{\text{run}}}{\sum_{\text{all runs}} \mathbb{1}[\text{success}]}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">CPSE</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4254em;vertical-align:-0.9857em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4397em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">all runs</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mopen">[</span><span class="mord text"><span class="mord">success</span></span><span class="mclose">]</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">all runs</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">run</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9857em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>This accounts for <strong>wasted spend</strong> on failed executions that consume tokens without producing usable output. A chain with 90% success rate and $0.01 per run has:</p>
<p>$$
\text{CPSE} = \frac{$0.01}{0.9} \approx $0.0111
$$</p>

      </article>
      <section class="doc-pager" aria-label="Document pagination">
        <a class="pager-link" href="../Agentic_ai/Optimization_of_prompt_chains.html"><small>Previous</small><strong>1.9 Optimization of Prompt Chains</strong></a>
        <a class="pager-link" href="../Agentic_ai/Prompt_Chaining_index.html"><small>Next</small><strong>Chapter 1: Prompt Chaining — Comprehensive Index</strong></a>
      </section>
      <footer class="doc-footer">
        <p>Generated from <code>llm_training_at_scale</code> at <time datetime="2026-02-19T19:13:56.962Z">2026-02-19T19:13:56.962Z</time>.</p>
      </footer>
    </main>
    <aside class="toc-pane">
      <p class="pane-label">On This Page</p>
      <nav class="toc-nav" aria-label="Table of contents">
<a class="toc-link toc-level-2" data-toc-link href="#111-prompt-chaining-frameworks-and-implementation">1.11 Prompt Chaining Frameworks and Implementation</a>
<a class="toc-link toc-level-3" data-toc-link href="#1111-framework-landscape">1.11.1 Framework Landscape</a>
<a class="toc-link toc-level-4" data-toc-link href="#taxonomy-of-design-philosophies">Taxonomy of Design Philosophies</a>
<a class="toc-link toc-level-4" data-toc-link href="#architectural-invariants-across-frameworks">Architectural Invariants Across Frameworks</a>
<a class="toc-link toc-level-3" data-toc-link href="#1112-langchain-expression-language-lcel">1.11.2 LangChain Expression Language (LCEL)</a>
<a class="toc-link toc-level-4" data-toc-link href="#the-runnable-interface">The Runnable Interface</a>
<a class="toc-link toc-level-4" data-toc-link href="#sequential-composition-via-pipe-operator">Sequential Composition via Pipe Operator</a>
<a class="toc-link toc-level-4" data-toc-link href="#runnableparallel">RunnableParallel</a>
<a class="toc-link toc-level-4" data-toc-link href="#runnablebranch-conditional-routing">RunnableBranch (Conditional Routing)</a>
<a class="toc-link toc-level-4" data-toc-link href="#runnablepassthrough-and-data-flow-control">RunnablePassthrough and Data Flow Control</a>
<a class="toc-link toc-level-4" data-toc-link href="#output-parsers-integration">Output Parsers Integration</a>
<a class="toc-link toc-level-4" data-toc-link href="#streaming-and-async-architecture">Streaming and Async Architecture</a>
<a class="toc-link toc-level-4" data-toc-link href="#lcel-limitations-and-design-tradeoffs">LCEL Limitations and Design Tradeoffs</a>
<a class="toc-link toc-level-3" data-toc-link href="#1113-dspy-based-chain-construction">1.11.3 DSPy-Based Chain Construction</a>
<a class="toc-link toc-level-4" data-toc-link href="#signatures-as-chain-step-contracts">Signatures as Chain Step Contracts</a>
<a class="toc-link toc-level-4" data-toc-link href="#modules-as-composable-chain-steps">Modules as Composable Chain Steps</a>
<a class="toc-link toc-level-4" data-toc-link href="#telepromptersoptimizers-for-chain-optimization">Teleprompters/Optimizers for Chain Optimization</a>
<a class="toc-link toc-level-4" data-toc-link href="#assertions-and-constraints-in-chains">Assertions and Constraints in Chains</a>
<a class="toc-link toc-level-4" data-toc-link href="#programmatic-vs-declarative-chain-definition">Programmatic vs. Declarative Chain Definition</a>
<a class="toc-link toc-level-3" data-toc-link href="#1114-implementation-patterns">1.11.4 Implementation Patterns</a>
<a class="toc-link toc-level-4" data-toc-link href="#pattern-1-chain-as-a-class-hierarchy">Pattern 1: Chain as a Class Hierarchy</a>
<a class="toc-link toc-level-4" data-toc-link href="#pattern-2-chain-as-a-pipeline-functional-composition">Pattern 2: Chain as a Pipeline (Functional Composition)</a>
<a class="toc-link toc-level-4" data-toc-link href="#pattern-3-chain-as-a-graph-dag-execution-engine">Pattern 3: Chain as a Graph (DAG Execution Engine)</a>
<a class="toc-link toc-level-4" data-toc-link href="#pattern-4-chain-as-a-state-machine">Pattern 4: Chain as a State Machine</a>
<a class="toc-link toc-level-4" data-toc-link href="#serialization-and-version-control">Serialization and Version Control</a>
<a class="toc-link toc-level-3" data-toc-link href="#1115-infrastructure-and-deployment">1.11.5 Infrastructure and Deployment</a>
<a class="toc-link toc-level-4" data-toc-link href="#chain-execution-engines">Chain Execution Engines</a>
<a class="toc-link toc-level-4" data-toc-link href="#distributed-chain-execution">Distributed Chain Execution</a>
<a class="toc-link toc-level-4" data-toc-link href="#serverless-chain-deployment">Serverless Chain Deployment</a>
<a class="toc-link toc-level-4" data-toc-link href="#queue-based-async-chain-execution">Queue-Based Async Chain Execution</a>
<a class="toc-link toc-level-2" data-toc-link href="#112-observability-debugging-and-tracing">1.12 Observability, Debugging, and Tracing</a>
<a class="toc-link toc-level-3" data-toc-link href="#1121-tracing-and-logging">1.12.1 Tracing and Logging</a>
<a class="toc-link toc-level-4" data-toc-link href="#per-step-inputoutput-logging">Per-Step Input/Output Logging</a>
<a class="toc-link toc-level-4" data-toc-link href="#token-usage-tracking-per-step">Token Usage Tracking Per Step</a>
<a class="toc-link toc-level-4" data-toc-link href="#trace-id-propagation">Trace ID Propagation</a>
<a class="toc-link toc-level-4" data-toc-link href="#structured-logging-format">Structured Logging Format</a>
<a class="toc-link toc-level-3" data-toc-link href="#1122-observability-tools">1.12.2 Observability Tools</a>
<a class="toc-link toc-level-4" data-toc-link href="#langsmith-tracing">LangSmith Tracing</a>
<a class="toc-link toc-level-4" data-toc-link href="#opentelemetry-integration">OpenTelemetry Integration</a>
<a class="toc-link toc-level-3" data-toc-link href="#1123-debugging-techniques">1.12.3 Debugging Techniques</a>
<a class="toc-link toc-level-4" data-toc-link href="#step-by-step-replay">Step-by-Step Replay</a>
<a class="toc-link toc-level-4" data-toc-link href="#input-perturbation-analysis">Input Perturbation Analysis</a>
<a class="toc-link toc-level-4" data-toc-link href="#root-cause-analysis-for-chain-failures">Root Cause Analysis for Chain Failures</a>
<a class="toc-link toc-level-3" data-toc-link href="#1124-metrics-and-kpis">1.12.4 Metrics and KPIs</a>
<a class="toc-link toc-level-4" data-toc-link href="#comprehensive-metrics-framework">Comprehensive Metrics Framework</a>
<a class="toc-link toc-level-4" data-toc-link href="#latency-distribution-analysis">Latency Distribution Analysis</a>
<a class="toc-link toc-level-4" data-toc-link href="#token-efficiency-metric">Token Efficiency Metric</a>
<a class="toc-link toc-level-4" data-toc-link href="#cost-per-successful-execution">Cost Per Successful Execution</a>
      </nav>
    </aside>
  </div>
  <script type="module" src="../assets/app.js?v=2026-02-19T19%3A13%3A56.962Z"></script>
</body>
</html>