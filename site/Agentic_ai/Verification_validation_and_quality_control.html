<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="1.8 Verification, Validation, and Quality Control">
  <title>1.8 Verification, Validation, and Quality Control | AI Engineering Knowledge Hub</title>
  <script>
  (() => {
    try {
      const key = "docs-theme-mode";
      const raw = window.localStorage.getItem(key);
      const mode = raw === "graphite" || raw === "ivory" ? raw : "ivory";
      document.documentElement.dataset.theme = mode;
      document.documentElement.style.colorScheme = mode === "graphite" ? "dark" : "light";
    } catch {
      document.documentElement.dataset.theme = "ivory";
      document.documentElement.style.colorScheme = "light";
    }
  })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="../assets/vendor/katex/katex.min.css?v=2026-02-19T19%3A13%3A56.962Z">
  <link rel="stylesheet" href="../assets/styles.css?v=2026-02-19T19%3A13%3A56.962Z">
</head>
<body>
  <div class="ambient-layer ambient-layer-a" aria-hidden="true"></div>
  <div class="ambient-layer ambient-layer-b" aria-hidden="true"></div>
  <header class="topbar">
    <button id="menu-toggle" class="icon-btn" type="button" aria-label="Toggle navigation">Menu</button>
    <a class="brand" href="../index.html">
      <span class="brand-kicker">Docs</span>
      <strong>AI Engineering Knowledge Hub</strong>
    </a>
    <div class="topbar-actions">
      <input id="nav-filter" class="doc-filter" type="search" placeholder="Filter documents" aria-label="Filter documents">
      <p id="filter-status" class="filter-status" aria-live="polite"></p>
      <button id="theme-toggle" class="icon-btn" type="button" aria-label="Switch theme">Graphite</button>
    </div>
  </header>
  <div class="site-shell">
    <aside class="nav-pane" id="left-nav">
      <p class="pane-label">Source Folder</p>
      <p class="pane-title">llm_training_at_scale</p>
      <nav class="doc-nav" aria-label="Document list">
<a class="doc-link" data-doc-link data-doc-title="1.10 advanced prompt chaining techniques" data-doc-path="agentic_ai/advanced_prompt_chaining_techniques" data-doc-folder="agentic_ai" href="../Agentic_ai/Advanced_prompt_chaining_techniques.html"><span>1.10 Advanced Prompt Chaining Techniques</span><small>Agentic_ai/Advanced_prompt_chaining_techniques</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/architecture_and_design_patterns_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Architecture_and_design_patterns_of_prompt_chains.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Architecture_and_design_patterns_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.7 error handling, robustness, and fault tolerance" data-doc-path="agentic_ai/error_handling_robustness_and_fault_tolerance" data-doc-folder="agentic_ai" href="../Agentic_ai/Error_handling_robustness_and_fault_tolerance.html"><span>1.7 Error Handling, Robustness, and Fault Tolerance</span><small>Agentic_ai/Error_handling_robustness_and_fault_tolerance</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.13 evaluation of prompt chains" data-doc-path="agentic_ai/evaluation_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Evaluation_of_prompt_chains.html"><span>1.13 Evaluation of Prompt Chains</span><small>Agentic_ai/Evaluation_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive treatment" data-doc-path="agentic_ai/foundations_of_prompt_chaining" data-doc-folder="agentic_ai" href="../Agentic_ai/Foundations_of_prompt_chaining.html"><span>Chapter 1: Prompt Chaining — Comprehensive Treatment</span><small>Agentic_ai/Foundations_of_prompt_chaining</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.9 optimization of prompt chains" data-doc-path="agentic_ai/optimization_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Optimization_of_prompt_chains.html"><span>1.9 Optimization of Prompt Chains</span><small>Agentic_ai/Optimization_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="prompt chaining: frameworks, observability, evaluation, security, applications, and paradigm comparisons" data-doc-path="agentic_ai/prompt chaining_frameworks_and_implementation" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt Chaining_frameworks_and_Implementation.html"><span>Prompt Chaining: Frameworks, Observability, Evaluation, Security, Applications, and Paradigm Comparisons</span><small>Agentic_ai/Prompt Chaining_frameworks_and_Implementation</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive index" data-doc-path="agentic_ai/prompt_chaining_index" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_Chaining_index.html"><span>Chapter 1: Prompt Chaining — Comprehensive Index</span><small>Agentic_ai/Prompt_Chaining_index</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.16 prompt chaining vs. related paradigms" data-doc-path="agentic_ai/prompt_chaining_vs_related_paradigm" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_chaining_vs_related_paradigm.html"><span>1.16 Prompt Chaining vs. Related Paradigms</span><small>Agentic_ai/Prompt_chaining_vs_related_paradigm</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/prompt_design_for_chain_steps" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_design_for_chain_steps.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Prompt_design_for_chain_steps</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.15 real-world applications and case studies" data-doc-path="agentic_ai/real-world_applications_and_case_studies" data-doc-folder="agentic_ai" href="../Agentic_ai/Real-World_applications_and_case_studies.html"><span>1.15 Real-World Applications and Case Studies</span><small>Agentic_ai/Real-World_applications_and_case_studies</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.6 routing and conditional logic in chains" data-doc-path="agentic_ai/routing_and_conditional_logic_in_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Routing_and_conditional_logic_in_chains.html"><span>1.6 Routing and Conditional Logic in Chains</span><small>Agentic_ai/Routing_and_conditional_logic_in_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.14 security, safety, and guardrails in prompt chains" data-doc-path="agentic_ai/security_safety_and_guardrails_in_prompt_chaind" data-doc-folder="agentic_ai" href="../Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind.html"><span>1.14 Security, Safety, and Guardrails in Prompt Chains</span><small>Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.4 state management and context propagation" data-doc-path="agentic_ai/state_management_and_context_propagation" data-doc-folder="agentic_ai" href="../Agentic_ai/State_management_and_context_propagation.html"><span>1.4 State Management and Context Propagation</span><small>Agentic_ai/State_management_and_context_propagation</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.5 task decomposition strategies" data-doc-path="agentic_ai/task_decomposition_strategies" data-doc-folder="agentic_ai" href="../Agentic_ai/Task_decomposition_strategies.html"><span>1.5 Task Decomposition Strategies</span><small>Agentic_ai/Task_decomposition_strategies</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/documentation_mcp_mcp_for_agent_security" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/introduction_tools_action" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Introduction_Tools_Action.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Introduction_Tools_Action</small></a>
<a class="doc-link" data-doc-link data-doc-title="2.6 security in mcp" data-doc-path="agentic_ai/tools/security_mcp_conclusion" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Security_MCP_conclusion.html"><span>2.6 Security in MCP</span><small>Agentic_ai/Tools/Security_MCP_conclusion</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota index" data-doc-path="agentic_ai/tools/tools_comprehensive_index" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Tools_comprehensive_Index.html"><span>Chapter 2: Tools — Comprehensive SOTA Index</span><small>Agentic_ai/Tools/Tools_comprehensive_Index</small></a>
<a class="doc-link is-active" data-doc-link data-doc-title="1.8 verification, validation, and quality control" data-doc-path="agentic_ai/verification_validation_and_quality_control" data-doc-folder="agentic_ai" href="../Agentic_ai/Verification_validation_and_quality_control.html"><span>1.8 Verification, Validation, and Quality Control</span><small>Agentic_ai/Verification_validation_and_quality_control</small></a>
<a class="doc-link" data-doc-link data-doc-title="context parallelism and ring attention" data-doc-path="context_parallelism_update" data-doc-folder="root" href="../context_parallelism_update.html"><span>Context Parallelism and Ring Attention</span><small>context_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="context_parallelism" data-doc-folder="root" href="../context_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>context_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism: a comprehensive technical treatment" data-doc-path="data_parallelism_basic" data-doc-folder="root" href="../data_parallelism_basic.html"><span>Data Parallelism: A Comprehensive Technical Treatment</span><small>data_parallelism_basic</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism (dp): a comprehensive technical treatment" data-doc-path="data_parallelism" data-doc-folder="root" href="../data_parallelism.html"><span>Data Parallelism (DP): A Comprehensive Technical Treatment</span><small>data_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="finding the best training configuration for distributed large model training" data-doc-path="distributed_large_model_training" data-doc-folder="root" href="../distributed_large_model_training.html"><span>Finding the Best Training Configuration for Distributed Large Model Training</span><small>distributed_large_model_training</small></a>
<a class="doc-link" data-doc-link data-doc-title="diving into the gpus — fusing, threading, and mixing" data-doc-path="diving_gpus_fusing_threading_and_mixing" data-doc-folder="root" href="../diving_gpus_fusing_threading_and_mixing.html"><span>Diving into the GPUs — Fusing, Threading, and Mixing</span><small>diving_gpus_fusing_threading_and_mixing</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism_update" data-doc-folder="root" href="../expert_parallelism_update.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism" data-doc-folder="root" href="../expert_parallelism.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="scaling distributed training: foundations and first principles" data-doc-path="high_level_overview_updated" data-doc-folder="root" href="../high_level_overview_updated.html"><span>Scaling Distributed Training: Foundations and First Principles</span><small>high_level_overview_updated</small></a>
<a class="doc-link" data-doc-link data-doc-title="high-level overview of distributed training: foundations, memory analysis, and first-step techniques" data-doc-path="high_level_overview" data-doc-folder="root" href="../high_level_overview.html"><span>High-Level Overview of Distributed Training: Foundations, Memory Analysis, and First-Step Techniques</span><small>high_level_overview</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: comprehensive technical exposition" data-doc-path="pipelineparallelism_update" data-doc-folder="root" href="../pipelineparallelism_update.html"><span>Pipeline Parallelism: Comprehensive Technical Exposition</span><small>pipelineparallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: a comprehensive technical exposition" data-doc-path="pipelineparallelism" data-doc-folder="root" href="../pipelineparallelism.html"><span>Pipeline Parallelism: A Comprehensive Technical Exposition</span><small>pipelineparallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism_update" data-doc-folder="root" href="../tensor_parallelism_update.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism" data-doc-folder="root" href="../tensor_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism</small></a>
      </nav>
    </aside>
    <main class="content-pane">
      <article class="doc-content">
<h1 id="18-verification-validation-and-quality-control" tabindex="-1">1.8 Verification, Validation, and Quality Control</h1>
<blockquote>
<p><strong>Scope.</strong> Verification and validation (V&amp;V) ensure that each step and the overall chain produce outputs that are correct, consistent, and aligned with the original intent. Verification asks “Did we build the thing right?” (does the output conform to specification?). Validation asks “Did we build the right thing?” (does the output satisfy the user’s actual need?). This section provides a taxonomy of V&amp;V patterns at per-step, chain-level, and cross-execution granularity.</p>
</blockquote>
<hr>
<h2 id="181-per-step-verification" tabindex="-1">1.8.1 Per-Step Verification</h2>
<h3 id="1811-output-schema-validation" tabindex="-1">1.8.1.1 Output Schema Validation</h3>
<p>The most deterministic form of verification: check that the output conforms to a predefined structural schema <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></eq>.</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mtext>schema</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mn mathvariant="double-struck">1</mn><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mtext> </mtext><msub><mi>y</mi><mi>t</mi></msub><mo>∈</mo><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><msub><mi>σ</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">
V_{\text{schema}}(y_t) = \mathbb{1}\!\bigl[\, y_t \in \mathcal{L}(\sigma_t) \,\bigr]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">schema</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">[</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord mathcal">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">]</span></span></span></span></span></span></eqn></section><p>This was implemented in §1.7.1.4. Key addition: <strong>semantic schema validation</strong> goes beyond structural compliance to check that field values are semantically reasonable.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SemanticSchemaValidator</span>:
    <span class="hljs-string">&quot;&quot;&quot;Validate both structure and semantic plausibility of output fields.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.field_validators: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_field_validator</span>(<span class="hljs-params">self, field_name: <span class="hljs-built_in">str</span>, 
                                  validator: <span class="hljs-type">Callable</span>[[<span class="hljs-type">Any</span>], <span class="hljs-built_in">bool</span>]</span>):
        <span class="hljs-variable language_">self</span>.field_validators[field_name] = validator
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">dict</span>, schema: <span class="hljs-built_in">type</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        results = {<span class="hljs-string">&quot;structural&quot;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;semantic&quot;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;field_results&quot;</span>: {}}
        
        <span class="hljs-comment"># Structural validation</span>
        <span class="hljs-keyword">if</span> schema:
            <span class="hljs-keyword">try</span>:
                schema.model_validate(data)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                results[<span class="hljs-string">&quot;structural&quot;</span>] = <span class="hljs-literal">False</span>
                results[<span class="hljs-string">&quot;structural_error&quot;</span>] = <span class="hljs-built_in">str</span>(e)
                <span class="hljs-keyword">return</span> results
        
        <span class="hljs-comment"># Per-field semantic validation</span>
        <span class="hljs-keyword">for</span> field_name, validator <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.field_validators.items():
            <span class="hljs-keyword">if</span> field_name <span class="hljs-keyword">in</span> data:
                is_valid = validator(data[field_name])
                results[<span class="hljs-string">&quot;field_results&quot;</span>][field_name] = is_valid
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_valid:
                    results[<span class="hljs-string">&quot;semantic&quot;</span>] = <span class="hljs-literal">False</span>
        
        <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># Example field validators</span>
validator = SemanticSchemaValidator()
validator.register_field_validator(
    <span class="hljs-string">&quot;confidence&quot;</span>, <span class="hljs-keyword">lambda</span> v: <span class="hljs-built_in">isinstance</span>(v, (<span class="hljs-built_in">int</span>, <span class="hljs-built_in">float</span>)) <span class="hljs-keyword">and</span> <span class="hljs-number">0.0</span> &lt;= v &lt;= <span class="hljs-number">1.0</span>
)
validator.register_field_validator(
    <span class="hljs-string">&quot;url&quot;</span>, <span class="hljs-keyword">lambda</span> v: <span class="hljs-built_in">isinstance</span>(v, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">and</span> v.startswith(<span class="hljs-string">&quot;http&quot;</span>)
)
validator.register_field_validator(
    <span class="hljs-string">&quot;year&quot;</span>, <span class="hljs-keyword">lambda</span> v: <span class="hljs-built_in">isinstance</span>(v, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">1900</span> &lt;= v &lt;= <span class="hljs-number">2030</span>
)
</code></pre>
</div><h3 id="1812-factuality-checking-retrieval-augmented-verification" tabindex="-1">1.8.1.2 Factuality Checking (Retrieval-Augmented Verification)</h3>
<p>Verify that claims in the output are supported by retrieved evidence:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mtext>factual</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mo stretchy="false">{</mo><mi>c</mi><mo>∈</mo><mtext>claims</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>:</mo><mi mathvariant="normal">∃</mi><mtext> </mtext><mi>e</mi><mo>∈</mo><mi mathvariant="script">E</mi><mo separator="true">,</mo><mtext>  </mtext><mtext>entails</mtext><mo stretchy="false">(</mo><mi>e</mi><mo separator="true">,</mo><mi>c</mi><mo stretchy="false">)</mo><mo stretchy="false">}</mo><mi mathvariant="normal">∣</mi></mrow><mrow><mi mathvariant="normal">∣</mi><mtext>claims</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
V_{\text{factual}}(y_t) = \frac{|\{c \in \text{claims}(y_t) : \exists\, e \in \mathcal{E},\; \text{entails}(e, c)\}|}{|\text{claims}(y_t)|}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">factual</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord text"><span class="mord">claims</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mopen">{</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">claims</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∃</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathcal" style="margin-right:0.08944em;">E</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">entails</span></span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">c</span><span class="mclose">)}</span><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><h3 id="1813-consistency-checking-with-prior-steps" tabindex="-1">1.8.1.3 Consistency Checking with Prior Steps</h3>
<p>Verify that step <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></eq>’s output does not contradict information established in previous steps:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mtext>consist</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><mn mathvariant="double-struck">1</mn><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mtext> </mtext><mi mathvariant="normal">¬</mi><mi mathvariant="normal">∃</mi><mtext> </mtext><mi>i</mi><mo>&lt;</mo><mi>t</mi><mo>:</mo><mtext>contradicts</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">
V_{\text{consist}}(y_t, y_1, \dots, y_{t-1}) = \mathbb{1}\!\bigl[\, \neg\exists\, i &lt; t : \text{contradicts}(y_t, y_i) \,\bigr]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">consist</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">[</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">¬∃</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">contradicts</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">]</span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsistencyChecker</span>:
    <span class="hljs-string">&quot;&quot;&quot;Check that a step&#x27;s output is consistent with prior outputs.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">self, current_output: <span class="hljs-built_in">str</span>, 
                    prior_outputs: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> prior_outputs:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;consistent&quot;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;contradictions&quot;</span>: []}
        
        prior_summary = <span class="hljs-string">&quot;\n---\n&quot;</span>.join(
            <span class="hljs-string">f&quot;Step <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{out[:<span class="hljs-number">500</span>]}</span>&quot;</span> <span class="hljs-keyword">for</span> i, out <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(prior_outputs)
        )
        
        prompt = (
            <span class="hljs-string">f&quot;Check if the Current Output contradicts any Prior Output.\n\n&quot;</span>
            <span class="hljs-string">f&quot;Prior Outputs:\n<span class="hljs-subst">{prior_summary}</span>\n\n&quot;</span>
            <span class="hljs-string">f&quot;Current Output:\n<span class="hljs-subst">{current_output}</span>\n\n&quot;</span>
            <span class="hljs-string">f&quot;List any contradictions. Respond as JSON:\n&quot;</span>
            <span class="hljs-string">f&#x27;{{&quot;consistent&quot;: true/false, &quot;contradictions&quot;: &#x27;</span>
            <span class="hljs-string">f&#x27;[{{&quot;claim_current&quot;: &quot;...&quot;, &quot;claim_prior&quot;: &quot;...&quot;, &#x27;</span>
            <span class="hljs-string">f&#x27;&quot;step&quot;: N, &quot;explanation&quot;: &quot;...&quot;}}]}}&#x27;</span>
        )
        
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>)
        <span class="hljs-keyword">return</span> json.loads(response)
</code></pre>
</div><h3 id="1814-constraint-satisfaction-verification" tabindex="-1">1.8.1.4 Constraint Satisfaction Verification</h3>
<p>For steps that must satisfy explicit constraints (numeric bounds, logical conditions, format rules):</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mtext>constraint</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mo>⋀</mo><mrow><mi>c</mi><mo>∈</mo><msub><mi mathvariant="script">C</mi><mi>t</mi></msub></mrow></munder><mi>c</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
V_{\text{constraint}}(y_t) = \bigwedge_{c \in \mathcal{C}_t} c(y_t)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">constraint</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4444em;vertical-align:-1.3944em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.05834em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0583em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">⋀</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">C</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{C}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.05834em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0583em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>is the set of constraints for step<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></eq>.</p>
<hr>
<h2 id="182-chain-level-verification" tabindex="-1">1.8.2 Chain-Level Verification</h2>
<h3 id="1821-end-to-end-output-quality-assessment" tabindex="-1">1.8.2.1 End-to-End Output Quality Assessment</h3>
<p>The final output is evaluated against the <strong>original task specification</strong>, not against any intermediate step’s specification:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>Q</mi><mtext>e2e</mtext></msub><mo>=</mo><msub><mtext>sim</mtext><mtext>semantic</mtext></msub><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><msub><mi>y</mi><mi>n</mi></msub><mo separator="true">,</mo><mtext>  </mtext><mtext>ideal</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
Q_{\text{e2e}} = \text{sim}_{\text{semantic}}\!\bigl(\, y_n,\; \text{ideal}(x) \,\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">e2e</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord"><span class="mord text"><span class="mord">sim</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">semantic</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">ideal</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><p>When no ground truth exists, use a <strong>judge LLM</strong> to evaluate quality on multiple dimensions:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EndToEndEvaluator</span>:
    <span class="hljs-string">&quot;&quot;&quot;Evaluate final chain output against original task intent.&quot;&quot;&quot;</span>
    
    EVALUATION_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Evaluate how well the Output addresses the original Task.

Task: {task}
Output: {output}

Rate on each dimension (1-5):
1. Relevance: Does it address what was asked?
2. Completeness: Does it cover all aspects?
3. Accuracy: Are the facts and reasoning correct?
4. Clarity: Is it well-written and easy to understand?
5. Actionability: Can the user act on this output?

Respond as JSON:
{{&quot;relevance&quot;: N, &quot;completeness&quot;: N, &quot;accuracy&quot;: N, 
  &quot;clarity&quot;: N, &quot;actionability&quot;: N, 
  &quot;overall&quot;: N, &quot;justification&quot;: &quot;...&quot;}}&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, evaluator_llm: <span class="hljs-string">&quot;LLMClient&quot;</span></span>):
        <span class="hljs-variable language_">self</span>.llm = evaluator_llm
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, output: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=<span class="hljs-variable language_">self</span>.EVALUATION_PROMPT.<span class="hljs-built_in">format</span>(task=task, output=output),
            temperature=<span class="hljs-number">0.0</span>
        )
        scores = json.loads(response)
        
        <span class="hljs-comment"># Normalized aggregate</span>
        dims = [<span class="hljs-string">&quot;relevance&quot;</span>, <span class="hljs-string">&quot;completeness&quot;</span>, <span class="hljs-string">&quot;accuracy&quot;</span>, <span class="hljs-string">&quot;clarity&quot;</span>, <span class="hljs-string">&quot;actionability&quot;</span>]
        scores[<span class="hljs-string">&quot;aggregate&quot;</span>] = <span class="hljs-built_in">sum</span>(scores.get(d, <span class="hljs-number">3</span>) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> dims) / (<span class="hljs-number">5</span> * <span class="hljs-built_in">len</span>(dims))
        <span class="hljs-keyword">return</span> scores
</code></pre>
</div><h3 id="1822-invariant-checking-across-chain-execution" tabindex="-1">1.8.2.2 Invariant Checking Across Chain Execution</h3>
<p>Define <strong>chain invariants</strong> — properties that must hold at every step boundary:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∀</mi><mtext> </mtext><mi>t</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">}</mo><mo>:</mo><mspace width="1em"/><mi>I</mi><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mtext mathvariant="monospace">True</mtext></mrow><annotation encoding="application/x-tex">
\forall\, t \in \{1, \dots, n\}: \quad I(S_t) = \texttt{True}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord">∀</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">}</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6111em;"></span><span class="mord text"><span class="mord texttt">True</span></span></span></span></span></span></eqn></section><table>
<thead>
<tr>
<th>Invariant Type</th>
<th>Example</th>
<th>Check Method</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Monotonic progress</strong></td>
<td>Task completion percentage never decreases</td>
<td>Compare <code>state.progress</code> across steps</td>
</tr>
<tr>
<td><strong>Budget adherence</strong></td>
<td>Total token usage stays within allocation</td>
<td>Cumulative sum check</td>
</tr>
<tr>
<td><strong>Schema consistency</strong></td>
<td>State always conforms to the declared schema</td>
<td>Pydantic validation at every boundary</td>
</tr>
<tr>
<td><strong>No information loss</strong></td>
<td>Key facts from step 1 remain accessible in step <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq></td>
<td>Keyword/entity presence check</td>
</tr>
<tr>
<td><strong>Safety</strong></td>
<td>No step output contains unsafe content</td>
<td>Safety classifier at every boundary</td>
</tr>
</tbody>
</table>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainInvariantChecker</span>:
    <span class="hljs-string">&quot;&quot;&quot;Verify that chain-wide invariants hold after every step.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.invariants: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">dict</span>], <span class="hljs-built_in">bool</span>]]] = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_invariant</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, check: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">dict</span>], <span class="hljs-built_in">bool</span>]</span>):
        <span class="hljs-variable language_">self</span>.invariants.append((name, check))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_all</span>(<span class="hljs-params">self, state: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        results = {}
        all_passed = <span class="hljs-literal">True</span>
        
        <span class="hljs-keyword">for</span> name, check <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.invariants:
            <span class="hljs-keyword">try</span>:
                passed = check(state)
                results[name] = {<span class="hljs-string">&quot;passed&quot;</span>: passed}
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> passed:
                    all_passed = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                results[name] = {<span class="hljs-string">&quot;passed&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-built_in">str</span>(e)}
                all_passed = <span class="hljs-literal">False</span>
        
        <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;all_passed&quot;</span>: all_passed, <span class="hljs-string">&quot;invariants&quot;</span>: results}


<span class="hljs-comment"># Example invariants</span>
invariant_checker = ChainInvariantChecker()

invariant_checker.add_invariant(
    <span class="hljs-string">&quot;token_budget&quot;</span>,
    <span class="hljs-keyword">lambda</span> s: s.get(<span class="hljs-string">&quot;tokens_used&quot;</span>, <span class="hljs-number">0</span>) &lt;= s.get(<span class="hljs-string">&quot;token_budget&quot;</span>, <span class="hljs-built_in">float</span>(<span class="hljs-string">&quot;inf&quot;</span>))
)
invariant_checker.add_invariant(
    <span class="hljs-string">&quot;step_progress&quot;</span>,
    <span class="hljs-keyword">lambda</span> s: s.get(<span class="hljs-string">&quot;step_index&quot;</span>, <span class="hljs-number">0</span>) &gt;= s.get(<span class="hljs-string">&quot;prev_step_index&quot;</span>, <span class="hljs-number">0</span>)
)
invariant_checker.add_invariant(
    <span class="hljs-string">&quot;no_empty_results&quot;</span>,
    <span class="hljs-keyword">lambda</span> s: <span class="hljs-built_in">bool</span>(s.get(<span class="hljs-string">&quot;latest_output&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).strip())
)
</code></pre>
</div><hr>
<h2 id="183-verification-patterns" tabindex="-1">1.8.3 Verification Patterns</h2>
<h3 id="1831-verifier-chain-pattern" tabindex="-1">1.8.3.1 Verifier Chain Pattern</h3>
<p>A <strong>separate, independent chain</strong> whose sole purpose is to validate the main chain’s output. The verifier chain has different prompts, potentially a different model, and evaluates along orthogonal criteria.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">Main Chain:     [Step 1] → [Step 2] → [Step 3] → Output
                                                     │
                                                     ▼
Verifier Chain: [Extract Claims] → [Check Facts] → [Score] → Verdict
</code></pre>
</div><h3 id="1832-self-consistency-multi-sample-agreement" tabindex="-1">1.8.3.2 Self-Consistency (Multi-Sample Agreement)</h3>
<p>Run the chain <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq>times with different random seeds (via temperature<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">&gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></eq>) and measure agreement:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Consistency</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>2</mn><mrow><mi>k</mi><mo stretchy="false">(</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow></munder><mtext>sim</mtext><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\text{Consistency}(x) = \frac{2}{k(k-1)} \sum_{i&lt;j} \text{sim}(y^{(i)}, y^{(j)})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Consistency</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7352em;vertical-align:-1.4138em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p><strong>Decision rule:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Accept</mtext><mtext>  </mtext><mo>⟺</mo><mtext>  </mtext><mtext>Consistency</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>&gt;</mo><msub><mi>τ</mi><mtext>agree</mtext></msub></mrow><annotation encoding="application/x-tex">
\text{Accept} \iff \text{Consistency}(x) &gt; \tau_{\text{agree}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Accept</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟺</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Consistency</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">agree</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>If consistency is low, the chain’s output on this input is unreliable and should be flagged for human review or re-executed with a different strategy.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SelfConsistencyVerifier</span>:
    <span class="hljs-string">&quot;&quot;&quot;Verify output reliability via multi-sample agreement.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, chain_executor: <span class="hljs-type">Callable</span>, 
                 similarity_fn: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>], <span class="hljs-built_in">float</span>],
                 k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>, agreement_threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.7</span></span>):
        <span class="hljs-variable language_">self</span>.executor = chain_executor
        <span class="hljs-variable language_">self</span>.sim_fn = similarity_fn
        <span class="hljs-variable language_">self</span>.k = k
        <span class="hljs-variable language_">self</span>.threshold = agreement_threshold
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self, input_data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Generate k independent outputs</span>
        outputs = <span class="hljs-keyword">await</span> asyncio.gather(*[
            <span class="hljs-variable language_">self</span>.executor({**input_data, <span class="hljs-string">&quot;seed&quot;</span>: i})
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.k)
        ])
        
        <span class="hljs-comment"># Compute pairwise similarity</span>
        <span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> combinations
        similarities = []
        <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> combinations(<span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.k), <span class="hljs-number">2</span>):
            sim = <span class="hljs-variable language_">self</span>.sim_fn(<span class="hljs-built_in">str</span>(outputs[a]), <span class="hljs-built_in">str</span>(outputs[b]))
            similarities.append(sim)
        
        avg_agreement = <span class="hljs-built_in">sum</span>(similarities) / <span class="hljs-built_in">len</span>(similarities) <span class="hljs-keyword">if</span> similarities <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        
        <span class="hljs-comment"># Select the output most consistent with others</span>
        output_scores = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.k):
            avg_sim = <span class="hljs-built_in">sum</span>(
                <span class="hljs-variable language_">self</span>.sim_fn(<span class="hljs-built_in">str</span>(outputs[i]), <span class="hljs-built_in">str</span>(outputs[j]))
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.k) <span class="hljs-keyword">if</span> j != i
            ) / (<span class="hljs-variable language_">self</span>.k - <span class="hljs-number">1</span>)
            output_scores.append((avg_sim, i))
        
        best_idx = <span class="hljs-built_in">max</span>(output_scores, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])[<span class="hljs-number">1</span>]
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;reliable&quot;</span>: avg_agreement &gt;= <span class="hljs-variable language_">self</span>.threshold,
            <span class="hljs-string">&quot;agreement_score&quot;</span>: avg_agreement,
            <span class="hljs-string">&quot;selected_output&quot;</span>: outputs[best_idx],
            <span class="hljs-string">&quot;selected_index&quot;</span>: best_idx,
            <span class="hljs-string">&quot;all_outputs_preview&quot;</span>: [<span class="hljs-built_in">str</span>(o)[:<span class="hljs-number">200</span>] <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> outputs],
            <span class="hljs-string">&quot;pairwise_similarities&quot;</span>: similarities
        }
</code></pre>
</div><h3 id="1833-critic-step-pattern" tabindex="-1">1.8.3.3 Critic Step Pattern</h3>
<p>A dedicated LLM step evaluates and scores the output using a detailed rubric:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CriticStep</span>:
    <span class="hljs-string">&quot;&quot;&quot;Dedicated LLM step to critique and score chain output.&quot;&quot;&quot;</span>
    
    CRITIC_PROMPT = <span class="hljs-string">&quot;&quot;&quot;You are a strict quality evaluator. Analyze the following output 
produced for the given task. Be critical and identify ALL issues.

Task: {task}
Output to evaluate: {output}

Evaluation rubric:
1. FACTUAL ACCURACY (0-10): Are all claims verifiable and correct?
2. LOGICAL COHERENCE (0-10): Is the reasoning sound, with no contradictions?
3. COMPLETENESS (0-10): Are all parts of the task addressed?
4. FORMAT COMPLIANCE (0-10): Does the output match the expected format?
5. CONCISENESS (0-10): Is the output appropriately detailed without unnecessary content?

For each dimension:
- Provide the score
- List specific issues found
- Suggest concrete improvements

Final verdict: ACCEPT (avg &gt;= 7), REVISE (avg 4-7), or REJECT (avg &lt; 4)

Respond as JSON.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, critic_llm: <span class="hljs-string">&quot;LLMClient&quot;</span></span>):
        <span class="hljs-variable language_">self</span>.llm = critic_llm
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">critique</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, output: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=<span class="hljs-variable language_">self</span>.CRITIC_PROMPT.<span class="hljs-built_in">format</span>(task=task, output=output),
            temperature=<span class="hljs-number">0.0</span>
        )
        <span class="hljs-keyword">return</span> json.loads(response)
</code></pre>
</div><h3 id="1834-formal-verification-for-code-generating-chains" tabindex="-1">1.8.3.4 Formal Verification for Code-Generating Chains</h3>
<p>When the chain produces executable code, apply <strong>deterministic verification</strong> via test suites and static analysis:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mtext>formal</mtext></msub><mo stretchy="false">(</mo><mtext>code</mtext><mo stretchy="false">)</mo><mo>=</mo><munder><mo>⋀</mo><mrow><mi>t</mi><mo>∈</mo><msub><mi mathvariant="script">T</mi><mtext>tests</mtext></msub></mrow></munder><mtext>passes</mtext><mo stretchy="false">(</mo><mtext>code</mtext><mo separator="true">,</mo><mi>t</mi><mo stretchy="false">)</mo><mtext>  </mtext><mo>∧</mo><mtext>  </mtext><mtext>lint</mtext><mo stretchy="false">(</mo><mtext>code</mtext><mo stretchy="false">)</mo><mo>=</mo><mtext mathvariant="monospace">CLEAN</mtext></mrow><annotation encoding="application/x-tex">
V_{\text{formal}}(\text{code}) = \bigwedge_{t \in \mathcal{T}_{\text{tests}}} \text{passes}(\text{code}, t) \;\wedge\; \text{lint}(\text{code}) = \texttt{CLEAN}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">formal</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord">code</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4444em;vertical-align:-1.3944em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.25417em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.2542em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">tests</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">⋀</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">passes</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">code</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">lint</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">code</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6111em;"></span><span class="mord text"><span class="mord texttt">CLEAN</span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> tempfile

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeVerifier</span>:
    <span class="hljs-string">&quot;&quot;&quot;Verify generated code via execution, testing, and static analysis.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self, code: <span class="hljs-built_in">str</span>, test_code: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>,
                     language: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;python&quot;</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        results = {
            <span class="hljs-string">&quot;syntax_valid&quot;</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">&quot;tests_passed&quot;</span>: <span class="hljs-literal">None</span>,
            <span class="hljs-string">&quot;lint_clean&quot;</span>: <span class="hljs-literal">None</span>,
            <span class="hljs-string">&quot;security_issues&quot;</span>: []
        }
        
        <span class="hljs-comment"># 1. Syntax check</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-built_in">compile</span>(code, <span class="hljs-string">&quot;&lt;generated&gt;&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span>)
            results[<span class="hljs-string">&quot;syntax_valid&quot;</span>] = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> SyntaxError <span class="hljs-keyword">as</span> e:
            results[<span class="hljs-string">&quot;syntax_error&quot;</span>] = <span class="hljs-built_in">str</span>(e)
            <span class="hljs-keyword">return</span> results
        
        <span class="hljs-comment"># 2. Execute tests if provided</span>
        <span class="hljs-keyword">if</span> test_code:
            <span class="hljs-keyword">with</span> tempfile.NamedTemporaryFile(mode=<span class="hljs-string">&quot;w&quot;</span>, suffix=<span class="hljs-string">&quot;.py&quot;</span>, delete=<span class="hljs-literal">False</span>) <span class="hljs-keyword">as</span> f:
                f.write(code + <span class="hljs-string">&quot;\n\n&quot;</span> + test_code)
                f.flush()
                <span class="hljs-keyword">try</span>:
                    proc = subprocess.run(
                        [<span class="hljs-string">&quot;python&quot;</span>, f.name],
                        capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>, timeout=<span class="hljs-number">30</span>
                    )
                    results[<span class="hljs-string">&quot;tests_passed&quot;</span>] = proc.returncode == <span class="hljs-number">0</span>
                    results[<span class="hljs-string">&quot;test_output&quot;</span>] = proc.stdout
                    results[<span class="hljs-string">&quot;test_errors&quot;</span>] = proc.stderr
                <span class="hljs-keyword">except</span> subprocess.TimeoutExpired:
                    results[<span class="hljs-string">&quot;tests_passed&quot;</span>] = <span class="hljs-literal">False</span>
                    results[<span class="hljs-string">&quot;test_errors&quot;</span>] = <span class="hljs-string">&quot;Execution timed out&quot;</span>
        
        <span class="hljs-comment"># 3. Static analysis (basic)</span>
        dangerous_patterns = [<span class="hljs-string">&quot;eval(&quot;</span>, <span class="hljs-string">&quot;exec(&quot;</span>, <span class="hljs-string">&quot;os.system(&quot;</span>, <span class="hljs-string">&quot;__import__(&quot;</span>,
                              <span class="hljs-string">&quot;subprocess.call(&quot;</span>, <span class="hljs-string">&quot;open(&quot;</span>, <span class="hljs-string">&quot;pickle.loads(&quot;</span>]
        <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> dangerous_patterns:
            <span class="hljs-keyword">if</span> pattern <span class="hljs-keyword">in</span> code:
                results[<span class="hljs-string">&quot;security_issues&quot;</span>].append(
                    <span class="hljs-string">f&quot;Potentially dangerous: <span class="hljs-subst">{pattern}</span>&quot;</span>
                )
        
        results[<span class="hljs-string">&quot;lint_clean&quot;</span>] = <span class="hljs-built_in">len</span>(results[<span class="hljs-string">&quot;security_issues&quot;</span>]) == <span class="hljs-number">0</span>
        <span class="hljs-keyword">return</span> results
</code></pre>
</div><hr>
<h2 id="184-human-in-the-loop-verification" tabindex="-1">1.8.4 Human-in-the-Loop Verification</h2>
<p><strong>Checkpoint-based human review</strong> inserts human evaluation at predefined chain boundaries. <strong>Active learning</strong> uses human feedback on uncertain outputs to improve automated verification models. <strong>Escalation policies</strong> define when and how to route to humans (covered in §1.6.4.4).</p>

      </article>
      <section class="doc-pager" aria-label="Document pagination">
        <a class="pager-link" href="../Agentic_ai/Tools/Tools_comprehensive_Index.html"><small>Previous</small><strong>Chapter 2: Tools — Comprehensive SOTA Index</strong></a>
        <a class="pager-link" href="../context_parallelism_update.html"><small>Next</small><strong>Context Parallelism and Ring Attention</strong></a>
      </section>
      <footer class="doc-footer">
        <p>Generated from <code>llm_training_at_scale</code> at <time datetime="2026-02-19T19:13:56.962Z">2026-02-19T19:13:56.962Z</time>.</p>
      </footer>
    </main>
    <aside class="toc-pane">
      <p class="pane-label">On This Page</p>
      <nav class="toc-nav" aria-label="Table of contents">
<a class="toc-link toc-level-2" data-toc-link href="#181-per-step-verification">1.8.1 Per-Step Verification</a>
<a class="toc-link toc-level-3" data-toc-link href="#1811-output-schema-validation">1.8.1.1 Output Schema Validation</a>
<a class="toc-link toc-level-3" data-toc-link href="#1812-factuality-checking-retrieval-augmented-verification">1.8.1.2 Factuality Checking (Retrieval-Augmented Verification)</a>
<a class="toc-link toc-level-3" data-toc-link href="#1813-consistency-checking-with-prior-steps">1.8.1.3 Consistency Checking with Prior Steps</a>
<a class="toc-link toc-level-3" data-toc-link href="#1814-constraint-satisfaction-verification">1.8.1.4 Constraint Satisfaction Verification</a>
<a class="toc-link toc-level-2" data-toc-link href="#182-chain-level-verification">1.8.2 Chain-Level Verification</a>
<a class="toc-link toc-level-3" data-toc-link href="#1821-end-to-end-output-quality-assessment">1.8.2.1 End-to-End Output Quality Assessment</a>
<a class="toc-link toc-level-3" data-toc-link href="#1822-invariant-checking-across-chain-execution">1.8.2.2 Invariant Checking Across Chain Execution</a>
<a class="toc-link toc-level-2" data-toc-link href="#183-verification-patterns">1.8.3 Verification Patterns</a>
<a class="toc-link toc-level-3" data-toc-link href="#1831-verifier-chain-pattern">1.8.3.1 Verifier Chain Pattern</a>
<a class="toc-link toc-level-3" data-toc-link href="#1832-self-consistency-multi-sample-agreement">1.8.3.2 Self-Consistency (Multi-Sample Agreement)</a>
<a class="toc-link toc-level-3" data-toc-link href="#1833-critic-step-pattern">1.8.3.3 Critic Step Pattern</a>
<a class="toc-link toc-level-3" data-toc-link href="#1834-formal-verification-for-code-generating-chains">1.8.3.4 Formal Verification for Code-Generating Chains</a>
<a class="toc-link toc-level-2" data-toc-link href="#184-human-in-the-loop-verification">1.8.4 Human-in-the-Loop Verification</a>
      </nav>
    </aside>
  </div>
  <script type="module" src="../assets/app.js?v=2026-02-19T19%3A13%3A56.962Z"></script>
</body>
</html>