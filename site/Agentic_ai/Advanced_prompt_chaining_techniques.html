<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="1.10 Advanced Prompt Chaining Techniques">
  <title>1.10 Advanced Prompt Chaining Techniques | AI Engineering Knowledge Hub</title>
  <script>
  (() => {
    try {
      const key = "docs-theme-mode";
      const raw = window.localStorage.getItem(key);
      const mode = raw === "graphite" || raw === "ivory" ? raw : "ivory";
      document.documentElement.dataset.theme = mode;
      document.documentElement.style.colorScheme = mode === "graphite" ? "dark" : "light";
    } catch {
      document.documentElement.dataset.theme = "ivory";
      document.documentElement.style.colorScheme = "light";
    }
  })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="../assets/vendor/katex/katex.min.css?v=2026-02-19T19%3A24%3A13.266Z">
  <link rel="stylesheet" href="../assets/styles.css?v=2026-02-19T19%3A24%3A13.266Z">
</head>
<body>
  <div class="ambient-layer ambient-layer-a" aria-hidden="true"></div>
  <div class="ambient-layer ambient-layer-b" aria-hidden="true"></div>
  <header class="topbar">
    <button id="menu-toggle" class="icon-btn" type="button" aria-label="Toggle navigation">Menu</button>
    <a class="brand" href="../index.html">
      <span class="brand-kicker">Docs</span>
      <strong>AI Engineering Knowledge Hub</strong>
    </a>
    <div class="topbar-actions">
      <input id="nav-filter" class="doc-filter" type="search" placeholder="Filter documents" aria-label="Filter documents">
      <p id="filter-status" class="filter-status" aria-live="polite"></p>
      <button id="theme-toggle" class="icon-btn" type="button" aria-label="Switch theme">Graphite</button>
    </div>
  </header>
  <div class="site-shell">
    <aside class="nav-pane" id="left-nav">
      <p class="pane-label">Source Folder</p>
      <p class="pane-title">llm_training_at_scale</p>
      <nav class="doc-nav" aria-label="Document list">
<a class="doc-link" data-doc-link data-doc-title="context parallelism and ring attention" data-doc-path="context_parallelism_update" data-doc-folder="root" href="../context_parallelism_update.html"><span>Context Parallelism and Ring Attention</span><small>context_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism (dp): a comprehensive technical treatment" data-doc-path="data_parallelism" data-doc-folder="root" href="../data_parallelism.html"><span>Data Parallelism (DP): A Comprehensive Technical Treatment</span><small>data_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="data parallelism: a comprehensive technical treatment" data-doc-path="data_parallelism_basic" data-doc-folder="root" href="../data_parallelism_basic.html"><span>Data Parallelism: A Comprehensive Technical Treatment</span><small>data_parallelism_basic</small></a>
<a class="doc-link" data-doc-link data-doc-title="diving into the gpus — fusing, threading, and mixing" data-doc-path="diving_gpus_fusing_threading_and_mixing" data-doc-folder="root" href="../diving_gpus_fusing_threading_and_mixing.html"><span>Diving into the GPUs — Fusing, Threading, and Mixing</span><small>diving_gpus_fusing_threading_and_mixing</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism" data-doc-folder="root" href="../expert_parallelism.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="expert parallelism and 5d parallelism: a comprehensive technical treatment" data-doc-path="expert_parallelism_update" data-doc-folder="root" href="../expert_parallelism_update.html"><span>Expert Parallelism and 5D Parallelism: A Comprehensive Technical Treatment</span><small>expert_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="finding the best training configuration for distributed large model training" data-doc-path="distributed_large_model_training" data-doc-folder="root" href="../distributed_large_model_training.html"><span>Finding the Best Training Configuration for Distributed Large Model Training</span><small>distributed_large_model_training</small></a>
<a class="doc-link" data-doc-link data-doc-title="high-level overview of distributed training: foundations, memory analysis, and first-step techniques" data-doc-path="high_level_overview" data-doc-folder="root" href="../high_level_overview.html"><span>High-Level Overview of Distributed Training: Foundations, Memory Analysis, and First-Step Techniques</span><small>high_level_overview</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: a comprehensive technical exposition" data-doc-path="pipelineparallelism" data-doc-folder="root" href="../pipelineparallelism.html"><span>Pipeline Parallelism: A Comprehensive Technical Exposition</span><small>pipelineparallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="pipeline parallelism: comprehensive technical exposition" data-doc-path="pipelineparallelism_update" data-doc-folder="root" href="../pipelineparallelism_update.html"><span>Pipeline Parallelism: Comprehensive Technical Exposition</span><small>pipelineparallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="scaling distributed training: foundations and first principles" data-doc-path="high_level_overview_updated" data-doc-folder="root" href="../high_level_overview_updated.html"><span>Scaling Distributed Training: Foundations and First Principles</span><small>high_level_overview_updated</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="context_parallelism" data-doc-folder="root" href="../context_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>context_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism" data-doc-folder="root" href="../tensor_parallelism.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism</small></a>
<a class="doc-link" data-doc-link data-doc-title="tensor parallelism (tp) and sequence parallelism (sp)" data-doc-path="tensor_parallelism_update" data-doc-folder="root" href="../tensor_parallelism_update.html"><span>Tensor Parallelism (TP) and Sequence Parallelism (SP)</span><small>tensor_parallelism_update</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive index" data-doc-path="agentic_ai/prompt_chaining_index" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_Chaining_index.html"><span>Chapter 1: Prompt Chaining — Comprehensive Index</span><small>Agentic_ai/Prompt_Chaining_index</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/architecture_and_design_patterns_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Architecture_and_design_patterns_of_prompt_chains.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Architecture_and_design_patterns_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining" data-doc-path="agentic_ai/prompt_design_for_chain_steps" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_design_for_chain_steps.html"><span>Chapter 1: Prompt Chaining</span><small>Agentic_ai/Prompt_design_for_chain_steps</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 1: prompt chaining — comprehensive treatment" data-doc-path="agentic_ai/foundations_of_prompt_chaining" data-doc-folder="agentic_ai" href="../Agentic_ai/Foundations_of_prompt_chaining.html"><span>Chapter 1: Prompt Chaining — Comprehensive Treatment</span><small>Agentic_ai/Foundations_of_prompt_chaining</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.4 state management and context propagation" data-doc-path="agentic_ai/state_management_and_context_propagation" data-doc-folder="agentic_ai" href="../Agentic_ai/State_management_and_context_propagation.html"><span>1.4 State Management and Context Propagation</span><small>Agentic_ai/State_management_and_context_propagation</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.5 task decomposition strategies" data-doc-path="agentic_ai/task_decomposition_strategies" data-doc-folder="agentic_ai" href="../Agentic_ai/Task_decomposition_strategies.html"><span>1.5 Task Decomposition Strategies</span><small>Agentic_ai/Task_decomposition_strategies</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.6 routing and conditional logic in chains" data-doc-path="agentic_ai/routing_and_conditional_logic_in_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Routing_and_conditional_logic_in_chains.html"><span>1.6 Routing and Conditional Logic in Chains</span><small>Agentic_ai/Routing_and_conditional_logic_in_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.7 error handling, robustness, and fault tolerance" data-doc-path="agentic_ai/error_handling_robustness_and_fault_tolerance" data-doc-folder="agentic_ai" href="../Agentic_ai/Error_handling_robustness_and_fault_tolerance.html"><span>1.7 Error Handling, Robustness, and Fault Tolerance</span><small>Agentic_ai/Error_handling_robustness_and_fault_tolerance</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.8 verification, validation, and quality control" data-doc-path="agentic_ai/verification_validation_and_quality_control" data-doc-folder="agentic_ai" href="../Agentic_ai/Verification_validation_and_quality_control.html"><span>1.8 Verification, Validation, and Quality Control</span><small>Agentic_ai/Verification_validation_and_quality_control</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.9 optimization of prompt chains" data-doc-path="agentic_ai/optimization_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Optimization_of_prompt_chains.html"><span>1.9 Optimization of Prompt Chains</span><small>Agentic_ai/Optimization_of_prompt_chains</small></a>
<a class="doc-link is-active" data-doc-link data-doc-title="1.10 advanced prompt chaining techniques" data-doc-path="agentic_ai/advanced_prompt_chaining_techniques" data-doc-folder="agentic_ai" href="../Agentic_ai/Advanced_prompt_chaining_techniques.html"><span>1.10 Advanced Prompt Chaining Techniques</span><small>Agentic_ai/Advanced_prompt_chaining_techniques</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.13 evaluation of prompt chains" data-doc-path="agentic_ai/evaluation_of_prompt_chains" data-doc-folder="agentic_ai" href="../Agentic_ai/Evaluation_of_prompt_chains.html"><span>1.13 Evaluation of Prompt Chains</span><small>Agentic_ai/Evaluation_of_prompt_chains</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.14 security, safety, and guardrails in prompt chains" data-doc-path="agentic_ai/security_safety_and_guardrails_in_prompt_chaind" data-doc-folder="agentic_ai" href="../Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind.html"><span>1.14 Security, Safety, and Guardrails in Prompt Chains</span><small>Agentic_ai/Security_safety_and_guardrails_in_prompt_chaind</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.15 real-world applications and case studies" data-doc-path="agentic_ai/real-world_applications_and_case_studies" data-doc-folder="agentic_ai" href="../Agentic_ai/Real-World_applications_and_case_studies.html"><span>1.15 Real-World Applications and Case Studies</span><small>Agentic_ai/Real-World_applications_and_case_studies</small></a>
<a class="doc-link" data-doc-link data-doc-title="1.16 prompt chaining vs. related paradigms" data-doc-path="agentic_ai/prompt_chaining_vs_related_paradigm" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt_chaining_vs_related_paradigm.html"><span>1.16 Prompt Chaining vs. Related Paradigms</span><small>Agentic_ai/Prompt_chaining_vs_related_paradigm</small></a>
<a class="doc-link" data-doc-link data-doc-title="prompt chaining: frameworks, observability, evaluation, security, applications, and paradigm comparisons" data-doc-path="agentic_ai/prompt chaining_frameworks_and_implementation" data-doc-folder="agentic_ai" href="../Agentic_ai/Prompt Chaining_frameworks_and_Implementation.html"><span>Prompt Chaining: Frameworks, Observability, Evaluation, Security, Applications, and Paradigm Comparisons</span><small>Agentic_ai/Prompt Chaining_frameworks_and_Implementation</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota index" data-doc-path="agentic_ai/tools/tools_comprehensive_index" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Tools_comprehensive_Index.html"><span>Chapter 2: Tools — Comprehensive SOTA Index</span><small>Agentic_ai/Tools/Tools_comprehensive_Index</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/documentation_mcp_mcp_for_agent_security" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Documentation_MCP_mcp_for_agent_security</small></a>
<a class="doc-link" data-doc-link data-doc-title="chapter 2: tools — comprehensive sota reference" data-doc-path="agentic_ai/tools/introduction_tools_action" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Introduction_Tools_Action.html"><span>Chapter 2: Tools — Comprehensive SOTA Reference</span><small>Agentic_ai/Tools/Introduction_Tools_Action</small></a>
<a class="doc-link" data-doc-link data-doc-title="2.6 security in mcp" data-doc-path="agentic_ai/tools/security_mcp_conclusion" data-doc-folder="agentic_ai/tools" href="../Agentic_ai/Tools/Security_MCP_conclusion.html"><span>2.6 Security in MCP</span><small>Agentic_ai/Tools/Security_MCP_conclusion</small></a>
      </nav>
    </aside>
    <main class="content-pane">
      <article class="doc-content">
<h1 id="110-advanced-prompt-chaining-techniques" tabindex="-1">1.10 Advanced Prompt Chaining Techniques</h1>
<blockquote>
<p><strong>Scope.</strong> The foundational chain patterns (linear, DAG, conditional) covered in prior sections handle the majority of structured workflows. This section extends the repertoire with <strong>advanced compositional patterns</strong> — recursive structures, parallel map-reduce topologies, iterative refinement loops, ensemble architectures, retrieval-augmented pipelines, tool-augmented execution, multi-modal cross-model chains, and self-adaptive meta-chains. Each pattern is formalized mathematically, analyzed for convergence/correctness properties, and accompanied by production-grade implementations. Mastery of these patterns is what separates simple prompt-template systems from true agentic architectures.</p>
</blockquote>
<hr>
<h2 id="1101-chain-of-thought-as-a-micro-chain" tabindex="-1">1.10.1 Chain-of-Thought as a Micro-Chain</h2>
<h3 id="11011-cot-as-implicit-single-step-chaining" tabindex="-1">1.10.1.1 CoT as Implicit Single-Step Chaining</h3>
<p>Chain-of-Thought (CoT) prompting (Wei et al., 2022) instructs the LLM to produce <strong>intermediate reasoning steps</strong> before its final answer — all within a <strong>single LLM call</strong>. Formally, CoT transforms the generation from:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>y</mi><mo>∼</mo><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y \sim p_\theta(y \mid x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></eqn></section><p>to:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>r</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>r</mi><mi>k</mi></msub><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>∼</mo><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>r</mi><mi>k</mi></msub><mo separator="true">,</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo separator="true">,</mo><msub><mtext>prompt</mtext><mtext>CoT</mtext></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
(r_1, r_2, \dots, r_k, y) \sim p_\theta(r_1, \dots, r_k, y \mid x, \text{prompt}_{\text{CoT}})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">prompt</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2342em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">CoT</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>r</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">r_1, \dots, r_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>are reasoning tokens that the model generates <strong>autoregressively before</strong> the final answer<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq>. Each <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">r_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>conditions the generation of<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">r_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></eq>and ultimately<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq>, creating what is functionally a <strong>sequential chain executed entirely within the model’s forward pass</strong>.</p>
<p><strong>Why CoT works — the representational argument.</strong> Transformers are bounded in the computation they can perform per forward pass. Without CoT, the model must map <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>→</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x \to y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq>in a fixed number of layers<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span></eq>. With CoT, the model gets <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq> additional “computation steps” via autoregressive token generation:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Effective compute</mtext><mo>∝</mo><mi>L</mi><mo>+</mo><mi>k</mi><mo>⋅</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">
\text{Effective compute} \propto L + k \cdot L
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Effective compute</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span></span></eqn></section><p>Each generated reasoning token provides an additional <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span></eq> layers of computation, effectively turning a bounded-depth circuit into an arbitrarily deep one — analogous to a Turing machine’s tape.</p>
<h3 id="11012-explicit-decomposition-of-cot-into-multi-step-chains" tabindex="-1">1.10.1.2 Explicit Decomposition of CoT into Multi-Step Chains</h3>
<p>CoT can be <strong>externalized</strong> from a single prompt into an explicit multi-step chain where each reasoning step is a separate LLM call with its own prompt, validation, and state management.</p>
<p><strong>Single-call CoT (implicit):</strong></p>
<div class="code-shell"><pre class="hljs"><code class="hljs">Prompt: &quot;Think step by step. What is 23 × 47?&quot;
Output: &quot;Step 1: 23 × 40 = 920. Step 2: 23 × 7 = 161. Step 3: 920 + 161 = 1081. Answer: 1081&quot;
</code></pre>
</div><p><strong>Multi-call explicit chain (externalized CoT):</strong></p>
<div class="code-shell"><pre class="hljs"><code class="hljs">Step 1 prompt: &quot;Decompose 23 × 47 into simpler sub-problems.&quot;
Step 1 output: &quot;Sub-problems: 23 × 40 and 23 × 7&quot;

Step 2 prompt: &quot;Compute 23 × 40.&quot;
Step 2 output: &quot;920&quot;

Step 3 prompt: &quot;Compute 23 × 7.&quot;  
Step 3 output: &quot;161&quot;

Step 4 prompt: &quot;Sum: 920 + 161 = ?&quot;
Step 4 output: &quot;1081&quot;
</code></pre>
</div><p><strong>Formal equivalence.</strong> Let <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mtext>CoT</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_{\text{CoT}}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">CoT</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq>denote the single-call CoT output and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mtext>chain</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_{\text{chain}}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chain</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></eq> denote the explicit chain output. Under ideal conditions:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mtext>CoT</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>f</mi><mtext>chain</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>y</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">
f_{\text{CoT}}(x) = f_{\text{chain}}(x) = y^*
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">CoT</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">chain</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>In practice, they diverge due to different error profiles.</p>
<h3 id="11013-comparative-analysis-cot-vs-explicit-prompt-chains" tabindex="-1">1.10.1.3 Comparative Analysis: CoT vs. Explicit Prompt Chains</h3>
<table>
<thead>
<tr>
<th>Dimension</th>
<th>CoT (Single Call)</th>
<th>Explicit Chain (Multi-Call)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Latency</strong></td>
<td>Single round-trip (<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∼</mo><msub><mi>l</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\sim l_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>)</td>
<td>Multiple round-trips (<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><msub><mi>l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\sum l_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>)</td>
</tr>
<tr>
<td><strong>Cost</strong></td>
<td>Lower (one call, reasoning tokens are output tokens)</td>
<td>Higher (each step has full prompt overhead)</td>
</tr>
<tr>
<td><strong>Error isolation</strong></td>
<td>Impossible — if step 3 is wrong, can’t retry just step 3</td>
<td>Each step independently verifiable and retryable</td>
</tr>
<tr>
<td><strong>Validation</strong></td>
<td>Post-hoc only (parse reasoning after generation)</td>
<td>Per-step validation gates between calls</td>
</tr>
<tr>
<td><strong>Context utilization</strong></td>
<td>All reasoning shares one context window</td>
<td>Each step can have a tailored context</td>
</tr>
<tr>
<td><strong>Controllability</strong></td>
<td>Low — model decides its own reasoning path</td>
<td>High — orchestrator controls step sequence</td>
</tr>
<tr>
<td><strong>Tool integration</strong></td>
<td>Not possible mid-reasoning (unless native tool-use)</td>
<td>Natural — any step can invoke tools</td>
</tr>
<tr>
<td><strong>Debugging</strong></td>
<td>Parse the monolithic output</td>
<td>Inspect each step independently</td>
</tr>
<tr>
<td><strong>Parallelism</strong></td>
<td>None (sequential token generation)</td>
<td>Independent sub-problems can parallelize</td>
</tr>
</tbody>
</table>
<h3 id="11014-decision-framework-cot-within-a-step-vs-across-steps" tabindex="-1">1.10.1.4 Decision Framework: CoT Within a Step vs. Across Steps</h3>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Use CoT within a single step when:</mtext><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Reasoning is short</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>k</mi><mo>≤</mo><mn>10</mn><mtext> reasoning steps</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>No tool calls needed mid-reasoning</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Error tolerance is moderate</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Latency is critical</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>The sub-problem is self-contained</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{Use CoT within a single step when:}
\begin{cases}
\text{Reasoning is short} &amp; (k \leq 10 \text{ reasoning steps}) \\
\text{No tool calls needed mid-reasoning} &amp; \\
\text{Error tolerance is moderate} &amp; \\
\text{Latency is critical} &amp; \\
\text{The sub-problem is self-contained} &amp;
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.2em;vertical-align:-3.35em;"></span><span class="mord text"><span class="mord">Use CoT within a single step when:</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-1.366em;"><span class="pstrut" style="height:3.816em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.358em;"><span class="pstrut" style="height:3.816em;"></span><span style="height:1.816em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="1.816em" style="width:0.8889em" viewBox="0 0 888.89 1816" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V1816 H384z M384 0 H504 V1816 H384z"/></svg></span></span><span style="top:-3.816em;"><span class="pstrut" style="height:3.816em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.958em;"><span class="pstrut" style="height:3.816em;"></span><span style="height:1.816em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="1.816em" style="width:0.8889em" viewBox="0 0 888.89 1816" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V1816 H384z M384 0 H504 V1816 H384z"/></svg></span></span><span style="top:-6.766em;"><span class="pstrut" style="height:3.816em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-5.85em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Reasoning is short</span></span></span></span><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">No tool calls needed mid-reasoning</span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Error tolerance is moderate</span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Latency is critical</span></span></span></span><span style="top:-0.09em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">The sub-problem is self-contained</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-5.85em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">10</span><span class="mord text"><span class="mord"> reasoning steps</span></span><span class="mclose">)</span></span></span><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span><span style="top:-0.09em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Use explicit chain across steps when:</mtext><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Reasoning is long</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>k</mi><mo>&gt;</mo><mn>10</mn><mtext> steps</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Intermediate results need validation</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Tools/retrieval needed mid-reasoning</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Errors in sub-steps are costly</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Sub-problems can parallelize</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Different models optimal for different sub-steps</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{Use explicit chain across steps when:}
\begin{cases}
\text{Reasoning is long} &amp; (k &gt; 10 \text{ steps}) \\
\text{Intermediate results need validation} &amp; \\
\text{Tools/retrieval needed mid-reasoning} &amp; \\
\text{Errors in sub-steps are costly} &amp; \\
\text{Sub-problems can parallelize} &amp; \\
\text{Different models optimal for different sub-steps} &amp;
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:8.64em;vertical-align:-4.07em;"></span><span class="mord text"><span class="mord">Use explicit chain across steps when:</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.45em;"><span style="top:-1.366em;"><span class="pstrut" style="height:4.416em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.358em;"><span class="pstrut" style="height:4.416em;"></span><span style="height:2.416em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="2.416em" style="width:0.8889em" viewBox="0 0 888.89 2416" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V2416 H384z M384 0 H504 V2416 H384z"/></svg></span></span><span style="top:-4.416em;"><span class="pstrut" style="height:4.416em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-5.558em;"><span class="pstrut" style="height:4.416em;"></span><span style="height:2.416em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="2.416em" style="width:0.8889em" viewBox="0 0 888.89 2416" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V2416 H384z M384 0 H504 V2416 H384z"/></svg></span></span><span style="top:-7.966em;"><span class="pstrut" style="height:4.416em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.95em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.57em;"><span style="top:-6.57em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Reasoning is long</span></span></span></span><span style="top:-5.13em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Intermediate results need validation</span></span></span></span><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Tools/retrieval needed mid-reasoning</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Errors in sub-steps are costly</span></span></span></span><span style="top:-0.81em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Sub-problems can parallelize</span></span></span></span><span style="top:0.63em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Different models optimal for different sub-steps</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.07em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.57em;"><span style="top:-6.57em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">10</span><span class="mord text"><span class="mord"> steps</span></span><span class="mclose">)</span></span></span><span style="top:-5.13em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span><span style="top:-0.81em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span><span style="top:0.63em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.07em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p><strong>Hybrid pattern — the most practical approach:</strong> Use CoT within each step of a multi-step chain. Each chain step gets “think step by step” in its prompt, but the chain orchestrator controls the macro-level flow:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridCoTChainStep</span>:
    <span class="hljs-string">&quot;&quot;&quot;A chain step that uses CoT internally but is externally orchestrated.&quot;&quot;&quot;</span>
    
    COT_WRAPPER = (
        <span class="hljs-string">&quot;Think through this step by step before providing your final answer.\n\n&quot;</span>
        <span class="hljs-string">&quot;Task: {task}\n&quot;</span>
        <span class="hljs-string">&quot;Context from previous steps: {context}\n\n&quot;</span>
        <span class="hljs-string">&quot;Show your reasoning, then provide the final answer in the specified format.\n&quot;</span>
        <span class="hljs-string">&quot;Reasoning:\n&quot;</span>
    )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, step_name: <span class="hljs-built_in">str</span>, 
                 output_schema: <span class="hljs-built_in">type</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.step_name = step_name
        <span class="hljs-variable language_">self</span>.output_schema = output_schema
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;&quot;</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        prompt = <span class="hljs-variable language_">self</span>.COT_WRAPPER.<span class="hljs-built_in">format</span>(task=task, context=context)
        
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=prompt,
            temperature=<span class="hljs-number">0.0</span>,
            max_tokens=<span class="hljs-number">2000</span>
        )
        
        <span class="hljs-comment"># Separate reasoning from answer</span>
        reasoning, answer = <span class="hljs-variable language_">self</span>._extract_reasoning_and_answer(response)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;step&quot;</span>: <span class="hljs-variable language_">self</span>.step_name,
            <span class="hljs-string">&quot;reasoning&quot;</span>: reasoning,  <span class="hljs-comment"># for debugging, not passed downstream</span>
            <span class="hljs-string">&quot;answer&quot;</span>: answer,        <span class="hljs-comment"># this is what downstream steps receive</span>
        }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_extract_reasoning_and_answer</span>(<span class="hljs-params">response: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]:
        <span class="hljs-comment"># Look for explicit answer markers</span>
        markers = [<span class="hljs-string">&quot;Final answer:&quot;</span>, <span class="hljs-string">&quot;Answer:&quot;</span>, <span class="hljs-string">&quot;Therefore:&quot;</span>, <span class="hljs-string">&quot;Result:&quot;</span>]
        <span class="hljs-keyword">for</span> marker <span class="hljs-keyword">in</span> markers:
            <span class="hljs-keyword">if</span> marker.lower() <span class="hljs-keyword">in</span> response.lower():
                idx = response.lower().index(marker.lower())
                reasoning = response[:idx].strip()
                answer = response[idx + <span class="hljs-built_in">len</span>(marker):].strip()
                <span class="hljs-keyword">return</span> reasoning, answer
        <span class="hljs-comment"># Fallback: last paragraph is the answer</span>
        paragraphs = response.strip().split(<span class="hljs-string">&quot;\n\n&quot;</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(paragraphs) &gt; <span class="hljs-number">1</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\n\n&quot;</span>.join(paragraphs[:-<span class="hljs-number">1</span>]), paragraphs[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, response
</code></pre>
</div><hr>
<h2 id="1102-recursive-chains" tabindex="-1">1.10.2 Recursive Chains</h2>
<h3 id="11021-self-referential-chain-definition" tabindex="-1">1.10.2.1 Self-Referential Chain Definition</h3>
<p>A recursive chain is a chain that <strong>invokes itself</strong> as a sub-step, processing progressively smaller or simpler versions of the problem until a base case is reached.</p>
<p><strong>Formal definition.</strong> A recursive chain <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></eq> is:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if base</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext mathvariant="monospace">True</mtext><mspace width="1em"/><mtext>(base case)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>h</mi><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi>x</mi><mo separator="true">,</mo><mtext>  </mtext><mi>f</mi><mo stretchy="false">(</mo><mtext>reduce</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>otherwise</mtext><mspace width="1em"/><mtext>(recursive case)</mtext></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
f(x) = \begin{cases}
g(x) &amp; \text{if } \text{base}(x) = \texttt{True} \quad \text{(base case)} \\
h\!\bigl(x,\; f(\text{reduce}(x))\bigr) &amp; \text{otherwise} \quad \text{(recursive case)}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord text"><span class="mord">reduce</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord text"><span class="mord">base</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord texttt">True</span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(base case)</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(recursive case)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where:</p>
<ul>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>base</mtext><mo>:</mo><mi mathvariant="script">X</mi><mo>→</mo><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\text{base}: \mathcal{X} \to \{0,1\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">base</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.14643em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">}</span></span></span></span></eq> is the base case predicate</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>:</mo><mi mathvariant="script">X</mi><mo>→</mo><mi mathvariant="script">Y</mi></mrow><annotation encoding="application/x-tex">g: \mathcal{X} \to \mathcal{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.14643em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span></span></span></span></eq> is the direct solution for base cases</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>reduce</mtext><mo>:</mo><mi mathvariant="script">X</mi><mo>→</mo><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">\text{reduce}: \mathcal{X} \to \mathcal{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">reduce</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.14643em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span></span></span></eq> reduces the problem to a smaller instance</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>:</mo><mi mathvariant="script">X</mi><mo>×</mo><mi mathvariant="script">Y</mi><mo>→</mo><mi mathvariant="script">Y</mi></mrow><annotation encoding="application/x-tex">h: \mathcal{X} \times \mathcal{Y} \to \mathcal{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathcal" style="margin-right:0.14643em;">X</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span></span></span></span></eq> combines the current level with recursive results</li>
</ul>
<p>More generally, for multi-branch recursion:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>h</mi><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi>x</mi><mo separator="true">,</mo><mtext>  </mtext><mi>f</mi><mo stretchy="false">(</mo><msub><mtext>reduce</mtext><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext>  </mtext><mi>f</mi><mo stretchy="false">(</mo><msub><mtext>reduce</mtext><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext>  </mtext><mo>…</mo><mo separator="true">,</mo><mtext>  </mtext><mi>f</mi><mo stretchy="false">(</mo><msub><mtext>reduce</mtext><mi>m</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
f(x) = h\!\bigl(x,\; f(\text{reduce}_1(x)),\; f(\text{reduce}_2(x)),\; \dots,\; f(\text{reduce}_m(x))\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">reduce</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">reduce</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">reduce</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><h3 id="11022-recursion-depth-control-and-base-cases" tabindex="-1">1.10.2.2 Recursion Depth Control and Base Cases</h3>
<p><strong>Termination guarantees.</strong> A recursive chain terminates iff there exists a well-founded ordering <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≺</mo></mrow><annotation encoding="application/x-tex">\prec</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">≺</span></span></span></span></eq> on inputs such that:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>reduce</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>≺</mo><mi>x</mi><mspace width="1em"/><mi mathvariant="normal">∀</mi><mtext> </mtext><mi>x</mi><mtext> where base</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext mathvariant="monospace">False</mtext></mrow><annotation encoding="application/x-tex">
\text{reduce}(x) \prec x \quad \forall\, x \text{ where } \text{base}(x) = \texttt{False}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">reduce</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≺</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:1em;"></span><span class="mord">∀</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mord text"><span class="mord"> where </span></span><span class="mord text"><span class="mord">base</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6111em;"></span><span class="mord text"><span class="mord texttt">False</span></span></span></span></span></span></eqn></section><p>and there are no infinite descending chains under <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≺</mo></mrow><annotation encoding="application/x-tex">\prec</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">≺</span></span></span></span></eq>.</p>
<p>In practice, since LLM outputs are stochastic and <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>reduce</mtext></mrow><annotation encoding="application/x-tex">\text{reduce}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">reduce</span></span></span></span></span></eq> may not strictly reduce problem size, we enforce termination via <strong>hard depth limits</strong>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>d</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if base</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext mathvariant="monospace">True</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>g</mi><mtext>approx</mtext></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>d</mi><mo>≥</mo><msub><mi>d</mi><mi>max</mi><mo>⁡</mo></msub><mspace width="1em"/><mtext>(forced base case)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>h</mi><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi>x</mi><mo separator="true">,</mo><mtext>  </mtext><msub><mi>f</mi><mrow><mi>d</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mtext>reduce</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
f_d(x) = \begin{cases}
g(x) &amp; \text{if } \text{base}(x) = \texttt{True} \\
g_{\text{approx}}(x) &amp; \text{if } d \geq d_{\max} \quad \text{(forced base case)} \\
h\!\bigl(x,\; f_{d+1}(\text{reduce}(x))\bigr) &amp; \text{otherwise}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">approx</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord">reduce</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord text"><span class="mord">base</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord texttt">True</span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(forced base case)</span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass, field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Callable</span>, <span class="hljs-type">Optional</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RecursionConfig</span>:
    max_depth: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>
    min_chunk_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">100</span>      <span class="hljs-comment"># tokens</span>
    base_case_detector: <span class="hljs-type">Optional</span>[<span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">bool</span>]] = <span class="hljs-literal">None</span>
    depth_exceeded_strategy: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;force_base&quot;</span>  <span class="hljs-comment"># force_base | error | approximate</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RecursiveChain</span>:
    <span class="hljs-string">&quot;&quot;&quot;Generic recursive chain with depth control and base case detection.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 
                 llm: <span class="hljs-string">&quot;LLMClient&quot;</span>,
                 base_solver: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">str</span>],
                 reducer: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]],
                 combiner: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]], <span class="hljs-built_in">str</span>],
                 config: RecursionConfig = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.base_solver = base_solver    <span class="hljs-comment"># g(x): solve base case directly</span>
        <span class="hljs-variable language_">self</span>.reducer = reducer            <span class="hljs-comment"># reduce(x): split into sub-problems</span>
        <span class="hljs-variable language_">self</span>.combiner = combiner          <span class="hljs-comment"># h(x, results): combine sub-results</span>
        <span class="hljs-variable language_">self</span>.config = config <span class="hljs-keyword">or</span> RecursionConfig()
        <span class="hljs-variable language_">self</span>._trace: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>] = []
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, input_text: <span class="hljs-built_in">str</span>, depth: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        trace_entry = {
            <span class="hljs-string">&quot;depth&quot;</span>: depth,
            <span class="hljs-string">&quot;input_length&quot;</span>: <span class="hljs-built_in">len</span>(input_text),
            <span class="hljs-string">&quot;is_base_case&quot;</span>: <span class="hljs-literal">False</span>
        }
        
        <span class="hljs-comment"># Check base case</span>
        is_base = <span class="hljs-variable language_">self</span>._is_base_case(input_text, depth)
        trace_entry[<span class="hljs-string">&quot;is_base_case&quot;</span>] = is_base
        
        <span class="hljs-keyword">if</span> is_base:
            result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.base_solver(input_text)
            trace_entry[<span class="hljs-string">&quot;action&quot;</span>] = <span class="hljs-string">&quot;base_solve&quot;</span>
            <span class="hljs-variable language_">self</span>._trace.append(trace_entry)
            <span class="hljs-keyword">return</span> result
        
        <span class="hljs-comment"># Check depth limit</span>
        <span class="hljs-keyword">if</span> depth &gt;= <span class="hljs-variable language_">self</span>.config.max_depth:
            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.config.depth_exceeded_strategy == <span class="hljs-string">&quot;force_base&quot;</span>:
                result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.base_solver(input_text)
                trace_entry[<span class="hljs-string">&quot;action&quot;</span>] = <span class="hljs-string">&quot;forced_base_at_max_depth&quot;</span>
                <span class="hljs-variable language_">self</span>._trace.append(trace_entry)
                <span class="hljs-keyword">return</span> result
            <span class="hljs-keyword">elif</span> <span class="hljs-variable language_">self</span>.config.depth_exceeded_strategy == <span class="hljs-string">&quot;error&quot;</span>:
                <span class="hljs-keyword">raise</span> RecursionError(<span class="hljs-string">f&quot;Max depth <span class="hljs-subst">{self.config.max_depth}</span> exceeded&quot;</span>)
            <span class="hljs-keyword">else</span>:
                result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.base_solver(input_text)
                <span class="hljs-variable language_">self</span>._trace.append(trace_entry)
                <span class="hljs-keyword">return</span> result
        
        <span class="hljs-comment"># Recursive case: reduce → recurse → combine</span>
        sub_problems = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.reducer(input_text)
        trace_entry[<span class="hljs-string">&quot;num_sub_problems&quot;</span>] = <span class="hljs-built_in">len</span>(sub_problems)
        trace_entry[<span class="hljs-string">&quot;action&quot;</span>] = <span class="hljs-string">&quot;recurse&quot;</span>
        <span class="hljs-variable language_">self</span>._trace.append(trace_entry)
        
        <span class="hljs-comment"># Recurse on each sub-problem (can parallelize independent branches)</span>
        sub_results = <span class="hljs-keyword">await</span> asyncio.gather(*[
            <span class="hljs-variable language_">self</span>.execute(sub, depth + <span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> sub <span class="hljs-keyword">in</span> sub_problems
        ])
        
        <span class="hljs-comment"># Combine</span>
        combined = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.combiner(input_text, <span class="hljs-built_in">list</span>(sub_results))
        <span class="hljs-keyword">return</span> combined
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_is_base_case</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, depth: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.config.base_case_detector:
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.config.base_case_detector(text)
        <span class="hljs-comment"># Default: base case when input is small enough</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(text.split()) &lt;= <span class="hljs-variable language_">self</span>.config.min_chunk_size
</code></pre>
</div><h3 id="11023-recursive-summarization-chains" tabindex="-1">1.10.2.3 Recursive Summarization Chains</h3>
<p>The canonical application of recursive chains: summarize a document too long for a single context window by recursively summarizing sub-sections.</p>
<p><strong>Algorithm.</strong> Given document <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></eq>with<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi>D</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|D|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span></span></span></span></eq>tokens and target summary length<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RecSummarize</mtext><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Summarize</mtext><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi mathvariant="normal">∣</mi><mi>D</mi><mi mathvariant="normal">∣</mi><mo>≤</mo><msub><mi>C</mi><mi>max</mi><mo>⁡</mo></msub><mo>−</mo><mi>L</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Summarize</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">(</mo><msubsup><mo>⨁</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></msubsup><mtext>RecSummarize</mtext><mo stretchy="false">(</mo><msub><mi>D</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{RecSummarize}(D) = \begin{cases}
\text{Summarize}(D) &amp; \text{if } |D| \leq C_{\max} - L \\
\text{Summarize}\!\Bigl(\bigoplus_{i=1}^{k} \text{RecSummarize}(D_i)\Bigr) &amp; \text{otherwise}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RecSummarize</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.24em;vertical-align:-1.37em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.87em;"><span style="top:-4.012em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Summarize</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span><span style="top:-2.43em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Summarize</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size2">(</span></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">⨁</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">RecSummarize</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="delimsizing size2">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.37em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.87em;"><span style="top:-4.012em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">L</span></span></span><span style="top:-2.43em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.37em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>=</mo><msub><mi>D</mi><mn>1</mn></msub><mo>⊕</mo><msub><mi>D</mi><mn>2</mn></msub><mo>⊕</mo><mo>⋯</mo><mo>⊕</mo><msub><mi>D</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">D = D_1 \oplus D_2 \oplus \cdots \oplus D_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>is a partition of<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></eq>into<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq>chunks that each fit in the context window, and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⊕</mo></mrow><annotation encoding="application/x-tex">\oplus</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">⊕</span></span></span></span></eq> denotes concatenation.</p>
<p><strong>Compression analysis.</strong> If each level achieves a compression ratio <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\rho</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span></eq>(summary is<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\rho</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span></eq>fraction of input), then after<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span></eq> levels of recursion:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi>S</mi><mi>d</mi></msub><mi mathvariant="normal">∣</mi><mo>=</mo><mi mathvariant="normal">∣</mi><mi>D</mi><mi mathvariant="normal">∣</mi><mo>⋅</mo><msup><mi>ρ</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">
|S_d| = |D| \cdot \rho^d
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0935em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></eqn></section><p>The required depth to achieve target length <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>d</mi><mo>∗</mo></msup><mo>=</mo><mrow><mo fence="true">⌈</mo><mfrac><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>L</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">∣</mi><mi>D</mi><mi mathvariant="normal">∣</mi><mo stretchy="false">)</mo></mrow><mrow><mi>log</mi><mo>⁡</mo><mi>ρ</mi></mrow></mfrac><mo fence="true">⌉</mo></mrow></mrow><annotation encoding="application/x-tex">
d^* = \left\lceil \frac{\log(L / |D|)}{\log \rho} \right\rceil
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7387em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌈</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mord">/∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌉</span></span></span></span></span></span></span></eqn></section><p>For <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi>D</mi><mi mathvariant="normal">∣</mi><mo>=</mo><mn>100,000</mn></mrow><annotation encoding="application/x-tex">|D| = 100{,}000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">100</span><span class="mord"><span class="mpunct">,</span></span><span class="mord">000</span></span></span></span></eq>tokens,<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>500</mn></mrow><annotation encoding="application/x-tex">L = 500</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">500</span></span></span></span></eq>tokens,<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo>=</mo><mn>0.1</mn></mrow><annotation encoding="application/x-tex">\rho = 0.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.1</span></span></span></span></eq>: <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>d</mi><mo>∗</mo></msup><mo>=</mo><mo stretchy="false">⌈</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0.005</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0.1</mn><mo stretchy="false">)</mo><mo stretchy="false">⌉</mo><mo>=</mo><mo stretchy="false">⌈</mo><mn>2.3</mn><mo stretchy="false">⌉</mo><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">d^* = \lceil \log(0.005) / \log(0.1) \rceil = \lceil 2.3 \rceil = 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">0.005</span><span class="mclose">)</span><span class="mord">/</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">0.1</span><span class="mclose">)⌉</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mord">2.3</span><span class="mclose">⌉</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></eq> levels.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RecursiveSummarizer</span>:
    <span class="hljs-string">&quot;&quot;&quot;Recursively summarize documents of arbitrary length.&quot;&quot;&quot;</span>
    
    SUMMARIZE_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Summarize the following text concisely, preserving all 
key facts, arguments, and conclusions. Target length: {target_words} words.

Text:
{text}

Summary:&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, 
                 context_window: <span class="hljs-built_in">int</span> = <span class="hljs-number">120000</span>,
                 target_summary_tokens: <span class="hljs-built_in">int</span> = <span class="hljs-number">500</span>,
                 chunk_overlap: <span class="hljs-built_in">int</span> = <span class="hljs-number">200</span>,
                 compression_ratio: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.1</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.context_window = context_window
        <span class="hljs-variable language_">self</span>.target_tokens = target_summary_tokens
        <span class="hljs-variable language_">self</span>.overlap = chunk_overlap
        <span class="hljs-variable language_">self</span>.compression_ratio = compression_ratio
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, depth: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, 
                        max_depth: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        tokens = text.split()  <span class="hljs-comment"># approximate tokenization</span>
        
        <span class="hljs-comment"># Base case: fits in context window</span>
        usable_window = <span class="hljs-variable language_">self</span>.context_window - <span class="hljs-variable language_">self</span>.target_tokens - <span class="hljs-number">500</span>  <span class="hljs-comment"># prompt overhead</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tokens) &lt;= usable_window <span class="hljs-keyword">or</span> depth &gt;= max_depth:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._single_summarize(text, <span class="hljs-variable language_">self</span>.target_tokens)
        
        <span class="hljs-comment"># Recursive case: chunk → summarize each → combine summaries → summarize</span>
        chunks = <span class="hljs-variable language_">self</span>._chunk_text(tokens, usable_window)
        
        <span class="hljs-comment"># Summarize each chunk (in parallel)</span>
        chunk_target = <span class="hljs-built_in">max</span>(
            <span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.target_tokens * <span class="hljs-built_in">len</span>(tokens) / usable_window * <span class="hljs-variable language_">self</span>.compression_ratio),
            <span class="hljs-number">100</span>
        )
        
        chunk_summaries = <span class="hljs-keyword">await</span> asyncio.gather(*[
            <span class="hljs-variable language_">self</span>.summarize(<span class="hljs-string">&quot; &quot;</span>.join(chunk), depth + <span class="hljs-number">1</span>, max_depth)
            <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks
        ])
        
        <span class="hljs-comment"># Combine all chunk summaries</span>
        combined = <span class="hljs-string">&quot;\n\n---\n\n&quot;</span>.join(chunk_summaries)
        
        <span class="hljs-comment"># If combined summaries fit in window, do final summarization</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(combined.split()) &lt;= usable_window:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._single_summarize(combined, <span class="hljs-variable language_">self</span>.target_tokens)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Need another level of recursion</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.summarize(combined, depth + <span class="hljs-number">1</span>, max_depth)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_single_summarize</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span>, target_tokens: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        prompt = <span class="hljs-variable language_">self</span>.SUMMARIZE_PROMPT.<span class="hljs-built_in">format</span>(
            text=text,
            target_words=<span class="hljs-built_in">int</span>(target_tokens * <span class="hljs-number">0.75</span>)  <span class="hljs-comment"># tokens → words approx</span>
        )
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>, max_tokens=target_tokens)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_chunk_text</span>(<span class="hljs-params">self, tokens: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], max_chunk: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]]:
        chunks = []
        start = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> start &lt; <span class="hljs-built_in">len</span>(tokens):
            end = <span class="hljs-built_in">min</span>(start + max_chunk, <span class="hljs-built_in">len</span>(tokens))
            chunks.append(tokens[start:end])
            start = end - <span class="hljs-variable language_">self</span>.overlap  <span class="hljs-comment"># overlap for context continuity</span>
            <span class="hljs-keyword">if</span> start &gt;= <span class="hljs-built_in">len</span>(tokens) - <span class="hljs-variable language_">self</span>.overlap:
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">return</span> chunks
</code></pre>
</div><h3 id="11024-recursive-refinement-chains" tabindex="-1">1.10.2.4 Recursive Refinement Chains</h3>
<p>Apply the recursive pattern to <strong>iterative improvement</strong>: each recursion level refines the output of the previous level rather than processing a sub-problem.</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>Refine</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi>x</mi><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mtext>Critique</mtext><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
y^{(k+1)} = \text{Refine}\!\bigl(x, y^{(k)}, \text{Critique}(y^{(k)})\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.288em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">Refine</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">Critique</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>Draft</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>d</mi><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Refine</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi>x</mi><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>d</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext>Critique</mtext><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>d</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>d</mi><mo>&gt;</mo><mn>0</mn></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
f(x, d) = \begin{cases}
y^{(0)} = \text{Draft}(x) &amp; \text{if } d = 0 \\
\text{Refine}\!\bigl(x, f(x, d-1), \text{Critique}(f(x, d-1))\bigr) &amp; \text{if } d &gt; 0
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">Draft</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Refine</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">Critique</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">))</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>This recursion unfolds to:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><munder><munder><mrow><mtext>Refine</mtext><mo>∘</mo><mtext>Critique</mtext><mo>∘</mo><mo>⋯</mo><mo>∘</mo><mtext>Refine</mtext><mo>∘</mo><mtext>Critique</mtext></mrow><mo stretchy="true">⏟</mo></munder><mrow><mi>d</mi><mtext> rounds</mtext></mrow></munder><mo>∘</mo><mtext>Draft</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y^{(d)} = \underbrace{\text{Refine} \circ \text{Critique} \circ \cdots \circ \text{Refine} \circ \text{Critique}}_{d \text{ rounds}} \circ \text{Draft}(x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">d</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.223em;vertical-align:-1.5285em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-1.4715em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord text mtight"><span class="mord mtight"> rounds</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span class="svg-align" style="top:-2.1576em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Refine</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Critique</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Refine</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Critique</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8424em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5285em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Draft</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></eqn></section><hr>
<h2 id="1103-map-reduce-chains" tabindex="-1">1.10.3 Map-Reduce Chains</h2>
<h3 id="11031-formal-definition" tabindex="-1">1.10.3.1 Formal Definition</h3>
<p>Map-Reduce is a computational paradigm that decomposes a problem into <strong>independent sub-problems</strong> (Map), solves each in parallel, and <strong>aggregates</strong> the results (Reduce).</p>
<p><strong>Formal model.</strong> Given input <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">X = \{x_1, x_2, \dots, x_n\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MapReduce</mtext><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Reduce</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">(</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">{</mo><mtext>Map</mtext><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msubsup><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">}</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">)</mo></mrow><annotation encoding="application/x-tex">
\text{MapReduce}(X) = \text{Reduce}\!\Bigl(\, \bigl\{\text{Map}(x_i)\bigr\}_{i=1}^{n} \,\Bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MapReduce</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="mord text"><span class="mord">Reduce</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size2">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen"><span class="delimsizing size1">{</span></span><span class="mord text"><span class="mord">Map</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose"><span class="delimsizing size1">}</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9043em;"><span style="top:-2.3003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size2">)</span></span></span></span></span></span></eqn></section><p>where:</p>
<ul>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Map</mtext><mo>:</mo><mi mathvariant="script">X</mi><mo>→</mo><mi mathvariant="script">Y</mi></mrow><annotation encoding="application/x-tex">\text{Map}: \mathcal{X} \to \mathcal{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Map</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.14643em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span></span></span></span></eq> is applied <strong>independently</strong> to each element</li>
<li><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Reduce</mtext><mo>:</mo><msup><mi mathvariant="script">Y</mi><mi>n</mi></msup><mo>→</mo><mi mathvariant="script">Z</mi></mrow><annotation encoding="application/x-tex">\text{Reduce}: \mathcal{Y}^n \to \mathcal{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Reduce</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">Y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.07944em;">Z</span></span></span></span></eq> aggregates all intermediate results into a final output</li>
</ul>
<p><strong>Key constraint.</strong> Map operations must be <strong>independent</strong> — no map operation depends on the result of another. This independence is what enables parallelism:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∀</mi><mtext> </mtext><mi>i</mi><mo mathvariant="normal">≠</mo><mi>j</mi><mo>:</mo><mspace width="1em"/><mtext>Map</mtext><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>⊥</mo><mtext>Map</mtext><mo stretchy="false">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\forall\, i \neq j: \quad \text{Map}(x_i) \perp \text{Map}(x_j)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">∀</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Map</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⊥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Map</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><h3 id="11032-three-phase-architecture" tabindex="-1">1.10.3.2 Three-Phase Architecture</h3>
<div class="code-shell"><pre class="hljs"><code class="hljs">Phase 1: SPLIT            Phase 2: MAP              Phase 3: REDUCE
┌──────────┐          ┌─────────────┐
│          │──chunk₁─▶│  Map Step 1  │──result₁─┐
│          │          └─────────────┘           │    ┌──────────────┐
│  Input   │          ┌─────────────┐           ├───▶│              │
│  Splitter│──chunk₂─▶│  Map Step 2  │──result₂─┤    │  Reduce Step │──▶ Final
│          │          └─────────────┘           ├───▶│              │    Output
│          │          ┌─────────────┐           │    └──────────────┘
│          │──chunk₃─▶│  Map Step 3  │──result₃─┘
└──────────┘          └─────────────┘
</code></pre>
</div><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypeVar, <span class="hljs-type">Generic</span>
<span class="hljs-keyword">import</span> asyncio

T_Input = TypeVar(<span class="hljs-string">&quot;T_Input&quot;</span>)
T_Mapped = TypeVar(<span class="hljs-string">&quot;T_Mapped&quot;</span>)
T_Output = TypeVar(<span class="hljs-string">&quot;T_Output&quot;</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MapReduceChain</span>(<span class="hljs-type">Generic</span>[T_Input, T_Mapped, T_Output]):
    <span class="hljs-string">&quot;&quot;&quot;Generic Map-Reduce chain with configurable split, map, and reduce.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,
                 splitter: <span class="hljs-type">Callable</span>[[T_Input], <span class="hljs-built_in">list</span>[T_Input]],
                 mapper: <span class="hljs-type">Callable</span>[[T_Input, <span class="hljs-built_in">int</span>], T_Mapped],
                 reducer: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[T_Mapped]], T_Output],
                 max_concurrency: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):
        <span class="hljs-variable language_">self</span>.splitter = splitter
        <span class="hljs-variable language_">self</span>.mapper = mapper
        <span class="hljs-variable language_">self</span>.reducer = reducer
        <span class="hljs-variable language_">self</span>.semaphore = asyncio.Semaphore(max_concurrency)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_bounded_map</span>(<span class="hljs-params">self, chunk: T_Input, index: <span class="hljs-built_in">int</span></span>) -&gt; T_Mapped:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.semaphore:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.mapper(chunk, index)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, input_data: T_Input</span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Phase 1: Split</span>
        chunks = <span class="hljs-variable language_">self</span>.splitter(input_data)
        
        <span class="hljs-comment"># Phase 2: Map (parallel)</span>
        map_results = <span class="hljs-keyword">await</span> asyncio.gather(*[
            <span class="hljs-variable language_">self</span>._bounded_map(chunk, i) <span class="hljs-keyword">for</span> i, chunk <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(chunks)
        ], return_exceptions=<span class="hljs-literal">True</span>)
        
        <span class="hljs-comment"># Handle map failures</span>
        successful_results = []
        failed_indices = []
        <span class="hljs-keyword">for</span> i, result <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(map_results):
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, Exception):
                failed_indices.append(i)
            <span class="hljs-keyword">else</span>:
                successful_results.append(result)
        
        <span class="hljs-comment"># Phase 3: Reduce</span>
        final_output = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.reducer(successful_results)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: final_output,
            <span class="hljs-string">&quot;total_chunks&quot;</span>: <span class="hljs-built_in">len</span>(chunks),
            <span class="hljs-string">&quot;successful_maps&quot;</span>: <span class="hljs-built_in">len</span>(successful_results),
            <span class="hljs-string">&quot;failed_maps&quot;</span>: failed_indices,
            <span class="hljs-string">&quot;parallelism&quot;</span>: <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(chunks), <span class="hljs-variable language_">self</span>.semaphore._value)
        }
</code></pre>
</div><h3 id="11033-hierarchical-reduce" tabindex="-1">1.10.3.3 Hierarchical Reduce</h3>
<p>When the number of map results <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> is too large for a single reduce step’s context window, apply <strong>hierarchical (tree) reduction</strong>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>HierReduce</mtext><mo stretchy="false">(</mo><mo stretchy="false">{</mo><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>r</mi><mi>n</mi></msub><mo stretchy="false">}</mo><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Reduce</mtext><mo stretchy="false">(</mo><mo stretchy="false">{</mo><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>r</mi><mi>n</mi></msub><mo stretchy="false">}</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mo>∑</mo><mi>i</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>r</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mo>≤</mo><msub><mi>C</mi><mi>max</mi><mo>⁡</mo></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Reduce</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">(</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">{</mo><mtext>HierReduce</mtext><mo stretchy="false">(</mo><msub><mi>R</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mtext>HierReduce</mtext><mo stretchy="false">(</mo><msub><mi>R</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">}</mo><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{HierReduce}(\{r_1, \dots, r_n\}) = \begin{cases}
\text{Reduce}(\{r_1, \dots, r_n\}) &amp; \text{if } \sum_i |r_i| \leq C_{\max} \\
\text{Reduce}\!\Bigl(\bigl\{\text{HierReduce}(R_1), \dots, \text{HierReduce}(R_k)\bigr\}\Bigr) &amp; \text{otherwise}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">HierReduce</span></span><span class="mopen">({</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">})</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.24em;vertical-align:-1.37em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.87em;"><span style="top:-4.012em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Reduce</span></span><span class="mopen">({</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">})</span></span></span><span style="top:-2.43em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Reduce</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size2">(</span></span><span class="mopen"><span class="delimsizing size1">{</span></span><span class="mord text"><span class="mord">HierReduce</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">HierReduce</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="delimsizing size1">}</span></span><span class="mclose"><span class="delimsizing size2">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.37em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.87em;"><span style="top:-4.012em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.43em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.37em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>R</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>R</mi><mi>k</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{R_1, \dots, R_k\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></eq>is a partition of<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>r</mi><mi>n</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{r_1, \dots, r_n\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></eq> into groups that each fit in the context window.</p>
<p><strong>Depth of hierarchical reduce.</strong> If each reduce combines <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></eq>results (branching factor) and there are<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> total results:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>d</mi><mtext>reduce</mtext></msub><mo>=</mo><mo stretchy="false">⌈</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mi>b</mi></msub><mi>n</mi><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">
d_{\text{reduce}} = \lceil \log_b n \rceil
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">reduce</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.242em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">⌉</span></span></span></span></span></eqn></section><p><strong>Total LLM calls:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>Calls</mtext><mtext>total</mtext></msub><mo>=</mo><munder><munder><mi>n</mi><mo stretchy="true">⏟</mo></munder><mtext>map</mtext></munder><mo>+</mo><munder><munder><mfrac><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow><mrow><mi>b</mi><mo>−</mo><mn>1</mn></mrow></mfrac><mo stretchy="true">⏟</mo></munder><mtext>reduce tree nodes</mtext></munder><mo>≈</mo><mi>n</mi><mo>+</mo><mfrac><mi>n</mi><mi>b</mi></mfrac></mrow><annotation encoding="application/x-tex">
\text{Calls}_{\text{total}} = \underbrace{n}_{\text{map}} + \underbrace{\frac{n - 1}{b - 1}}_{\text{reduce tree nodes}} \approx n + \frac{n}{b}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Calls</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">total</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8688em;vertical-align:-1.2855em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-1.8506em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">map</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span class="svg-align" style="top:-2.352em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.648em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2855em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.4249em;vertical-align:-2.1034em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-1.218em;"><span class="pstrut" style="height:3.3214em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">reduce tree nodes</span></span></span></span></span><span style="top:-3.3214em;"><span class="pstrut" style="height:3.3214em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span class="svg-align" style="top:-1.9041em;"><span class="pstrut" style="height:3.3214em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3.3214em;"><span class="pstrut" style="height:3.3214em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4173em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1034em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">b</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HierarchicalReducer</span>:
    <span class="hljs-string">&quot;&quot;&quot;Tree-structured reduce for large result sets.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, reduce_fn: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]], <span class="hljs-built_in">str</span>],
                 max_items_per_reduce: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>,
                 context_budget: <span class="hljs-built_in">int</span> = <span class="hljs-number">80000</span></span>):
        <span class="hljs-variable language_">self</span>.reduce_fn = reduce_fn
        <span class="hljs-variable language_">self</span>.max_items = max_items_per_reduce
        <span class="hljs-variable language_">self</span>.context_budget = context_budget
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">reduce</span>(<span class="hljs-params">self, results: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-comment"># Base case: few enough results for a single reduce</span>
        total_tokens = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(r.split()) <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(results) &lt;= <span class="hljs-variable language_">self</span>.max_items <span class="hljs-keyword">and</span> total_tokens &lt;= <span class="hljs-variable language_">self</span>.context_budget:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.reduce_fn(results)
        
        <span class="hljs-comment"># Recursive case: group and reduce</span>
        groups = <span class="hljs-variable language_">self</span>._partition(results)
        
        <span class="hljs-comment"># Reduce each group in parallel</span>
        group_summaries = <span class="hljs-keyword">await</span> asyncio.gather(*[
            <span class="hljs-variable language_">self</span>.reduce_fn(group) <span class="hljs-keyword">for</span> group <span class="hljs-keyword">in</span> groups
        ])
        
        <span class="hljs-comment"># Recursively reduce the group summaries</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.reduce(<span class="hljs-built_in">list</span>(group_summaries))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_partition</span>(<span class="hljs-params">self, results: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]]:
        groups = []
        current_group = []
        current_tokens = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
            r_tokens = <span class="hljs-built_in">len</span>(r.split())
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">len</span>(current_group) &gt;= <span class="hljs-variable language_">self</span>.max_items <span class="hljs-keyword">or</span> 
                current_tokens + r_tokens &gt; <span class="hljs-variable language_">self</span>.context_budget):
                <span class="hljs-keyword">if</span> current_group:
                    groups.append(current_group)
                current_group = [r]
                current_tokens = r_tokens
            <span class="hljs-keyword">else</span>:
                current_group.append(r)
                current_tokens += r_tokens
        
        <span class="hljs-keyword">if</span> current_group:
            groups.append(current_group)
        
        <span class="hljs-keyword">return</span> groups
</code></pre>
</div><h3 id="11034-concrete-application-multi-document-summarization" tabindex="-1">1.10.3.4 Concrete Application — Multi-Document Summarization</h3>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDocumentSummarizer</span>:
    <span class="hljs-string">&quot;&quot;&quot;Map-Reduce chain for summarizing a corpus of documents.&quot;&quot;&quot;</span>
    
    MAP_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Extract the key findings, arguments, and data from this document.
Focus on facts and insights that would be relevant to a comprehensive summary.

Document ({doc_index} of {total_docs}):
{document}

Key Findings (structured list):&quot;&quot;&quot;</span>
    
    REDUCE_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Synthesize the following extracted findings from {n_sources} documents
into a coherent, comprehensive summary. Identify common themes, contradictions, 
and unique insights across sources.

Extracted Findings:
{findings}

Comprehensive Synthesis:&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, context_window: <span class="hljs-built_in">int</span> = <span class="hljs-number">128000</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.context_window = context_window
        
        <span class="hljs-variable language_">self</span>.chain = MapReduceChain(
            splitter=<span class="hljs-keyword">lambda</span> docs: docs,  <span class="hljs-comment"># documents are already split</span>
            mapper=<span class="hljs-variable language_">self</span>._map_document,
            reducer=<span class="hljs-variable language_">self</span>._reduce_findings,
            max_concurrency=<span class="hljs-number">5</span>
        )
        <span class="hljs-variable language_">self</span>.hier_reducer = HierarchicalReducer(
            reduce_fn=<span class="hljs-variable language_">self</span>._reduce_findings,
            max_items_per_reduce=<span class="hljs-number">5</span>
        )
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_map_document</span>(<span class="hljs-params">self, document: <span class="hljs-built_in">str</span>, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        prompt = <span class="hljs-variable language_">self</span>.MAP_PROMPT.<span class="hljs-built_in">format</span>(
            document=document[:<span class="hljs-number">50000</span>],  <span class="hljs-comment"># truncate if needed</span>
            doc_index=index + <span class="hljs-number">1</span>,
            total_docs=<span class="hljs-string">&quot;N&quot;</span>
        )
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>, max_tokens=<span class="hljs-number">1000</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_reduce_findings</span>(<span class="hljs-params">self, findings: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:
        combined = <span class="hljs-string">&quot;\n\n---\n\n&quot;</span>.join(
            <span class="hljs-string">f&quot;Source <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>:\n<span class="hljs-subst">{f}</span>&quot;</span> <span class="hljs-keyword">for</span> i, f <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(findings)
        )
        prompt = <span class="hljs-variable language_">self</span>.REDUCE_PROMPT.<span class="hljs-built_in">format</span>(
            n_sources=<span class="hljs-built_in">len</span>(findings),
            findings=combined
        )
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>, max_tokens=<span class="hljs-number">2000</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">dict</span>:
        result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.chain.execute(documents)
        
        <span class="hljs-comment"># If too many map results, use hierarchical reduce</span>
        <span class="hljs-keyword">if</span> result.get(<span class="hljs-string">&quot;total_chunks&quot;</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">5</span>:
            map_results = result[<span class="hljs-string">&quot;output&quot;</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(map_results, <span class="hljs-built_in">list</span>):
                final = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.hier_reducer.reduce(map_results)
                result[<span class="hljs-string">&quot;output&quot;</span>] = final
        
        <span class="hljs-keyword">return</span> result
</code></pre>
</div><hr>
<h2 id="1104-iterative-refinement-chains" tabindex="-1">1.10.4 Iterative Refinement Chains</h2>
<h3 id="11041-generate-critique-revise-loop" tabindex="-1">1.10.4.1 Generate → Critique → Revise Loop</h3>
<p>Iterative refinement chains repeatedly improve an output through a three-phase cycle:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Draft</mtext><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>Critique</mtext></mpadded></mover><mtext>Feedback</mtext><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>Revise</mtext></mpadded></mover><mtext>Improved Draft</mtext><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>Critique</mtext></mpadded></mover><mo>⋯</mo></mrow><annotation encoding="application/x-tex">
\text{Draft} \xrightarrow{\text{Critique}} \text{Feedback} \xrightarrow{\text{Revise}} \text{Improved Draft} \xrightarrow{\text{Critique}} \cdots
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1113em;vertical-align:-0.011em;"></span><span class="mord text"><span class="mord">Draft</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1003em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Critique</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1113em;vertical-align:-0.011em;"></span><span class="mord text"><span class="mord">Feedback</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1003em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Revise</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2948em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Improved Draft</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1003em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Critique</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.313em;"></span><span class="minner">⋯</span></span></span></span></span></eqn></section><p><strong>Formal model.</strong> Define the refinement operator <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">R</mi></mrow><annotation encoding="application/x-tex">\mathcal{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">R</span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>Generate</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y^{(0)} = \text{Generate}(x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Generate</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>c</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>Critique</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
c^{(t)} = \text{Critique}(x, y^{(t)})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Critique</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>Revise</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>c</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y^{(t+1)} = \text{Revise}(x, y^{(t)}, c^{(t)})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Revise</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p>The chain iterates until a <strong>convergence criterion</strong> is met.</p>
<h3 id="11042-convergence-criteria" tabindex="-1">1.10.4.2 Convergence Criteria</h3>
<p><strong>Definition.</strong> The refinement loop converges when the quality improvement between iterations falls below a threshold <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">ϵ</span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mi mathvariant="normal">∥</mi><mo>&lt;</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">
\|Q(y^{(t+1)}) - Q(y^{(t)})\| &lt; \epsilon
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">ϵ</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>:</mo><mi mathvariant="script">Y</mi><mo>→</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Q: \mathcal{Y} \to [0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7805em;vertical-align:-0.0972em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></eq> is a quality function.</p>
<p><strong>Practical convergence criteria:</strong></p>
<table>
<thead>
<tr>
<th>Criterion</th>
<th>Formula</th>
<th>Robustness</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Quality plateau</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>&lt;</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">Q(y^{(t+1)}) - Q(y^{(t)}) &lt; \epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">ϵ</span></span></span></span></eq></td>
<td>Good, requires quality function</td>
</tr>
<tr>
<td><strong>Output stability</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>sim</mtext><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>&gt;</mo><mn>1</mn><mo>−</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\text{sim}(y^{(t+1)}, y^{(t)}) &gt; 1 - \epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">ϵ</span></span></span></span></eq></td>
<td>Good, catches when changes stop</td>
</tr>
<tr>
<td><strong>Critic satisfaction</strong></td>
<td>Critic says “no issues found”</td>
<td>Moderate, may be premature</td>
</tr>
<tr>
<td><strong>Max iterations</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>≥</mo><msub><mi>t</mi><mi>max</mi><mo>⁡</mo></msub></mrow><annotation encoding="application/x-tex">t \geq t_{\max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq></td>
<td>Guaranteed termination, may under/over-iterate</td>
</tr>
<tr>
<td><strong>Budget exhaustion</strong></td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>t</mi></msub><mtext>cost</mtext><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>≥</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">\sum_t \text{cost}(t) \geq B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1308em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">cost</span></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></eq></td>
<td>Practical, but quality-agnostic</td>
</tr>
</tbody>
</table>
<p><strong>Combined criterion (recommended):</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Stop</mtext><mtext>  </mtext><mo>⟺</mo><mtext>  </mtext><mo stretchy="false">(</mo><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>≥</mo><msub><mi>Q</mi><mi>min</mi><mo>⁡</mo></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>∨</mo><mtext>  </mtext><mo stretchy="false">(</mo><mi>t</mi><mo>≥</mo><msub><mi>t</mi><mi>max</mi><mo>⁡</mo></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>∨</mo><mtext>  </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi mathvariant="normal">∣</mi><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mo>&lt;</mo><mi>ϵ</mi><mtext>  </mtext><mo>∧</mo><mtext>  </mtext><mi>t</mi><mo>≥</mo><mn>2</mn><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
\text{Stop} \iff (Q(y^{(t)}) \geq Q_{\min}) \;\vee\; (t \geq t_{\max}) \;\vee\; \bigl(|Q(y^{(t)}) - Q(y^{(t-1)})| &lt; \epsilon \;\wedge\; t \geq 2\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Stop</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟺</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">i</span><span class="mtight">n</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.288em;vertical-align:-0.35em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mord">∣</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5556em;"></span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord">2</span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><h3 id="11043-quality-monotonic-refinement-guarantees" tabindex="-1">1.10.4.3 Quality-Monotonic Refinement Guarantees</h3>
<p>A refinement chain is <strong>quality-monotonic</strong> iff:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>≥</mo><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mspace width="1em"/><mi mathvariant="normal">∀</mi><mtext> </mtext><mi>t</mi></mrow><annotation encoding="application/x-tex">
Q(y^{(t+1)}) \geq Q(y^{(t)}) \quad \forall\, t
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mord">∀</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span></span></span></span></span></eqn></section><p><strong>This is NOT guaranteed by default.</strong> LLMs can degrade output quality during revision (introducing new errors while fixing old ones, over-editing, losing nuance).</p>
<p><strong>Strategies to enforce monotonicity:</strong></p>
<ol>
<li><strong>Accept-if-better gate:</strong></li>
</ol>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>y</mi><mtext>final</mtext><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>&gt;</mo><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise (reject revision)</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
y^{(t+1)}_{\text{final}} = \begin{cases}
y^{(t+1)} &amp; \text{if } Q(y^{(t+1)}) &gt; Q(y^{(t)}) \\
y^{(t)} &amp; \text{otherwise (reject revision)}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3461em;vertical-align:-0.3013em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.3987em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">final</span></span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise (reject revision)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><ol start="2">
<li>
<p><strong>Diff-based revision:</strong> Instead of regenerating the entire output, apply only targeted edits.</p>
</li>
<li>
<p><strong>Independent evaluator:</strong> Use a different model or method for <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span></eq> than for generation/revision.</p>
</li>
</ol>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IterativeRefinementChain</span>:
    <span class="hljs-string">&quot;&quot;&quot;Generate-Critique-Revise loop with convergence control.&quot;&quot;&quot;</span>
    
    CRITIQUE_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Critically evaluate the following output for the given task.
Identify specific issues and suggest concrete improvements.

Task: {task}
Current Output: {output}

Provide your critique as JSON:
{{&quot;issues&quot;: [{{&quot;description&quot;: &quot;...&quot;, &quot;severity&quot;: &quot;low|medium|high&quot;, 
  &quot;location&quot;: &quot;...&quot;, &quot;suggestion&quot;: &quot;...&quot;}}], 
  &quot;overall_quality&quot;: 0.0-1.0,
  &quot;needs_revision&quot;: true/false}}&quot;&quot;&quot;</span>
    
    REVISE_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Revise the output to address the identified issues.
Make targeted improvements while preserving what is already good.
Do NOT introduce new content beyond what is needed to fix the issues.

Task: {task}
Current Output: {output}

Issues to address:
{critique}

Revised Output:&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, 
                 critic_llm: <span class="hljs-string">&quot;LLMClient&quot;</span> = <span class="hljs-literal">None</span>,
                 max_iterations: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span>,
                 quality_threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.85</span>,
                 convergence_epsilon: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.02</span>,
                 enforce_monotonicity: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.critic_llm = critic_llm <span class="hljs-keyword">or</span> llm
        <span class="hljs-variable language_">self</span>.max_iter = max_iterations
        <span class="hljs-variable language_">self</span>.q_threshold = quality_threshold
        <span class="hljs-variable language_">self</span>.epsilon = convergence_epsilon
        <span class="hljs-variable language_">self</span>.monotonic = enforce_monotonicity
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, initial_draft: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Phase 0: Generate initial draft</span>
        <span class="hljs-keyword">if</span> initial_draft <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            current = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
                prompt=<span class="hljs-string">f&quot;Complete the following task:\n<span class="hljs-subst">{task}</span>&quot;</span>,
                temperature=<span class="hljs-number">0.3</span>, max_tokens=<span class="hljs-number">3000</span>
            )
        <span class="hljs-keyword">else</span>:
            current = initial_draft
        
        history = [{<span class="hljs-string">&quot;iteration&quot;</span>: <span class="hljs-number">0</span>, <span class="hljs-string">&quot;output_preview&quot;</span>: current[:<span class="hljs-number">200</span>], <span class="hljs-string">&quot;quality&quot;</span>: <span class="hljs-literal">None</span>}]
        prev_quality = <span class="hljs-number">0.0</span>
        best_output = current
        best_quality = <span class="hljs-number">0.0</span>
        
        <span class="hljs-keyword">for</span> iteration <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.max_iter + <span class="hljs-number">1</span>):
            <span class="hljs-comment"># Phase 1: Critique</span>
            critique_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.critic_llm.generate(
                prompt=<span class="hljs-variable language_">self</span>.CRITIQUE_PROMPT.<span class="hljs-built_in">format</span>(task=task, output=current),
                temperature=<span class="hljs-number">0.0</span>, max_tokens=<span class="hljs-number">1000</span>
            )
            critique = json.loads(critique_response)
            current_quality = critique.get(<span class="hljs-string">&quot;overall_quality&quot;</span>, <span class="hljs-number">0.5</span>)
            
            history.append({
                <span class="hljs-string">&quot;iteration&quot;</span>: iteration,
                <span class="hljs-string">&quot;quality&quot;</span>: current_quality,
                <span class="hljs-string">&quot;issues_found&quot;</span>: <span class="hljs-built_in">len</span>(critique.get(<span class="hljs-string">&quot;issues&quot;</span>, [])),
                <span class="hljs-string">&quot;needs_revision&quot;</span>: critique.get(<span class="hljs-string">&quot;needs_revision&quot;</span>, <span class="hljs-literal">False</span>)
            })
            
            <span class="hljs-comment"># Track best</span>
            <span class="hljs-keyword">if</span> current_quality &gt; best_quality:
                best_quality = current_quality
                best_output = current
            
            <span class="hljs-comment"># Check convergence</span>
            <span class="hljs-keyword">if</span> current_quality &gt;= <span class="hljs-variable language_">self</span>.q_threshold:
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> critique.get(<span class="hljs-string">&quot;needs_revision&quot;</span>, <span class="hljs-literal">True</span>):
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(current_quality - prev_quality) &lt; <span class="hljs-variable language_">self</span>.epsilon <span class="hljs-keyword">and</span> iteration &gt;= <span class="hljs-number">2</span>:
                <span class="hljs-keyword">break</span>
            
            <span class="hljs-comment"># Phase 2: Revise</span>
            issues_text = <span class="hljs-string">&quot;\n&quot;</span>.join(
                <span class="hljs-string">f&quot;- [<span class="hljs-subst">{iss[<span class="hljs-string">&#x27;severity&#x27;</span>]}</span>] <span class="hljs-subst">{iss[<span class="hljs-string">&#x27;description&#x27;</span>]}</span>: <span class="hljs-subst">{iss[<span class="hljs-string">&#x27;suggestion&#x27;</span>]}</span>&quot;</span>
                <span class="hljs-keyword">for</span> iss <span class="hljs-keyword">in</span> critique.get(<span class="hljs-string">&quot;issues&quot;</span>, [])
            )
            
            revised = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
                prompt=<span class="hljs-variable language_">self</span>.REVISE_PROMPT.<span class="hljs-built_in">format</span>(
                    task=task, output=current, critique=issues_text
                ),
                temperature=<span class="hljs-number">0.1</span>, max_tokens=<span class="hljs-number">3000</span>
            )
            
            <span class="hljs-comment"># Enforce monotonicity</span>
            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.monotonic:
                revised_critique = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.critic_llm.generate(
                    prompt=<span class="hljs-variable language_">self</span>.CRITIQUE_PROMPT.<span class="hljs-built_in">format</span>(task=task, output=revised),
                    temperature=<span class="hljs-number">0.0</span>, max_tokens=<span class="hljs-number">500</span>
                )
                revised_quality = json.loads(revised_critique).get(<span class="hljs-string">&quot;overall_quality&quot;</span>, <span class="hljs-number">0.0</span>)
                
                <span class="hljs-keyword">if</span> revised_quality &gt;= current_quality:
                    current = revised
                    prev_quality = current_quality
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># Reject revision — keep current</span>
                    history[-<span class="hljs-number">1</span>][<span class="hljs-string">&quot;revision_rejected&quot;</span>] = <span class="hljs-literal">True</span>
                    prev_quality = current_quality
                    <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">else</span>:
                current = revised
                prev_quality = current_quality
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: best_output <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.monotonic <span class="hljs-keyword">else</span> current,
            <span class="hljs-string">&quot;final_quality&quot;</span>: best_quality <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.monotonic <span class="hljs-keyword">else</span> current_quality,
            <span class="hljs-string">&quot;iterations&quot;</span>: <span class="hljs-built_in">len</span>(history) - <span class="hljs-number">1</span>,
            <span class="hljs-string">&quot;history&quot;</span>: history,
            <span class="hljs-string">&quot;converged&quot;</span>: (current_quality &gt;= <span class="hljs-variable language_">self</span>.q_threshold) <span class="hljs-keyword">or</span> 
                        (<span class="hljs-built_in">abs</span>(current_quality - prev_quality) &lt; <span class="hljs-variable language_">self</span>.epsilon)
        }
</code></pre>
</div><hr>
<h2 id="1105-ensemble-chains" tabindex="-1">1.10.5 Ensemble Chains</h2>
<h3 id="11051-formal-definition" tabindex="-1">1.10.5.1 Formal Definition</h3>
<p>An ensemble chain generates <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq> <strong>independent candidate outputs</strong> and selects or aggregates the best:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><mtext>Aggregate</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></msup><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
y^* = \text{Aggregate}\!\bigl(\, y^{(1)}, y^{(2)}, \dots, y^{(k)} \,\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.288em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">Aggregate</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><p>where each <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">y^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></eq> may be produced by a different chain variant, different model, or different random seed.</p>
<h3 id="11052-aggregation-strategies" tabindex="-1">1.10.5.2 Aggregation Strategies</h3>
<h4 id="a-majority-voting" tabindex="-1">A. Majority Voting</h4>
<p>For discrete outputs (classification, multiple-choice):</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>y</mi></munder><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mn mathvariant="double-struck">1</mn><mo stretchy="false">[</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mi>y</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">
y^* = \arg\max_y \sum_{i=1}^{k} \mathbb{1}[y^{(i)} = y]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1138em;vertical-align:-1.2777em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8361em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8361em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">]</span></span></span></span></span></eqn></section><h4 id="b-confidence-weighted-voting" tabindex="-1">B. Confidence-Weighted Voting</h4>
<p>When each candidate has an associated confidence <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>y</mi></munder><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><mo>⋅</mo><mn mathvariant="double-struck">1</mn><mo stretchy="false">[</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mi>y</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">
y^* = \arg\max_y \sum_{i=1}^{k} w_i \cdot \mathbb{1}[y^{(i)} = y]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1138em;vertical-align:-1.2777em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8361em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8361em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">]</span></span></span></span></span></eqn></section><h4 id="c-best-of-n-selection" tabindex="-1">C. Best-of-N Selection</h4>
<p>Generate <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq> candidates and select the one with the highest quality score:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></munder><mtext>  </mtext><mi>Q</mi><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y^* = \arg\max_{y^{(i)}} \; Q(y^{(i)})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.9155em;vertical-align:-0.9775em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.2586em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.822em;"><span style="top:-2.822em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9775em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p><strong>Quality improvement.</strong> If individual output quality follows distribution <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">F(q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span></span></span></span></eq>, then the expected quality of the best of <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msub><mi>Q</mi><mtext>best-of-N</mtext></msub><mo stretchy="false">]</mo><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mn>1</mn></msubsup><mi>q</mi><mo>⋅</mo><mi>N</mi><mo>⋅</mo><mi>F</mi><mo stretchy="false">(</mo><mi>q</mi><msup><mo stretchy="false">)</mo><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>⋅</mo><mi>f</mi><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mtext> </mtext><mi>d</mi><mi>q</mi></mrow><annotation encoding="application/x-tex">
\mathbb{E}[Q_{\text{best-of-N}}] = \int_0^1 q \cdot N \cdot F(q)^{N-1} \cdot f(q) \, dq
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">best-of-N</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.476em;vertical-align:-0.9119em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.564em;"><span style="top:-1.7881em;margin-left:-0.4445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span style="top:-3.8129em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9119em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span></eqn></section><p>For a uniform distribution on <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></eq>: <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msub><mi>Q</mi><mtext>best-of-N</mtext></msub><mo stretchy="false">]</mo><mo>=</mo><mfrac><mi>N</mi><mrow><mi>N</mi><mo>+</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\mathbb{E}[Q_{\text{best-of-N}}] = \frac{N}{N+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">best-of-N</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2757em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq>.</p>
<p>For <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">N=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></eq>: <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.50</mn></mrow><annotation encoding="application/x-tex">0.50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.50</span></span></span></span></eq>. For <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">N=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></eq>: <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.75</mn></mrow><annotation encoding="application/x-tex">0.75</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.75</span></span></span></span></eq>. For <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">N=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></eq>: <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.83</mn></mrow><annotation encoding="application/x-tex">0.83</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.83</span></span></span></span></eq>. For <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">N=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span></eq>: <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.91</mn></mrow><annotation encoding="application/x-tex">0.91</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.91</span></span></span></span></eq>.</p>
<h4 id="d-llm-as-judge-selection" tabindex="-1">D. LLM-as-Judge Selection</h4>
<p>Use a separate LLM to evaluate all candidates and select the best:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><msup><mi>j</mi><mo>∗</mo></msup><mo stretchy="false">)</mo></mrow></msup><mspace width="1em"/><mtext>where</mtext><mspace width="1em"/><msup><mi>j</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>j</mi></munder><mtext>  </mtext><msub><mtext>LLM</mtext><mtext>judge</mtext></msub><mo stretchy="false">(</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y^* = y^{(j^*)} \quad \text{where} \quad j^* = \arg\max_j \; \text{LLM}_{\text{judge}}(y^{(j)}, x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1418em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9473em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7633em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">where</span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8018em;vertical-align:-0.8638em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3723em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8638em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">LLM</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">judge</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></eqn></section><h4 id="e-synthesis-aggregation" tabindex="-1">E. Synthesis Aggregation</h4>
<p>Instead of selecting one candidate, <strong>synthesize</strong> a new output that combines the best aspects of all candidates:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><msub><mtext>LLM</mtext><mtext>synthesize</mtext></msub><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><mi>x</mi><mo separator="true">,</mo><mtext>  </mtext><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></msup><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
y^* = \text{LLM}_{\text{synthesize}}\!\bigl(\, x,\; y^{(1)}, \dots, y^{(k)} \,\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.288em;vertical-align:-0.35em;"></span><span class="mord"><span class="mord text"><span class="mord">LLM</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">synthesize</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EnsembleChain</span>:
    <span class="hljs-string">&quot;&quot;&quot;Execute multiple chain variants and aggregate results.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 
                 chain_variants: <span class="hljs-built_in">list</span>[<span class="hljs-type">Callable</span>],
                 aggregation: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;best_of_n&quot;</span>,
                 quality_fn: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>], <span class="hljs-built_in">float</span>] = <span class="hljs-literal">None</span>,
                 judge_llm: <span class="hljs-string">&quot;LLMClient&quot;</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.variants = chain_variants
        <span class="hljs-variable language_">self</span>.aggregation = aggregation
        <span class="hljs-variable language_">self</span>.quality_fn = quality_fn
        <span class="hljs-variable language_">self</span>.judge_llm = judge_llm
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, input_data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Generate all candidates in parallel</span>
        candidates = <span class="hljs-keyword">await</span> asyncio.gather(*[
            variant(input_data) <span class="hljs-keyword">for</span> variant <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.variants
        ], return_exceptions=<span class="hljs-literal">True</span>)
        
        <span class="hljs-comment"># Filter out failures</span>
        valid = [(i, c) <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(candidates) 
                 <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(c, Exception)]
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">&quot;All ensemble variants failed&quot;</span>)
        
        task = input_data.get(<span class="hljs-string">&quot;task&quot;</span>, input_data.get(<span class="hljs-string">&quot;query&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))
        
        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.aggregation == <span class="hljs-string">&quot;best_of_n&quot;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._best_of_n(valid, task)
        <span class="hljs-keyword">elif</span> <span class="hljs-variable language_">self</span>.aggregation == <span class="hljs-string">&quot;majority_vote&quot;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._majority_vote(valid)
        <span class="hljs-keyword">elif</span> <span class="hljs-variable language_">self</span>.aggregation == <span class="hljs-string">&quot;synthesis&quot;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._synthesis(valid, task)
        <span class="hljs-keyword">elif</span> <span class="hljs-variable language_">self</span>.aggregation == <span class="hljs-string">&quot;judge&quot;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._judge_selection(valid, task)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_best_of_n</span>(<span class="hljs-params">self, candidates: <span class="hljs-built_in">list</span>, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        scored = []
        <span class="hljs-keyword">for</span> idx, output <span class="hljs-keyword">in</span> candidates:
            score = <span class="hljs-variable language_">self</span>.quality_fn(<span class="hljs-built_in">str</span>(output), task) <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.quality_fn <span class="hljs-keyword">else</span> <span class="hljs-number">0.5</span>
            scored.append((score, idx, output))
        
        scored.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>], reverse=<span class="hljs-literal">True</span>)
        best_score, best_idx, best_output = scored[<span class="hljs-number">0</span>]
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: best_output,
            <span class="hljs-string">&quot;selected_variant&quot;</span>: best_idx,
            <span class="hljs-string">&quot;quality_score&quot;</span>: best_score,
            <span class="hljs-string">&quot;all_scores&quot;</span>: [(idx, score) <span class="hljs-keyword">for</span> score, idx, _ <span class="hljs-keyword">in</span> scored],
            <span class="hljs-string">&quot;n_candidates&quot;</span>: <span class="hljs-built_in">len</span>(candidates)
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_majority_vote</span>(<span class="hljs-params">self, candidates: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter
        outputs = [<span class="hljs-built_in">str</span>(c) <span class="hljs-keyword">for</span> _, c <span class="hljs-keyword">in</span> candidates]
        counter = Counter(outputs)
        most_common, count = counter.most_common(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: most_common,
            <span class="hljs-string">&quot;vote_count&quot;</span>: count,
            <span class="hljs-string">&quot;total_votes&quot;</span>: <span class="hljs-built_in">len</span>(candidates),
            <span class="hljs-string">&quot;agreement_ratio&quot;</span>: count / <span class="hljs-built_in">len</span>(candidates)
        }
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_synthesis</span>(<span class="hljs-params">self, candidates: <span class="hljs-built_in">list</span>, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        candidate_texts = <span class="hljs-string">&quot;\n\n---\n\n&quot;</span>.join(
            <span class="hljs-string">f&quot;Candidate <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>:\n<span class="hljs-subst">{<span class="hljs-built_in">str</span>(output)}</span>&quot;</span> <span class="hljs-keyword">for</span> i, (_, output) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(candidates)
        )
        
        prompt = (
            <span class="hljs-string">f&quot;Given the task and multiple candidate solutions below, &quot;</span>
            <span class="hljs-string">f&quot;synthesize the best possible output by combining the strengths &quot;</span>
            <span class="hljs-string">f&quot;of each candidate and avoiding their weaknesses.\n\n&quot;</span>
            <span class="hljs-string">f&quot;Task: <span class="hljs-subst">{task}</span>\n\n&quot;</span>
            <span class="hljs-string">f&quot;Candidates:\n<span class="hljs-subst">{candidate_texts}</span>\n\n&quot;</span>
            <span class="hljs-string">f&quot;Synthesized Best Output:&quot;</span>
        )
        
        synthesized = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.judge_llm.generate(
            prompt=prompt, temperature=<span class="hljs-number">0.0</span>, max_tokens=<span class="hljs-number">3000</span>
        )
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: synthesized,
            <span class="hljs-string">&quot;n_candidates&quot;</span>: <span class="hljs-built_in">len</span>(candidates),
            <span class="hljs-string">&quot;aggregation&quot;</span>: <span class="hljs-string">&quot;synthesis&quot;</span>
        }
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_judge_selection</span>(<span class="hljs-params">self, candidates: <span class="hljs-built_in">list</span>, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        candidate_texts = <span class="hljs-string">&quot;\n\n---\n\n&quot;</span>.join(
            <span class="hljs-string">f&quot;Option <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>:\n<span class="hljs-subst">{<span class="hljs-built_in">str</span>(output)}</span>&quot;</span> <span class="hljs-keyword">for</span> i, (_, output) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(candidates)
        )
        
        prompt = (
            <span class="hljs-string">f&quot;You are evaluating multiple candidate responses to a task.\n\n&quot;</span>
            <span class="hljs-string">f&quot;Task: <span class="hljs-subst">{task}</span>\n\n<span class="hljs-subst">{candidate_texts}</span>\n\n&quot;</span>
            <span class="hljs-string">f&quot;Which option is the BEST? Respond as JSON:\n&quot;</span>
            <span class="hljs-string">f&#x27;{{&quot;best_option&quot;: N, &quot;reasoning&quot;: &quot;...&quot;}}&#x27;</span>
        )
        
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.judge_llm.generate(prompt=prompt, temperature=<span class="hljs-number">0.0</span>)
        result = json.loads(response)
        best_idx = result[<span class="hljs-string">&quot;best_option&quot;</span>] - <span class="hljs-number">1</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: candidates[<span class="hljs-built_in">min</span>(best_idx, <span class="hljs-built_in">len</span>(candidates)-<span class="hljs-number">1</span>)][<span class="hljs-number">1</span>],
            <span class="hljs-string">&quot;judge_reasoning&quot;</span>: result[<span class="hljs-string">&quot;reasoning&quot;</span>],
            <span class="hljs-string">&quot;selected_option&quot;</span>: result[<span class="hljs-string">&quot;best_option&quot;</span>],
            <span class="hljs-string">&quot;n_candidates&quot;</span>: <span class="hljs-built_in">len</span>(candidates)
        }
</code></pre>
</div><h3 id="11053-mixture-of-chains-architecture" tabindex="-1">1.10.5.3 Mixture-of-Chains Architecture</h3>
<p>A more structured ensemble where different chains are <strong>specialized</strong> for different aspects of the task:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">                    Input
                      │
            ┌─────────┼─────────┐
            ▼         ▼         ▼
     ┌──────────┐ ┌────────┐ ┌──────────┐
     │ Chain A:  │ │Chain B:│ │ Chain C:  │
     │ Factual   │ │Creative│ │ Analytical│
     │ Accuracy  │ │Writing │ │ Depth     │
     └─────┬────┘ └───┬────┘ └─────┬────┘
           │          │            │
           └──────────┼────────────┘
                      ▼
              ┌───────────────┐
              │   Synthesizer  │
              │  (merge best   │
              │   aspects)     │
              └───────┬───────┘
                      ▼
                 Final Output
</code></pre>
</div><hr>
<h2 id="1106-retrieval-augmented-chains" tabindex="-1">1.10.6 Retrieval-Augmented Chains</h2>
<h3 id="11061-rag-as-a-chain-step" tabindex="-1">1.10.6.1 RAG as a Chain Step</h3>
<p>Retrieval-Augmented Generation (RAG) naturally decomposes into a <strong>three-step chain</strong>:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RAG</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Generate</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><mi>q</mi><mo separator="true">,</mo><mtext>  </mtext><mtext>Augment</mtext><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><mtext>Retrieve</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
\text{RAG}(q) = \text{Generate}\!\bigl(\, q,\; \text{Augment}(q, \text{Retrieve}(q)) \,\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RAG</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">Generate</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">Augment</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">Retrieve</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><p><strong>Step 1 — Retrieve:</strong> Query a knowledge base <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">K</mi></mrow><annotation encoding="application/x-tex">\mathcal{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.01445em;">K</span></span></span></span></eq> to find relevant documents:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">D</mi><mi>q</mi></msub><mo>=</mo><mtext>TopK</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><mi mathvariant="script">K</mi><mo separator="true">,</mo><mtext>  </mtext><mi>q</mi><mo separator="true">,</mo><mtext>  </mtext><mi>k</mi><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><mtext>top-</mtext><msub><mi>k</mi><mrow><mi>d</mi><mo>∈</mo><mi mathvariant="script">K</mi></mrow></msub><mtext>  </mtext><mtext>sim</mtext><mo stretchy="false">(</mo><mi>e</mi><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>e</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\mathcal{D}_q = \text{TopK}\!\bigl(\, \mathcal{K},\; q,\; k \,\bigr) = \arg\text{top-}k_{d \in \mathcal{K}} \; \text{sim}(e(q), e(d))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">TopK</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathcal" style="margin-right:0.01445em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">top-</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight" style="margin-right:0.01445em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mclose">))</span></span></span></span></span></eqn></section><p><strong>Step 2 — Augment:</strong> Construct a context-augmented prompt:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mtext>aug</mtext></msub><mo>=</mo><mtext>Template</mtext><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><msub><mi mathvariant="script">D</mi><mi>q</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mtext>“Context: </mtext><munder><mo>⨁</mo><mrow><mi>d</mi><mo>∈</mo><msub><mi mathvariant="script">D</mi><mi>q</mi></msub></mrow></munder><mi>d</mi><mtext>. Question: </mtext><mi>q</mi><mtext>”</mtext></mrow><annotation encoding="application/x-tex">
p_{\text{aug}} = \text{Template}(q, \mathcal{D}_q) = \text{``Context: } \bigoplus_{d \in \mathcal{D}_q} d \text{. Question: } q\text{&#x27;&#x27;}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">aug</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Template</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5494em;vertical-align:-1.4994em;"></span><span class="mord text"><span class="mord">“Context: </span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">⨁</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4994em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord text"><span class="mord">. Question: </span></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord text"><span class="mord">”</span></span></span></span></span></span></eqn></section><p><strong>Step 3 — Generate:</strong> Produce the answer conditioned on augmented context:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>y</mi><mo>∼</mo><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><msub><mi>p</mi><mtext>aug</mtext></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y \sim p_\theta(y \mid p_{\text{aug}})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">aug</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><h3 id="11062-multi-hop-retrieval-chains" tabindex="-1">1.10.6.2 Multi-Hop Retrieval Chains</h3>
<p>For questions requiring information synthesis from multiple sources, a single retrieval is insufficient. <strong>Multi-hop retrieval</strong> chains iteratively retrieve and reason:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>for </mtext><mi>t</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>T</mi><mo>:</mo></mrow><annotation encoding="application/x-tex">
\text{for } t = 1, 2, \dots, T:
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">for </span></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>q</mi><mi>t</mi></msub><mo>=</mo><mtext>QueryRewrite</mtext><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><msub><mi>y</mi><mrow><mo>&lt;</mo><mi>t</mi></mrow></msub><mo separator="true">,</mo><msub><mi mathvariant="script">D</mi><mrow><mo>&lt;</mo><mi>t</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
q_t = \text{QueryRewrite}(q, y_{&lt;t}, \mathcal{D}_{&lt;t})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">QueryRewrite</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">D</mi><mi>t</mi></msub><mo>=</mo><mtext>Retrieve</mtext><mo stretchy="false">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\mathcal{D}_t = \text{Retrieve}(q_t)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Retrieve</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><mi>t</mi></msub><mo>=</mo><mtext>Reason</mtext><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><msub><mi mathvariant="script">D</mi><mrow><mo>≤</mo><mi>t</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mo>&lt;</mo><mi>t</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
y_t = \text{Reason}(q, \mathcal{D}_{\leq t}, y_{&lt;t})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Reason</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2952em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2452em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></eqn></section><p>Each hop refines the query based on what was learned from previous retrievals.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHopRAGChain</span>:
    <span class="hljs-string">&quot;&quot;&quot;Iterative retrieval-reasoning chain for complex queries.&quot;&quot;&quot;</span>
    
    QUERY_REWRITE_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Based on the original question and what we&#x27;ve learned so far,
formulate a follow-up search query to find missing information.

Original question: {question}
Information gathered so far: {gathered}
What we still need to know: {gaps}

Follow-up search query:&quot;&quot;&quot;</span>
    
    REASONING_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Answer the question using the provided evidence.
If the evidence is insufficient, indicate what additional information is needed.

Question: {question}
Evidence:
{evidence}

Respond as JSON:
{{&quot;answer&quot;: &quot;...&quot;, &quot;confidence&quot;: 0.0-1.0, &quot;sufficient&quot;: true/false,
  &quot;missing_information&quot;: [&quot;...&quot;] or null}}&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, retriever: <span class="hljs-string">&quot;Retriever&quot;</span>,
                 max_hops: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span>, confidence_threshold: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.8</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.retriever = retriever
        <span class="hljs-variable language_">self</span>.max_hops = max_hops
        <span class="hljs-variable language_">self</span>.conf_threshold = confidence_threshold
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        all_evidence = []
        hop_log = []
        current_query = question
        
        <span class="hljs-keyword">for</span> hop <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.max_hops):
            <span class="hljs-comment"># Retrieve</span>
            docs = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.retriever.search(current_query, k=<span class="hljs-number">5</span>)
            all_evidence.extend(docs)
            
            <span class="hljs-comment"># Reason</span>
            evidence_text = <span class="hljs-string">&quot;\n---\n&quot;</span>.join(
                <span class="hljs-string">f&quot;[Source <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>]: <span class="hljs-subst">{d[<span class="hljs-string">&#x27;content&#x27;</span>]}</span>&quot;</span> <span class="hljs-keyword">for</span> i, d <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(all_evidence)
            )
            
            reasoning_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
                prompt=<span class="hljs-variable language_">self</span>.REASONING_PROMPT.<span class="hljs-built_in">format</span>(
                    question=question, evidence=evidence_text
                ),
                temperature=<span class="hljs-number">0.0</span>
            )
            result = json.loads(reasoning_response)
            
            hop_log.append({
                <span class="hljs-string">&quot;hop&quot;</span>: hop + <span class="hljs-number">1</span>,
                <span class="hljs-string">&quot;query&quot;</span>: current_query,
                <span class="hljs-string">&quot;docs_retrieved&quot;</span>: <span class="hljs-built_in">len</span>(docs),
                <span class="hljs-string">&quot;confidence&quot;</span>: result[<span class="hljs-string">&quot;confidence&quot;</span>],
                <span class="hljs-string">&quot;sufficient&quot;</span>: result[<span class="hljs-string">&quot;sufficient&quot;</span>]
            })
            
            <span class="hljs-comment"># Check if we have enough information</span>
            <span class="hljs-keyword">if</span> result[<span class="hljs-string">&quot;sufficient&quot;</span>] <span class="hljs-keyword">or</span> result[<span class="hljs-string">&quot;confidence&quot;</span>] &gt;= <span class="hljs-variable language_">self</span>.conf_threshold:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">&quot;answer&quot;</span>: result[<span class="hljs-string">&quot;answer&quot;</span>],
                    <span class="hljs-string">&quot;confidence&quot;</span>: result[<span class="hljs-string">&quot;confidence&quot;</span>],
                    <span class="hljs-string">&quot;hops&quot;</span>: hop + <span class="hljs-number">1</span>,
                    <span class="hljs-string">&quot;total_sources&quot;</span>: <span class="hljs-built_in">len</span>(all_evidence),
                    <span class="hljs-string">&quot;hop_log&quot;</span>: hop_log
                }
            
            <span class="hljs-comment"># Rewrite query for next hop</span>
            <span class="hljs-keyword">if</span> result.get(<span class="hljs-string">&quot;missing_information&quot;</span>):
                gaps = <span class="hljs-string">&quot;, &quot;</span>.join(result[<span class="hljs-string">&quot;missing_information&quot;</span>])
                gathered = result[<span class="hljs-string">&quot;answer&quot;</span>]
                current_query = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
                    prompt=<span class="hljs-variable language_">self</span>.QUERY_REWRITE_PROMPT.<span class="hljs-built_in">format</span>(
                        question=question,
                        gathered=gathered,
                        gaps=gaps
                    ),
                    temperature=<span class="hljs-number">0.0</span>, max_tokens=<span class="hljs-number">100</span>
                )
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;answer&quot;</span>: result[<span class="hljs-string">&quot;answer&quot;</span>],
            <span class="hljs-string">&quot;confidence&quot;</span>: result[<span class="hljs-string">&quot;confidence&quot;</span>],
            <span class="hljs-string">&quot;hops&quot;</span>: <span class="hljs-variable language_">self</span>.max_hops,
            <span class="hljs-string">&quot;total_sources&quot;</span>: <span class="hljs-built_in">len</span>(all_evidence),
            <span class="hljs-string">&quot;exhausted_hops&quot;</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">&quot;hop_log&quot;</span>: hop_log
        }
</code></pre>
</div><h3 id="11063-adaptive-retrieval-retrieve-only-when-needed" tabindex="-1">1.10.6.3 Adaptive Retrieval (Retrieve Only When Needed)</h3>
<p>Not every query requires retrieval. An <strong>adaptive retrieval</strong> chain decides at runtime whether retrieval is necessary:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>AdaptiveRAG</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>DirectAnswer</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if NeedsRetrieval</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mtext mathvariant="monospace">False</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>RAG</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if NeedsRetrieval</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mtext mathvariant="monospace">True</mtext></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{AdaptiveRAG}(q) = \begin{cases}
\text{DirectAnswer}(q) &amp; \text{if } \text{NeedsRetrieval}(q) = \texttt{False} \\
\text{RAG}(q) &amp; \text{if } \text{NeedsRetrieval}(q) = \texttt{True}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">AdaptiveRAG</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">DirectAnswer</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">RAG</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord text"><span class="mord">NeedsRetrieval</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord texttt">False</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord text"><span class="mord">NeedsRetrieval</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord texttt">True</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p><strong>Decision criteria for retrieval necessity:</strong></p>
<table>
<thead>
<tr>
<th>Signal</th>
<th>Indicates Retrieval Needed</th>
<th>Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Query mentions specific facts/dates/numbers</td>
<td>Yes</td>
<td>NER + pattern matching</td>
</tr>
<tr>
<td>Query asks about recent events</td>
<td>Yes</td>
<td>Temporal keyword detection</td>
</tr>
<tr>
<td>Query is opinion/creative/hypothetical</td>
<td>No</td>
<td>Intent classification</td>
</tr>
<tr>
<td>Model uncertainty is high</td>
<td>Yes</td>
<td>Confidence-based routing</td>
</tr>
<tr>
<td>Query references specific documents</td>
<td>Yes</td>
<td>Reference detection</td>
</tr>
</tbody>
</table>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveRAGChain</span>:
    <span class="hljs-string">&quot;&quot;&quot;Retrieve only when the model lacks sufficient knowledge.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, retriever: <span class="hljs-string">&quot;Retriever&quot;</span>,
                 confidence_router: <span class="hljs-string">&quot;ConfidenceRouter&quot;</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.retriever = retriever
        <span class="hljs-variable language_">self</span>.router = confidence_router
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Step 1: Attempt direct answer</span>
        direct = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=<span class="hljs-string">f&quot;Answer if you are confident. If unsure, say &#x27;UNCERTAIN&#x27;.\n\nQ: <span class="hljs-subst">{question}</span>&quot;</span>,
            temperature=<span class="hljs-number">0.0</span>, logprobs=<span class="hljs-literal">True</span>
        )
        
        <span class="hljs-comment"># Step 2: Check confidence</span>
        confidence = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.router.estimate_confidence_logprob(
            <span class="hljs-string">f&quot;Q: <span class="hljs-subst">{question}</span>&quot;</span>
        )
        
        <span class="hljs-keyword">if</span> confidence &gt; <span class="hljs-number">0.85</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;UNCERTAIN&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> direct.upper():
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">&quot;answer&quot;</span>: direct,
                <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;direct_knowledge&quot;</span>,
                <span class="hljs-string">&quot;retrieval_used&quot;</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">&quot;confidence&quot;</span>: confidence
            }
        
        <span class="hljs-comment"># Step 3: Retrieval-augmented path</span>
        docs = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.retriever.search(question, k=<span class="hljs-number">5</span>)
        context = <span class="hljs-string">&quot;\n\n&quot;</span>.join(d[<span class="hljs-string">&quot;content&quot;</span>] <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs)
        
        augmented_answer = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=(
                <span class="hljs-string">f&quot;Answer based on the following context.\n\n&quot;</span>
                <span class="hljs-string">f&quot;Context:\n<span class="hljs-subst">{context}</span>\n\n&quot;</span>
                <span class="hljs-string">f&quot;Question: <span class="hljs-subst">{question}</span>\n\nAnswer:&quot;</span>
            ),
            temperature=<span class="hljs-number">0.0</span>
        )
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;answer&quot;</span>: augmented_answer,
            <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;retrieval_augmented&quot;</span>,
            <span class="hljs-string">&quot;retrieval_used&quot;</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">&quot;num_sources&quot;</span>: <span class="hljs-built_in">len</span>(docs),
            <span class="hljs-string">&quot;direct_confidence_was&quot;</span>: confidence
        }
</code></pre>
</div><h3 id="11064-query-rewriting-chains" tabindex="-1">1.10.6.4 Query Rewriting Chains</h3>
<p>Raw user queries are often suboptimal for retrieval (vague, conversational, multi-faceted). A <strong>query rewriting chain</strong> transforms the user query into one or more optimized search queries:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>q</mi><mtext>user</mtext></msub><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><mtext>Rewrite</mtext></mpadded></mover><mo stretchy="false">{</mo><msubsup><mi>q</mi><mn>1</mn><mtext>search</mtext></msubsup><mo separator="true">,</mo><msubsup><mi>q</mi><mn>2</mn><mtext>search</mtext></msubsup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msubsup><mi>q</mi><mi>m</mi><mtext>search</mtext></msubsup><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">
q_{\text{user}} \xrightarrow{\text{Rewrite}} \{q_1^{\text{search}}, q_2^{\text{search}}, \dots, q_m^{\text{search}}\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2948em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">user</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1003em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Rewrite</span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">search</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">search</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">search</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span></eqn></section><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryRewriter</span>:
    <span class="hljs-string">&quot;&quot;&quot;Transform user queries into optimized search queries.&quot;&quot;&quot;</span>
    
    REWRITE_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Given the user&#x27;s question, generate {n} optimized search queries
that would retrieve the most relevant information. Consider:
1. Different phrasings of the same concept
2. Specific technical terms vs. general language
3. Breaking compound questions into atomic searches
4. Adding relevant context terms

User question: {question}

Generate {n} search queries as a JSON list: [&quot;query1&quot;, &quot;query2&quot;, ...]&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">rewrite</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span>, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=<span class="hljs-variable language_">self</span>.REWRITE_PROMPT.<span class="hljs-built_in">format</span>(question=question, n=n),
            temperature=<span class="hljs-number">0.3</span>
        )
        queries = json.loads(response)
        <span class="hljs-keyword">return</span> queries <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(queries, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">else</span> [question]
</code></pre>
</div><hr>
<h2 id="1107-tool-augmented-chains" tabindex="-1">1.10.7 Tool-Augmented Chains</h2>
<h3 id="11071-tool-invocation-as-a-chain-step" tabindex="-1">1.10.7.1 Tool Invocation as a Chain Step</h3>
<p>Tools extend the chain’s capabilities beyond what the LLM can do alone. A tool call is a chain step where the LLM <strong>generates a structured action</strong> and a tool executor <strong>performs the action deterministically</strong>.</p>
<p><strong>Formal model:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>ToolStep</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mtext>args</mtext><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mtext>LLM</mtext><mtext>plan</mtext></msub><mo stretchy="false">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>(plan the tool call)</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>o</mi><mi>t</mi></msub><mo>=</mo><msub><mtext>Tool</mtext><msub><mi>a</mi><mi>t</mi></msub></msub><mo stretchy="false">(</mo><msub><mtext>args</mtext><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>(execute the tool)</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>S</mi><mi>t</mi></msub><mo>∪</mo><mo stretchy="false">{</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>o</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">}</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>(update state with observation)</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{ToolStep}(S_t) = \begin{cases}
(a_t, \text{args}_t) = \text{LLM}_{\text{plan}}(S_t) &amp; \text{(plan the tool call)} \\
o_t = \text{Tool}_{a_t}(\text{args}_t) &amp; \text{(execute the tool)} \\
S_{t+1} = S_t \cup \{(a_t, o_t)\} &amp; \text{(update state with observation)}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">ToolStep</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">args</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord text"><span class="mord">LLM</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">plan</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord text"><span class="mord">Tool</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">args</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">{(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)}</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">(plan the tool call)</span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">(execute the tool)</span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">(update state with observation)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><h3 id="11072-tool-registry-and-type-safe-invocation" tabindex="-1">1.10.7.2 Tool Registry and Type-Safe Invocation</h3>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, get_type_hints
<span class="hljs-keyword">from</span> inspect <span class="hljs-keyword">import</span> signature
<span class="hljs-keyword">import</span> json

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolDefinition</span>:
    name: <span class="hljs-built_in">str</span>
    description: <span class="hljs-built_in">str</span>
    parameters: <span class="hljs-built_in">dict</span>           <span class="hljs-comment"># JSON Schema for parameters</span>
    function: <span class="hljs-type">Callable</span>
    return_type: <span class="hljs-built_in">str</span>
    requires_confirmation: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    timeout_seconds: <span class="hljs-built_in">float</span> = <span class="hljs-number">30.0</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolRegistry</span>:
    <span class="hljs-string">&quot;&quot;&quot;Registry of available tools with schema generation.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.tools: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, ToolDefinition] = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">self, func: <span class="hljs-type">Callable</span>, description: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;&quot;</span>,
                 requires_confirmation: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>) -&gt; ToolDefinition:
        <span class="hljs-string">&quot;&quot;&quot;Register a function as a tool, auto-generating schema.&quot;&quot;&quot;</span>
        hints = get_type_hints(func)
        sig = signature(func)
        
        params = {
            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;object&quot;</span>,
            <span class="hljs-string">&quot;properties&quot;</span>: {},
            <span class="hljs-string">&quot;required&quot;</span>: []
        }
        
        <span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> sig.parameters.items():
            <span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;self&quot;</span>:
                <span class="hljs-keyword">continue</span>
            param_type = hints.get(name, <span class="hljs-built_in">str</span>)
            json_type = <span class="hljs-variable language_">self</span>._python_to_json_type(param_type)
            params[<span class="hljs-string">&quot;properties&quot;</span>][name] = {<span class="hljs-string">&quot;type&quot;</span>: json_type}
            <span class="hljs-keyword">if</span> param.default <span class="hljs-keyword">is</span> param.empty:
                params[<span class="hljs-string">&quot;required&quot;</span>].append(name)
        
        tool_def = ToolDefinition(
            name=func.__name__,
            description=description <span class="hljs-keyword">or</span> func.__doc__ <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>,
            parameters=params,
            function=func,
            return_type=<span class="hljs-variable language_">self</span>._python_to_json_type(hints.get(<span class="hljs-string">&quot;return&quot;</span>, <span class="hljs-built_in">str</span>)),
            requires_confirmation=requires_confirmation
        )
        
        <span class="hljs-variable language_">self</span>.tools[func.__name__] = tool_def
        <span class="hljs-keyword">return</span> tool_def
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_schemas_for_llm</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Generate tool schemas in OpenAI function-calling format.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> [
            {
                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;function&quot;</span>,
                <span class="hljs-string">&quot;function&quot;</span>: {
                    <span class="hljs-string">&quot;name&quot;</span>: tool.name,
                    <span class="hljs-string">&quot;description&quot;</span>: tool.description,
                    <span class="hljs-string">&quot;parameters&quot;</span>: tool.parameters
                }
            }
            <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.tools.values()
        ]
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, tool_name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-keyword">if</span> tool_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.tools:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Unknown tool: <span class="hljs-subst">{tool_name}</span>&quot;</span>)
        
        tool = <span class="hljs-variable language_">self</span>.tools[tool_name]
        
        <span class="hljs-keyword">try</span>:
            result = <span class="hljs-keyword">await</span> asyncio.wait_for(
                <span class="hljs-variable language_">self</span>._call(tool.function, arguments),
                timeout=tool.timeout_seconds
            )
            <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-string">&quot;result&quot;</span>: result}
        <span class="hljs-keyword">except</span> asyncio.TimeoutError:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;Tool timed out after <span class="hljs-subst">{tool.timeout_seconds}</span>s&quot;</span>}
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-built_in">str</span>(e)}
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_call</span>(<span class="hljs-params">self, func: <span class="hljs-type">Callable</span>, args: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-keyword">if</span> asyncio.iscoroutinefunction(func):
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> func(**args)
        <span class="hljs-keyword">return</span> func(**args)
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_python_to_json_type</span>(<span class="hljs-params">py_type</span>) -&gt; <span class="hljs-built_in">str</span>:
        mapping = {<span class="hljs-built_in">str</span>: <span class="hljs-string">&quot;string&quot;</span>, <span class="hljs-built_in">int</span>: <span class="hljs-string">&quot;integer&quot;</span>, <span class="hljs-built_in">float</span>: <span class="hljs-string">&quot;number&quot;</span>,
                   <span class="hljs-built_in">bool</span>: <span class="hljs-string">&quot;boolean&quot;</span>, <span class="hljs-built_in">list</span>: <span class="hljs-string">&quot;array&quot;</span>, <span class="hljs-built_in">dict</span>: <span class="hljs-string">&quot;object&quot;</span>}
        <span class="hljs-keyword">return</span> mapping.get(py_type, <span class="hljs-string">&quot;string&quot;</span>)


<span class="hljs-comment"># --- Register tools ---</span>
registry = ToolRegistry()

<span class="hljs-meta">@registry.register(<span class="hljs-params">description=<span class="hljs-string">&quot;Search the web for information&quot;</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">web_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, max_results: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]:
    <span class="hljs-string">&quot;&quot;&quot;Search the web and return results.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># implementation</span>

<span class="hljs-meta">@registry.register(<span class="hljs-params">description=<span class="hljs-string">&quot;Execute Python code in a sandboxed environment&quot;</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_python</span>(<span class="hljs-params">code: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">&quot;&quot;&quot;Run Python code and return output.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># implementation</span>

<span class="hljs-meta">@registry.register(<span class="hljs-params">description=<span class="hljs-string">&quot;Query a SQL database&quot;</span>, requires_confirmation=<span class="hljs-literal">True</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sql_query</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, database: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;default&quot;</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]:
    <span class="hljs-string">&quot;&quot;&quot;Execute a SQL query and return results.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># implementation</span>
</code></pre>
</div><h3 id="11073-tool-result-parsing-and-integration" tabindex="-1">1.10.7.3 Tool Result Parsing and Integration</h3>
<p>After a tool executes, its result must be <strong>parsed, validated, and integrated</strong> back into the chain’s context:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolIntegrationStep</span>:
    <span class="hljs-string">&quot;&quot;&quot;Parse tool results and integrate into the chain context.&quot;&quot;&quot;</span>
    
    INTEGRATION_PROMPT = <span class="hljs-string">&quot;&quot;&quot;The following tool was called and produced the result below.
Interpret this result in the context of the original task.

Original Task: {task}
Tool Called: {tool_name}({arguments})
Tool Result:
{result}

Based on this result:
1. What key information was obtained?
2. Does this answer the original question, or do we need additional steps?
3. Are there any issues with the result (errors, empty, unexpected)?

Analysis:&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">integrate</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, tool_name: <span class="hljs-built_in">str</span>,
                       arguments: <span class="hljs-built_in">dict</span>, result: <span class="hljs-type">Any</span>,
                       llm: <span class="hljs-string">&quot;LLMClient&quot;</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        result_str = json.dumps(result, indent=<span class="hljs-number">2</span>, default=<span class="hljs-built_in">str</span>)[:<span class="hljs-number">5000</span>]
        
        analysis = <span class="hljs-keyword">await</span> llm.generate(
            prompt=<span class="hljs-variable language_">self</span>.INTEGRATION_PROMPT.<span class="hljs-built_in">format</span>(
                task=task,
                tool_name=tool_name,
                arguments=json.dumps(arguments),
                result=result_str
            ),
            temperature=<span class="hljs-number">0.0</span>
        )
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;tool_name&quot;</span>: tool_name,
            <span class="hljs-string">&quot;raw_result&quot;</span>: result,
            <span class="hljs-string">&quot;interpretation&quot;</span>: analysis,
            <span class="hljs-string">&quot;result_token_count&quot;</span>: <span class="hljs-built_in">len</span>(result_str.split())
        }
</code></pre>
</div><hr>
<h2 id="1108-multi-model-chains" tabindex="-1">1.10.8 Multi-Model Chains</h2>
<h3 id="11081-different-llms-for-different-steps" tabindex="-1">1.10.8.1 Different LLMs for Different Steps</h3>
<p>Multi-model chains assign <strong>specialized models</strong> to each step based on the step’s requirements:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><msub><mi>p</mi><msub><mi>θ</mi><mi>i</mi></msub></msub><mo stretchy="false">(</mo><mi>y</mi><mo>∣</mo><mtext>Render</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace width="1em"/><mtext>where </mtext><msub><mi>θ</mi><mi>i</mi></msub><mtext> may differ per step</mtext></mrow><annotation encoding="application/x-tex">
y_i = p_{\theta_i}(y \mid \text{Render}(S_i)) \quad \text{where } \theta_i \text{ may differ per step}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0001em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Render</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">where </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord"> may differ per step</span></span></span></span></span></span></eqn></section><p><strong>Model assignment criteria:</strong></p>
<table>
<thead>
<tr>
<th>Step Characteristic</th>
<th>Optimal Model Profile</th>
</tr>
</thead>
<tbody>
<tr>
<td>Simple classification/routing</td>
<td>Small, fast (<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≤</mo></mrow><annotation encoding="application/x-tex">\leq</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mrel">≤</span></span></span></span></eq> 8B parameters)</td>
</tr>
<tr>
<td>Complex reasoning</td>
<td>Large, capable (GPT-4o, Claude Sonnet)</td>
</tr>
<tr>
<td>Code generation</td>
<td>Code-specialized (Codex, DeepSeek-Coder)</td>
</tr>
<tr>
<td>Creative writing</td>
<td>Creative-tuned (Claude, GPT-4o at high temperature)</td>
</tr>
<tr>
<td>Structured extraction</td>
<td>Instruction-tuned with structured output support</td>
</tr>
<tr>
<td>Safety evaluation</td>
<td>Safety-specialized or separate classifier</td>
</tr>
<tr>
<td>Multilingual</td>
<td>Multilingual-optimized model</td>
</tr>
</tbody>
</table>
<h3 id="11082-vision-language-chains" tabindex="-1">1.10.8.2 Vision-Language Chains</h3>
<p>Cross-modal chains where visual inputs are processed by vision models and results feed into language-model reasoning:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">Image → [Vision Model] → Caption/Description → [Language Model] → Analysis
  │                                                                  │
  └──── [OCR Tool] → Extracted Text ─────────────────────────────────┘
</code></pre>
</div><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VisionLanguageChain</span>:
    <span class="hljs-string">&quot;&quot;&quot;Cross-modal chain: image → visual understanding → text reasoning.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vision_llm: <span class="hljs-string">&quot;MultimodalLLM&quot;</span>, 
                 text_llm: <span class="hljs-string">&quot;LLMClient&quot;</span>,
                 ocr_tool: <span class="hljs-type">Callable</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-variable language_">self</span>.vision = vision_llm
        <span class="hljs-variable language_">self</span>.text = text_llm
        <span class="hljs-variable language_">self</span>.ocr = ocr_tool
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_image</span>(<span class="hljs-params">self, image_data: <span class="hljs-built_in">bytes</span>, 
                           question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Phase 1: Visual understanding (multimodal model)</span>
        visual_analysis = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.vision.generate(
            prompt=(
                <span class="hljs-string">&quot;Describe this image in detail. Include:\n&quot;</span>
                <span class="hljs-string">&quot;1. What objects/entities are present\n&quot;</span>
                <span class="hljs-string">&quot;2. Any text visible in the image\n&quot;</span>
                <span class="hljs-string">&quot;3. Spatial relationships between elements\n&quot;</span>
                <span class="hljs-string">&quot;4. Any data, charts, or structured information&quot;</span>
            ),
            images=[image_data],
            temperature=<span class="hljs-number">0.0</span>
        )
        
        <span class="hljs-comment"># Phase 1b: OCR (parallel with visual analysis)</span>
        extracted_text = <span class="hljs-string">&quot;&quot;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.ocr:
            extracted_text = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.ocr(image_data)
        
        <span class="hljs-comment"># Phase 2: Text-based reasoning (language model)</span>
        reasoning = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.text.generate(
            prompt=(
                <span class="hljs-string">f&quot;Based on the following image analysis, answer the question.\n\n&quot;</span>
                <span class="hljs-string">f&quot;Image Description:\n<span class="hljs-subst">{visual_analysis}</span>\n\n&quot;</span>
                <span class="hljs-string">f&quot;Extracted Text (OCR):\n<span class="hljs-subst">{extracted_text}</span>\n\n&quot;</span>
                <span class="hljs-string">f&quot;Question: <span class="hljs-subst">{question}</span>\n\n&quot;</span>
                <span class="hljs-string">f&quot;Answer:&quot;</span>
            ),
            temperature=<span class="hljs-number">0.0</span>
        )
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;visual_analysis&quot;</span>: visual_analysis,
            <span class="hljs-string">&quot;extracted_text&quot;</span>: extracted_text,
            <span class="hljs-string">&quot;answer&quot;</span>: reasoning
        }
</code></pre>
</div><h3 id="11083-speech-text-speech-chains" tabindex="-1">1.10.8.3 Speech-Text-Speech Chains</h3>
<p>End-to-end chains spanning speech and text modalities:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">Audio → [ASR] → Transcript → [NLP Chain] → Response Text → [TTS] → Audio
</code></pre>
</div><div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpeechToSpeechChain</span>:
    <span class="hljs-string">&quot;&quot;&quot;End-to-end speech processing chain: ASR → NLP → TTS.&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, asr_model, nlp_chain: <span class="hljs-type">Callable</span>, tts_model</span>):
        <span class="hljs-variable language_">self</span>.asr = asr_model       <span class="hljs-comment"># Speech-to-Text</span>
        <span class="hljs-variable language_">self</span>.nlp = nlp_chain       <span class="hljs-comment"># Text processing chain</span>
        <span class="hljs-variable language_">self</span>.tts = tts_model       <span class="hljs-comment"># Text-to-Speech</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">self, audio_input: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Phase 1: Automatic Speech Recognition</span>
        transcript = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.asr.transcribe(audio_input)
        
        <span class="hljs-comment"># Phase 2: NLP Chain (can be any complex chain)</span>
        nlp_result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.nlp({<span class="hljs-string">&quot;query&quot;</span>: transcript[<span class="hljs-string">&quot;text&quot;</span>]})
        
        <span class="hljs-comment"># Phase 3: Text-to-Speech</span>
        response_text = nlp_result.get(<span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)
        audio_output = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.tts.synthesize(response_text)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;transcript&quot;</span>: transcript,
            <span class="hljs-string">&quot;nlp_result&quot;</span>: nlp_result,
            <span class="hljs-string">&quot;response_text&quot;</span>: response_text,
            <span class="hljs-string">&quot;audio_output&quot;</span>: audio_output
        }
</code></pre>
</div><hr>
<h2 id="1109-self-adaptive-chains" tabindex="-1">1.10.9 Self-Adaptive Chains</h2>
<h3 id="11091-chains-that-modify-their-own-structure" tabindex="-1">1.10.9.1 Chains That Modify Their Own Structure</h3>
<p>The most advanced pattern: chains that <strong>dynamically alter their own topology</strong> at runtime based on intermediate results. This is the bridge between static prompt chains and fully autonomous agents.</p>
<p><strong>Formal model.</strong> A self-adaptive chain is a function:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">A</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Execute</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><mtext>MetaChain</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
\mathcal{A}(x) = \text{Execute}\!\bigl(\, \text{MetaChain}(x) \,\bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal">A</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mord text"><span class="mord">Execute</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">MetaChain</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size1">)</span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>MetaChain</mtext></mrow><annotation encoding="application/x-tex">\text{MetaChain}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">MetaChain</span></span></span></span></span></eq> is itself a chain that <strong>produces a chain specification</strong> as its output:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MetaChain</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>→</mo><mi>G</mi><mo>=</mo><mo stretchy="false">(</mo><mi>V</mi><mo separator="true">,</mo><mi>E</mi><mo separator="true">,</mo><mi mathvariant="normal">Σ</mi><mo stretchy="false">)</mo><mspace width="1em"/><mtext>(the execution plan)</mtext></mrow><annotation encoding="application/x-tex">
\text{MetaChain}(x) \to G = (V, E, \Sigma) \quad \text{(the execution plan)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MetaChain</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">Σ</span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(the execution plan)</span></span></span></span></span></span></eqn></section><section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Execute</mtext><mo stretchy="false">(</mo><mi>G</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>→</mo><mi>y</mi><mspace width="1em"/><mtext>(run the generated plan)</mtext></mrow><annotation encoding="application/x-tex">
\text{Execute}(G, x) \to y \quad \text{(run the generated plan)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Execute</span></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">(run the generated plan)</span></span></span></span></span></span></eqn></section><h3 id="11092-dynamic-step-insertiondeletion" tabindex="-1">1.10.9.2 Dynamic Step Insertion/Deletion</h3>
<p>Based on intermediate results, the chain can:</p>
<ul>
<li><strong>Insert</strong> additional steps (e.g., “this needs more research, add a retrieval step”)</li>
<li><strong>Delete</strong> planned steps (e.g., “we already have enough information, skip analysis”)</li>
<li><strong>Replace</strong> steps with alternatives (e.g., “the API is down, switch to cached data”)</li>
</ul>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveChainExecutor</span>:
    <span class="hljs-string">&quot;&quot;&quot;Chain that modifies its own structure at runtime.&quot;&quot;&quot;</span>
    
    ADAPTATION_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Given the current chain state, decide if the planned 
next steps should be modified.

Original task: {task}
Completed steps: {completed}
Current result quality: {quality}
Remaining planned steps: {remaining}

Should we:
A) PROCEED with the next planned step
B) INSERT an additional step before the next one
C) SKIP the next planned step
D) REPLACE the next step with a different approach
E) TERMINATE early (output is sufficient)

Respond as JSON:
{{&quot;decision&quot;: &quot;A|B|C|D|E&quot;, &quot;reasoning&quot;: &quot;...&quot;,
  &quot;inserted_step&quot;: {{...}} or null,
  &quot;replacement_step&quot;: {{...}} or null}}&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: <span class="hljs-string">&quot;LLMClient&quot;</span>, 
                 step_library: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>],
                 quality_fn: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-variable language_">self</span>.llm = llm
        <span class="hljs-variable language_">self</span>.step_library = step_library
        <span class="hljs-variable language_">self</span>.quality_fn = quality_fn
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, 
                      initial_plan: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]</span>) -&gt; <span class="hljs-built_in">dict</span>:
        plan = <span class="hljs-built_in">list</span>(initial_plan)  <span class="hljs-comment"># mutable copy</span>
        completed_steps = []
        state = {<span class="hljs-string">&quot;task&quot;</span>: task}
        current_output = <span class="hljs-literal">None</span>
        adaptations = []
        
        step_idx = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> step_idx &lt; <span class="hljs-built_in">len</span>(plan):
            current_step = plan[step_idx]
            
            <span class="hljs-comment"># Adaptive decision point</span>
            quality = <span class="hljs-variable language_">self</span>.quality_fn(<span class="hljs-built_in">str</span>(current_output)) <span class="hljs-keyword">if</span> current_output <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>
            adaptation = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._decide_adaptation(
                task=task,
                completed=completed_steps,
                quality=quality,
                remaining=plan[step_idx:]
            )
            
            adaptations.append({
                <span class="hljs-string">&quot;before_step&quot;</span>: step_idx,
                <span class="hljs-string">&quot;decision&quot;</span>: adaptation[<span class="hljs-string">&quot;decision&quot;</span>]
            })
            
            <span class="hljs-keyword">if</span> adaptation[<span class="hljs-string">&quot;decision&quot;</span>] == <span class="hljs-string">&quot;E&quot;</span>:  <span class="hljs-comment"># TERMINATE</span>
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">elif</span> adaptation[<span class="hljs-string">&quot;decision&quot;</span>] == <span class="hljs-string">&quot;C&quot;</span>:  <span class="hljs-comment"># SKIP</span>
                step_idx += <span class="hljs-number">1</span>
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">elif</span> adaptation[<span class="hljs-string">&quot;decision&quot;</span>] == <span class="hljs-string">&quot;B&quot;</span>:  <span class="hljs-comment"># INSERT</span>
                inserted = adaptation.get(<span class="hljs-string">&quot;inserted_step&quot;</span>, {})
                plan.insert(step_idx, inserted)
                <span class="hljs-comment"># Don&#x27;t increment — execute the inserted step</span>
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">elif</span> adaptation[<span class="hljs-string">&quot;decision&quot;</span>] == <span class="hljs-string">&quot;D&quot;</span>:  <span class="hljs-comment"># REPLACE</span>
                plan[step_idx] = adaptation.get(<span class="hljs-string">&quot;replacement_step&quot;</span>, current_step)
                <span class="hljs-comment"># Don&#x27;t increment — execute the replacement</span>
                <span class="hljs-keyword">continue</span>
            
            <span class="hljs-comment"># A) PROCEED — execute the step</span>
            step_fn = <span class="hljs-variable language_">self</span>.step_library.get(current_step.get(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;llm&quot;</span>))
            <span class="hljs-keyword">if</span> step_fn:
                current_output = <span class="hljs-keyword">await</span> step_fn({**state, **current_step})
                state[<span class="hljs-string">&quot;latest_output&quot;</span>] = current_output
            
            completed_steps.append({
                <span class="hljs-string">&quot;step&quot;</span>: current_step,
                <span class="hljs-string">&quot;output_preview&quot;</span>: <span class="hljs-built_in">str</span>(current_output)[:<span class="hljs-number">200</span>]
            })
            
            step_idx += <span class="hljs-number">1</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: current_output,
            <span class="hljs-string">&quot;steps_executed&quot;</span>: <span class="hljs-built_in">len</span>(completed_steps),
            <span class="hljs-string">&quot;original_plan_length&quot;</span>: <span class="hljs-built_in">len</span>(initial_plan),
            <span class="hljs-string">&quot;final_plan_length&quot;</span>: <span class="hljs-built_in">len</span>(plan),
            <span class="hljs-string">&quot;adaptations&quot;</span>: adaptations
        }
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_decide_adaptation</span>(<span class="hljs-params">self, task, completed, 
                                   quality, remaining</span>) -&gt; <span class="hljs-built_in">dict</span>:
        response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.llm.generate(
            prompt=<span class="hljs-variable language_">self</span>.ADAPTATION_PROMPT.<span class="hljs-built_in">format</span>(
                task=task,
                completed=json.dumps(completed[-<span class="hljs-number">3</span>:], default=<span class="hljs-built_in">str</span>),  <span class="hljs-comment"># last 3</span>
                quality=quality,
                remaining=json.dumps(remaining[:<span class="hljs-number">3</span>], default=<span class="hljs-built_in">str</span>)  <span class="hljs-comment"># next 3</span>
            ),
            temperature=<span class="hljs-number">0.0</span>
        )
        <span class="hljs-keyword">return</span> json.loads(response)
</code></pre>
</div><h3 id="11093-meta-chain-a-chain-that-constructs-and-executes-sub-chains" tabindex="-1">1.10.9.3 Meta-Chain: A Chain That Constructs and Executes Sub-Chains</h3>
<p>The ultimate generalization: a <strong>meta-chain</strong> where the first step generates a complete chain specification, and subsequent steps execute that specification.</p>
<div class="code-shell"><pre class="hljs"><code class="hljs">Input → [Planner: Generate Chain Spec] → [Validator: Check Spec] 
    → [Executor: Run Generated Chain] → [Evaluator: Assess Output] → Output
</code></pre>
</div><p><strong>Formal model:</strong></p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MetaChain</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Evaluate</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">(</mo><mtext> </mtext><mtext>Execute</mtext><mtext> ⁣</mtext><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mtext> </mtext><mtext>Validate</mtext><mo stretchy="false">(</mo><mtext>Plan</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mtext> </mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">)</mo></mrow><annotation encoding="application/x-tex">
\text{MetaChain}(x) = \text{Evaluate}\!\Bigl(\, \text{Execute}\!\bigl(\, \text{Validate}(\text{Plan}(x))\bigr) \,\Bigr)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MetaChain</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="mord text"><span class="mord">Evaluate</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size2">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">Execute</span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mopen"><span class="delimsizing size1">(</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">Validate</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">Plan</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mclose"><span class="delimsizing size1">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose"><span class="delimsizing size2">)</span></span></span></span></span></span></eqn></section><p>This is a <strong>two-level architecture</strong>:</p>
<ul>
<li><strong>Level 1 (Meta):</strong> Plans, validates, and orchestrates</li>
<li><strong>Level 0 (Object):</strong> The dynamically generated chain that actually solves the task</li>
</ul>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MetaChainOrchestrator</span>:
    <span class="hljs-string">&quot;&quot;&quot;A chain that generates, validates, and executes sub-chains.&quot;&quot;&quot;</span>
    
    PLAN_PROMPT = <span class="hljs-string">&quot;&quot;&quot;Design a step-by-step chain to accomplish this task.
For each step, specify:
- step_id: unique identifier
- type: one of [llm_call, tool_call, code_execute, retrieval, conditional]
- description: what this step does
- prompt_template: the prompt to use (with {variable} placeholders)
- dependencies: list of step_ids this step depends on
- output_key: key name for this step&#x27;s output

Available tools: {tools}

Task: {task}

Respond with a JSON chain specification:
{{&quot;steps&quot;: [...], &quot;final_output_key&quot;: &quot;...&quot;}}&quot;&quot;&quot;</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, planner_llm: <span class="hljs-string">&quot;LLMClient&quot;</span>,
                 executor_llm: <span class="hljs-string">&quot;LLMClient&quot;</span>,
                 tool_registry: ToolRegistry</span>):
        <span class="hljs-variable language_">self</span>.planner = planner_llm
        <span class="hljs-variable language_">self</span>.executor = executor_llm
        <span class="hljs-variable language_">self</span>.tools = tool_registry
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># Level 1, Step 1: PLAN</span>
        plan_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.planner.generate(
            prompt=<span class="hljs-variable language_">self</span>.PLAN_PROMPT.<span class="hljs-built_in">format</span>(
                task=task,
                tools=json.dumps(<span class="hljs-variable language_">self</span>.tools.get_schemas_for_llm(), indent=<span class="hljs-number">2</span>)
            ),
            temperature=<span class="hljs-number">0.0</span>
        )
        chain_spec = json.loads(plan_response)
        
        <span class="hljs-comment"># Level 1, Step 2: VALIDATE</span>
        validation = <span class="hljs-variable language_">self</span>._validate_chain_spec(chain_spec)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> validation[<span class="hljs-string">&quot;valid&quot;</span>]:
            <span class="hljs-comment"># Re-plan with feedback</span>
            chain_spec = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._replan(task, chain_spec, validation)
        
        <span class="hljs-comment"># Level 1, Step 3: EXECUTE (Level 0 chain)</span>
        execution_result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._execute_chain(chain_spec, task)
        
        <span class="hljs-comment"># Level 1, Step 4: EVALUATE</span>
        evaluation = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._evaluate_result(task, execution_result)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;output&quot;</span>: execution_result.get(chain_spec.get(<span class="hljs-string">&quot;final_output_key&quot;</span>, <span class="hljs-string">&quot;result&quot;</span>)),
            <span class="hljs-string">&quot;chain_spec&quot;</span>: chain_spec,
            <span class="hljs-string">&quot;validation&quot;</span>: validation,
            <span class="hljs-string">&quot;execution_log&quot;</span>: execution_result,
            <span class="hljs-string">&quot;evaluation&quot;</span>: evaluation
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_chain_spec</span>(<span class="hljs-params">self, spec: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;Validate chain specification for structural correctness.&quot;&quot;&quot;</span>
        issues = []
        step_ids = {s[<span class="hljs-string">&quot;step_id&quot;</span>] <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> spec.get(<span class="hljs-string">&quot;steps&quot;</span>, [])}
        
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> spec.get(<span class="hljs-string">&quot;steps&quot;</span>, []):
            <span class="hljs-comment"># Check dependencies reference valid step IDs</span>
            <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> step.get(<span class="hljs-string">&quot;dependencies&quot;</span>, []):
                <span class="hljs-keyword">if</span> dep <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> step_ids:
                    issues.append(<span class="hljs-string">f&quot;Step <span class="hljs-subst">{step[<span class="hljs-string">&#x27;step_id&#x27;</span>]}</span> depends on unknown step <span class="hljs-subst">{dep}</span>&quot;</span>)
            
            <span class="hljs-comment"># Check for required fields</span>
            <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;step_id&quot;</span>, <span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>]:
                <span class="hljs-keyword">if</span> field <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> step:
                    issues.append(<span class="hljs-string">f&quot;Step missing required field: <span class="hljs-subst">{field}</span>&quot;</span>)
            
            <span class="hljs-comment"># Check tool references</span>
            <span class="hljs-keyword">if</span> step.get(<span class="hljs-string">&quot;type&quot;</span>) == <span class="hljs-string">&quot;tool_call&quot;</span>:
                tool_name = step.get(<span class="hljs-string">&quot;tool_name&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)
                <span class="hljs-keyword">if</span> tool_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.tools.tools:
                    issues.append(<span class="hljs-string">f&quot;Unknown tool: <span class="hljs-subst">{tool_name}</span>&quot;</span>)
        
        <span class="hljs-comment"># Check for cycles (topological sort)</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-variable language_">self</span>._topological_sort(spec.get(<span class="hljs-string">&quot;steps&quot;</span>, []))
        <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
            issues.append(<span class="hljs-string">f&quot;Cyclic dependency: <span class="hljs-subst">{e}</span>&quot;</span>)
        
        <span class="hljs-keyword">return</span> {<span class="hljs-string">&quot;valid&quot;</span>: <span class="hljs-built_in">len</span>(issues) == <span class="hljs-number">0</span>, <span class="hljs-string">&quot;issues&quot;</span>: issues}
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_execute_chain</span>(<span class="hljs-params">self, spec: <span class="hljs-built_in">dict</span>, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;Execute the generated chain specification.&quot;&quot;&quot;</span>
        steps = spec.get(<span class="hljs-string">&quot;steps&quot;</span>, [])
        ordered = <span class="hljs-variable language_">self</span>._topological_sort(steps)
        results = {<span class="hljs-string">&quot;task&quot;</span>: task}
        
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> ordered:
            step_type = step.get(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;llm_call&quot;</span>)
            
            <span class="hljs-keyword">if</span> step_type == <span class="hljs-string">&quot;llm_call&quot;</span>:
                <span class="hljs-comment"># Fill in template variables from prior results</span>
                prompt = step.get(<span class="hljs-string">&quot;prompt_template&quot;</span>, step[<span class="hljs-string">&quot;description&quot;</span>])
                <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> results.items():
                    prompt = prompt.replace(<span class="hljs-string">f&quot;{{<span class="hljs-subst">{key}</span>}}&quot;</span>, <span class="hljs-built_in">str</span>(value)[:<span class="hljs-number">2000</span>])
                
                output = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.executor.generate(
                    prompt=prompt, temperature=<span class="hljs-number">0.1</span>, max_tokens=<span class="hljs-number">2000</span>
                )
                results[step[<span class="hljs-string">&quot;output_key&quot;</span>]] = output
            
            <span class="hljs-keyword">elif</span> step_type == <span class="hljs-string">&quot;tool_call&quot;</span>:
                args = step.get(<span class="hljs-string">&quot;arguments&quot;</span>, {})
                <span class="hljs-comment"># Resolve variable references in arguments</span>
                resolved_args = {}
                <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> args.items():
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(v, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">and</span> v.startswith(<span class="hljs-string">&quot;{&quot;</span>) <span class="hljs-keyword">and</span> v.endswith(<span class="hljs-string">&quot;}&quot;</span>):
                        var_name = v[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]
                        resolved_args[k] = results.get(var_name, v)
                    <span class="hljs-keyword">else</span>:
                        resolved_args[k] = v
                
                tool_result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.tools.execute(
                    step.get(<span class="hljs-string">&quot;tool_name&quot;</span>, <span class="hljs-string">&quot;&quot;</span>), resolved_args
                )
                results[step[<span class="hljs-string">&quot;output_key&quot;</span>]] = tool_result
            
            <span class="hljs-keyword">elif</span> step_type == <span class="hljs-string">&quot;code_execute&quot;</span>:
                <span class="hljs-comment"># Sandboxed code execution</span>
                code = step.get(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)
                <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> results.items():
                    code = code.replace(<span class="hljs-string">f&quot;{{<span class="hljs-subst">{key}</span>}}&quot;</span>, <span class="hljs-built_in">str</span>(value))
                <span class="hljs-comment"># Execute in sandbox...</span>
                results[step[<span class="hljs-string">&quot;output_key&quot;</span>]] = <span class="hljs-string">f&quot;[code execution result]&quot;</span>
        
        <span class="hljs-keyword">return</span> results
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_topological_sort</span>(<span class="hljs-params">steps: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]:
        <span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict, deque
        
        graph = defaultdict(<span class="hljs-built_in">list</span>)
        in_degree = {s[<span class="hljs-string">&quot;step_id&quot;</span>]: <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> steps}
        id_to_step = {s[<span class="hljs-string">&quot;step_id&quot;</span>]: s <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> steps}
        
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> steps:
            <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> step.get(<span class="hljs-string">&quot;dependencies&quot;</span>, []):
                graph[dep].append(step[<span class="hljs-string">&quot;step_id&quot;</span>])
                in_degree[step[<span class="hljs-string">&quot;step_id&quot;</span>]] += <span class="hljs-number">1</span>
        
        queue = deque([sid <span class="hljs-keyword">for</span> sid, deg <span class="hljs-keyword">in</span> in_degree.items() <span class="hljs-keyword">if</span> deg == <span class="hljs-number">0</span>])
        ordered = []
        
        <span class="hljs-keyword">while</span> queue:
            current = queue.popleft()
            ordered.append(id_to_step[current])
            <span class="hljs-keyword">for</span> neighbor <span class="hljs-keyword">in</span> graph[current]:
                in_degree[neighbor] -= <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> in_degree[neighbor] == <span class="hljs-number">0</span>:
                    queue.append(neighbor)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ordered) != <span class="hljs-built_in">len</span>(steps):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Cyclic dependency detected&quot;</span>)
        <span class="hljs-keyword">return</span> ordered
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_evaluate_result</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, result: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">&quot;&quot;&quot;Evaluate whether the chain&#x27;s output satisfies the task.&quot;&quot;&quot;</span>
        output_keys = [k <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> result <span class="hljs-keyword">if</span> k != <span class="hljs-string">&quot;task&quot;</span>]
        output_summary = json.dumps(
            {k: <span class="hljs-built_in">str</span>(result[k])[:<span class="hljs-number">500</span>] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> output_keys[-<span class="hljs-number">3</span>:]},
            indent=<span class="hljs-number">2</span>
        )
        
        eval_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.planner.generate(
            prompt=(
                <span class="hljs-string">f&quot;Evaluate whether this result satisfies the original task.\n\n&quot;</span>
                <span class="hljs-string">f&quot;Task: <span class="hljs-subst">{task}</span>\n\n&quot;</span>
                <span class="hljs-string">f&quot;Result:\n<span class="hljs-subst">{output_summary}</span>\n\n&quot;</span>
                <span class="hljs-string">f&quot;Score (0-1) and brief justification as JSON:&quot;</span>
            ),
            temperature=<span class="hljs-number">0.0</span>
        )
        <span class="hljs-keyword">return</span> json.loads(eval_response)
</code></pre>
</div><h3 id="11094-learned-chain-topologies" tabindex="-1">1.10.9.4 Learned Chain Topologies</h3>
<p>The frontier of self-adaptive chains: <strong>learning optimal chain structures from data</strong> rather than hand-designing them.</p>
<p><strong>Approach 1 — Reinforcement Learning over Chain Structures.</strong> Treat chain topology as an action space and task success as reward:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>π</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>∣</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>π</mi></munder><mtext>  </mtext><mi mathvariant="double-struck">E</mi><mtext> ⁣</mtext><mrow><mo fence="true">[</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></munderover><msup><mi>γ</mi><mi>t</mi></msup><msub><mi>r</mi><mi>t</mi></msub><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\pi^*(a_t \mid S_t) = \arg\max_\pi \; \mathbb{E}\!\left[\sum_{t=0}^{T} \gamma^t r_t \right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbb">E</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8436em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>is the choice of which step to add/execute next, and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> reflects quality, cost, and latency.</p>
<p><strong>Approach 2 — Bayesian Optimization over Chain Hyperparameters.</strong> Optimize the chain’s structural parameters (number of steps, which steps to include, model assignments) using Bayesian optimization with a Gaussian Process surrogate:</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>θ</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>θ</mi></munder><mtext>  </mtext><mi>α</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mi>μ</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>+</mo><mi>κ</mi><mo>⋅</mo><mi>σ</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\theta^* = \arg\max_\theta \; \alpha(\theta) = \mu(\theta) + \kappa \cdot \sigma(\theta)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7387em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.5021em;vertical-align:-0.7521em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7521em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">μ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">κ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></eqn></section><p>where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span></eq>is the acquisition function (Upper Confidence Bound),<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">μ</span></span></span></span></eq>is the predicted quality, and<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></eq> is the uncertainty.</p>
<p><strong>Approach 3 — Evolutionary Search.</strong> Maintain a population of chain topologies, evaluate each on a benchmark, and evolve through mutation (add/remove/swap steps) and crossover:</p>
<div class="code-shell"><pre class="hljs"><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainTopologyEvolver</span>:
    <span class="hljs-string">&quot;&quot;&quot;Evolve chain structures through mutation and selection.&quot;&quot;&quot;</span>
    
<span class="hljs-meta">    @dataclass</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainGenome</span>:
        steps: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]
        fitness: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, step_library: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>],
                 fitness_fn: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]], <span class="hljs-built_in">float</span>],
                 population_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span></span>):
        <span class="hljs-variable language_">self</span>.step_library = step_library
        <span class="hljs-variable language_">self</span>.fitness_fn = fitness_fn
        <span class="hljs-variable language_">self</span>.pop_size = population_size
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mutate</span>(<span class="hljs-params">self, genome: <span class="hljs-string">&quot;ChainTopologyEvolver.ChainGenome&quot;</span></span>) -&gt; <span class="hljs-string">&quot;ChainTopologyEvolver.ChainGenome&quot;</span>:
        <span class="hljs-keyword">import</span> random
        steps = <span class="hljs-built_in">list</span>(genome.steps)
        mutation = random.choice([<span class="hljs-string">&quot;add&quot;</span>, <span class="hljs-string">&quot;remove&quot;</span>, <span class="hljs-string">&quot;swap&quot;</span>, <span class="hljs-string">&quot;modify&quot;</span>])
        
        <span class="hljs-keyword">if</span> mutation == <span class="hljs-string">&quot;add&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(steps) &lt; <span class="hljs-number">15</span>:
            new_step = random.choice(<span class="hljs-variable language_">self</span>.step_library)
            pos = random.randint(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(steps))
            steps.insert(pos, {**new_step})
        <span class="hljs-keyword">elif</span> mutation == <span class="hljs-string">&quot;remove&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(steps) &gt; <span class="hljs-number">2</span>:
            pos = random.randint(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(steps) - <span class="hljs-number">1</span>)
            steps.pop(pos)
        <span class="hljs-keyword">elif</span> mutation == <span class="hljs-string">&quot;swap&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(steps) &gt;= <span class="hljs-number">2</span>:
            i, j = random.sample(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(steps)), <span class="hljs-number">2</span>)
            steps[i], steps[j] = steps[j], steps[i]
        <span class="hljs-keyword">elif</span> mutation == <span class="hljs-string">&quot;modify&quot;</span> <span class="hljs-keyword">and</span> steps:
            pos = random.randint(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(steps) - <span class="hljs-number">1</span>)
            steps[pos] = random.choice(<span class="hljs-variable language_">self</span>.step_library)
        
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.ChainGenome(steps=steps)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">evolve</span>(<span class="hljs-params">self, generations: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>) -&gt; <span class="hljs-string">&quot;ChainTopologyEvolver.ChainGenome&quot;</span>:
        <span class="hljs-comment"># Initialize population</span>
        population = []
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.pop_size):
            n_steps = random.randint(<span class="hljs-number">2</span>, <span class="hljs-number">8</span>)
            steps = random.choices(<span class="hljs-variable language_">self</span>.step_library, k=n_steps)
            population.append(<span class="hljs-variable language_">self</span>.ChainGenome(steps=steps))
        
        <span class="hljs-keyword">for</span> gen <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(generations):
            <span class="hljs-comment"># Evaluate fitness</span>
            <span class="hljs-keyword">for</span> genome <span class="hljs-keyword">in</span> population:
                genome.fitness = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.fitness_fn(genome.steps)
            
            <span class="hljs-comment"># Selection (top 50%)</span>
            population.sort(key=<span class="hljs-keyword">lambda</span> g: g.fitness, reverse=<span class="hljs-literal">True</span>)
            survivors = population[:<span class="hljs-variable language_">self</span>.pop_size // <span class="hljs-number">2</span>]
            
            <span class="hljs-comment"># Reproduction</span>
            offspring = []
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.pop_size - <span class="hljs-built_in">len</span>(survivors)):
                parent = random.choice(survivors)
                child = <span class="hljs-variable language_">self</span>.mutate(parent)
                offspring.append(child)
            
            population = survivors + offspring
        
        population.sort(key=<span class="hljs-keyword">lambda</span> g: g.fitness, reverse=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> population[<span class="hljs-number">0</span>]
</code></pre>
</div><hr>
<h2 id="summary-advanced-technique-selection-matrix" tabindex="-1">Summary: Advanced Technique Selection Matrix</h2>
<table>
<thead>
<tr>
<th>Technique</th>
<th>Best For</th>
<th>Complexity</th>
<th>Cost Multiplier</th>
<th>Key Risk</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CoT as Micro-Chain</strong></td>
<td>Short reasoning tasks</td>
<td>Very Low</td>
<td>1×</td>
<td>Unverifiable intermediate steps</td>
</tr>
<tr>
<td><strong>Recursive Chains</strong></td>
<td>Hierarchical problems (summarization, decomposition)</td>
<td>Medium</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq>×</td>
<td>Stack overflow, non-termination</td>
</tr>
<tr>
<td><strong>Map-Reduce</strong></td>
<td>Large inputs decomposable into independent parts</td>
<td>Medium</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq>× (parallelizable)</td>
<td>Information loss at reduce boundaries</td>
</tr>
<tr>
<td><strong>Iterative Refinement</strong></td>
<td>Quality-critical outputs needing polish</td>
<td>Medium</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>max</mi><mo>⁡</mo></msub></mrow><annotation encoding="application/x-tex">t_{\max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq>×</td>
<td>Non-monotonic quality, divergence</td>
</tr>
<tr>
<td><strong>Ensemble Chains</strong></td>
<td>High-reliability tasks</td>
<td>Low–Med</td>
<td><eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq>×</td>
<td>Expensive; diminishing returns past <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>≈</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">k \approx 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></eq></td>
</tr>
<tr>
<td><strong>RAG Chains</strong></td>
<td>Knowledge-intensive tasks</td>
<td>Medium</td>
<td>1.5–3×</td>
<td>Retrieval quality bottleneck</td>
</tr>
<tr>
<td><strong>Tool-Augmented</strong></td>
<td>Tasks requiring computation, search, or external actions</td>
<td>Medium–High</td>
<td>Variable</td>
<td>Tool errors, injection attacks</td>
</tr>
<tr>
<td><strong>Multi-Model</strong></td>
<td>Tasks spanning modalities or requiring specialized models</td>
<td>High</td>
<td>Variable</td>
<td>Integration complexity, format mismatches</td>
</tr>
<tr>
<td><strong>Self-Adaptive</strong></td>
<td>Novel tasks with unpredictable structure</td>
<td>Very High</td>
<td>Unpredictable</td>
<td>Instability, runaway cost, debugging difficulty</td>
</tr>
</tbody>
</table>

      </article>
      <section class="doc-pager" aria-label="Document pagination">
        <a class="pager-link" href="../Agentic_ai/Optimization_of_prompt_chains.html"><small>Previous</small><strong>1.9 Optimization of Prompt Chains</strong></a>
        <a class="pager-link" href="../Agentic_ai/Evaluation_of_prompt_chains.html"><small>Next</small><strong>1.13 Evaluation of Prompt Chains</strong></a>
      </section>
      <footer class="doc-footer">
        <p>Generated from <code>llm_training_at_scale</code> at <time datetime="2026-02-19T19:24:13.266Z">2026-02-19T19:24:13.266Z</time>.</p>
      </footer>
    </main>
    <aside class="toc-pane">
      <p class="pane-label">On This Page</p>
      <nav class="toc-nav" aria-label="Table of contents">
<a class="toc-link toc-level-2" data-toc-link href="#1101-chain-of-thought-as-a-micro-chain">1.10.1 Chain-of-Thought as a Micro-Chain</a>
<a class="toc-link toc-level-3" data-toc-link href="#11011-cot-as-implicit-single-step-chaining">1.10.1.1 CoT as Implicit Single-Step Chaining</a>
<a class="toc-link toc-level-3" data-toc-link href="#11012-explicit-decomposition-of-cot-into-multi-step-chains">1.10.1.2 Explicit Decomposition of CoT into Multi-Step Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11013-comparative-analysis-cot-vs-explicit-prompt-chains">1.10.1.3 Comparative Analysis: CoT vs. Explicit Prompt Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11014-decision-framework-cot-within-a-step-vs-across-steps">1.10.1.4 Decision Framework: CoT Within a Step vs. Across Steps</a>
<a class="toc-link toc-level-2" data-toc-link href="#1102-recursive-chains">1.10.2 Recursive Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11021-self-referential-chain-definition">1.10.2.1 Self-Referential Chain Definition</a>
<a class="toc-link toc-level-3" data-toc-link href="#11022-recursion-depth-control-and-base-cases">1.10.2.2 Recursion Depth Control and Base Cases</a>
<a class="toc-link toc-level-3" data-toc-link href="#11023-recursive-summarization-chains">1.10.2.3 Recursive Summarization Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11024-recursive-refinement-chains">1.10.2.4 Recursive Refinement Chains</a>
<a class="toc-link toc-level-2" data-toc-link href="#1103-map-reduce-chains">1.10.3 Map-Reduce Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11031-formal-definition">1.10.3.1 Formal Definition</a>
<a class="toc-link toc-level-3" data-toc-link href="#11032-three-phase-architecture">1.10.3.2 Three-Phase Architecture</a>
<a class="toc-link toc-level-3" data-toc-link href="#11033-hierarchical-reduce">1.10.3.3 Hierarchical Reduce</a>
<a class="toc-link toc-level-3" data-toc-link href="#11034-concrete-application-multi-document-summarization">1.10.3.4 Concrete Application — Multi-Document Summarization</a>
<a class="toc-link toc-level-2" data-toc-link href="#1104-iterative-refinement-chains">1.10.4 Iterative Refinement Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11041-generate-critique-revise-loop">1.10.4.1 Generate → Critique → Revise Loop</a>
<a class="toc-link toc-level-3" data-toc-link href="#11042-convergence-criteria">1.10.4.2 Convergence Criteria</a>
<a class="toc-link toc-level-3" data-toc-link href="#11043-quality-monotonic-refinement-guarantees">1.10.4.3 Quality-Monotonic Refinement Guarantees</a>
<a class="toc-link toc-level-2" data-toc-link href="#1105-ensemble-chains">1.10.5 Ensemble Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11051-formal-definition">1.10.5.1 Formal Definition</a>
<a class="toc-link toc-level-3" data-toc-link href="#11052-aggregation-strategies">1.10.5.2 Aggregation Strategies</a>
<a class="toc-link toc-level-4" data-toc-link href="#a-majority-voting">A. Majority Voting</a>
<a class="toc-link toc-level-4" data-toc-link href="#b-confidence-weighted-voting">B. Confidence-Weighted Voting</a>
<a class="toc-link toc-level-4" data-toc-link href="#c-best-of-n-selection">C. Best-of-N Selection</a>
<a class="toc-link toc-level-4" data-toc-link href="#d-llm-as-judge-selection">D. LLM-as-Judge Selection</a>
<a class="toc-link toc-level-4" data-toc-link href="#e-synthesis-aggregation">E. Synthesis Aggregation</a>
<a class="toc-link toc-level-3" data-toc-link href="#11053-mixture-of-chains-architecture">1.10.5.3 Mixture-of-Chains Architecture</a>
<a class="toc-link toc-level-2" data-toc-link href="#1106-retrieval-augmented-chains">1.10.6 Retrieval-Augmented Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11061-rag-as-a-chain-step">1.10.6.1 RAG as a Chain Step</a>
<a class="toc-link toc-level-3" data-toc-link href="#11062-multi-hop-retrieval-chains">1.10.6.2 Multi-Hop Retrieval Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11063-adaptive-retrieval-retrieve-only-when-needed">1.10.6.3 Adaptive Retrieval (Retrieve Only When Needed)</a>
<a class="toc-link toc-level-3" data-toc-link href="#11064-query-rewriting-chains">1.10.6.4 Query Rewriting Chains</a>
<a class="toc-link toc-level-2" data-toc-link href="#1107-tool-augmented-chains">1.10.7 Tool-Augmented Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11071-tool-invocation-as-a-chain-step">1.10.7.1 Tool Invocation as a Chain Step</a>
<a class="toc-link toc-level-3" data-toc-link href="#11072-tool-registry-and-type-safe-invocation">1.10.7.2 Tool Registry and Type-Safe Invocation</a>
<a class="toc-link toc-level-3" data-toc-link href="#11073-tool-result-parsing-and-integration">1.10.7.3 Tool Result Parsing and Integration</a>
<a class="toc-link toc-level-2" data-toc-link href="#1108-multi-model-chains">1.10.8 Multi-Model Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11081-different-llms-for-different-steps">1.10.8.1 Different LLMs for Different Steps</a>
<a class="toc-link toc-level-3" data-toc-link href="#11082-vision-language-chains">1.10.8.2 Vision-Language Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11083-speech-text-speech-chains">1.10.8.3 Speech-Text-Speech Chains</a>
<a class="toc-link toc-level-2" data-toc-link href="#1109-self-adaptive-chains">1.10.9 Self-Adaptive Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11091-chains-that-modify-their-own-structure">1.10.9.1 Chains That Modify Their Own Structure</a>
<a class="toc-link toc-level-3" data-toc-link href="#11092-dynamic-step-insertiondeletion">1.10.9.2 Dynamic Step Insertion/Deletion</a>
<a class="toc-link toc-level-3" data-toc-link href="#11093-meta-chain-a-chain-that-constructs-and-executes-sub-chains">1.10.9.3 Meta-Chain: A Chain That Constructs and Executes Sub-Chains</a>
<a class="toc-link toc-level-3" data-toc-link href="#11094-learned-chain-topologies">1.10.9.4 Learned Chain Topologies</a>
<a class="toc-link toc-level-2" data-toc-link href="#summary-advanced-technique-selection-matrix">Summary: Advanced Technique Selection Matrix</a>
      </nav>
    </aside>
  </div>
  <script type="module" src="../assets/app.js?v=2026-02-19T19%3A24%3A13.266Z"></script>
</body>
</html>